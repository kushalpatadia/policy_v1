nbs.modules._tools={toolsVersion:"2.68.58.2.20160718"};nbs.factories.SavingsGoalFactory={hitTheGoal:function(n,t,i,r,u){var s;if(t>=n||t==0&&i==0)return{goal:n,rate:u,periodicDeposit:i,monthsInPeriod:r,saved:t.toFixed(2),interest:0..toFixed(2),term:0};var h=u/100,f=t,e=0,o=0;do o%r==0&&(f+=i),e+=f*(h/12),o++;while(f+e<n);return s=nbs.number.round(e,2),{goal:n,rate:u,periodicDeposit:i,monthsInPeriod:r,saved:(f+s).toFixed(2),interest:s.toFixed(2),term:o}},howMuchSavedRegularAmount:function(n,t,i,r,u){for(var s=u/100,f=n,e=0,o=0;o<r;o++)o%i==0&&(f+=t),e+=f*(s/12);return{rate:u,periodicDeposit:t,monthsInPeriod:i,saved:nbs.number.round(f+e,2).toFixed(2),interest:nbs.number.round(e,2).toFixed(2),term:r}},howMuchToSaveEachMonth:function(n,t,i,r){var u=r/100,f=n-t*(1+i*(u/12)),h=f/i,e=0,o=0,s;if(f<=0)return this.hitTheGoal(n,t,0,1,r);for(s=1;s<i+1;s++)e+=h*(1+s*(u/12))-h;o=1/(f+e)*f;var c=h*o,l=t*(1+i*(u/12))+c*i+e*o,a=t*(1+i*(u/12))-t+e*o;return{goal:n,rate:r,periodicDeposit:nbs.number.round(c,2).toFixed(2),monthsInPeriod:1,saved:nbs.number.round(l,2).toFixed(2),interest:nbs.number.round(a,2).toFixed(2),term:i}}};nbs.factories.MortgageEarlyRepaymentChargeFactory={getCharge:function(n,t){var i=parseFloat(n),r=parseFloat(t),u=i/100*r;return nbs.number.round(u,2).toFixed(2)},getErc:function(n,t,i,r,u){var l=n[t][i].predetermined||!1,o,e,h,c,s;if(l)return n[t][i].rate;o=n[t][i].dateset;e=new Date(r);for(h in o){var f=o[h],a=new Date(f.from),v=new Date(f.to);if(e>=a&&e<=v){c=this._termRemaining(i,e,u);for(s in f.erc)if(f.erc[s].remaining===c)return f.erc[s].rate}}return null},_daysDiff:function(n,t){var i=Math.abs(t.getTime()-n.getTime());return Math.ceil(i/864e5)},_termRemaining:function(n,t,i){var r=new Date(t),u=new Date(i),f,e;return r.setTime(r.getTime()+31536e6*n),r<=u?0:(f=this._daysDiff(r,u),e=Math.ceil(f/365),e)}};nbs.factories.MortgageOverpaymentsFactory={debug:!0,simulateInterestOnlyMortgage:function(n,t,i,r){var e,c,o,a,v;r=r||0;e=[];c=t/1200;n=n-r;var u=nbs.number.round(n*c),l=u,f=l,s=nbs.number.round(n-f+u),h=nbs.number.round(n-s);for(e.push({month:1,repayment:f+r,interest:u,capitalPaid:h,balance:s,accInterest:u}),o=1;o<i;o++)if(l=u,a=nbs.number.round(e[o-1].accInterest+u),v=e[o-1].balance,f=u,f=nbs.number.round(f,2),s=nbs.number.round(v-f+u),h=nbs.number.round(n-s),e.push({month:o+1,repayment:f,interest:u,capitalPaid:h,balance:s,accInterest:a}),h>=n)break;return e},simulateRepaymentMortgage:function(n,t,i,r,u,f){var c,l,v,e,o,s,a,h,y,p;if(r=r||0,u=u||0,f=f||0,c=[],l=t/1200,v=n*(l*Math.pow(1+l,i)/(Math.pow(1+l,i)-1)),v=nbs.number.round(v),n=n-r,e=nbs.number.round(n*l),o=v,o+=f>0?u:0,s=nbs.number.round(n-o+e),a=nbs.number.round(n-s),s<0&&(s=0),c.push({month:1,repayment:o+r,interest:e,capitalPaid:a,balance:s,accInterest:e}),a<n)for(h=1;h<i+1;h++)if(e=nbs.number.round(c[h-1].balance*l),y=nbs.number.round(c[h-1].accInterest+e),p=c[h-1].balance,o=v,h<f&&(o+=u),s+e<o,s=nbs.number.round(p-o+e),a=nbs.number.round(n-s),c.push({month:h+1,repayment:o,interest:e,capitalPaid:a,balance:s,accInterest:y}),a>=n)break;return c}};nbs.modules.SteppedForm=nbs.declare(nbs.modules._Base,{steppedFormName:"GenericSteppedForm",animationSpeed:600,initialise:function(n,t){this.inherited.apply(this,arguments);this.$steps=n.children("section.step");this.$content=this.$steps.children("div.stepContent");this.$continueButtons=this.$steps.find("input.nonlinear");this.stepCount=this.$steps.length;this.index=0;this.previousIndex=0;this.forms=[];this.isNonLinear=t.nonlinear||!1;this.$content.each(function(){$(this).hide().children().fadeTo(0,0)});this.isInEditMode=!1;this._bindEvents();var i=this;setTimeout(function(){i.toggle(0,!1)},1e3);this.hasRanStartStep=!1;this.hasRanFinalStep=!1},startup:function(){var n=this,i=this.$content.find("div.form:first"),t=[];this.$steps.find(".stepTitle h3").each(function(){$(this).attr("aria-hidden","true").find("a").on("click,keydown",function(n){n.preventDefault()})});this.$continueButtons.hide();i.each(function(i){var r=nbs.registry.get($(this));if(r){r.on("submit",function(t){t&&(n.isNonLinear?n.jumpToFirstIncomplete():n.toggle(i+1,!0))});t.push(r)}});this.forms=t},toggle:function(n,t){var i=this,r=n>this.index;this._close(r).pipe(function(){if(!r)for(var t=n+1;t<i.$steps.size();t++)i.isNonLinear||i.$steps.eq(t).removeClass("complete");return i.index=n,i._open(n)}).pipe(function(){t&&i._anchorWindow(n)})},_anchorWindow:function(n){nbs.util.defer(function(){nbs.dom.$window.scrollTop(this.$steps.eq(n).offset().top);this.$steps.eq(n).find("h3 a").focus()},this)},_bindEvents:function(){var n=this;this.$el.find("li.edit").each(function(t){$(this).children("a").click(function(i){i.preventDefault();n._editHandler(t)})});this.$steps.eq(0).find("input, select, .customRadio").on("focus",nbs.util.hitch(this,"_firstStepInputInteraction"))},_firstStepInputInteraction:function(){if(!this.hasRanStartStep){var n={pageName:"bw:tool:"+this.steppedFormName+":Step 1",eVar4:this.steppedFormName+"|Step 1",events:"event4"};this.hasRanStartStep=!0;nbs.analytics.send(n)}},_editHandler:function(n){this.isInEditMode=!0;n>this.index?this.forms[this.index].isValid()&&(this.previousIndex=this.index,this._updateVisibleActions(n,this.index),this.toggle(n,!0)):(this.previousIndex=this.index,this._updateVisibleActions(n,this.index),this.toggle(n,!0))},_updateVisibleActions:function(n,t){this.isNonLinear&&(this.$steps.eq(n).find("input.continue").hide(),this.$steps.eq(n).find("input.nonlinear").show(),this.$steps.eq(t).find("input.continue").show(),this.$steps.eq(t).find("input.nonlinear").hide())},jumpToFirstIncomplete:function(){var n=this.$steps.filter(":not(.complete, .open):first").index();this.toggle(n,!0)},_open:function(n){var i=new $.Deferred,t=this.$steps.eq(n),r=this.$content.eq(n),f=r.children(),u=t.find("ul.actions");return t.removeClass("complete").addClass("open"),this._setStepHeadingAriaHidden(n,!1),u.attr("aria-hidden","true"),this.isNonLinear&&(t.removeClass("visited"),t.hasClass("complete")&&u.attr("aria-hidden","false")),this.stepTitle=t.data("nbs-steptitle"),r.slideDown(function(){i.resolve()}),f.fadeTo(this.animationSpeed,1),this._analytics(n),i.promise()},_close:function(n){var i=new $.Deferred,t=this.$steps.eq(this.index),r=this.$content.eq(this.index),f=r.children(),e=t.find("ul.actions"),u;return t.removeClass("open"),t.removeClass("visited"),this._setStepHeadingAriaHidden(this.index,!0),this.isNonLinear&&this.index!==this.stepCount-1&&(t.addClass("visited"),this._setStepHeadingAriaHidden(this.index,!1)),u=this.$steps.filter(".open,.visited").filter(":last").index(),u>this.index&&this.isNonLinear&&(n=!0),n&&this.index!==this.stepCount-1&&(t.addClass("complete"),this._setStepHeadingAriaHidden(this.index,!1),e.attr("aria-hidden","false"),this.isNonLinear&&t.removeClass("visited")),r.slideUp(this.animationSpeed,function(){i.resolve()}),f.fadeTo(this.animationSpeed,0),i.promise()},_analytics:function(n){if(this.hasRanStartStep){var i=this.$steps.eq(n),t={pageName:"bw:tool:"+this.steppedFormName+":Step "+(n+1),eVar4:this.steppedFormName+"|Step "+(n+1)};n==this.stepCount-1&&(this.hasRanFinalStep||(t.events="event98"),t.pageName="bw:tool:"+this.steppedFormName+":Completed",t.eVar4=this.steppedFormName+"|Completed",this.hasRanFinalStep=!0);i.is(":visible")&&nbs.analytics.send(t)}},_setStepHeadingAriaHidden:function(n,t){var i=this.$steps.eq(n);i.find(".stepTitle h3").attr("aria-hidden",t?"true":"false")}});nbs.modules.CostOfMovingToolCommonFunctions=nbs.declare(nbs.modules._Base,{initialise:function(){this.inherited.apply(this,arguments)},CalculateAgentFee:function(){var t=this.StateAgentFeeIn.find(":checked").val(),n;this.SellingAmount.val()!=""&&(t=="percentage"?this.ChangeStringToNumber(this.SellingAmount)>0&&this.ChangeStringToNumber(this.SellingEstateAgentFees)>0?(n=this.ChangeStringToNumber(this.SellingAmount)/100*this.ChangeStringToNumber(this.SellingEstateAgentFees),this.HiddenCalculatedAgentFeeInPounds.val(n),this.PurpleBoxPanel.show(),this.estateAgentFeesPurpleBox.html(this.FormatNumber(n,"£")+" "+this.HiddenPurpleBoxText.val())):this.PurpleBoxPanel.hide():this.SellingAmount.val()!=""&&this.SellingEstateAgentFees.val()!=""?(n=this.ChangeStringToNumber(this.SellingEstateAgentFees)*100/this.ChangeStringToNumber(this.SellingAmount),this.HiddenCalculatedAgentFeeInPounds.val(this.ChangeStringToNumber(this.SellingEstateAgentFees)),this.PurpleBoxPanel.show(),this.estateAgentFeesPurpleBox.html(Number(parseFloat(n,"£").toFixed(2)).toString()+"% "+this.HiddenPurpleBoxText.val())):this.PurpleBoxPanel.hide())},CalculateOnResultPage:function(){var n=this.ChangeStringToNumber(this.HomeBuyerReport)+this.ChangeStringToNumber(this.MortgageValuationFee)+this.ChangeStringToNumber(this.MortgageFee)+this.ChangeStringToNumber(this.StampDuty)+this.ChangeStringToNumber(this.BuyingConveyancingFee),t=this.ChangeStringToNumber(this.EnergyPerformanceCertificate)+this.ChangeStringToNumber(this.RemovalCosts)+this.ChangeStringToNumber(this.EstateAgentFee)+this.ChangeStringToNumber(this.SellingConveyancingFee);return this.FormatNumber(n+t,"£")},JsonParams:function(n){var t={BuyingAmount:n.BuyingAmount==null?null:n.ChangeStringToNumber(n.BuyingAmount),BuyingMortgageValuationFee:n.BuyingMortgageValuationFee==null?null:n.ChangeStringToNumber(n.BuyingMortgageValuationFee),BuyingMortgageFees:n.BuyingMortgageFees==null?null:n.ChangeStringToNumber(n.BuyingMortgageFees),BuyingHomeBuyerReportFee:n.BuyingHomeBuyerReportFee==null?null:n.ChangeStringToNumber(n.BuyingHomeBuyerReportFee),BuyingPropertyType:n.BuyingPropertyType==null?null:n.BuyingPropertyType.find(":checked").val(),BuyingPropertyLocation:n.BuyingPropertyLocation==null?null:n.BuyingPropertyLocation.find(":checked").val(),FirstTimeBuyer:n.FirstTimeBuyer==null?null:n.FirstTimeBuyer.find(":checked").val(),SellingAmount:n.SellingAmount==null?null:n.ChangeStringToNumber(n.SellingAmount),SellingEstateAgentFees:n.HiddenCalculatedAgentFeeInPounds==null?null:n.HiddenCalculatedAgentFeeInPounds.val(),SellingEnergyPerformanceCertificate:n.SellingEnergyPerformanceCertificate==null?null:n.ChangeStringToNumber(n.SellingEnergyPerformanceCertificate),SellingRemovalCosts:n.SellingRemovalCosts==null?null:n.ChangeStringToNumber(n.SellingRemovalCosts),SellingPropertyType:n.SellingPropertyType==null?null:n.SellingPropertyType.find(":checked").val(),SellingPropertyLocation:n.SellingPropertyLocation==null?null:n.SellingPropertyLocation.find(":checked").val()};return JSON.stringify(t)},GetResultBuying:function(n){var t=JSON.parse(n.JsonParams(n));alert("SellingAmount "+t.SellingAmount+"\nSellingEstateAgentFees "+t.SellingEstateAgentFees+"\nSellingEnergyPerformanceCertificate "+t.SellingEnergyPerformanceCertificate+"\nBuyingAmount "+t.BuyingAmount+"\nBuyingMortgageValuationFee "+t.BuyingMortgageValuationFee+"\nBuyingMortgageFees "+t.BuyingMortgageFees);$.ajax({type:"GET",url:"/services/toolservice.svc/GetTotalBuyingAmount",data:{BuyingAmount:t.BuyingAmount,BuyingMortgageValuationFee:t.BuyingMortgageValuationFee,BuyingMortgageFees:t.BuyingMortgageFees,BuyingHomeBuyerReportFee:t.BuyingHomeBuyerReportFee,BuyingPropertyType:t.BuyingPropertyType,BuyingPropertyLocation:t.BuyingPropertyLocation,FirstTimeBuyer:t.FirstTimeBuyer},contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){var i=JSON.parse(t);n.lblResult.html(n.FormatNumber(i.TotalAmount,"£"));n.BuyingConveyancingFee.val(n.FormatNumber(i.BuyingConveyancingFee));n.StampDuty.val(n.FormatNumber(i.StampDuty));n.HomeBuyerReport.val(n.BuyingHomeBuyerReportFee.val());n.MortgageValuationFee.val(n.BuyingMortgageValuationFee.val());n.MortgageFee.val(n.BuyingMortgageFees.val());n.DepositText.html(n.HiddenPlusDepositText.val()+" "+n.FormatNumber(n.BuyingDepositAmount.val(),"£"));n.DepositText.show()},error:function(){}})},GetResultSelling:function(n){var t=JSON.parse(n.JsonParams(n));$.ajax({type:"GET",url:"/services/toolservice.svc/GetTotalSellingAmount",data:{SellingAmount:t.SellingAmount,SellingEstateAgentFees:t.SellingEstateAgentFees,SellingEnergyPerformanceCertificate:t.SellingEnergyPerformanceCertificate,SellingRemovalCosts:t.SellingRemovalCosts,SellingPropertyType:t.SellingPropertyType,SellingPropertyLocation:t.SellingPropertyLocation},contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){var i=JSON.parse(t);n.lblResult.html(n.FormatNumber(i.TotalAmount,"£"));n.SellingConveyancingFee.val(n.FormatNumber(i.SellingConveyancingFee));n.EnergyPerformanceCertificate.val(n.SellingEnergyPerformanceCertificate.val());n.RemovalCosts.val(n.SellingRemovalCosts.val());n.EstateAgentFee.val(n.FormatNumber(n.HiddenCalculatedAgentFeeInPounds.val()));n.DepositText.hide()},error:function(){}})},GetResultBuyingSelling:function(n){var t=JSON.parse(n.JsonParams(n));alert("SellingAmount "+t.SellingAmount+"\nSellingEstateAgentFees "+t.SellingEstateAgentFees+"\nSellingEnergyPerformanceCertificate "+t.SellingEnergyPerformanceCertificate+"\nBuyingAmount "+t.BuyingAmount+"\nBuyingMortgageValuationFee "+t.BuyingMortgageValuationFee+"\nBuyingMortgageFees "+t.BuyingMortgageFees);$.ajax({type:"GET",url:"/services/toolservice.svc/GetTotalByuingSellingAmount",data:{BuyingAmount:t.BuyingAmount,BuyingMortgageValuationFee:t.BuyingMortgageValuationFee,BuyingMortgageFees:t.BuyingMortgageFees,BuyingHomeBuyerReportFee:t.BuyingHomeBuyerReportFee,BuyingPropertyType:t.BuyingPropertyType,BuyingPropertyLocation:t.BuyingPropertyLocation,FirstTimeBuyer:t.FirstTimeBuyer,SellingAmount:t.SellingAmount,SellingEstateAgentFees:t.SellingEstateAgentFees,SellingEnergyPerformanceCertificate:t.SellingEnergyPerformanceCertificate,SellingRemovalCosts:t.SellingRemovalCosts,SellingPropertyType:t.SellingPropertyType,SellingPropertyLocation:t.SellingPropertyLocation},contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){var i=JSON.parse(t);n.lblResult.html(n.FormatNumber(i.TotalAmount,"£"));n.SellingConveyancingFee.val(n.FormatNumber(i.SellingConveyancingFee));n.BuyingConveyancingFee.val(n.FormatNumber(i.BuyingConveyancingFee));n.StampDuty.val(n.FormatNumber(i.StampDuty));n.EnergyPerformanceCertificate.val(n.SellingEnergyPerformanceCertificate.val());n.HomeBuyerReport.val(n.BuyingHomeBuyerReportFee.val());n.MortgageValuationFee.val(n.BuyingMortgageValuationFee.val());n.MortgageFee.val(n.BuyingMortgageFees.val());n.RemovalCosts.val(n.SellingRemovalCosts.val());n.EstateAgentFee.val(n.FormatNumber(n.HiddenCalculatedAgentFeeInPounds.val()));n.DepositText.html(n.HiddenPlusDepositText.val()+" "+n.FormatNumber(n.BuyingDepositAmount.val(),"£"));n.DepositText.show()},error:function(){}})},ChangeStringToNumber:function(n){return n==null||n.val()==""||n.val()=="£"?0:parseFloat(n.val().replace(/\,/g,"").replace("£","").replace("%",""))},FormatNumber:function(n,t){nStr=Number(parseFloat(n).toFixed(2)).toString();parseInt(nStr)==nStr&&(nStr=nStr+".00");x=nStr.split(".");x1=x[0];x2="."+x[1];x2.length==2&&(x2=x2+"0");for(var i=/(\d+)(\d{3})/;i.test(x1);)x1=x1.replace(i,"$1,$2");return t=="£"?"£"+x1+x2:x1+x2}});jQuery.fn.forceNumeric=function(){return this.each(function(){$(this).keydown(function(n){var t=n.which||n.keyCode;return!n.shiftKey&&!n.altKey&&!n.ctrlKey&&t>=48&&t<=57||t>=96&&t<=105||t==9||t==8?!0:!1})})};nbs.modules.AffordabilityCalcLite=nbs.declare(nbs.modules.SteppedForm,{steppedFormName:"Mso Mortgage Affordability Calculator",debug:!1,data:[],numberStrings:["first","second","third","fourth","fifth","sixth","seventh","eighth","ninth","tenth"],$currentTooltip:null,step1Initialised:!1,step2Initialised:!1,step3Initialised:!1,step4Initialised:!1,step5Initialised:!1,step6Initialised:!1,currentStepIndex:0,app1RetirementIncomeRequired:!1,app2RetirementIncomeRequired:!1,maxTerm:4e3,ltvMG:.95,ltvFA:.85,ltvRM:.9,maxNoOfOtherMortgages:6,newBuyStandard:"What is the(expected) purchase price",newBuySharedOrEquity:"What is the(expected) purchase price of your share",newBuyRightToBuy:"What is the(expected) discounted purchase price",expectedWord:" expected",expectedPlaceholder:"(expected)",remortgageSharedOrEquity:"What will be the estimated value of your share at completion",remortgageStandardOrRight:"What is the current estimated value",furtherShared:"What will be the estimated value of your share at completion",furtherEquity:"What is the estimated value of the share you currently own",furtherStandardOrRight:"What is the current estimated value",currentMarketValue:"What's the full market value of the place you've found",expectedMarketValue:"What's the expected full market value",timeTrading:"How long have you been in business",timeWithEmployer:" How long have you had your job",timeContracting:"How long have you been a contractor",timeRegular:"How long have you been in regular work",requiredMarkup:'<span class="nbr">?<\/span><span class="required" aria-label="This is a required field">*<\/span>',initialise:function(n){this.inherited.apply(this,arguments);this._intializeStep1();this.$errorList=$("#errorOverlay ol");this.$errorsTemplate=$("#errorsTemplate");this.$resultReqTerm=n.find(".resultArea span.requestedTerm");this.$resultAmount=n.find(".result_mortgage_amount");this.$resultReqLoanAmt=n.find(".termResult span.requestedLoanAmt");this.$resultTerm=n.find(".termResult span.minTermResult");this.$resultArea=n.find(".resultArea");this.$resultError=n.find(".resultError");this.$resultLoading=n.find(".resultLoading");this.$printCalcResults=n.find(".printCalcResults");this.$resultAreaZero=n.find(".resultAreaZero");n.find(".stepTitleInner h3 a").on("click,keydown",function(n){n.preventDefault()});n.find(".formActions .button.continue").click(nbs.util.hitch(this,"_handleNextStep"));n.find(".formActions .button.clear").click(nbs.util.hitch(this,"_handleResetStep"));var t=this;this.$el.find("li.edit").each(function(n){$(this).children("a").click(function(i){i.preventDefault();t._changeStep(n)})});this.$el.on("keypress","input[type=number]",function(n){return!(n.which>27&&n.which<48||n.which>57)});this.$el.on("keyup","input[data-maxlen]",function(){var n=$(this),t=n.data("maxlen");n.val().length>t&&n.val(n.val().slice(0,t))});this._bindTooltipHandlers();n.find(".initHidden").hide();nbs.dispatcher.on("window/resize",nbs.util.hitch(this,"_resizeHandler"))},startup:function(){this.inherited.apply(this,arguments);this.errorOverlay=nbs.registry.get("errorOverlay")},_generatePrintSummaryOfDataEntered:function(){var r,t,u,f,n,e,i;$(".printedSummary").remove();$(".resultsContainer").prepend("<table class='printedSummary'><caption>Based on the following details that you entered:<\/caption><\/table>");$("button.printCalcResults").closest(".toolSection").find(".formRow").each(function(){var o,s,h;n="<tr>";i=0;o=!1;s=!1;h=$(this).find("input[type=text],input[type=number],select :selected, div.radio.checked, input[type=checkbox]:checked, input[type=radio]:checked");e=h.size();i;h.each(function(){i++;var h,c;h=!1;c=!1;u=f="";$(this).is("option")?(t=$(this).text(),(t=="Please choose"||t=="Please select")&&(t="")):$(this).is("div.radio.checked")?t=$(this).find("label").text():$(this).is("input[type=radio]")?$(this).is(":checked")&&(t=$(this).next().text()):(t=$(this).val(),$(this).is("[name*='date_of_birth']")&&(h=!0),($(this).is("[name*='requested_term']")||$(this).is("[name*='time_in_employment']"))&&(c=!0));r=$(this).closest(".formRow").find(".label label").clone().children().remove().end().text();u=$(this).closest(".formRow").find(".prefix").text();$(this).parent().hasClass("yearsInput")&&(f=" years");t!=""&&(h||c?(h&&(o||(o=!0,n+="<th>"+r+"<\/th>"),i==1&&(n+="<td>"),n+=t,i<3&&(n+="/"),i==e&&(n+="<\/td>")),c&&(s||(s=!0,n+="<th>"+r+"<\/th>"),i==1&&(n+="<td>"),n+=t,i==1&&(n+=" years "),i==2&&(n+=" months "),i==e&&(n+="<\/td>"))):(n+="<th>"+r+"<\/th>",n+="<td>"+u+t+f+"<\/td>"))});n+="<\/tr>";n=n.replace(/<tr><\/tr>/g,"");$(".printedSummary").append(n)});this.$printCalcResults.on("click",function(){return window.print(),!1})},_intializeStep1:function(){this.step1Initialised||(this.$borrowerType=$("#borrower_type"),this.$borrowMore=$("#borrow_more_fields"),this.$requestedLoan=$("#required_loan"),this.$requestedLoanRow=this.$requestedLoan.closest(".formRow"),this.$outstandingBalance=$("#current_outstanding_balance"),this.$requestedTermYY=$("#requested_term_yy"),this.$requestedTermMM=$("#requested_term_mm"),this.$requestedTermRow=this.$requestedTermYY.closest(".formRow"),this.$foundPropertyRow=$("#have_found_property_row"),this.$foundProperty=this.$foundPropertyRow.find("input:radio"),this.$propertyOwnership=$("#property_ownership"),this.$soleOrJoint=this.$el.find("input[name=sole_or_joint]:radio"),this.$purchasePrice=$("#purchase_price"),this.$purchasePriceRow=this.$purchasePrice.closest(".formRow"),this.$marketValue=$("#market_value"),this.$marketValueRow=this.$marketValue.closest(".formRow"),this.$propertyDetails=$("#property_details"),this.$propertyFoundYes=$("input#have_found_property_yes"),this.$propertyDetails.hide().attr("aria-hidden",!0),this.$propertyTenure=$("#property_tenure"),this.$propertyTenureRow=this.$propertyTenure.closest(".formRow"),this.$propertyType=$("#property_type"),this.$propertyTypeRow=this.$propertyType.closest(".formRow"),this.$borrowerType.change(nbs.util.hitch(this,"_handleBorrowerTypeChange")),this.$propertyOwnership.change(nbs.util.hitch(this,"_handlePropertyOwnershipChange")),this.$foundProperty.change(nbs.util.hitch(this,"_handleFoundPropertyChange")),this.step1Initialised=!0)},_intializeStep2:function(){this.step2Initialised||(this.$mainDependents=$("#main_dependents"),this.$jointDependents=$("#joint_dependents"),this.$dependentTemplate=$("#dependent_template"),this.$mainPlannedRetireAge=$("#main_planned_retirement_age"),this.$mainPlannedRetireAgeRow=this.$mainPlannedRetireAge.closest(".formRow"),this.$jointPlannedRetireAge=$("#joint_planned_retirement_age"),this.$jointPlannedRetireAgeRow=this.$jointPlannedRetireAge.closest(".formRow"),this.$mainNoDependents=$("#main_no_of_dependants"),this.$jointNoDependents=$("#joint_no_of_dependants"),this.$mainAreRetired=this.$el.find("input[name=main_are_retired]:radio"),this.$jointAreRetired=this.$el.find("input[name=joint_are_retired]:radio"),this.$mainRetireAtStateAge=this.$el.find("input[name=main_retire_at_state_age]:radio"),this.$jointRetireAtStateAge=this.$el.find("input[name=joint_retire_at_state_age]:radio"),this.$mainNoDependents.change(nbs.util.hitch(this,"_handleMainDependentsChange")),this.$jointNoDependents.change(nbs.util.hitch(this,"_handleJointDependentsChange")),this.$mainAreRetired.change({section:"main_retirement_age_details",showValue:"No"},this._handleYesNoChange),this.$jointAreRetired.change({section:"joint_retirement_age_details",showValue:"No"},this._handleYesNoChange),this.$mainAreRetired.change({section:"main_retirement_bir",showValue:"Yes"},this._handleYesNoChange),this.$jointAreRetired.change({section:"joint_retirement_bir",showValue:"Yes"},this._handleYesNoChange),this.$mainRetireAtStateAge.change({section:this.$mainPlannedRetireAgeRow,showValue:"No"},this._handleYesNoChange),this.$jointRetireAtStateAge.change({section:this.$jointPlannedRetireAgeRow,showValue:"No"},this._handleYesNoChange),this.step2Initialised=!0);this._showOrHideJointSection("joint_app_personal_details")},_intializeStep3:function(){this.step3Initialised||(this.$mainEmploymentStatus=$("#main_first_job_employment_status"),this.$mainEmploymentSecondStatus=$("#main_second_job_employment_status"),this.$mainEmploymentContract=$("#main_first_employed_contract"),this.$mainEmploymentSecondContract=$("#main_second_employed_contract"),this.$mainEmploymentTax=this.$el.find("input[name=main_first_treated_as_employee_for_tax]:radio"),this.$mainEmploymentSecondTax=this.$el.find("input[name=main_second_treated_as_employee_for_tax]:radio"),this.$mainSecondJob=this.$el.find("input[name=main_have_second_employment]:radio"),this.$mainSecondRemainContractRow=$("#main_second_remaining_contract_yy").closest(".formRow"),this.$jointEmploymentStatus=$("#joint_first_job_employment_status"),this.$jointEmploymentSecondStatus=$("#joint_second_job_employment_status"),this.$jointEmploymentContract=$("#joint_first_employed_contract"),this.$jointEmploymentSecondContract=$("#joint_second_employed_contract"),this.$jointEmploymentTax=this.$el.find("input[name=joint_first_treated_as_employee_for_tax]:radio"),this.$jointEmploymentSecondTax=this.$el.find("input[name=joint_second_treated_as_employee_for_tax]:radio"),this.$jointSecondJob=this.$el.find("input[name=joint_have_second_employment]:radio"),this.$jointSecondRemainContractRow=$("#joint_second_remaining_contract_yy").closest(".formRow"),this.$mainEmploymentStatus.change(nbs.util.hitch(this,"_handleEmploymentStatusChange","main","first")),this.$mainEmploymentSecondStatus.change(nbs.util.hitch(this,"_handleEmploymentStatusChange","main","second")),this.$jointEmploymentStatus.change(nbs.util.hitch(this,"_handleEmploymentStatusChange","joint","first")),this.$jointEmploymentSecondStatus.change(nbs.util.hitch(this,"_handleEmploymentStatusChange","joint","second")),this.$mainEmploymentContract.change(nbs.util.hitch(this,"_handleEmploymentContractChange","main","first")),this.$mainEmploymentSecondContract.change(nbs.util.hitch(this,"_handleEmploymentContractChange","main","second")),this.$jointEmploymentContract.change(nbs.util.hitch(this,"_handleEmploymentContractChange","joint","first")),this.$jointEmploymentSecondContract.change(nbs.util.hitch(this,"_handleEmploymentContractChange","joint","second")),this.$mainEmploymentTax.change(nbs.util.hitch(this,"_handleTreatedAsEmployeeForTax","main","first")),this.$mainEmploymentSecondTax.change(nbs.util.hitch(this,"_handleTreatedAsEmployeeForTax","main","second")),this.$jointEmploymentTax.change(nbs.util.hitch(this,"_handleTreatedAsEmployeeForTax","joint","first")),this.$jointEmploymentSecondTax.change(nbs.util.hitch(this,"_handleTreatedAsEmployeeForTax","joint","second")),this.$mainSecondJob.change({section:"main_second_employment_details",showValue:"Yes"},this._handleYesNoChange),this.$jointSecondJob.change({section:"joint_second_employment_details",showValue:"Yes"},this._handleYesNoChange),this.step3Initialised=!0);this._showOrHideJointSection("joint_employment_income");this._checkRetiredEmploymentStatus()},_intializeStep4:function(){this.step4Initialised||(this.$mainHaveAddIncome=this.$el.find("input[name=main_have_additional_income]:radio"),this.$mainRetireIncomeDetails=$("#main_retire_income_details"),this.$jointHaveAddIncome=this.$el.find("input[name=joint_have_additional_income]:radio"),this.$jointRetireIncomeDetails=$("#joint_retire_income_details"),this.$mainHaveAddIncome.change({section:"main_additional_income_details",showValue:"Yes"},this._handleYesNoChange),this.$jointHaveAddIncome.change({section:"joint_additional_income_details",showValue:"Yes"},this._handleYesNoChange),this.step4Initialised=!0);this._showOrHideJointSection("joint_add_income_section");this.$mainEmploymentStatus.val()!=="R"&&this.app1RetirementIncomeRequired?this.$mainRetireIncomeDetails.show():this.$mainRetireIncomeDetails.hide();this.$mainEmploymentStatus.val()==="R"?(this._setFieldAsRequired("main_add_pension_income"),$("#main_have_additional_income_yes").prop("checked",!0).change()):this._setFieldAsUnrequired("main_add_pension_income");this._isJointApp()&&(this.$jointEmploymentStatus.val()!=="R"&&this.app2RetirementIncomeRequired?this.$jointRetireIncomeDetails.show():this.$jointRetireIncomeDetails.hide(),this.$jointEmploymentStatus.val()==="R"?(this._setFieldAsRequired("joint_add_pension_income"),$("#joint_have_additional_income_yes").prop("checked",!0).change()):this._setFieldAsUnrequired("joint_add_pension_income"))},_intializeStep5:function(){this.step5Initialised||(this.$mainDependentsCosts=$("#main_dependents_costs"),this.$jointDependentsCosts=$("#joint_dependents_costs"),this.step5Initialised=!0);this._showOrHideJointSection("joint_other_income_section");var t=parseInt(this.$mainNoDependents.val(),10),n;t>0?this.$mainDependentsCosts.show():this.$mainDependentsCosts.hide();this._isJointApp()&&(n=parseInt(this.$jointNoDependents.val(),10),n>0?this.$jointDependentsCosts.show():this.$jointDependentsCosts.hide())},_intializeStep6:function(){if(!this.step6Initialised){this.$propertyOutgoings=$("#property_outgoings_section");this.$buildingInsurance=$("#property_building_insurance");this.$buildingInsuranceRow=this.$buildingInsurance.closest(".formRow");this.$mainHaveMortgages=this.$el.find("input[name=main_do_you_have_other_mortgages]:radio");this.$jointHaveMortgages=this.$el.find("input[name=joint_do_you_have_other_mortgages]:radio");this.$howManyJointMortgages=$("#main_how_many_joint_mortgages");this.$howManyMainOtherMortgages=$("#main_how_many_other_mortgages");this.$howManyJointOtherMortgages=$("#joint_how_many_other_mortgages");this.$mainHaveMortgages.change({section:"main_app_other_mortgages",showValue:"Yes"},this._handleYesNoChange);this.$jointHaveMortgages.change({section:"joint_other_mortgages_details",showValue:"Yes"},this._handleYesNoChange);this.$howManyJointMortgages.change(nbs.util.hitch(this,"_handleHowManyJointMortgages"));this.$howManyMainOtherMortgages.change(nbs.util.hitch(this,"_handleHowManyOtherMortgages","main"));this.$howManyJointOtherMortgages.change(nbs.util.hitch(this,"_handleHowManyOtherMortgages","joint"));this.$mainJointMortgages=$("#main_joint_mortgages");this.$mainOtherMortgages=$("#main_other_mortgages");this.$jointOtherMortgages=$("#joint_other_mortgages");this.$mainJointMortgages.on("change","input:radio",this._handleOtherMortgageRadios);this.$mainOtherMortgages.on("change","input:radio",this._handleOtherMortgageRadios);this.$jointOtherMortgages.on("change","input:radio",this._handleOtherMortgageRadios);this.$otherMortgageTemplate=$("#other_mortgage_template");this.step6Initialised=!0}this._showOrHideJointSection("joint_other_mortgages_section");this._showOrHideJointSection("main_joint_mortgages_section");var n=this._getPropertyDetailsRequired();n?(this.$propertyOutgoings.show(),this.$propertyTenure.val()==="1"?(this.$buildingInsuranceRow.data("type","numberAllowZero"),this._enableField("property_ground_rent"),this._enableField("property_service_charge")):(this.$buildingInsuranceRow.data("type","number"),this._disableField("property_ground_rent"),this._disableField("property_service_charge")),this.$propertyOwnership.val()==="SO"?this._enableField("property_shared_ownership_rental"):this._disableField("property_shared_ownership_rental")):this.$propertyOutgoings.hide();this.$borrowerType.val()==="FA"?this._disableMortgageOption6():this._enableMortgageOption6()},_handleBorrowerTypeChange:function(){var n=this.$borrowerType.val();n==="RM"||n==="FA"?(this.$foundPropertyRow.hide(),this.$propertyDetails.show()):(this.$foundPropertyRow.show(),this.$foundProperty.filter(":checked").val()==="Yes"?this.$propertyDetails.show():this.$propertyDetails.hide());n==="FA"?this.$borrowMore.show():this.$borrowMore.hide();this.$purchasePriceRow.find("label").html(this._getPurchasePriceLabel())},_handlePropertyOwnershipChange:function(){var n=this.$propertyOwnership.val(),i=this.$foundProperty.filter(":checked").val(),t=this.currentMarketValue;n==="SD"||n===""?this._disableField("market_value"):(this._enableField("market_value"),i!=="Yes"&&(t=this.expectedMarketValue));this.$purchasePriceRow.find("label").html(this._getPurchasePriceLabel());this.$marketValueRow.find("label").html(t+this.requiredMarkup)},_handleFoundPropertyChange:function(){var n=this.$foundProperty.filter(":checked").val(),i=this.$borrowerType.val(),t=this.currentMarketValue;i==="MG"&&n==="Yes"?(this.$propertyDetails.show(),this.$propertyDetails.attr("aria-hidden",!1)):(this.$propertyDetails.hide(),this.$propertyDetails.attr("aria-hidden",!0));this.$propertyOwnership.val()!=="SD"&&n!=="Yes"&&(t=this.expectedMarketValue);this.$purchasePriceRow.find("label").html(this._getPurchasePriceLabel());this.$marketValueRow.find("label").html(t+this.requiredMarkup)},_handleMainDependentsChange:function(){var i=this.$mainNoDependents.val(),t=parseInt(i,10),r=this.$mainDependents.children(".formRow"),u=r.size(),f=[],n;if(i==""||t==0)this.$mainDependents.empty();else if(t<u)r.filter(function(n){return n>=t}).remove();else{for(n=u;n<t;n++)f.push({applicant:"main",num:n+1,person:this.numberStrings[n]});this.$dependentTemplate.tmpl(f).appendTo(this.$mainDependents)}},_handleJointDependentsChange:function(){var i=this.$jointNoDependents.val(),t=parseInt(i,10),r=this.$jointDependents.children(".formRow"),u=r.size(),f=[],n;if(i==""||t==0)this.$jointDependents.empty();else if(t<u)r.filter(function(n){return n>=t}).remove();else{for(n=u;n<t;n++)f.push({applicant:"joint",num:n+1,person:this.numberStrings[n]});this.$dependentTemplate.tmpl(f).appendTo(this.$jointDependents)}},_handleEmploymentStatusChange:function(n,t,i){var r=t+"_"+i,e=$("#"+r+"_job_employment_status").val(),s=$("#"+r+"_employed_contract").val(),u="",f=!0,o;this._enableField(r+"_time_in_employment_yy");i==="first"&&this._enableField(t+"_have_second_employment_yes");this._disableField(r+"_employed_contract");this._disableAllIncomeSections(r);this._disableField(r+"_remaining_contract_yy");switch(e){case"":f=!1;break;case"Y":u=r+"_director_salary_details";break;case"D":u=r+"_salary_details";break;case"P":u=r+"_share_profit_details";break;case"T":u=r+"_sole_profit_details";break;case"E":this._enableField(r+"_employed_contract");break;default:f=!1;i==="first"&&this._setApplicantToUnemployed(t,r)}u.length>0&&$("#"+u).show();f?$("#"+r+"_employed_details").show():$("#"+r+"_employed_details").hide();o=$("#"+r+"_time_in_employment_yy").closest(".formRow");o.find(".label label").html(this._getEmploymentTimeLabel(e,s))},_disableAllIncomeSections:function(n){$("#"+n+"_salary_details").hide();$("#"+n+"_director_salary_details").hide();$("#"+n+"_sole_profit_details").hide();$("#"+n+"_share_profit_details").hide()},_setApplicantToUnemployed:function(n,t){this._disableField(t+"_time_in_employment_yy");this._disableField(n+"_have_second_employment_yes")},_handleEmploymentContractChange:function(n,t,i){var r=t+"_"+i,u=$("#"+r+"_employed_contract").val(),o=$("#"+r+"_job_employment_status").val(),f=this.$el.find("input[name="+r+"_treated_as_employee_for_tax]:radio:checked"),e;this._disableAllIncomeSections(r);switch(u){case"":this._disableField(r+"_treated_as_employee_for_tax_yes");this._disableField(r+"_remaining_contract_yy");f.prop("checked",!1);break;case"SF":case"SE":this._enableField(r+"_treated_as_employee_for_tax_yes");u==="SF"?this._enableField(r+"_remaining_contract_yy"):this._disableField(r+"_remaining_contract_yy");f.val()==="Yes"?$("#"+r+"_salary_details").show():f.val()==="No"&&$("#"+r+"_sole_profit_details").show();break;default:this._disableField(r+"_treated_as_employee_for_tax_yes");u==="FC"?this._enableField(r+"_remaining_contract_yy"):this._disableField(r+"_remaining_contract_yy");f.prop("checked",!1);$("#"+r+"_salary_details").show()}e=$("#"+r+"_time_in_employment_yy").closest(".formRow");e.find(".label label").html(this._getEmploymentTimeLabel(o,u))},_handleTreatedAsEmployeeForTax:function(n,t,i){var r=t+"_"+i,u=this.$el.find("input[name="+r+"_treated_as_employee_for_tax]:radio:checked");u.val()==="Yes"?($("#"+r+"_sole_profit_details").hide(),$("#"+r+"_salary_details").show()):($("#"+r+"_sole_profit_details").show(),$("#"+r+"_salary_details").hide())},_handleMainDependentsChange:function(){var i=this.$mainNoDependents.val(),t=parseInt(i,10),r=this.$mainDependents.children(".formRow"),u=r.size(),f=[],n;if(i==""||t==0)this.$mainDependents.empty();else if(t<u)r.filter(function(n){return n>=t}).remove();else{for(n=u;n<t;n++)f.push({applicant:"main",num:n+1,person:this.numberStrings[n]});this.$dependentTemplate.tmpl(f).appendTo(this.$mainDependents)}},_handleHowManyJointMortgages:function(){var r=this.$howManyJointMortgages.val(),n=r===""?0:parseInt(r,10),u=this.$mainJointMortgages.children("section"),f=u.size(),e=[],t,o,s,i;if(n==0)this.$mainJointMortgages.empty();else if(n<f)u.filter(function(t){return t>=n}).remove();else{for(t=f;t<n;t++)o="Joint mortgage "+(t+1),e.push({title:o,applicant:"joint",num:t+1});this.$otherMortgageTemplate.tmpl(e).appendTo(this.$mainJointMortgages)}if(this._isJointApp())if(n==this.maxNoOfOtherMortgages)$("#main_other_mortgages_section").hide(),$("#joint_other_mortgages_section").hide();else for($("#main_other_mortgages_section").show(),$("#joint_other_mortgages_section").show(),$("#main_how_many_other_mortgages option").show(),$("#joint_how_many_other_mortgages option").show(),s=this.maxNoOfOtherMortgages-n,i=6;i>s;i--)$("#main_how_many_other_mortgages option[value="+i+"]").hide(),$("#joint_how_many_other_mortgages option[value="+i+"]").hide()},_handleHowManyOtherMortgages:function(n,t){var e=$("#"+t+"_how_many_other_mortgages").val(),r=e===""?0:parseInt(e,10),f=$("#"+t+"_other_mortgages"),o=f.children("section"),s=o.size(),h=[],c,i,a,u;if(r==0)f.empty();else if(r<s)o.filter(function(n){return n>=r}).remove();else{for(c=t==="main"?1:7,i=s;i<r;i++)h.push({title:this._getOtherMortgageTitle(t,i),applicant:"other",num:i+c});this.$otherMortgageTemplate.tmpl(h).appendTo(f)}if(this._isJointApp()){var v=this.$howManyMainOtherMortgages.val()===""?0:this.$howManyMainOtherMortgages.val(),y=this.$howManyJointOtherMortgages.val()===""?0:this.$howManyJointOtherMortgages.val(),l=Math.max(v,y);if(l==this.maxNoOfOtherMortgages)$("#main_joint_mortgages_section").hide();else for($("#main_joint_mortgages_section").show(),$("#main_how_many_joint_mortgages option").show(),a=this.maxNoOfOtherMortgages-l,u=6;u>a;u--)$("#main_how_many_joint_mortgages option[value="+u+"]").hide()}},_getOtherMortgageTitle:function(n,t){var i=t+1,r=n==="main"?"Other":"Joint applicant other";return r+" mortgage "+i},_handleOtherMortgageRadios:function(){var u=$(this).prop("id"),n=u.split("_")[0],t=u.split("_")[2],f=$("#"+n+"_mortgage_"+t+"_prop_let_yes"),i=$("#"+n+"_mortgage_"+t+"_ten_agree_yes"),r=$("#"+n+"_mortgage_"+t+"_let_fields");f.is(":checked")?(i.closest(".formRow").show(),i.is(":checked")?r.show():r.hide()):(i.closest(".formRow").hide(),r.hide())},_handleNextStep:function(n){n.preventDefault();var r=this.$steps.eq(this.currentStepIndex),i=r.find(".form"),t=this._validateForm(i);if(t){switch(this.currentStepIndex){case 0:t=this._step1Validation();break;case 1:t=this._step2Validation();break;case 2:t=this._step3Validation()}t&&(this.data[this.currentStepIndex]=this.formToData(i),this._initialiseNextStep(),this.currentStepIndex==5&&this._calculate(),this._changeStep(this.currentStepIndex+1,!0))}},_handleResetStep:function(n){n.preventDefault();var i=this.$steps.eq(this.currentStepIndex),t=i.find(".form"),r=t.find("input:not([type=radio])"),u=t.find("input[type=radio]"),f=t.find("select");r.val("");f.prop("selectedIndex",0).change();u.each(function(){$(this).data("default")==="checked"?$(this).prop("checked",!0).change():$(this).prop("checked",!1).change()});t.removeClass("errors");t.find(".formRow").removeClass("error");t.find(".field .iconInvalid, .field .errorMessage").remove();this.currentStepIndex==2&&this._checkRetiredEmploymentStatus()},_initialiseNextStep:function(){switch(this.currentStepIndex){case 0:this._intializeStep2();break;case 1:this._intializeStep3();break;case 2:this._intializeStep4();break;case 3:this._intializeStep5();break;case 4:this._intializeStep6()}},_changeStep:function(n){var t=this,u=this.$steps.eq(this.currentStepIndex),i=this.$steps.eq(n),f=i.find(".stepInner"),e=n>this.currentStepIndex,r;if(u.removeClass("open"),u.find(".stepContent").hide(),i.removeClass("complete").addClass("open"),i.find(".stepContent").show(),f.fadeTo(this.animationSpeed,1),t.isInEditMode||t._analytics(n),t.isInEditMode=!1,t.index=n,e)u.addClass("complete");else for(r=n+1;r<t.$steps.size();r++)t.$steps.eq(r).removeClass("complete");this.currentStepIndex=n;this._anchorToStep(i)},_anchorToStep:function(n){nbs.dom.$window.scrollTop(n.offset().top);n.find("h3 a").focus()},_enableField:function(n){var t=$("#"+n).closest(".formRow").show()},_disableField:function(n){var t=$("#"+n).closest(".formRow").hide()},_setFieldAsRequired:function(n){var t=$("#"+n).closest(".formRow");t.addClass("req");t.find(".required").show()},_setFieldAsUnrequired:function(n){var t=$("#"+n).closest(".formRow");t.removeClass("req");t.find(".required").hide()},_getYearsAndMonths:function(n){var t=$("#"+n+"_yy").val(),i=$("#"+n+"_mm").val();return t.length==0&&(t=0),i.length==0&&(i=0),parseInt(t,10)*100+parseInt(i,10)},_getDob:function(n){var t=$(n+"_d"),i=$(n+"_m"),r=$(n+"_y"),u;return t.size()>0&&i.size()>0&&r.size()>0&&(u=new Date(r.val(),i.val()-1,t.val())),u},_getDobString:function(n){var t=this._getDob(n);return t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear()},_getGender:function(n){return this.$el.find("input[name="+n+"_gender]:radio:checked").val()},_getAge:function(n){var t=new Date,i,r;return n&&(i=t.getFullYear()-n.getFullYear(),r=t.getMonth()-n.getMonth(),(r<0||r===0&&t.getDate()<n.getDate())&&i--),i},_isAgeError:function(n,t){var i=!1,r=$(n+"_d").closest(".formRow");return nbs.util.isDefined(t)&&(t<18||t>79)&&(i=!0,this._showRowError(r,"Please enter a valid date of birth")),i},_showRowError:function(n,t){var i=n.children(".field");n.addClass("error");i.append('<span data-icon="" class="icon iconInvalid" aria-label="Error"><span class="screenReaderText">Invalid<\/span><\/span>');i.append('<div class="errorMessage"><p>'+t+"<\/p><\/div>")},_isJointApp:function(){return this.$soleOrJoint.filter(":checked").val()==="joint"},_showOrHideJointSection:function(n){var t=$("#"+n);this._isJointApp()?t.show():t.hide()},_handleYesNoChange:function(n){var t=n.data.section,i=n.data.showValue;typeof t=="string"&&(t=$("#"+t));$(this).is(":checked")&&$(this).val()===i?t.show():t.hide()},_checkRetiredEmploymentStatus:function(){this.$mainAreRetired.filter(":checked").val()=="Yes"?(this.$mainEmploymentStatus.val("R").change(),this.$mainEmploymentStatus.find("[value='E'],[value='T'], [value='P'], [value='D'], [value='Y'], [value='H'], [value='L'], [value='Unemployed']").prop("disabled",!0),this.$mainEmploymentStatus.find("[value='R']").prop("disabled",!1)):(this.$mainEmploymentStatus.find("option[value='R']").prop("disabled",!1),this.$mainEmploymentStatus.val()=="R"&&this.$mainEmploymentStatus.val(""),this.$mainEmploymentStatus.find("[value='E'],[value='T'], [value='P'], [value='D'], [value='Y'], [value='H'], [value='L'], [value='Unemployed']").prop("disabled",!1),this.$mainEmploymentStatus.find("[value='R']").prop("disabled",!0));this._isJointApp()&&(this.$jointAreRetired.filter(":checked").val()=="Yes"?(this.$jointEmploymentStatus.val("R").change(),this.$jointEmploymentStatus.find("[value='E'],[value='T'], [value='P'], [value='D'], [value='Y'], [value='H'], [value='L'], [value='Unemployed']").prop("disabled",!0),this.$jointEmploymentStatus.find("[value='R']").prop("disabled",!1)):(this.$jointEmploymentStatus.find("option[value='R']").prop("disabled",!1),this.$jointEmploymentStatus.val()=="R"&&this.$jointEmploymentStatus.val(""),this.$jointEmploymentStatus.find("[value='E'],[value='T'], [value='P'], [value='D'], [value='Y'], [value='H'], [value='L'], [value='Unemployed']").prop("disabled",!1),this.$jointEmploymentStatus.find("[value='R']").prop("disabled",!0)))},_getRetirementIncomeRequired:function(n,t,i,r,u){$.ajax({type:"GET",global:!1,cache:!1,url:"/services/toolservice.svc/GetMortgageAffordabilityRetirementIncomeRequired",data:{dateOfBirth:t,gender:i,plannedRetirementAge:r,mortgageTerm:u},success:nbs.util.hitch(this,"_getRetirementIncomeRequiredSuccess",n),error:nbs.util.hitch(this,"_getRetirementIncomeRequiredError")})},_getRetirementIncomeRequiredSuccess:function(n,t,i,r){r=="main"?this.app1RetirementIncomeRequired=n.GetMortgageAffordabilityRetirementIncomeRequiredResult:r=="joint"&&(this.app2RetirementIncomeRequired=n.GetMortgageAffordabilityRetirementIncomeRequiredResult)},_getRetirementIncomeRequiredError:function(){},_getPurchasePriceLabel:function(){var r=this.$borrowerType.val(),n=this.$propertyOwnership.val(),u=this.$foundProperty.filter(":checked").val(),t=this.newBuyStandard,i=this.expectedWord;switch(r){case"":case"MG":t=n==="SD"||n===""?this.newBuyStandard:n==="SO"||n==="ES"?this.newBuySharedOrEquity:this.newBuyRightToBuy;u==="Yes"&&(i="");break;case"RM":t=n==="SO"||n==="ES"?this.remortgageSharedOrEquity:this.remortgageStandardOrRight;break;case"FA":t=n==="SO"?this.furtherShared:n==="ES"?this.furtherEquity:this.furtherStandardOrRight}return t=t.replace(this.expectedPlaceholder,i),t+this.requiredMarkup},_getEmploymentTimeLabel:function(n,t){var i="";switch(n){case"P":case"T":case"Y":i=this.timeTrading;break;case"D":i=this.timeWithEmployer;break;case"E":switch(t){case"SF":case"SE":case"FC":i=this.timeContracting;break;case"TP":i=this.timeRegular;break;default:i=this.timeWithEmployer}break;default:i=this.timeWithEmployer}return i+this.requiredMarkup},_getPropertyDetailsRequired:function(){var t=this.$foundProperty.filter(":checked").val(),i=this.$borrowerType.val(),n=!0;return i==="MG"&&t!=="Yes"&&(n=!1),n},_disableMortgageOption6:function(){$("#main_how_many_joint_mortgages option[value=6]").hide();$("#main_how_many_other_mortgages option[value=6]").hide();$("#joint_how_many_other_mortgages option[value=6]").hide();this.maxNoOfOtherMortgages=5},_enableMortgageOption6:function(){$("#main_how_many_joint_mortgages option[value=6]").show();$("#main_how_many_other_mortgages option[value=6]").show();$("#joint_how_many_other_mortgages option[value=6]").show();this.maxNoOfOtherMortgages=6},formToData:function(n){var i=n.find(".field:visible input:not([type=radio]), .field:visible input:radio:checked, .field:visible select"),t={};return i.each(function(){var n=$(this).attr("name"),i=$(this).val();t[n]=i}),t},_bindTooltipHandlers:function(){var n=this;this.$el.on("click",".formRow .label .help a",function(t){t.preventDefault();t.stopPropagation();n._showTooltip.apply(n,[$(this)])});if(nbs.has("touch"))nbs.dom.$document.on("touchend.tooltip",nbs.util.hitch(this,"_documentClickHandler"));else{this.$el.on("mouseenter focus",".formRow .label .help a",function(){n._showTooltip.apply(n,[$(this)])});this.$el.on("mouseleave blur",".formRow .label .help a",nbs.util.hitch(this,"_hideTooltip"))}},_showTooltip:function(n){var i=n.closest(".help"),t=i.find(".tooltipText").clone();this.$currentTooltip!==null&&this._hideTooltip();t.css({position:"absolute",display:"block"}).attr("role","tooltip");t.appendTo(nbs.dom.$body);this._positionTooltip(n,t);nbs.dom.redraw(t);this.$currentTooltip=t},_hideTooltip:function(){this.$currentTooltip!=null&&(this.$currentTooltip.remove(),this.$currentTooltip=null)},_positionTooltip:function(n,t){var c=this,i=n.offset(),u=n.height(),f=n.width(),e=t.height(),r=t.width(),o=i.left-r,l=i.top+e+u,s=i.left+r+f,h=nbs.dom.$window.width();t.addClass("below").css("top",i.top+u);s<=h?t.addClass("left").css("left",i.left):o>0?t.addClass("right").css("left",i.left-r):t.addClass("centre").css("left",i.left-r/2+f/2)},_documentClickHandler:function(n){this.$currentTooltip!==null&&nbs.dom.isTargetOutside(this.$currentTooltip,n)&&this._hideTooltip()},_resizeHandler:function(){this.$currentTooltip!==null&&this._hideTooltip()},_validateForm:function(n){var t=this,i=!0,r=n.find(".formRow:visible");return n.removeClass("errors"),n.find(".field .iconInvalid, .field .errorMessage").remove(),r.each(function(){var n=$(this),r=n.hasClass("req"),h=n.data("type"),e="Please enter a valid value",f=!1;n.removeClass("error");switch(h){case"number":var o=n.find("input").val(),u=parseFloat(o),s=o!="";f=r?s&&!isNaN(u)&&u>0:s?!isNaN(u)&&u>=0:!0;break;case"numberAllowZero":var o=n.find("input").val(),u=parseFloat(o),s=o!="";f=r?s&&!isNaN(u)&&u>=0:s?!isNaN(u)&&u>=0:!0;e="Please enter a valid value (zero is allowed)";break;case"select":f=r&&n.find("select").val().length>0||!r;e="Please select a value";break;case"radio":f=r&&n.find("input:checked").length>0||!r;e="Please select a value";break;case"date":f=t._validateDate(n,r);e="Please enter a valid date";break;case"yearsAndMonths":f=t._validateYearsAndMonths(n,r);e="Please enter valid years and months"}f||(t._showRowError(n,e),i=!1)}),i||n.addClass("errors"),i},_validateDate:function(n,t){var r=n.find(".day").val().toString(),u=n.find(".month").val().toString(),f=n.find(".year").val().toString(),o=r.length>0||u.length>0||f.length>0,e=!1,i;return r.length>0&&u.length>0&&f.length==4&&(i=new Date(f,u-1,r),e=i&&i.getFullYear()==Number(f)&&i.getFullYear()>1900&&i.getMonth()+1==Number(u)&&i.getDate()==Number(r)),t?o&&e:o?e:!0},_validateYearsAndMonths:function(n,t){var e=n.find("input"),o=!1,s=!1,u,f,i,r;return e.size()==2&&(u=e.eq(0).val(),f=e.eq(1).val(),(u.length||f.length)&&(o=!0,i=u.length==0?0:parseInt(u,10),r=f.length==0?0:parseInt(f,10),s=!isNaN(i)&&!isNaN(r)&&(i>0||r>0)&&i>=0&&i<100&&r>=0&&r<12)),t?o&&s:o?s:!0},_step1Validation:function(){var n=[],o=!0,t=this.$borrowerType.val(),i=nbs.number.parse(this.$requestedLoan.val()),r=i,l=nbs.number.parse(this.$marketValue.val()),a=nbs.number.parse(this.$outstandingBalance.val()),v=nbs.number.parse(this.$purchasePrice.val()),s=this.$propertyOwnership.val(),h=this._getYearsAndMonths("requested_term"),e=!1,u=!1,f=1,c;return h>this.maxTerm&&(e=!0,n.push("Sorry, Nationwide cannot offer any product with a term greater than 40 years.")),t==="FA"?(r=r+a,f=this.ltvFA,h>this._getYearsAndMonths("remaining_term_of_loan")&&(e=!0,n.push("Sorry, Nationwide cannot offer a Borrow More with a term greater than your existing agreement"))):f=t==="RM"?this.ltvRM:this.ltvMG,c=s==="ES"||s==="RB"?r/l:r/v,c>f&&(u=!0,n.push("Sorry, Nationwide does not offer greater than "+f*100+"% loan to value for the requested application type.")),t==="MG"||t==="FA"?(i<5e3||i>2e6)&&(u=!0,n.push("The requested loan must be between £5,000 and £2,000,000.")):t==="RM"&&(i<25e3||i>2e6)&&(u=!0,n.push("The requested loan must be between £25,000 and £2,000,000.")),e&&this._showRowError(this.$requestedTermRow,"Please enter a valid term"),u&&this._showRowError(this.$requestedLoanRow,"Please enter a valid loan amount"),n.length>0&&(this.$errorList.html(this.$errorsTemplate.tmpl({errors:n})),this.errorOverlay.show(),o=!1),o},_step2Validation:function(){var t=[],h=this.$requestedTermYY.val(),c=this.$soleOrJoint.filter(":checked").val()==="joint"?!0:!1,u=!0,y=this._getDob("#main_date_of_birth"),l=this._getAge(y),f=this.$mainAreRetired.filter(":checked").val()=="Yes",a=this.$mainRetireAtStateAge.filter(":checked").val()=="Yes",i=this.$mainPlannedRetireAge.val(),e=this._isAgeError("#main_date_of_birth",l),v,o,r,s,n;return i=f||a||i.length==0?0:i,!f&&!a&&i<=l&&(this._showRowError(this.$mainPlannedRetireAgeRow,"Please enter a valid planned retirement age"),t.push("Your planned retirement age must be greater than your age.")),c&&(v=this._getDob("#joint_date_of_birth"),o=this._getAge(v),r=this.$jointAreRetired.filter(":checked").val()=="Yes",s=this.$jointRetireAtStateAge.filter(":checked").val()=="Yes",e=this._isAgeError("#joint_date_of_birth",o)?!0:e,n=this.$jointPlannedRetireAge.val(),n=r||s||n.length==0?0:n,!r&&!s&&n<=o&&(this._showRowError(this.$jointPlannedRetireAgeRow,"Please enter a valid planned retirement age"),t.push("The planned retirement age for the joint applicant must be greater than their age."))),e&&t.push("Sorry, Nationwide does not offer mortgages to people under the age of 18 or over the age of 80. If one or more applicants are over 80 we are only able to lend if:<br/>a. They are an existing Nationwide borrower.<br/>b. They do not increase the loan amount.<br/>c. The term of the new loan is not greater than the current loan."),t.length>0&&(this.$errorList.html(this.$errorsTemplate.tmpl({errors:t})),this.errorOverlay.show(),u=!1),u&&(f?this.app1RetirementIncomeRequired=!1:this._getRetirementIncomeRequired("main",this._getDobString("#main_date_of_birth"),this._getGender("main"),i,h),c&&(r?this.app2RetirementIncomeRequired=!1:this._getRetirementIncomeRequired("joint",this._getDobString("#joint_date_of_birth"),this._getGender("joint"),n,h))),u},_step3Validation:function(){var n=[],t=!0,r=this._getYearsAndMonths("main_second_remaining_contract"),i;return r>5e3&&(this._showRowError(this.$mainSecondRemainContractRow,"Please enter a valid remaining term"),n.push("The maximum remaining contract is 50 years.")),this._isJointApp()&&(i=this._getYearsAndMonths("joint_second_remaining_contract"),i>5e3&&(this._showRowError(this.$jointSecondRemainContractRow,"Please enter a valid remaining term"),n.push("The maximum remaining contract is 50 years."))),n.length>0&&(this.$errorList.html(this.$errorsTemplate.tmpl({errors:n})),this.errorOverlay.show(),t=!1),t},_calculate:function(){for(var i=this.data,n={},t=0;t<i.length;t++)n=$.extend(!0,i[t],n);n.main_applicant_retirement_income_required=this.app1RetirementIncomeRequired;n.joint_applicant_retirement_income_required=this.app2RetirementIncomeRequired;this.$resultArea.hide();this.$resultError.hide();this.$resultLoading.show();$.ajax({type:"POST",url:"/services/toolservice.svc/GetMsoMortgageAffordability",data:n,success:nbs.util.hitch(this,"_calculateSuccess"),error:nbs.util.hitch(this,"_calculateError")})},_calculateSuccess:function(n){var t;if(this.$resultError.hide(),t=n.GetMsoMortgageAffordabilityResult,nbs.util.isDefined(t)&&t!=null&&t.MortgageMaxAmount!=null&&t.MortgageMinTerm!=null){var u=parseInt(t.MortgageMinTerm.substr(0,2),10),f=parseInt(t.MortgageMinTerm.substr(2,2),10),e=nbs.number.parse(this.$requestedLoan.val()),i=this.$requestedTermYY.val(),r=this.$requestedTermMM.val(),o=i.length>0?parseInt(i,10):0,s=r.length>0?parseInt(r,10):0;this.$resultReqTerm.html(o+" years and "+s+" months");this.$resultAmount.html("&pound;"+nbs.number.formatWithCommas(t.MortgageMaxAmount));this.$resultReqLoanAmt.html("&pound;"+nbs.number.formatWithCommas(e));this.$resultTerm.html(u+" years and "+f+" months");parseInt(t.MortgageMaxAmount)==0?(this.$resultArea.hide(),this.$resultAreaZero.fadeIn()):(this.$resultAreaZero.hide(),this.$resultArea.fadeIn())}else this.$resultError.fadeIn();this.$resultLoading.hide();$("button.printCalcResults").attr("aria-hidden",!1).attr("hidden",!1);this._generatePrintSummaryOfDataEntered()},_calculateError:function(){$("button.printCalcResults").attr("aria-hidden",!1).attr("hidden",!1);this.$resultLoading.hide();this.$resultError.fadeIn()}});nbs.modules.AffordabilityCalculator=nbs.declare(nbs.modules.SteppedForm,{steppedFormName:"Mortgage Affordability Calculator",initialise:function(n){this.inherited.apply(this,arguments);this.$deposit=n.find("#amount_of_deposit");this.$depositRow=this.$deposit.closest(".formRow");this.$purchasePrice=n.find("#purchase_price");this.$purchasePriceRow=this.$purchasePrice.closest(".formRow");this.$requiredLoan=n.find("#required_loan");this.$requiredLoanRow=this.$requiredLoan.closest(".formRow");n.find("#purchase_price, #required_loan").on("keyup",nbs.util.hitch(this,"_handlePurchaseLoanKeyUp"));this._setupDepositRow();this.$errorList=n.find("#errorOverlay ol");this.$errorsTemplate=n.find("#errorsTemplate");this.$result=n.find(".result");this.$resultArea=n.find(".resultArea");this.$resultError=n.find(".resultError");this.$resultLoading=n.find(".resultLoading")},_setupDepositRow:function(){this.$depositRow.hide();this.$depositRow.data("required",!1);this.$depositRow.append("<div><div class='label'><p>OR<\/p><\/div><\/div>");this.$deposit.on("keyup",nbs.util.hitch(this,"_handleDepositKeyUp"))},startup:function(){this.inherited.apply(this,arguments);this.forms[0].customFormValidationFunction=nbs.util.hitch(this,"_handleStep1CustomValidation");this.errorOverlay=nbs.registry.get("errorOverlay");this.borrowerType=nbs.registry.get("borrower_type_select");this.borrowerType.on("change",nbs.util.hitch(this,"_handleBorrowerTypeChange"));this.soleOrJoint=nbs.registry.get("sole_or_joint")},_handleDepositKeyUp:function(){var n=this.$deposit.val().length>0;this.$purchasePrice.prop("disabled",n);this.$purchasePriceRow.data("required",!n);this.$requiredLoan.prop("disabled",n);this.$requiredLoanRow.data("required",!n)},_handlePurchaseLoanKeyUp:function(){var n=this.$purchasePrice.val().length>0||this.$requiredLoan.val().length>0;this.$deposit.prop("disabled",n);this.$depositRow.is(":visible")&&this.$depositRow.data("required",!n)},_handleBorrowerTypeChange:function(n){n==="ftb"||n==="ncmh"||n==="ecmh"?this.$depositRow.slideDown(nbs.util.hitch(this,"_handlePurchaseLoanKeyUp")):(this.$depositRow.slideUp(),this.$deposit.val(""),this._handleDepositKeyUp(),this.$depositRow.data("required",!1))},_handleStep1CustomValidation:function(){var n=[],r=!0,o=this.soleOrJoint.getValue()==="joint"?!0:!1,p=this._getDob("#applicant_dob0"),u=this._getAge(p),f=this._isAgeError("#applicant_dob0",u),s,t,c,i;o&&(s=this._getDob("#applicant_dob1"),t=this._getAge(s),f=this._isAgeError("#applicant_dob1",t)?!0:f);f&&(n.push("Sorry, Nationwide does not offer mortgages to people under the age of 18 or over the age of 75. If one or more applicants are over 75 we are only able to lend if:<br/>a. They are an existing Nationwide borrower.<br/>b. They do not increase the loan amount.<br/>c. The term of the new loan is not greater than the current loan."),r=!1);var w=this.borrowerType.getValue(),h=this.$el.find("#required_loan"),e=nbs.number.parse(h.val()),b=nbs.number.parse(this.$el.find("#current_outstanding_balance").val()),k=nbs.number.parse(this.$el.find("#purchase_price").val());w==="ecbm"&&(e=e+b);c=e/k;c>=1&&(i=h.closest(".formRow"),i.removeClass("valid").addClass("error"),i.children(".field").children(".errorMessage").children("p").hide(),i.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),n.push("Sorry, Nationwide does not offer 100% LTV mortgages."),r=!1);n.length>0&&(this.$errorList.html(this.$errorsTemplate.tmpl({errors:n})),this.errorOverlay.show());var l=this.$el.find("#retirement_age0"),a=this.$el.find("#retirement_age1"),v=this.$el.find("#retirement_income0"),d=v.closest(".formRow").hide(),y=this.$el.find("#retirement_income1"),g=y.closest(".formRow").hide();return l.val()-u<=5&&u<l.val()?d.show():v.val(""),o&&(a.val()-t<=5&&t<a.val()?g.show():y.val("")),r},_isAgeError:function(n,t){var r=!1,i=this.$el.find(n+"_d").closest(".formRow");return nbs.util.isDefined(t)&&(t<18||t>75)&&(r=!0,i.removeClass("valid").addClass("error"),i.children(".field").children(".errorMessage").children("p").hide(),i.children(".field").children(".errorMessage").children("p[data-error-type=date]").show()),r},_getDob:function(n){var t=this.$el.find(n+"_d"),i=this.$el.find(n+"_m"),r=this.$el.find(n+"_y"),u;return t.size()>0&&i.size()>0&&r.size()>0&&(u=new Date(r.val(),i.val()-1,t.val())),u},_getAge:function(n){var t=new Date,i,r;return n&&(i=t.getFullYear()-n.getFullYear(),r=t.getMonth()-n.getMonth(),(r<0||r===0&&t.getDate()<n.getDate())&&i--),i},toggle:function(n){var t=arguments,i=this;n==this.stepCount-1&&this._calculate();this.inherited.apply(this,arguments)},_calculate:function(){for(var r,i=this.forms,n={},t=0,u=i.length;t<u;t++)r=i[t],n=$.extend(!0,r.serialise(!0),n);this.$resultArea.hide();this.$resultError.hide();this.$resultLoading.show();$.ajax({type:"POST",url:"/services/toolservice.svc/GetMortgageAffordability",data:n,success:nbs.util.hitch(this,"_calculateSuccess"),error:nbs.util.hitch(this,"_calculateError")})},_calculateSuccess:function(n){var t=n.GetMortgageAffordabilityResult;t==null||t=="null"||t=="undefined"?this.$resultError.fadeIn():(this.$result.html("&pound;"+nbs.number.formatWithCommas(t)),this.$resultArea.fadeIn());this.$resultLoading.hide()},_calculateError:function(){this.$resultError.fadeIn();this.$resultLoading.hide()}});nbs.modules.AnnuityForm=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$eligibilityform=n.find("#Eligibility");this.$pensionfunds=n.find("#PensionFunds");this.$hiddenno=n.find("#HiddenNo");this.$hiddencontent=n.find("#HiddenContent")},startup:function(){this.inherited.apply(this,arguments);this.$eligibilityform.find(".addtext").hide();typeof pagemode=="undefined"&&(this.$hiddenno.hide(),this.$hiddencontent.hide());$(".innerradio").bind("change",nbs.util.hitch(this,"_change"))},_change:function(){var n,t;this.$eligibilityform.find(".booleanNo").each(function(){var n=$(this).find(".innerradio");n.is(":checked")?n.closest(".formRow").next().show():n.closest(".formRow").next().hide()});n=!1;this.$pensionfunds.find(".booleanNo input[type=radio]:checked").length==this.$pensionfunds.find(".booleanNo input[type=radio]").length&&(n=!0);n?this.$hiddenno.show():typeof pagemode=="undefined"&&this.$hiddenno.hide();t=!1;this.$eligibilityform.find(".booleanYes input[type=radio]:checked").length==this.$eligibilityform.find(".booleanYes input[type=radio]").length&&this.$pensionfunds.find(".booleanYes input[type=radio]:checked").length>0&&(t=!0);t?this.$hiddencontent.show():typeof pagemode=="undefined"&&this.$hiddencontent.hide()}});nbs.modules.BranchFinder=nbs.declare(nbs.modules._Base,{locationData:[],currentLocation:null,searchProps:{contextData:{}},detailsProps:{contextData:{}},event4Fired:!1,event98Fired:!1,initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t},startup:function(){window._bingMapCallback=nbs.util.hitch(this,"_initMap");typeof Microsoft=="undefined"&&this._loadScript("https://www.bing.com/api/maps/mapcontrol?callback=_bingMapCallback",null);this.detailsOverlay=nbs.registry.get("detailsOverlay");var n=this;if(nbs.detect.isIe())this.detailsOverlay.on("hide",function(){n.$detailsMapArea.height("100%")});this.detailsOverlay.on("hide",function(){n.searchProps.linkTrackVars.charAt(0)===","&&(n.searchProps.linkTrackVars=n.searchProps.linkTrackVars.substring(1));(n.event4Fired||n.event98Fired)&&(delete n.searchProps.events,n.searchProps.linkTrackVars=n.searchProps.linkTrackVars.replace(",events",""),delete n.searchProps.linkTrackEvents);nbs.analytics.toolUsage(n.searchProps,null,!0)})},_loadScript:function(n,t){jQuery.ajax({url:n,dataType:"script",success:t,async:!0})},_initMap:function(){nbs.mapping.common.initialise(this.opts.region);this.mapClient=nbs.mapping.bingClientFactory.create();this._initSearch(this.$el);this._initDetails(this.$el);this.$activeForm=this.$addressForm},_initSearch:function(n){this.$addressForm=n.find(".addressSearch");this.$suggestionArea=n.find(".suggestionArea");this.$addressFormFields=n.find(".addressSearch input");this.$query=this.$addressForm.find("#query");this.$messageTemplate=n.find("#messageTemplate");this.$resultPane=n.find(".branchResults").hide();this.$mapArea=this.$resultPane.find(".mapInner");this.$resultList=n.find(".results");this.$addressResultsHeader=this.$resultPane.find(".addressResultsHeader");this.$prefixResultHeader=this.$resultPane.find(".prefixResultHeader").hide();this.map=nbs.mapping.mapExtensions.create(this.$mapArea[0],{});n.on("click",'.addressSearch button[type="submit"]',nbs.util.hitch(this,"_addressSearch"));this.$addressFormFields.keypress(nbs.util.hitch(this,"_handleAddressFormKeyPress"));this.$query.focus(nbs.util.hitch(this,"_handleAddressFormFocus"));this.$resultList.on("click","a.button",nbs.util.hitch(this,"_handleViewDetailsClick"));this.$addressForm.on("click","a.location",nbs.util.hitch(this,"_locationClicked"));this.$suggestionArea.on("click","a.location",nbs.util.hitch(this,"_locationClicked"))},_initDetails:function(n){var t=nbs.registry.get($.find("#detailsOverlay")),i,r,u;this.$detailsPane=t.$el.find(".branchFinderDetails");this.$detailsMapArea=t.$el.find(".map");this.$addressDetails=this.$detailsPane.find(".addressDetails");this.$facilities=this.$detailsPane.find(".branchFacilities");this.$openingTimes=this.$detailsPane.find(".openingTimes");this.$searchbox=t.$el.find("#query");t.$el.find("#query").focus(function(){$(this).val()});this.$addressTemplate=n.find("#addressTemplate");this.$facilitiesTemplate=n.find("#branchFacilitesTemplate");this.$openingTimesTemplate=n.find("#openingTimesTemplate");i={showDashboard:!1,showScalebar:!1};this.detailsMap=nbs.mapping.mapExtensions.create(this.$detailsMapArea[0],i);this.$detailsPane.find("a.directionsLink").click(nbs.util.hitch(this,"_handleDirectionsClick"));r=!0;u=this;r===!0&&navigator.geolocation&&this.$addressFormFields.val()==""&&nbs.isMobile()&&this._geolocate(this)},_geolocate:function(n){function t(t){n.mapClient.geocodePoint(t.coords.latitude+","+t.coords.longitude,nbs.util.hitch(n,"_populateSearch"))}navigator.geolocation.getCurrentPosition(t)},_switchSearchMode:function(n){n.preventDefault();var t=this,i=500;this.$activeForm===this.$addressForm&&this.$addressForm.fadeTo(i,0,function(){t.$addressForm.hide();t.$prefixForm.show();t.$prefixForm.fadeTo(i,1);t.$activeForm=t.$prefixForm})},_handleDirectionsClick:function(n){n.preventDefault();var i=this.currentLocation,t=this._formatBranchAddress(i);nbs.detect.isIos()?this._openAppleDirections(t):nbs.detect.isAndroid()?this._openGoogleDirections(t):this._openBingDirections(i,t);nbs.analytics.toolUsage(this.detailsProps,"branch finder – view details")},_openBingDirections:function(n,t){var i="http://bing.com/maps/default.aspx?rtp=~pos.{lat}_{long}_{address}";i=i.replace("{lat}",n.Latitude);i=i.replace("{long}",n.Longitude);i=i.replace("{address}",t);window.open(i,"_blank")},_openAppleDirections:function(n){var t="http://maps.apple.com/?daddr="+n;window.location=t},_openGoogleDirections:function(n){var t="http://maps.google.com/?daddr="+n;window.location=t},_handleAddressFormKeyPress:function(n){n.which===13&&this._addressSearch(n)},_handlePrefixFormKeyPress:function(n){n.which===13&&this._prefixSearch(n)},_handleAddressFormFocus:function(){this.$query.val("")},_handleViewDetailsClick:function(n){var u,f;n.preventDefault();var r=$(n.target),i=r.data("index"),t=this.currentLocation=this.locationData[i];this.$addressTemplate.tmpl(t).appendTo(this.$addressDetails.empty());this.$openingTimesTemplate.tmpl(t).appendTo(this.$openingTimes.empty());this.$facilitiesTemplate.tmpl(t).appendTo(this.$facilities.empty());this.detailsMap.clearPushpins();this.detailsMap.createPushpins([t]);this.detailsMap.zoomToPins();this.detailsOverlay.show();this.$detailsPane.focus();this.$detailsPane.find("a.hideOverlay").click(function(){$(".branchResults a.button:eq("+i+")").focus()});nbs.detect.isIe()&&(u=this.$detailsMapArea[0].clientHeight+1,this.$detailsMapArea.height(u));this.detailsProps.linkTrackVars="";f=r.clone().find("span").remove().end().text().trim();nbs.cookie.create("navigation","bfinder|{0}|{1}".format(f,i+1),!1);this.detailsProps.pageName="bw:lightbox:branch finder:branch details";this.detailsProps.contextData["nbs_branch_finder.nbs_branch_details_prefix"]=t.prefixFormatted;this.detailsProps.contextData["nbs_branch_finder.nbs_branch_details_address"]=t.AddressLine;this.detailsProps.contextData["nbs_branch_finder.nbs_branch_details_name"]=t.entityType==="atm"?"Cash machine details":"Nationwide "+t.town;this.detailsProps.linkTrackVars+=",pageName";this.detailsProps.linkTrackVars+=",contextData.nbs_branch_finder.nbs_branch_details_prefix";this.detailsProps.linkTrackVars+=",contextData.nbs_branch_finder.nbs_branch_details_address";this.detailsProps.linkTrackVars+=",contextData.nbs_branch_finder.nbs_branch_details_name";this.detailsProps.linkTrackVars.charAt(0)===","&&(this.detailsProps.linkTrackVars=this.detailsProps.linkTrackVars.substring(1));nbs.analytics.toolUsage(this.detailsProps,null,!0)},_prefixSearch:function(n){n.preventDefault();delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_street"];delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_town"];delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_postcode"];delete this.searchProps.contextData["nbs_branch_finder.nbs_search_opt_branch"];delete this.searchProps.contextData["nbs_branch_finder.nbs_search_opt_cash"];delete this.searchProps.contextData["nbs_branch_finder.nbs_first_result_prefix"];delete this.searchProps.contextData["nbs_branch_finder.nbs_first_result_address"];delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_suggested"];this.event4Fired?this.searchProps.events=this.searchProps.linkTrackVars=this.searchProps.linkTrackEvents="":(this.searchProps.events="event4",this.searchProps.linkTrackVars="events",this.searchProps.linkTrackEvents=this.searchProps.events);this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_prefix"]="prefix:y";this.searchProps.linkTrackVars+=",contextData.nbs_branch_finder.nbs_search_crit_prefix";this.searchProps.pageName="bw:tool:branch finder:prefix search results";this.searchProps.linkTrackVars+=",pageName";this.$prefix.val().length===0?(this.searchProps.contextData["nbs_error.nbs_error_type"]="user",this._showError("Please enter a prefix.")):(this._hideError(),this._clearResults(),this.mapClient.findByPrefix(this.$prefix.val(),nbs.util.hitch(this,"_findByPrefixResults")))},_findByPrefixResults:function(n,t){if(t)if(n){this.locationData=[n];this.map.createPushpins([n]);this.map.zoomToPins();this.$resultPane.slideDown();this._updateResults([n]);var i=$(".branchResults").find("div.suggestionArea").empty()}else this._noResults();else this.searchProps.contextData["nbs_error.nbs_error_type"]="sys",this._showError(nbs.mapping.common.serviceError,!0)},_addressSearch:function(n,t){n.preventDefault();$(".branchResults .results li").removeClass("highlight");this.query=this.$query.val().replace(/-/g," ");this.query=$.trim(this.query.replace(/([^A-Za-z0-9\ ,\ '\/\ .])/gi,""));t&&(this.query=t);var r=this.$activeForm.find(".messageArea").empty(),i=nbs.mapping.common.noExactMatchesFound;i=i.replace("{searchPhrase}",$.trim(this.query));delete this.searchProps.contextData["nbs_branch_finder.nbs_first_result_address"];delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_suggested"];this.searchProps.pageName="bw:tool:branch finder:address search results";this.event4Fired?this.searchProps.events=this.searchProps.linkTrackVars=this.searchProps.linkTrackEvents="":(this.searchProps.events="event4",this.searchProps.linkTrackVars="events",this.searchProps.linkTrackEvents=this.searchProps.events);this.searchProps.linkTrackVars+=",pageName";this.searchProps.linkTrackVars+=",contextData.nbs_branch_finder.nbs_search_crit_query";this.query!==""?(this.map.clearPushpins(),this._hideError(),this._clearResults(),this.mapClient.geocode(this.query,nbs.util.hitch(this,"_addressGeocodeResults"))):(this.searchProps.contextData["nbs_error.nbs_error_type"]="user",this._showError(nbs.mapping.common.noDataFound,!0))},_noResults:function(){this.searchProps.contextData["nbs_error.nbs_error_type"]="user";this._showError(nbs.mapping.common.noDataFound,!0);this.map.clearPushpins();this._clearResults();this.$resultPane.slideUp()},_noExactResults:function(){var t=this.$query.val(),n=nbs.mapping.common.noExactDataFound;n=n.replace("{searchPhrase}",$.trim(t));this._showError(n,!0);this.map.clearPushpins();this._clearResults();this.$resultPane.slideUp()},_otherResults:function(n){var u=$(".branchResults").find("div.suggestionArea").empty(),t,r;for(this._hideError(),t='<h3 class="resultsHeader resultsSuggestion">Not near where you wanted? Maybe one of these places is.<\/h3><ul class="listStyle02">',r=[],r.push(n[0].name),i=1;i<n.length;i++)r.indexOf(n[i].name)===-1&&(t=t+'<li><a href="#" class="location arrowLink" data-latitude="'+n[i].latitude+'" data-longitude="'+n[i].longitude+'">'+n[i].name+"<\/a><\/li>",r.push(n[i].name));t=t+"<\/ul>";r.length>1&&u.html(t).show()},_populateSearch:function(n,t){t&&(this.$query=this.$addressForm.find("#query"),this.$query.val(n.locations[0].formattedAddress))},_addressGeocodeResults:function(n,t){var r,i;t?(r=this.$activeForm.find("div.suggestionArea").empty().hide(),this.queryNoUk=$.trim(this.query.replace(", united kingdom","")),this.queryNoUk=$.trim(this.$query.val().replace(/([^0-9])/gi,"")),this.query===", united kingdom"?(this.searchProps.contextData["nbs_error.nbs_error_type"]="user",this._showError(nbs.mapping.common.addressDataError,!0),this.map.clearPushpins(),this._clearResults(),this.$resultPane.slideUp()):this.queryNoUk.length===4?this.mapClient.findByPrefix(this.queryNoUk,nbs.util.hitch(this,"_findByPrefixResults")):n&&n.locations.length>0?n.hasExactResult()?(i=n.locations[0],this._findNearby(i),$(".branchResults").find("div.suggestionArea").empty(),n.hasOtherResults()&&this._otherResults(n.locations)):this._noExactResults():this._noResults()):(this.searchProps.contextData["nbs_error.nbs_error_type"]="sys",this._showError(nbs.mapping.common.serviceError,!0))},_findNearby:function(n){var t="yes",i="no";this._hideError();this.filtersAvailable&&(t=this.$branchOption.is(":checked")?"yes":"no",i=this.$atmOption.is(":checked")?"yes":"no");this.mapClient.findNearby(n.latitude,n.longitude,5,{atm:i,branch:t},nbs.util.hitch(this,"_findNearbyResults"))},_findNearbyResults:function(n,t){t?n&&n.locations&&n.locations.length>0?(this.locationData=n.locations,this.map.createPushpins(n.locations),this._showResultsAndZoomToPins(),this._updateResults(n.locations)):this._noResults():(this.searchProps.contextData["nbs_error.nbs_error_type"]="sys",this._showError(nbs.mapping.common.serviceError,!0))},_clearResults:function(){this.$activeForm===this.$addressForm?(this.$addressResultsHeader.show(),this.$prefixResultHeader.hide()):(this.$addressResultsHeader.hide(),this.$prefixResultHeader.show());this.map.clearPushpins();this.$resultList.find("li").hide()},_showResultsAndZoomToPins:function(){function t(){nbs.viewport.isElementInView($(".map"))||$("html, body").animate({scrollTop:$(".branchResults").offset().top},{duration:500,complete:function(){$("#skipToResultsList").focus()}})}var n=this,i=this.$resultPane.is(":visible");i?(this.map.zoomToPins(),t()):this.$resultPane.slideDown(function(){nbs.util.defer(n.map.zoomToPins,n,500);n._hideError();nbs.detect.isIe()&&n.$mapArea.height(301);t()})},_showDisambiguation:function(n){var i=this.$activeForm.find(".messageArea").empty(),r=this.$street.val()+" "+this.$town.val()+" "+this.$postCode.val(),t=nbs.mapping.common.noExactMatchesFound;t=t.replace("{searchPhrase}",$.trim(r));this.$messageTemplate.tmpl({message:t,locations:n.locations}).appendTo(i);i.show();this.searchProps.linkTrackVars+=",pageName";this.searchProps.contextData["nbs_error.nbs_error_type"]="user";this.searchProps.contextData["nbs_error.nbs_error_description"]="branch_finder";this.searchProps.contextData["nbs_error.nbs_error_text"]=t;this.searchProps.linkTrackVars+=",contextData.nbs_error.nbs_error_type";this.searchProps.linkTrackVars+=",contextData.nbs_error.nbs_error_description";this.searchProps.linkTrackVars+=",contextData.nbs_error.nbs_error_text";this.searchProps.linkTrackVars.charAt(0)===","&&(this.searchProps.linkTrackVars=this.searchProps.linkTrackVars.substring(1));nbs.analytics.toolUsage(this.searchProps,null,!0);this.event4Fired=!0;delete this.searchProps.contextData["nbs_error.nbs_error_type"];delete this.searchProps.contextData["nbs_error.nbs_error_description"];delete this.searchProps.contextData["nbs_error.nbs_error_text"]},_locationClicked:function(n){n.preventDefault();this.map.clearPushpins();var t=$(n.currentTarget),i=t.data("latitude"),r=t.data("longitude"),u=t.text();i&&r&&(delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_street"],delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_town"],delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_postcode"],delete this.searchProps.contextData["nbs_branch_finder.nbs_search_opt_branch"],delete this.searchProps.contextData["nbs_branch_finder.nbs_search_opt_cash"],delete this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_suggested"],this.searchProps.pageName="bw:tool:branch finder:suggested search results",this.searchProps.contextData["nbs_branch_finder.nbs_search_crit_suggested"]=u,this.searchProps.linkTrackVars="contextData.nbs_branch_finder.nbs_search_crit_suggested",this._findNearby({latitude:i,longitude:r}),this.$resultPane.slideDown(function(){}))},_formatBranchAddress:function(n){var t="";return!n.branch&&n.outlet&&(t+=n.outlet+", "),t+(n.street+", "+n.town+", "+n.pc)},_updateResults:function(n){for(var i,t,u=this.$resultList.find("li").hide(),r=0;r<n.length;r++)i=u.eq(r).show(),t=n[r],i.children(".address").html(this._formatBranchAddress(t)),t.branch?i.children("a.button").children(".srText").html("for "+t.town+" branch at "+t.street):i.children("a.button").children(".srText").html("for cash machine at "+t.street+", "+t.town),t.closed?(i.children(".branchClosure").show(),i.find(".closureDetails").html(t.closureText)):(i.children(".branchClosure").hide(),i.find(".closureDetails").empty());this.searchProps.contextData["nbs_branch_finder.nbs_first_result_prefix"]=n[0].prefixFormatted;this.searchProps.contextData["nbs_branch_finder.nbs_first_result_address"]=this._formatBranchAddress(n[0]);this.event4Fired&&(this.searchProps.events=this.searchProps.linkTrackVars=this.searchProps.linkTrackEvents="");this.event98Fired?this.searchProps.events=this.searchProps.linkTrackVars=this.searchProps.linkTrackEvents="":(this.searchProps.events+=",event98",this.searchProps.linkTrackVars+=",events",this.searchProps.linkTrackEvents=this.searchProps.events);this.searchProps.linkTrackVars+=",pageName";this.searchProps.linkTrackVars+=",contextData.nbs_branch_finder.nbs_first_result_prefix";this.searchProps.linkTrackVars+=",contextData.nbs_branch_finder.nbs_first_result_address";this.searchProps.linkTrackVars.charAt(0)===","&&(this.searchProps.linkTrackVars=this.searchProps.linkTrackVars.substring(1));this.searchProps.events.charAt(0)===","&&(this.searchProps.events=this.searchProps.events.substring(1));nbs.analytics.toolUsage(this.searchProps,null,!0);this.event4Fired=!0;this.event98Fired=!0},_showError:function(n,t){var i=this.$activeForm.find(".messageArea").empty();this.$messageTemplate.tmpl({message:n,showErrorIcon:!0}).appendTo(i);i.show();this.searchProps.contextData["nbs_error.nbs_error_description"]="branch_finder";this.searchProps.contextData["nbs_error.nbs_error_text"]=n;this.searchProps.linkTrackVars+=",contextData.nbs_error.nbs_error_type";this.searchProps.linkTrackVars+=",contextData.nbs_error.nbs_error_description";this.searchProps.linkTrackVars+=",contextData.nbs_error.nbs_error_text";this.searchProps.linkTrackVars.charAt(0)===","&&(this.searchProps.linkTrackVars=this.searchProps.linkTrackVars.substring(1));nbs.analytics.toolUsage(this.searchProps,null,!0);this.event4Fired=!0;delete this.searchProps.contextData["nbs_error.nbs_error_type"];delete this.searchProps.contextData["nbs_error.nbs_error_description"];delete this.searchProps.contextData["nbs_error.nbs_error_text"];t&&this.map.resetView()},_hideError:function(){this.$activeForm.find(".messageArea").hide()}});nbs.modules.BrowserCheckup=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);var i=n.find("#javascriptTest"),r=n.find(".secureTestRow"),u=n.find(".imagesTestRow"),f=n.find("#imagesTest"),t=new Image,e=new Date,o=e.getTime();i.html("<strong>Yes<\/strong>");r.show();u.show();t.alt="Yes";t.src="/assets/main-site/images/content/troubleyes.gif?"+o;t.onload=function(){f.html("<strong>Yes<\/strong>")}}});$(document).ready(function(){(function(){function f(t){return n="",n+=t=="invalid"?'<span class="icon iconInvalid" data-icon="&#xe009;" aria-label="Error"><span class="screenReaderText">Invalid<\/span><\/span>':'<span class="icon iconValid" data-icon="&#xe00f;" aria-label="Error"><span class="screenReaderText">Valid<\/span><\/span>'}function s(){i=0;r=0;$("#monthlyIncomeInputs input").each(function(){$(this).closest(".formRow").removeClass("error");$(this).closest(".formRow").removeClass("valid");$(this).closest(".formRow").find("span.icon").remove();$(this).closest(".formRow").find("div.errorMessage").remove();$(this).val()!=""&&(r=parseFloat($(this).val()),isNaN(r)?(f("invalid"),$(this).closest(".formRow").addClass("error")):(i+=r,f("valid"),$(this).closest(".formRow").addClass("valid")),$(this).after(n))});$("#Totalincome").val(i)}function h(){t=0;u=0;$("#monthlyOutgoingInputs input").each(function(){$(this).closest(".formRow").removeClass("error");$(this).closest(".formRow").removeClass("valid");$(this).closest(".formRow").find("span.icon").remove();$(this).closest(".formRow").find("div.errorMessage").remove();$(this).val()!=""&&(u=parseFloat($(this).val()),isNaN(u)?(f("invalid"),$(this).closest(".formRow").addClass("error")):(t+=u,f("valid"),$(this).closest(".formRow").addClass("valid")),$(this).after(n))});$("#Totaloutgoings").val(t)}function o(){return e=i-t,isNaN(e)||$("#DisposableIncome").val(e),!1}var i,t,e,r,u,n;t=0;$("#monthlyIncomeInputs input").bind("keyup blur",function(){s();o()});$("#monthlyOutgoingInputs input").bind("keyup blur",function(){h();o()});$("#budgetCalcForm input").bind("focus",function(){$(this).select()})})()});nbs.modules.BudgetPlanner=nbs.declare(nbs.modules.SteppedForm,{steppedFormName:"Budget Planner",barChart:null,doughnutChart:null,stageIndex:0,stageData:null,initialised:!1,colours:["#9F1C34","#EC7225","#73AF56","#AD98C8","#833A96"],coloursHover:["#B8354D","#FF8B3E","#8CC86F","#C6B1E1","#9C53AF"],barChartOptions:{responsive:!1,maintainAspectRadio:!0,tooltipTemplate:"<%if (label){%><%=label%> <%}%><%= value %>%",legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].lineColor%>"><\/span><%if(datasets[i].label){%><%=datasets[i].label%><%}%><\/li><%}%><\/ul>',showYAxisTitle:!0,YAxisFontSize:12,YAxisFontStyle:"normal",YAxisFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",YAxisFontColor:"#666",YAxisTitle:"% of overall spending",YAxisTitleTopPadding:75,YAxisTitleSpacing:8,YAxisTitleWidth:0},doughnutChartOptions:{responsive:!1,maintainAspectRadio:!0,tooltipTemplate:"<%if (label){%><%=label%> <%}%><%= value %>%",legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<segments.length; i++){%><li><span style="display:inline-block;width:40px;height:40px;border-radius:10px;margin-right:2px;background-color:<%=segments[i].fillColor%>"><\/span><%if(segments[i].label){%><span><%=segments[i].label%><br /><strong>&pound;<%=segments[i].costamount%><\/strong><\/span><%}%><\/li><%}%><\/ul>'},incomeTotals:0,householdTotals:0,insuranceTotals:0,familyTotals:0,travelTotals:0,reviewExpenses:0,reviewTotals:0,stepSectionTotals:0,incomeSectionHeading:"",householdSectionHeading:"",insuranceSectionHeading:"",familySectionHeading:"",travelSectionHeading:"",strToolOutcomeValue:"",jStorageSessionTimeout:2592e6,initialise:function(n){this.inherited.apply(this,arguments);this.defaultErrorMsg=this.$el.find(".formActions .validationMessage").html();$("p.requiredMessage").hide();this.$incomeResultHeader=this.$(".step").eq(0);this.$incomeResultHeader.find(".actions").prepend('<li class="stepValue">&pound;<span id="Income_Totals">0<\/span> p/m<\/li>');this.$houseHoldResultHeader=this.$(".step").eq(1);this.$houseHoldResultHeader.find(".actions").prepend('<li class="stepValue">&pound;<span id="HouseHold_Totals">0<\/span> p/m<\/li>');this.$insuranceResultHeader=this.$(".step").eq(2);this.$insuranceResultHeader.find(".actions").prepend('<li class="stepValue">&pound;<span id="Insurance_Totals">0<\/span> p/m<\/li>');this.$familyResultHeader=this.$(".step").eq(3);this.$familyResultHeader.find(".actions").prepend('<li class="stepValue">&pound;<span id="Family_Totals">0<\/span> p/m<\/li>');this.$travelResultHeader=this.$(".step").eq(4);this.$travelResultHeader.find(".actions").prepend('<li class="stepValue">&pound;<span id="Travel_Totals">0<\/span> p/m<\/li>');this.$reviewResultHeader=this.$(".step").eq(5);this.$reviewResultHeader.find(".actions").empty();this.$reviewResultHeader.find(".actions").append('<li style="color:#fff;">&pound;<span id="Review_Totals">0<\/span>&nbsp;p/m<\/li>');this.$reviewResultHeader.addClass("userInteractiveResult");var t=this.$houseHoldResultHeader.find(".stepTitleInner>h3>a").html(),i=t.indexOf(":")+2;this.householdSectionHeading=$.trim(this._htmlToText(t.substr(i,t.length)));t=this.$insuranceResultHeader.find(".stepTitleInner>h3>a").html();i=t.indexOf(":")+2;this.insuranceSectionHeading=$.trim(this._htmlToText(t.substr(i,t.length)));t=this.$familyResultHeader.find(".stepTitleInner>h3>a").html();i=t.indexOf(":")+2;this.familySectionHeading=$.trim(this._htmlToText(t.substr(i,t.length)));t=this.$travelResultHeader.find(".stepTitleInner>h3>a").html();i=t.indexOf(":")+2;this.travelSectionHeading=$.trim(this._htmlToText(t.substr(i,t.length)));t=this.$incomeResultHeader.find(".stepTitleInner>h3>a").html();i=t.indexOf(":")+2;takeUpTo=t.indexOf("<")-i;this.incomeSectionHeading=$.trim(this._htmlToText(t.substr(i,t.length)));this.$FamilyTotals=n.find("#Family_Totals");this.$HouseHoldTotals=n.find("#HouseHold_Totals");this.$InsuranceTotals=n.find("#Insurance_Totals");this.$IncomeTotals=n.find("#Income_Totals");this.$TravelTotals=n.find("#Travel_Totals");this.$reviewTotals=n.find("#Review_Totals");this.$reviewResultPeriodSelect=n.find("#ReviewResult_Period");this.$incomeResultHeader.find("input[type = button]").click(nbs.util.hitch(this,"_handleIncomeStepCalculations"));this.$houseHoldResultHeader.find("input[type = button]").click(nbs.util.hitch(this,"_handleHouseHoldStepCalculations"));this.$insuranceResultHeader.find("input[type = button]").click(nbs.util.hitch(this,"_handleInsuranceStepCalculations"));this.$familyResultHeader.find("input[type = button]").click(nbs.util.hitch(this,"_handleFamilyStepCalculations"));this.$travelResultHeader.find("input[type = button]").click(nbs.util.hitch(this,"_handleTravelStepCalculations"));this.$incomeResultHeader.find("input[type = button].nonlinear").click(nbs.util.hitch(this,"_handleUpdateResults"));this.$houseHoldResultHeader.find("input[type = button].nonlinear").click(nbs.util.hitch(this,"_handleUpdateResults"));this.$insuranceResultHeader.find("input[type = button].nonlinear").click(nbs.util.hitch(this,"_handleUpdateResults"));this.$familyResultHeader.find("input[type = button].nonlinear").click(nbs.util.hitch(this,"_handleUpdateResults"));this.$travelResultHeader.find("input[type = button].nonlinear").click(nbs.util.hitch(this,"_handleUpdateResults"));this.$incomeResultHeader.find("input[type = button]").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$houseHoldResultHeader.find("input[type = button]").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$insuranceResultHeader.find("input[type = button]").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$familyResultHeader.find("input[type = button]").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$travelResultHeader.find("input[type = button]").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$incomeResultHeader.find("input[type = button].nonlinear").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$houseHoldResultHeader.find("input[type = button].nonlinear").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$insuranceResultHeader.find("input[type = button].nonlinear").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$familyResultHeader.find("input[type = button].nonlinear").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$travelResultHeader.find("input[type = button].nonlinear").keyup(nbs.util.hitch(this,"_handleProgressKeyUp"));this.$(".step").find("li.edit a").on("click",nbs.util.hitch(this,"_handleIncomeStepCalculations")).on("click",nbs.util.hitch(this,"_handleHouseHoldStepCalculations")).on("click",nbs.util.hitch(this,"_handleInsuranceStepCalculations")).on("click",nbs.util.hitch(this,"_handleFamilyStepCalculations")).on("click",nbs.util.hitch(this,"_handleTravelStepCalculations"));this.$reviewResultPeriodSelect.on("change",nbs.util.hitch(this,"_handleReviewResultPeriodChange"));this.$errorList=n.find("#errorOverlay ol");this.$errorsTemplate=n.find("#errorsTemplate");this.$resultIncome=n.find(".resultincome");this.$resultExpenses=n.find(".resultexpenses");this.$result=n.find(".resulttotal");this.$resultArea=n.find(".resultArea");this.$resultError=n.find(".resultError");this.$resultLoading=n.find(".resultLoading");this.$ResultPositiveText=n.find(".resultPositiveText");this.$ResultNegativeText=n.find(".resultNegativeText");this.$btnBarChartView=n.find("#btnBarChart");this.$btnDoughnutChartView=n.find("#btnDoughnutChart");this.$btnBarChartView.click(nbs.util.hitch(this,"_createBarChart"));this.$btnDoughnutChartView.click(nbs.util.hitch(this,"_createDoughnutChart"));n.on("click","a.clearall",nbs.util.hitch(this,"_resetAllClickHandler"));$(".step").each(function(){var t=$(this).find("input[type = text]"),n;t.each(function(){var n=$(this).attr("id"),t=$.jStorage.get(n);$(this).val(t);$(this).addClass("twodecimalplaces")});n=$(this).find("select");n.each(function(){var t=$(this).attr("id"),n;t!="ReviewResult_Period"&&(n=$.jStorage.get(t),n!=null?$(this).val(n):$(this).val("M"))})});$(".twodecimalplaces").keyup(function(){/^\d+(\.{0,1}\d{0,2})?$/.test(this.value)||(this.value=this.value.substring(0,this.value.length-1))});$(".twodecimalplaces").blur(function(){if(this.value.indexOf(".")!=-1){var t=this.value.split("."),i=$.trim(t[0]),n=$.trim(t[1].substring(0,2));this.value=n==""||n=="00"||n==".."?i:i+"."+n}})},_handleProgressKeyUp:function(n){var t=n.which||n.keyCode;(t===13||t===32)&&$(n.currentTarget).click()},_handleUpdateResults:function(){this.reviewExpenses=(nbs.number.parse(this.householdTotals)+nbs.number.parse(this.insuranceTotals)+nbs.number.parse(this.familyTotals)+nbs.number.parse(this.travelTotals)).toFixed(2);this.reviewTotals=(nbs.number.parse(this.incomeTotals)-nbs.number.parse(this.reviewExpenses)).toFixed(2);this.$reviewTotals.html(nbs.number.formatWithCommas(this.reviewTotals));this.strToolOutcomeValue=this.reviewTotals>0?"positive":"negative"},startup:function(){this.inherited.apply(this,arguments)},_editHandler:function(){this.inherited.apply(this,arguments)},_handleIncomeStepCalculations:function(n){var f,t,i;n.preventDefault();var r=[],u=[],e=this.$incomeResultHeader.find("input[type = text]");for(e.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);r.push(t)}),f=this.$incomeResultHeader.find("select"),f.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);u.push(t)}),this.stepSectionTotals=0,t=0;t<r.length;t++)this.stepSectionTotals+=this._getMonthlyValue(r[t],u[t]);if(this.incomeTotals=this.stepSectionTotals.toFixed(2),this.$IncomeTotals.html(nbs.number.formatWithCommas(this.incomeTotals)),i=$(".step.open .form"),this.incomeTotals<=0)return this.$el.find(".formActions .validationMessage").html("You must enter the value in at least one of the income fields"),i.addClass("errors"),!1;this.$el.find(".formActions .validationMessage").html(this.defaultErrorMsg);i.find(".error").length?i.addClass("errors"):i.removeClass("errors")},_handleHouseHoldStepCalculations:function(n){var u,t;n.preventDefault();var i=[],r=[],f=this.$houseHoldResultHeader.find("input[type = text]");for(f.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);i.push(t)}),u=this.$houseHoldResultHeader.find("select"),u.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);r.push(t)}),this.stepSectionTotals=0,t=0;t<i.length;t++)this.stepSectionTotals+=this._getMonthlyValue(i[t],r[t]);this.householdTotals=this.stepSectionTotals.toFixed(2);this.$HouseHoldTotals.html(nbs.number.formatWithCommas(this.householdTotals))},_handleInsuranceStepCalculations:function(n){var u,t;n.preventDefault();var i=[],r=[],f=this.$insuranceResultHeader.find("input[type = text]");for(f.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);i.push(t)}),u=this.$insuranceResultHeader.find("select"),u.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);r.push(t)}),this.stepSectionTotals=0,t=0;t<i.length;t++)this.stepSectionTotals+=this._getMonthlyValue(i[t],r[t]);this.insuranceTotals=this.stepSectionTotals.toFixed(2);this.$InsuranceTotals.html(nbs.number.formatWithCommas(this.insuranceTotals))},_handleFamilyStepCalculations:function(n){var u,t;n.preventDefault();var i=[],r=[],f=this.$familyResultHeader.find("input[type = text]");for(f.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);i.push(t)}),u=this.$familyResultHeader.find("select"),u.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);r.push(t)}),this.stepSectionTotals=0,t=0;t<i.length;t++)this.stepSectionTotals+=this._getMonthlyValue(i[t],r[t]);this.familyTotals=this.stepSectionTotals.toFixed(2);this.$FamilyTotals.html(nbs.number.formatWithCommas(this.familyTotals))},_handleTravelStepCalculations:function(n){var u,t;n.preventDefault();var i=[],r=[],f=this.$travelResultHeader.find("input[type = text]");for(f.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);i.push(t)}),u=this.$travelResultHeader.find("select"),u.each(function(){var n=$(this).attr("id"),t=$(this).val();$.jStorage.set(n,t);$.jStorage.setTTL(n,this.jStorageSessionTimeout);r.push(t)}),this.stepSectionTotals=0,t=0;t<i.length;t++)this.stepSectionTotals+=this._getMonthlyValue(i[t],r[t]);this.travelTotals=this.stepSectionTotals.toFixed(2);this.$TravelTotals.html(nbs.number.formatWithCommas(this.travelTotals));this.reviewExpenses=(nbs.number.parse(this.householdTotals)+nbs.number.parse(this.insuranceTotals)+nbs.number.parse(this.familyTotals)+nbs.number.parse(this.travelTotals)).toFixed(2);this.reviewTotals=(nbs.number.parse(this.incomeTotals)-nbs.number.parse(this.reviewExpenses)).toFixed(2);this.$reviewTotals.html(nbs.number.formatWithCommas(this.reviewTotals));this.strToolOutcomeValue=this.reviewTotals>0?"positive":"negative"},_getMonthlyValue:function(n,t){var i=0;n!=null&&n!=""&&(i=parseFloat(n));switch(t){case"W":i=i*52/12;break;case"Q":i=i/3;break;case"Y":i=i/12}return i},_handleReviewResultPeriodChange:function(n){n.preventDefault();var t=this.incomeTotals,i=this.reviewExpenses,r=this.reviewTotals,u="monthly",f=this.$reviewResultPeriodSelect.val();switch(f){case"W":t=t*12/52;i=i*12/52;r=r*12/52;u="weekly";break;case"Q":t=t*3;i=i*3;r=r*3;u="quarterly";break;case"Y":t=t*12;i=i*12;r=r*12;u="annual";break;default:t=t*1;i=i*1;r=r*1;u="monthly"}this.$resultIncome.html("&pound;"+nbs.number.formatWithCommas(t.toFixed(2))+"<span>Total "+u+" income<\/span>");this.$resultExpenses.html("&pound;"+nbs.number.formatWithCommas(i.toFixed(2))+"<span>Total "+u+" outgoings<\/span>");this.$result.html("&pound;"+nbs.number.formatWithCommas(r.toFixed(2)));this._createDoughnutChart()},toggle:function(n){var t=arguments,i=this;n==this.stepCount-1&&(this._calculate(),this._createBarChart(),this._createDoughnutChart());this.inherited.apply(this,arguments)},_open:function(n){n==this.stepCount-1&&this._plannerAnalytics();this.inherited.apply(this,arguments)},_calculate:function(){for(var r,t=this.forms,i={},n=0,u=t.length;n<u;n++)r=t[n],i=$.extend(!0,r.serialise(!0),i);this.$resultArea.hide();this.$resultError.hide();this.$resultLoading.show();this.$ResultPositiveText.hide();this.$ResultNegativeText.hide();this._calculateSuccess()},_calculateSuccess:function(){var n=this.reviewTotals;n==null||n=="null"||n=="undefined"?this.$resultError.fadeIn():(this.$resultIncome.html("&pound;"+nbs.number.formatWithCommas(this.incomeTotals)+"<span>Total monthly income<\/span>"),this.$resultExpenses.html("&pound;"+nbs.number.formatWithCommas(this.reviewExpenses)+"<span>Total monthly outgoings<\/span>"),this.$result.html("&pound;"+nbs.number.formatWithCommas(n)),n>=0?this.$ResultPositiveText.show():this.$ResultNegativeText.show(),this.$reviewResultHeader.find(".actions ").css("opacity","100"),this.$resultArea.fadeIn());this.$resultLoading.hide()},_calculateError:function(){this.$resultError.fadeIn();this.$resultLoading.hide()},_createBarChart:function(){var s=(nbs.number.parse(this.householdTotals)+nbs.number.parse(this.insuranceTotals)+nbs.number.parse(this.familyTotals)+nbs.number.parse(this.travelTotals)).toFixed(2),d=(nbs.number.parse(this.householdTotals)/s*100).toFixed(0),e=[],i,t,r,u,c=this,k=this.$houseHoldResultHeader.find(".formRow"),l,a,v,h,o,y,p,w,b,f,n;for(k.each(function(){i=$.trim($(this).find("label").html());u=$(this).find("select").val();t=c._getMonthlyValue($(this).find("input").val(),u);r=$.trim(t)==""?0:(nbs.number.parse(t)/s*100).toFixed(0);e.push({spendingHeader:i,spendingAmount:nbs.number.parse(r)})}),l=this.$insuranceResultHeader.find(".formRow"),l.each(function(){i=$.trim($(this).find("label").html());u=$(this).find("select").val();t=c._getMonthlyValue($(this).find("input").val(),u);r=$.trim(t)==""?0:(nbs.number.parse(t)/s*100).toFixed(0);e.push({spendingHeader:i,spendingAmount:nbs.number.parse(r)})}),a=this.$familyResultHeader.find(".formRow"),a.each(function(){i=$.trim($(this).find("label").html());u=$(this).find("select").val();t=c._getMonthlyValue($(this).find("input").val(),u);r=$.trim(t)==""?0:(nbs.number.parse(t)/s*100).toFixed(0);e.push({spendingHeader:i,spendingAmount:nbs.number.parse(r)})}),v=this.$travelResultHeader.find(".formRow"),v.each(function(){i=$.trim($(this).find("label").html());u=$(this).find("select").val();t=c._getMonthlyValue($(this).find("input").val(),u);r=$.trim(t)==""?0:(nbs.number.parse(t)/s*100).toFixed(0);e.push({spendingHeader:i,spendingAmount:nbs.number.parse(r)})}),e.sort(function(n,t){return n.spendingAmount<t.spendingAmount?1:n.spendingAmount>t.spendingAmount?-1:0}),h=[],o=[],n=0;n<5;++n)h.push(this._htmlToText(e[n].spendingHeader)),o.push(e[n].spendingAmount);if(y={labels:h,colors:this.colours,colorsHover:this.coloursHover,datasets:[{label:"Top 5 Spendings",fillColor:this.colours[0],highlightFill:this.coloursHover[0],data:o}]},document.createElement("canvas").getContext)p=$("#barChart").get(0).getContext("2d"),this.barChart!=null&&this.barChart.destroy(),this.barChart=new Chart(p).Bar(y,this.barChartOptions),this.barChart.update();else{for(f="<table>",n=0;n<5;n++)w=h[n]+"&nbsp;("+o[n]+"%)",b=h[n]+"&nbsp;"+o[n]+"%",f+='<tr><td class="tblLegend">'+w+"<\/td><td>",f+='<table style="width:'+o[n]+'%;">',f+='<tr><td title="'+b+'" style="background-color:'+this.colours[n]+';">&nbsp;<\/td><\/tr>',f+="<\/table>",f+="<\/td><\/tr>";f+="<\/table>";$("#ieBarChart").html(f);$("#ieBarChart").css("display","block")}},_createDoughnutChart:function(){var t,i,r,u,s,b=this.$reviewResultPeriodSelect.val(),y,p,w,f,n;switch(b){case"M":t=this.householdTotals;i=this.insuranceTotals;r=this.familyTotals;u=this.travelTotals;break;case"W":t=this.householdTotals*12/52;i=this.insuranceTotals*12/52;r=this.familyTotals*12/52;u=this.travelTotals*12/52;break;case"Q":t=this.householdTotals*3;i=this.insuranceTotals*3;r=this.familyTotals*3;u=this.travelTotals*3;break;case"Y":t=this.householdTotals*12;i=this.insuranceTotals*12;r=this.familyTotals*12;u=this.travelTotals*12;break;default:t=this.householdTotals;i=this.insuranceTotals;r=this.familyTotals;u=this.travelTotals}s=(nbs.number.parse(t)+nbs.number.parse(i)+nbs.number.parse(r)+nbs.number.parse(u)).toFixed(2);var c=(nbs.number.parse(t)/s*100).toFixed(0),l=(nbs.number.parse(i)/s*100).toFixed(0),a=(nbs.number.parse(r)/s*100).toFixed(0),v=(nbs.number.parse(u)/s*100).toFixed(0),k=[{value:nbs.number.parse(c),color:this.colours[0],highlight:this.coloursHover[0],label:this.householdSectionHeading,costamount:nbs.number.parse(t).toFixed(2)},{value:nbs.number.parse(l),color:this.colours[1],highlight:this.coloursHover[1],label:this.insuranceSectionHeading,costamount:nbs.number.parse(i).toFixed(2)},{value:nbs.number.parse(a),color:this.colours[2],highlight:this.coloursHover[2],label:this.familySectionHeading,costamount:nbs.number.parse(r).toFixed(2)},{value:nbs.number.parse(v),color:this.colours[3],highlight:this.coloursHover[3],label:this.travelSectionHeading,costamount:nbs.number.parse(u).toFixed(2)}];if(document.createElement("canvas").getContext)y=$("#donutChart").get(0).getContext("2d"),this.doughnutChart!=null&&this.doughnutChart.destroy(),this.doughnutChart=new Chart(y).Doughnut(k,this.doughnutChartOptions),this.doughnutChart.update(),$("#donutChartLegend").html(this.doughnutChart.generateLegend());else{var o=[],h=[],e=[];for(o.push(this._htmlToText(this.householdSectionHeading)),h.push(nbs.number.parse(t).toFixed(2)),e.push(nbs.number.parse(c)),o.push(this._htmlToText(this.insuranceSectionHeading)),h.push(nbs.number.parse(i).toFixed(2)),e.push(nbs.number.parse(l)),o.push(this._htmlToText(this.familySectionHeading)),h.push(nbs.number.parse(r).toFixed(2)),e.push(nbs.number.parse(a)),o.push(this._htmlToText(this.travelSectionHeading)),h.push(nbs.number.parse(u).toFixed(2)),e.push(nbs.number.parse(v)),f="<table>",n=0;n<4;n++)p=o[n]+"<span>&pound;"+h[n]+"&nbsp;("+e[n]+"%)<\/span>",w=o[n]+"&nbsp;"+e[n]+"%",f+='<tr><td class="tblLegend">'+p+"<\/td><td>",f+='<table style="width:'+e[n]+'%;">',f+='<tr><td title="'+w+'" style="background-color:'+this.colours[n]+';">&nbsp;<\/td><\/tr>',f+="<\/table>",f+="<\/td><\/tr>";f+="<\/table>";$("#ieDonutChart").html(f);$("#ieDonutChart").css("display","block")}},resetAll:function(){this.$(".step").each(function(){$(this).find(".clear").click();$(this).removeClass("visited").removeClass("complete")});this.$incomeResultHeader.find("li.edit a").click()},_resetAllClickHandler:function(n){n.preventDefault();$.jStorage.flush();this.resetAll()},_plannerAnalytics:function(){s.contextData["tool.outcome"]=this.strToolOutcomeValue},_htmlEscape:function(n){return String(n).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},_htmlToText:function(n){return String(n).replace("&amp;","&").replace("&quot;",'"').replace("&#39;","'").replace("&lt;","<").replace("&gt;",">")}});nbs.modules.ComparisonTable=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.count=0;this.opts=t=$.extend(!0,{selectors:{button:"button.compare",tooManyOverlay:"#tooManySelectedOverlay",notEnoughOverlay:"#notEnoughSelectedOverlay"},min:2,max:3},t);this.overlayContent={tooMany:$(t.selectors.tooManyOverlay).html(),notEnough:$(t.selectors.notEnoughOverlay).html()};n.on("click",t.selectors.button,nbs.util.hitch(this,"_buttonClickHandler"))},startup:function(){for(var t=this.checkboxes=nbs.registry.getDescendents(this.$el,["Checkbox"]),i=this,n=0;n<t.length;n++)t[n].on("check",nbs.util.hitch(this,"_checkboxClickHandler",n));this._countChecked()},_buttonClickHandler:function(){if(this.count<this.opts.min)return this._showOverlay("notEnough"),!1},_checkboxClickHandler:function(n,t){this.checkboxes[t].disabled?this._showOverlay("tooMany"):this._countChecked()},_showOverlay:function(n){new nbs.modules.Overlay(nbs.dom.$body,{content:this.overlayContent[n]})},_countChecked:function(){var t=this.checkboxes,i=this.opts.max,n;for(this.count=0,n=0;n<t.length;n++)t[n].checked&&this.count++;this.count<i?this._enableCheckboxes():this._disableCheckboxes()},_disableCheckboxes:function(){for(var t,i=this.checkboxes,n=0;n<i.length;n++)t=i[n],t.checked||t.disable()},_enableCheckboxes:function(){for(var t=this.checkboxes,n=0;n<t.length;n++)t[n].checked=!0}});nbs.modules.ContactUs=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$el=n},startup:function(){this.$el.find("button[type=submit],input[type=submit]").on("click",nbs.util.hitch(this,"_validateOption"))},_validateOption:function(){var n=this.$el.find("#ddlSubjects").val()=="Please select ...";return n&&alert("Please select an option."),!n}});nbs.modules.CostOfMovingCalculator=nbs.declare(nbs.modules.SteppedForm,{steppedFormName:"Cost of moving home calculator",initialise:function(n){this.inherited.apply(this,arguments);this.$el=n;this.$el.find(".step").eq(0).find(".actions").prepend('<li class="stepValue">&pound;<span class="SaleTotal">0<\/span><\/li>');this.$el.find(".step").eq(1).find(".actions").prepend('<li class="stepValue">&pound;<span class="PurchaseTotal">0<\/span><\/li>');this.$el.find(".step").eq(2).find(".actions").prepend('<li class="stepValue">&pound;<span class="OtherTotal">0<\/span><\/li>')},startup:function(){this.inherited.apply(this,arguments);var n=this;this.$(".step").find("li.edit a").on("click",nbs.util.hitch(this,"_handleStep1CustomValidation")).on("click",nbs.util.hitch(this,"_handleStep2CustomValidation")).on("click",nbs.util.hitch(this,"_handleStep3CustomValidation"));this.$resultSelling=this.$el.find(".resultSellingTotal>span");this.$resultBuying=this.$el.find(".resultBuyingTotal>span");this.$resultOther=this.$el.find(".resultOtherTotal>span");this.$resultTotal=this.$el.find(".resultTotal>span");this.$resultDeposit=this.$el.find(".resultDeposit>span");this.$resultChangeSelling=this.$el.find(".changeSelling");this.$resultChangeBuying=this.$el.find(".changeBuying");this.$resultChangeOther=this.$el.find(".changeOther");this.$resultPrint=this.$el.find(".print");this.$resultResetAll=this.$el.find(".resetAll");this.$rdoSellingProperty=nbs.registry.get("sellingProperty");this.$rdoSellingPropertyInScotland=nbs.registry.get("saleArea");this.$rdoSellingPropertyLeasehold=nbs.registry.get("saleType");this.$salePrice=this.$el.find("#priceSale");this.$saleCostEPC=nbs.registry.get("saleCostEPCField");this.$saleCostLegalConveyancing=nbs.registry.get("saleCostLegalConveyancingField");this.$saleEstateAgentCost=nbs.registry.get("estateAgentCostField");this.$rdoBuyingProperty=nbs.registry.get("buyingProperty");this.$rdoIsSecondProperty=nbs.registry.get("isSecondProperty");this.$boolUseHigherStampDutyRates=!1;this.$rdoBuyingInScotland=nbs.registry.get("purchaseArea");this.$rdoBuyingPropertyLeasehold=nbs.registry.get("purchaseType");this.$rdoIsFirstBuyer=nbs.registry.get("firstTimeBuyer");this.$purchasePrice=this.$el.find("#pricePurchase");this.$purchaseStampDuty=this.$el.find("#purchaseCostStampDuty");this.$purchaseDeposit=this.$el.find("#purchaseCostDeposit");this.$rdoValuationLevel=nbs.registry.get("valuationLevel");this.$purchaseValuationFee=nbs.registry.get("purchaseValuationField");this.$otherSurveyFees=this.$el.find("#otherSurveyFees");this.$otherLegalFees=this.$el.find("#otherLegalFees");this.$purchaseCostLegalConveyancing=nbs.registry.get("purchaseLegalConveyancingField");this.$costRemoval=this.$el.find("#costsRemoval");this.$costStorage=this.$el.find("#costsStorage");this.$otherExpenses=this.$el.find("#otherExpenses");this.$costTelephone=this.$el.find("#costsTelephone");this.$costRent=this.$el.find("#costsRent");this.$rdoSellingProperty.on("change",nbs.util.hitch(this,"_updateSellingYesNo"));this.$rdoBuyingProperty.on("change",nbs.util.hitch(this,"_updateBuyingYesNo"));this.$rdoIsSecondProperty.on("change",nbs.util.hitch(this,"_updateIsSecondPropertyYesNo"));this.$rdoIsFirstBuyer.on("change",nbs.util.hitch(this,"_updateIsFirstBuyer"));this.$rdoSellingPropertyInScotland.on("change",nbs.util.hitch(this,"_updateSaleConveyancingCost"));this.$rdoSellingPropertyLeasehold.on("change",nbs.util.hitch(this,"_updateSaleConveyancingCost"));this.$salePrice.on("keyup",nbs.util.hitch(this,"_salePriceUpdated"));this.$rdoBuyingInScotland.on("change",nbs.util.hitch(this,"_updateBuyingInScotland"));this.$rdoBuyingPropertyLeasehold.on("change",nbs.util.hitch(this,"_updatePurchaseConveyancingCost"));this.$purchasePrice.on("keyup",nbs.util.hitch(this,"_purchasePriceUpdated"));this.$rdoValuationLevel.on("change",nbs.util.hitch(this,"_updatePurchaseValuationLevel"));this.$purchaseStampDuty.on("change",nbs.util.hitch(this,"_updateStampDuty"));this.forms[0].customFormValidationFunction=nbs.util.hitch(this,"_handleStep1CustomValidation");this.forms[1].customFormValidationFunction=nbs.util.hitch(this,"_handleStep2CustomValidation");this.forms[2].customFormValidationFunction=nbs.util.hitch(this,"_handleStep3CustomValidation");this.forms[0].$el.find(".clear").on("click",nbs.util.hitch(this,"_handleStep1Clear"));this.forms[1].$el.find(".clear").on("click",nbs.util.hitch(this,"_handleStep2Clear"));this.$resultChangeSelling.on("click",nbs.util.hitch(this,"_changeSelling"));this.$resultChangeBuying.on("click",nbs.util.hitch(this,"_changeBuying"));this.$resultChangeOther.on("click",nbs.util.hitch(this,"_changeOther"));this.$resultPrint.on("click",nbs.util.hitch(this,"_print"));this.$resultResetAll.on("click",nbs.util.hitch(this,"_resetAll"));this.$purchaseStampDuty.parents(".field").prepend('<p class="purchaseStampDuty"><\/p>');this.$purchaseStampDuty.hide().trigger("change").parents(".prefixInput").hide();this.$saleEstateAgentCost.$el.parents(".formRow").data("required",!1)},_print:function(n){n.preventDefault();window.print()},_resetAll:function(n){n.preventDefault();this.forms[0].$el.find(".clear").trigger("click");this.forms[1].$el.find(".clear").trigger("click");this.forms[2].$el.find(".clear").trigger("click");this.$el.find(".step").removeClass("complete");this.toggle(0,!0)},_updateSellingYesNo:function(){this.$rdoSellingProperty.getValue()==="No"&&(this._updateCostOfSaleTotal(),this.toggle(1,!0))},_updateBuyingYesNo:function(){this.$rdoBuyingProperty.getValue()==="No"&&(this._updateCostOfPurchaseTotal(),this.toggle(2,!0))},_updateIsSecondPropertyYesNo:function(){this.$boolUseHigherStampDutyRates=this.$rdoIsSecondProperty.getValue()==="Yes"?!0:!1;this._purchasePriceUpdated()},_updateIsFirstBuyer:function(){this.$rdoBuyingInScotland.getValue()==="Yes"?this._updateBuyingInScotland():this._purchasePriceUpdated()},_handleStep1CustomValidation:function(){var n=!0;if(this.$rdoSellingProperty.getValue()==="Yes")switch(this.$saleEstateAgentCost.getType()){case"fixed":this.$saleEstateAgentCost.getValue()>9999999||this.$saleEstateAgentCost.fixedAmount.$el.val()===""?(this.$saleEstateAgentCost.$el.parents(".formRow").addClass("error"),this.$saleEstateAgentCost.$el.siblings(".errorMessage").find("p").html("Please enter a positive number less than &pound;10m."),n=!1):this.$saleEstateAgentCost.$el.parents(".formRow").removeClass("error");break;case"percentage":this.$saleEstateAgentCost.getPercentage()>100||this.$saleEstateAgentCost.percentageAmount.$el.val()===""?(this.$saleEstateAgentCost.$el.parents(".formRow").addClass("error"),this.$saleEstateAgentCost.$el.siblings(".errorMessage").find("p").html("Please enter a positive number between 0 and 100."),n=!1):this.$saleEstateAgentCost.$el.parents(".formRow").removeClass("error")}return n&&this._updateCostOfSaleTotal(),n},_handleStep2CustomValidation:function(){var n=!0;return this.$rdoBuyingProperty.getValue()==="Yes"&&(parseFloat(this.$purchaseDeposit.val())>=parseFloat(this.$purchasePrice.val())?(this.$purchaseDeposit.parents(".formRow").removeClass("valid").addClass("error"),this.$purchaseDeposit.parents(".formRow").find(".errorMessage p").hide().filter("[data-error-type='required']").show().html("Please enter a positive number. This must be less than the purchase price."),n=!1):this.$purchaseDeposit.parents(".formRow").removeClass("error")),n&&this._updateCostOfPurchaseTotal(),n},_handleStep3CustomValidation:function(){var t=!0,n=this.$costRemoval.closest(".formRow");return this.$costRemoval.val()!==""?(n.data("required",!0),n.attr("data-required","true")):(n.data("required",!1),n.attr("data-required","false")),n=this.$costStorage.closest(".formRow"),this.$costStorage.val()!==""?(n.data("required",!0),n.attr("data-required","true")):(n.data("required",!1),n.attr("data-required","false")),n=this.$costTelephone.closest(".formRow"),this.$costTelephone.val()!==""?(n.data("required",!0),n.attr("data-required","true")):(n.data("required",!1),n.attr("data-required","false")),n=this.$costRent.closest(".formRow"),this.$costRent.val()!==""?(n.data("required",!0),n.attr("data-required","true")):(n.data("required",!1),n.attr("data-required","false")),n=this.$otherExpenses.closest(".formRow"),this.$otherExpenses.val()!==""?(n.data("required",!0),n.attr("data-required","true")):(n.data("required",!1),n.attr("data-required","false")),t&&this._updateOtherCostsTotal(),t},_handleStep1Clear:function(){this.$saleCostEPC.reset();this.$saleCostLegalConveyancing.reset();this.$saleEstateAgentCost.reset()},_handleStep2Clear:function(){this.$purchaseValuationFee.reset();this.$purchaseCostLegalConveyancing.reset();this.$purchaseStampDuty.trigger("change")},_changeSelling:function(n){n.preventDefault();this.$el.find(".step:nth-child(1) .edit a").trigger("click")},_changeBuying:function(n){n.preventDefault();this.$el.find(".step:nth-child(2) .edit a").trigger("click")},_changeOther:function(n){n.preventDefault();this.$el.find(".step:nth-child(3) .edit a").trigger("click")},_getLegalConveyancingError:function(){alert("An unknown error occured. The calculator has recieved or sent back bad data. Please ensure you are entering numeric values where expected or refresh the page and try again.")},_salePriceUpdated:function(){this._updateSaleConveyancingCost();this.$saleEstateAgentCost.setSourceAmount(this.$salePrice.val())},_updateSaleConveyancingCost:function(){if(this.$rdoSellingPropertyInScotland.getValue()==undefined||this.$rdoSellingPropertyLeasehold.getValue()==undefined||this.$salePrice.val().length<=0){this.$saleCostLegalConveyancing.setValue(0);return}var n=this.$rdoSellingPropertyInScotland.getValue()==="Yes"?"scotland":"restofuk",t=this.$rdoSellingPropertyLeasehold.getValue()==="Yes"?"leasehold":"freehold",i=this.$salePrice.val();this._getSaleLegalConveyancing(n,t,i)},_getSaleLegalConveyancingSuccess:function(n){n.indexOf("error")===-1&&this.$saleCostLegalConveyancing.setValue(n)},_getSaleLegalConveyancing:function(n,t,i){$.ajax({url:"/services/ToolService.svc/GetLegalConveryancingCost",global:!1,type:"GET",data:{action:"legalConveyancing",area:n,purchaseType:t,relationshipType:"sale",price:nbs.tidying.cleanNumerical(i)},dataType:"text",success:nbs.util.hitch(this,"_getSaleLegalConveyancingSuccess"),error:nbs.util.hitch(this,"_getLegalConveyancingError")})},_updateBuyingInScotland:function(){var t;this._updatePurchaseConveyancingCost();var i=this.$purchasePrice.val().length>0?this.$purchasePrice.val():0,n=this.$rdoBuyingInScotland.getValue()==="Yes"?"scotland":"restofuk",r=this.$rdoIsFirstBuyer.getValue()==="Yes"?!0:!1;n==="scotland"?$("label[for='purchaseCostStampDuty']").text("Land and Buildings Transaction Tax (LBTT)"):$("label[for='purchaseCostStampDuty']").text("Stamp Duty Land Tax (SDLT)");t=this._getPurchaseStampDuty(i,n,r);this.$purchaseStampDuty.val(t).trigger("change")},_purchasePriceUpdated:function(){this._updatePurchaseConveyancingCost();var n=this.$purchasePrice.val().length>0?this.$purchasePrice.val():0,t=this.$rdoBuyingInScotland.getValue()==="Yes"?"scotland":"restofuk",i=this.$rdoIsFirstBuyer.getValue()==="Yes"?!0:!1,r=this._getPurchaseStampDuty(n,t,i);this.$purchaseStampDuty.val(r).trigger("change");this._getPurchaseValuation()},_updatePurchaseConveyancingCost:function(){if(this.$rdoBuyingInScotland.getValue()==undefined||this.$rdoBuyingPropertyLeasehold.getValue()==undefined||this.$purchasePrice.val().length<=0){this.$purchaseCostLegalConveyancing.setValue(0);return}var n=this.$rdoBuyingInScotland.getValue()==="Yes"?"scotland":"restofuk",t=this.$rdoBuyingPropertyLeasehold.getValue()==="Yes"?"leasehold":"freehold",i=this.$purchasePrice.val();this._getPurchaseLegalConveyancing(n,t,i)},_updatePurchaseValuationLevel:function(){this._getPurchaseValuation()},_getPurchaseLegalConveyancingSuccess:function(n){n.indexOf("error")===-1&&this.$purchaseCostLegalConveyancing.setValue(n)},_getPurchaseLegalConveyancing:function(n,t,i){$.ajax({url:"/services/ToolService.svc/GetLegalConveryancingCost",global:!1,type:"GET",data:{action:"legalConveyancing",area:n,purchaseType:t,relationshipType:"purchase",price:nbs.tidying.cleanNumerical(i)},dataType:"text",success:nbs.util.hitch(this,"_getPurchaseLegalConveyancingSuccess"),error:nbs.util.hitch(this,"_getLegalConveyancingError")})},_getPurchaseStampDuty:function(n,t,i){var d,g;if(t!=="scotland"){if(i&&n<=3e5)return 0;if(i&&n>3e5&&n<=5e5)return d=n-3e5,g=d*.05,Math.floor(g)}var it=Math.abs(n),r=it,w=0,c=3,s=0,l=2,y=5,b=10,nt=12;this.$boolUseHigherStampDutyRates&&(s+=c,l+=c,y+=c,b+=c,nt+=c);var h=0,a=0,p=0,k=0,tt=0,e=0,u=125e3,f=25e4,o=925e3,v=15e5;return t==="scotland"&&(e=0,u=145e3,f=25e4,o=325e3,v=75e4),r>e&&r<=u&&(h=r*s/100),r>u&&r<=f&&(h=(u-e)*s/100,a=(r-u)*l/100),r>f&&r<=o&&(h=(u-e)*s/100,a=(f-u)*l/100,p=(r-f)*y/100),r>o&&r<=v&&(h=(u-e)*s/100,a=(f-u)*l/100,p=(o-f)*y/100,k=(r-o)*b/100),r>v&&(h=(u-e)*s/100,a=(f-u)*l/100,p=(o-f)*y/100,k=(v-o)*b/100,tt=(r-v)*nt/100),w=h+a+p+k+tt,r>=e&&r<=39999.99&&(w=0),Math.floor(w)},_getPurchaseValuation:function(){var n=this.$purchasePrice.val(),t=this.$rdoValuationLevel.getValue()==="MortgageValuationFees"?"basic":"homebuyerReport";n.length>0&&this.$rdoValuationLevel.getValue()!=null?this._getPurchaseValuationAjax(n,t):this.$purchaseValuationFee.reset()},_getPurchaseValuationAjax:function(n,t){$.ajax({url:"/services/ToolService.svc/GetValuation",global:!1,type:"GET",data:{action:"valuation",valuationLevel:t,price:nbs.tidying.cleanNumerical(n)},dataType:"text",success:nbs.util.hitch(this,"_getPurchaseValuationSuccess"),error:nbs.util.hitch(this,"_getPurchaseValuationError")})},_getPurchaseValuationSuccess:function(n){n.indexOf("error")===-1&&this.$purchaseValuationFee.setValue(n)},_getPurchaseValuationError:function(){alert("An unknown error occured. The calculator has recieved or sent back bad data. Please ensure you are entering numeric values where expected or refresh the page and try again.")},_updateStampDuty:function(){var n=this.$purchaseStampDuty.val();(n.length<=0||n<=0)&&this.$purchasePrice.val().length<=0&&(n=" - ");this.$el.find(".purchaseStampDuty").html("&pound;"+nbs.number.formatWithCommas(n))},_updateCostOfSaleTotal:function(){var n=0;if(this.$rdoSellingProperty.getValue()==="Yes"){var t=parseFloat(this.$saleCostEPC.getValue()||"0"),i=parseFloat(this.$saleCostLegalConveyancing.getValue()||"0"),r=parseFloat(this.$saleEstateAgentCost.getValueWithVat()||"0");n=t+i+r}return this.$el.find(".SaleTotal").text(nbs.number.formatWithCommas(n,0)),n},_updateCostOfPurchaseTotal:function(){var n=0;if(this.$rdoBuyingProperty.getValue()==="Yes"){var t=parseFloat(this.$purchaseStampDuty.val()||"0"),i=parseFloat(this.$purchaseValuationFee.getValue()||"0"),r=parseFloat(this.$otherSurveyFees.val()||"0"),u=parseFloat(this.$purchaseCostLegalConveyancing.getValue()||"0"),f=parseFloat(this.$otherLegalFees.val()||"0");n=t+i+r+u+f}return this.$el.find(".PurchaseTotal").text(nbs.number.formatWithCommas(n,0)),n},_updateOtherCostsTotal:function(){var n=parseFloat(this.$costRemoval.val()||"0");return n+=parseFloat(this.$costStorage.val()||"0"),n+=parseFloat(this.$costTelephone.val()||"0"),n+=parseFloat(this.$costRent.val()||"0"),n+=parseFloat(this.$otherExpenses.val()||"0"),this.$el.find(".OtherTotal").text(nbs.number.formatWithCommas(n,0)),n},_updateResults:function(){var n=this._updateCostOfSaleTotal(),t=this._updateCostOfPurchaseTotal(),i=this._updateOtherCostsTotal(),u=n+t+i,r;this.$resultSelling.text(nbs.number.formatWithCommas(n,0));this.$resultBuying.text(nbs.number.formatWithCommas(t,0));this.$resultOther.text(nbs.number.formatWithCommas(i,0));this.$resultTotal.text(nbs.number.formatWithCommas(u,0));this.$rdoBuyingProperty.getValue()==="Yes"?(r=parseFloat(this.$purchaseDeposit.val()||"0"),this.$resultDeposit.text(nbs.number.formatWithCommas(r,0)),this.$resultDeposit.parent().show()):(this.$resultDeposit.text("0"),this.$resultDeposit.parent().hide())},toggle:function(n){var i=arguments,t=this;n===this.stepCount-1?(this._calculate(),t.inherited.apply(t,i)):this.inherited.apply(this,arguments)},_calculate:function(){this._updateResults()}});nbs.modules.CostOfMovingTool=nbs.declare(nbs.modules.CostOfMovingToolCommonFunctions,{NumberInput:null,SellingAmount:null,StateAgentFeeIn:null,SellingEstateAgentFees:null,SellingEnergyPerformanceCertificate:null,SellingRemovalCosts:null,SellingPropertyType:null,SellingPropertyLocation:null,ContinueButton1:null,estateAgentFeesPurpleBox:null,PurpleBoxPanel:null,BuyingAmount:null,BuyingDepositAmount:null,BuyingMortgageValuationFee:null,BuyingMortgageFees:null,BuyingHomeBuyerReportFee:null,BuyingPropertyType:null,BuyingPropertyLocation:null,FirstTimeBuyer:null,GoBackButton:null,ContinueButton2:null,HomeBuyerReport:null,MortgageValuationFee:null,MortgageFee:null,StampDuty:null,BuyingConveyancingFee:null,EnergyPerformanceCertificate:null,RemovalCosts:null,EstateAgentFee:null,SellingConveyancingFee:null,StartAgainButton:null,DepositText:null,lblResult:null,HiddenPurpleBoxText:null,HiddenPlusDepositText:null,HiddenCalculatedAgentFeeInPounds:null,TextEnergyPerformanceCertificate:null,LinkEnergyPerformanceCertificate:null,TextHomeBuyerReport:null,LinkHomeBuyerReport:null,TextMortgageValuationFee:null,LinkMortgageValuationFee:null,TextMortgageValuationFee:null,LinkMortgageValuationFee:null,TextMortgageFee:null,LinkMortgageFee:null,TextRemovalCosts:null,LinkRemovalCosts:null,TextEstateAgentFee:null,LinkEstateAgentFee:null,TextBuyingConveyancingFee:null,LinkBuyingConveyancingFee:null,TextSellingConveyancingFee:null,LinkSellingConveyancingFee:null,divSellingPanel:null,divBuyingPanel:null,divResultPanel:null,initialise:function(n){this.inherited.apply(this,arguments);this.NumberInput=n.find(".numberinput");this.SellingAmount=n.find("#txtSellingAmount");this.SellingEstateAgentFees=n.find("#txtSellingEstateAgentFees");this.StateAgentFeeIn=n.find("#rdoFeeIn");this.SellingEnergyPerformanceCertificate=n.find("#txtSellingEnergyPerformanceCertificate");this.SellingRemovalCosts=n.find("#txtSellingRemovalCosts");this.SellingPropertyType=n.find("#rdoSellingPropertyType");this.SellingPropertyLocation=n.find("#rdoSellingPropertyLocation");this.ContinueButton1=n.find("#lbtnContinue1");this.estateAgentFeesPurpleBox=n.find(".PurpleBoxEstateAgentFees");this.PurpleBoxPanel=n.find(".purpleBoxPanel");this.BuyingAmount=n.find("#txtBuyingAmount");this.BuyingDepositAmount=n.find("#txtBuyingDepositAmount");this.BuyingMortgageValuationFee=n.find("#txtBuyingMortgageValuationFee");this.BuyingMortgageFees=n.find("#txtBuyingMortgageFees");this.BuyingHomeBuyerReportFee=n.find("#txtBuyingHomeBuyerReportFee");this.BuyingPropertyType=n.find("#rdoBuyingPropertyType");this.BuyingPropertyLocation=n.find("#rdoBuyingPropertyLocation");this.FirstTimeBuyer=n.find("#rdoFirstTimeBuyer");this.GoBackButton=n.find("#lbtnGoBack");this.ContinueButton2=n.find("#lbtnContinue2");this.HomeBuyerReport=n.find("#txtHomeBuyerReport");this.MortgageValuationFee=n.find("#txtMortgageValuationFee");this.MortgageFee=n.find("#txtMortgageFee");this.StampDuty=n.find("#txtStampDuty");this.BuyingConveyancingFee=n.find("#txtBuyingConveyancingFee");this.EnergyPerformanceCertificate=n.find("#txtEnergyPerformanceCertificate");this.RemovalCosts=n.find("#txtRemovalCosts");this.EstateAgentFee=n.find("#txtEstateAgentFee");this.SellingConveyancingFee=n.find("#txtSellingConveyancingFee");this.StartAgainButton=n.find("#lbtnStartAgain");this.DepositText=n.find("#lblDepositText");this.lblResult=n.find("#lblResult");this.HiddenPurpleBoxText=n.find("#hfPurpleBoxText");this.HiddenPlusDepositText=n.find("#hfPlusDepositText");this.HiddenCalculatedAgentFeeInPounds=n.find("#hfCalculatedAgentFeeInPounds");this.TextEnergyPerformanceCertificate=n.find("#txtEnergyPerformanceCertificate");this.LinkEnergyPerformanceCertificate=n.find(".hrfEnergyPerformanceCertificate");this.TextHomeBuyerReport=n.find("#txtHomeBuyerReport");this.LinkHomeBuyerReport=n.find(".hrfHomeBuyerReport");this.TextMortgageValuationFee=n.find("#txtMortgageValuationFee");this.LinkMortgageValuationFee=n.find(".hrfMortgageValuationFee");this.TextMortgageFee=n.find("#txtMortgageFee");this.LinkMortgageFee=n.find(".hrfMortgageFee");this.TextRemovalCosts=n.find("#txtRemovalCosts");this.LinkRemovalCosts=n.find(".hrfRemovalCosts");this.TextEstateAgentFee=n.find("#txtEstateAgentFee");this.LinkEstateAgentFee=n.find(".hrfEstateAgentFee");this.TextBuyingConveyancingFee=n.find("#txtBuyingConveyancingFee");this.LinkBuyingConveyancingFee=n.find(".hrfBuyingConveyancingFee");this.TextSellingConveyancingFee=n.find("#txtSellingConveyancingFee");this.LinkSellingConveyancingFee=n.find(".hrfSellingConveyancingFee");this.divSellingPanel=n.find(".divSellingPanel");this.divBuyingPanel=n.find(".divBuyingPanel");this.divResultPanel=n.find(".divResultPanel");this.divSelling=n.find(".divSelling");this.divBuying=n.find(".divBuying")},startup:function(){this.NumberInput.forceNumeric();this.divBuyingPanel.hide();this.divResultPanel.hide();this.CostOfMoovingToolEvents();var n=this.StateAgentFeeIn.find("input:checked").val();this.PurpleBoxPanel.hide()},CostOfMoovingToolEvents:function(){var n=this;this.ContinueButton2.click(function(){n.divResultPanel.show();n.divSellingPanel.hide();n.divBuyingPanel.hide();n.GetResultBuyingSelling(n)});this.ContinueButton1.click(function(){n.divSellingPanel.hide();n.divBuyingPanel.show();n.divResultPanel.hide()});this.GoBackButton.click(function(){n.divSellingPanel.show();n.divBuyingPanel.hide();n.divResultPanel.hide()});this.StartAgainButton.click(function(){n.divSellingPanel.show();n.divBuyingPanel.hide();n.divResultPanel.hide()});this.SellingAmount.on("input paste keyup blur",function(){n.CalculateAgentFee()});this.StateAgentFeeIn.change(function(){n.CalculateAgentFee()});this.SellingEstateAgentFees.on("input paste keyup blur",function(){n.CalculateAgentFee()});this.LinkEnergyPerformanceCertificate.bind("click",function(){n.TextEnergyPerformanceCertificate.attr("ReadOnly",!1).focus()});this.TextEnergyPerformanceCertificate.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkHomeBuyerReport.bind("click",function(){n.TextHomeBuyerReport.attr("ReadOnly",!1).focus()});this.TextHomeBuyerReport.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkMortgageValuationFee.bind("click",function(){n.TextMortgageValuationFee.attr("ReadOnly",!1).focus()});this.TextMortgageValuationFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkMortgageFee.bind("click",function(){n.TextMortgageFee.attr("ReadOnly",!1).focus()});this.TextMortgageFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkRemovalCosts.bind("click",function(){n.TextRemovalCosts.attr("ReadOnly",!1).focus()});this.TextRemovalCosts.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkEstateAgentFee.bind("click",function(){n.TextEstateAgentFee.attr("ReadOnly",!1).focus()});this.TextEstateAgentFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkBuyingConveyancingFee.bind("click",function(){n.TextBuyingConveyancingFee.attr("ReadOnly",!1).focus()});this.TextBuyingConveyancingFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkSellingConveyancingFee.bind("click",function(){n.TextSellingConveyancingFee.attr("ReadOnly",!1).focus()});this.TextSellingConveyancingFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())})}});nbs.modules.CreditCardBenefitsCalc=nbs.declare(nbs.modules._Base,{balanceTransferEnabled:!1,purchasesEnabled:!1,prevValues:{apr:null,btAmount:null,purchasesAmount:null},initialise:function(n,t){this.inherited.apply(this,arguments);nbs.analytics.moduleAnalytics=!1;this.opts=t=$.extend(!0,{btFee:2,btMin:0,btPeriod:0,purchasesPeriod:0,hasRewardPurchase:!1,hasRewardTransfer:!1,minimumContributionPurchase:0,minimumContributionTransfer:0,allowCombinedContribution:!1},t);this.opts.btFee=t.btFee=t.btFee/100;this.displayFields={btSaving:n.find(".ccCalcBTSaving"),purchasesSaving:n.find(".ccCalcPurchasesSaving"),totalSaving:n.find(".ccBenefitsTotalSaving")};nbs.mode.isLive()&&this.$el.find(".rewardText").hide();this.analyticsHasRan=!1},startup:function(){var n=this.$el.find("#CreditCardBalanceSlider"),t=this.$el.find("#CreditCardPurchasesSlider");if(this.capture={},n.size()>0){this.balanceTransferEnabled=!0;this.capture.btSlider=nbs.registry.get(n);this.capture.btSlider.on("move",nbs.util.hitch(this,"btSliderMove"))}if(t.size()>0){this.purchasesEnabled=!0;this.capture.purchasesSlider=nbs.registry.get(t);this.capture.purchasesSlider.on("move",nbs.util.hitch(this,"purchasesSliderMove"))}if(this.balanceTransferEnabled||this.purchasesEnabled){this.capture.aprSlider=nbs.registry.get(this.$el.find("#CreditCardAPRSlider"));this.capture.aprSlider.on("move",nbs.util.hitch(this,"aprSliderMove"));nbs.mode.isLive()&&this._updateCalc(!0,"calledbyStartup")}},aprSliderMove:function(n){this.prevValues.apr!==n.value&&(this.prevValues.apr=n.value,this._updateCalc(!1,"calledByaprSliderMove"))},btSliderMove:function(n){this.prevValues.btAmount!==n.value&&(this.prevValues.btAmount=n.value,this._updateCalc(!1,"calledBybtSlidermove"))},purchasesSliderMove:function(n){this.prevValues.purchasesAmount!==n.value&&(this.prevValues.purchasesAmount=n.value,this._updateCalc(!1,"purchaseSliderMove"))},_updateCalc:function(n,t){var f=this.capture.aprSlider.getValue()/100,i=0,e,r,o,u;this.balanceTransferEnabled&&(e=this.capture.btSlider.getValue(),r=this._calcBalanceTransferSaving(f,e),this.displayFields.btSaving.html("&pound;"+nbs.number.formatWithCommas(r,2)),i+=r);this.purchasesEnabled&&(o=this.capture.purchasesSlider.getValue(),u=(Math.pow(1+f,1/12)-1)*this.opts.purchasesPeriod*o,this.displayFields.purchasesSaving.html("&pound;"+nbs.number.formatWithCommas(u,2)),i+=u);this.displayFields.totalSaving.html("&pound;"+nbs.number.formatWithCommas(i,2));this._displayRewards();this._usageAnalytics(n,t)},_displayRewards:function(){var i=this.capture.purchasesSlider.getValue()+this.capture.btSlider.getValue(),n=!1,t=!1;this.opts.allowCombinedContribution&&(i>=this.opts.minimumContributionPurchase||i>=this.opts.minimumContributionTransfer)&&(t=!0,n=!0);this.capture.purchasesSlider.getValue()>=this.opts.minimumContributionPurchase&&(n=!0);this.capture.btSlider.getValue()>=this.opts.minimumContributionTransfer&&(t=!0);nbs.mode.isLive()&&this.$el.find(".rewardText").hide();this.opts.hasRewardPurchase&&n&&this.$el.find(".rewardTextPurchases,.rewardTextCombined").show();this.opts.hasRewardTransfer&&t&&this.$el.find(".rewardTextTransfers,.rewardTextCombined").show()},_calcBalanceTransferSaving:function(n,t){var i=0;return t!==0&&(i=t*this.opts.btFee<this.opts.btMin?this.opts.btMin:t*this.opts.btFee,i=-i+(Math.pow(1+n,1/12)-1)*this.opts.btPeriod*t),i},_usageAnalytics:function(n){this.analyticsHasRan||n||(nbs.analytics.toolUsage({eVar4:"Credit Card Benefits Calculator|Interacted",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage"),this.analyticsHasRan=!0)}});nbs.modules.CreditCardBTFeeCalc=nbs.declare(nbs.modules._Base,{creditLimit:null,btFee:null,btMin:null,initialise:function(n,t){this.inherited.apply(this,arguments);this.$form=n.find(".form");this.$inputs=n.find("table input");this.$totalAmt=n.find("#lblTotalAmt");this.$totalFee=n.find("#lblTotalFee");this.$totalCost=n.find("#lblTotalCost");this.$warningMsg=n.find("div.warning").hide();this.$reduceCostBy=n.find("#lblReduceCostBy");this.$creditLimitLabel=n.find("span.creditLimit");this.$creditLimitInput=n.find(".creditLimitInput");this.$creditLimitTxt=n.find("#txtCreditLimit");this.$btFeeLabel=n.find(".btFee");this.$btMinFeeLabel=n.find(".btMinFee");this.$cardChooser=$("#cardTypeToggle");this.$cardTabs=this.$cardChooser.find("li");this.$offerChooser=$("#cardOfferToggles");this.$offerTabs=this.$offerChooser.find("li");this.$offerToggles=this.$offerChooser.find("nav");this.$cardChooser.on("click","li",nbs.util.hitch(this,"_handleCardChooserClick"));this.$offerChooser.on("click","li",nbs.util.hitch(this,"_handleCardOfferClick"));if(this.creditLimit=t.creditLimit?nbs.number.parse(t.creditLimit):0,!isNaN(this.creditLimit)&&this.creditLimit>0)this.$creditLimitInput.hide(),this.$creditLimitLabel.html("&pound;"+nbs.number.formatWithCommas(this.creditLimit));else{this.$creditLimitLabel.hide();this.$creditLimitTxt.on("keyup",nbs.util.hitch(this,"_handleCreditLimitChange"))}this.$inputs.on("keyup",nbs.util.hitch(this,"_calculate"))},_handleCardChooserClick:function(n){n.preventDefault();var t=$(n.currentTarget),i=t.data("card-id");this.$cardTabs.removeClass("active");t.addClass("active");this.$offerToggles.hide();$("#"+i).show();this.$offerChooser.slideDown();nbs.isLessThanTablet()&&nbs.dom.animateScrollToElement(this.$offerChooser,500,10)},_handleCardOfferClick:function(n){n.preventDefault();var t=$(n.currentTarget),i=nbs.number.parse(t.data("offer-fee")),r=nbs.number.parse(t.data("offer-min-fee"));isNaN(i)||isNaN(r)||(this.$offerTabs.removeClass("active"),t.addClass("active"),this.$form.slideDown(),this.btFee=i/100,this.btMin=r,this.$btFeeLabel.text(i+"%"),this.$btMinFeeLabel.html("&pound;"+nbs.number.formatWithCommas(r,2)),nbs.isLessThanTablet()&&nbs.dom.animateScrollToElement(this.$form,500,10),this._calculate())},_handleCreditLimitChange:function(){this.creditLimit=nbs.number.parse(this.$creditLimitTxt.val());this._calculate()},_calculate:function(){var n=this,r=0,u=0,t=0,i;this.$inputs.each(function(){var f=nbs.number.parse($(this).val()),o=$(this).closest("tr"),s=o.find(".fee"),h=o.find(".cost"),i=0,e=0;!isNaN(f)&&f>0?(i=f*n.btFee,i<n.btMin&&(i=n.btMin),e=f+i,s.html("&pound;"+nbs.number.formatWithCommas(i,2)),h.html("&pound;"+nbs.number.formatWithCommas(e,2)),r+=f,u+=i,t+=e):(s.html(""),h.html(""))});this.$totalAmt.html("&pound;"+nbs.number.formatWithCommas(r,2));this.$totalFee.html("&pound;"+nbs.number.formatWithCommas(u,2));this.$totalCost.html("&pound;"+nbs.number.formatWithCommas(t,2));i=t-this.creditLimit;i>0?(this.$reduceCostBy.html("&pound;"+nbs.number.formatWithCommas(i,2)),this.$totalCost.addClass("overLimit"),this.$warningMsg.show()):(this.$warningMsg.hide(),this.$totalCost.removeClass("overLimit"))}});~function(){var n={};nbs.template=function(t,i){var r;return n[t]||(r=n[t]=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+t.replace(/[\r\t\n]/g," ").split("{{").join("\t").replace(/((^|}})[^\t]*)'/g,"$1\r").replace(/\t=(.*?)}}/g,"',$1,'").split("\t").join("');").split("}}").join("p.push('").split("\r").join("\\'")+"');}return p.join('');")),i?r(i):r}}();nbs.modules.CreditCardComparison=nbs.declare(nbs.modules._Base,{slideSpeed:500,initialise:function(n){this.inherited.apply(this,arguments);this.data=[];var t=$("#creditCardDetailTemplate").html();this.templateFnc=nbs.template(t);this.isFirstRender=!0;this.$results=n.find("#results");this.$rows=this.$results.children(".row");this.$termValue=n.find(".termValue");this.$amountValue=n.find(".amountValue");this.$noInterestMonthlyRepayment=n.find("#noInterestMonthlyRepayment");n.on("click","#results > .row",nbs.util.hitch(this,"_clickHandler"));this.$rows.each(function(n){$(this).attr("data-id",n)});this._parseData()},startup:function(){this.slider=nbs.registry.get("amountSlider");this.termRadioGroup=nbs.registry.get("termRadioGroup");var n=this,t=null;this.slider.on("move",function(){clearTimeout(t);t=setTimeout(function(){n._changeHandler()},30)});this.termRadioGroup.on("change",function(){n._changeHandler()});this._changeHandler()},_parseData:function(){var n=this.data;this.$rows.each(function(){var i=$(this),t=new Function("return {"+i.data("nbsData")+"}")();t.id=i.attr("data-id");t.alt=t.alt||!1;t.repayMin=t.repayMin||25;t.repayPct=t.repayPct||3;t.rate=Math.pow(t.apr+1,1/12);t.name=i.find(".nameText").text();t.content=i.find("div.detail").html();t.$row=i;t.$total=i.find(".totalVal");t.$difference=i.find("div.difference");t.$differenceVal=t.$difference.find("span.differenceVal");t.$fee=i.find("span.fee");t.$interest=i.find("span.interest");t.$bar=i.find("div.bar");n.push(t)})},_clickHandler:function(n){var r=$(n.currentTarget),u=$(n.target),t,i;u.hasClass("showOverlay")||(t=r.index()-1,i=this.templateFnc(this._getTemplateData(t)),new nbs.modules.Overlay(nbs.dom.$pageBody,{content:i}))},_changeHandler:function(){nbs.util.defer(function(){this.amount=this.slider.getValue();this.term=parseInt(this.termRadioGroup.getValue(),10);this._calculate();this._sort();this.render()},this)},render:function(){var r,u,t;for(this.$termValue.text(this.term),this.$amountValue.text(this._format(this.amount)),this.$noInterestMonthlyRepayment.text(this._format(this._toFixed(this.amount/this.term))),r=this.data,u=this.isFirstRender?0:this.slideSpeed,this.$rows.detach(),t=0;t<r.length;t++){var n=this.data[t],f=n.results.total,i=f/this.max*100+"%";n.$total.text(this._format(f));n.$fee.text(this._format(n.results.fee));n.$interest.text(this._format(n.results.interest));this.$results.append(this.$rows.filter(function(){return $(this).attr("data-id")==n.id}));this.max===0&&(i=10);nbs.detect.is("ie")&&nbs.detect.getVersion()<9?n.$bar.width(i):n.$bar.stop().animate({width:i},u)}this.isFirstRender=!1},_sort:function(){for(var n,t=this.data,i=!0,r,u=1;u<t.length&&i;u++)for(i=!1,n=0;n<t.length-1;n++)t[n+1].results.total<t[n].results.total&&(r=t[n],t[n]=t[n+1],t[n+1]=r,i=!0)},_getTemplateData:function(n){var t=this.data[n],i=t.results.total,r=t.results.fee;return{data:{content:t.content,term:t.term,fee:t.fee,feeAmount:this._format(r),apr:t.apr,selectedTerm:this.term,difference:this._format(i-this.min),total:this._format(i),name:t.name,wrapperClass:t.alt?"":" overlayNormalActive"}}},_calculate:function(){var r,u,s,f;this.max=0;this.min=Infinity;var h=this.data,c=this.amount,l=this.term;for(r=0;r<h.length;r++){var t=h[r],e=this._toFixed(c/100*t.fee),n=c+e,i=0,a=Math.max(t.repayMin,n*(t.repayPct/100)),o=this._toFixed(n/l);for(o=Math.max(o,a),u=1;u<=l;u++)u>t.term&&(s=this._toFixed(n/100*t.rate),i+=s,n+=s),n-=Math.min(o,n),n=this._toFixed(n);i=this._toFixed(i);f=this._toFixed(e+i);this.max=Math.max(this.max,f);this.min=Math.min(this.min,f);t.results={fee:e,interest:i,total:f}}},_toFixed:function(n){return parseFloat(n.toFixed(2),10)},_format:function(n){return"£"+nbs.number.formatWithCommas(n,2)}});nbs.modules.CreditCardCashbackCalc=nbs.declare(nbs.modules._Base,{introRate:0,introTerm:0,standardRate:0,analyticsHasRan:!1,initialise:function(n,t){this.inherited.apply(this,arguments);this.introRate=t.introRate/100;this.introTerm=t.introTerm*1;this.standardRate=t.standardRate/100;this.$amountEarned=n.find(".ccCashbackEarned")},startup:function(){var t=this.$el.find("#CreditCardSpendSlider"),n=nbs.registry.get(t);n.on("move",nbs.util.hitch(this,"_spendSliderMove"));this._calculate({value:n.getValue()},!0)},_spendSliderMove:function(n){this._calculate(n,!1)},_calculate:function(n,t){var i=n.value*this.introTerm*this.introRate,r=12-this.introTerm,u=n.value*r*this.standardRate,f=i+u;this.$amountEarned.html(nbs.tidying.formatCurrency(f,2));t||this._usageAnalytics()},_usageAnalytics:function(){this.analyticsHasRan||(nbs.analytics.toolUsage({eVar4:"Credit Card CashBack Calculator|Interacted",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage"),this.analyticsHasRan=!0)}});nbs.modules.CreditCardRewardsCalc=nbs.declare(nbs.modules._Base,{rewardRatioDivisor:null,initialise:function(n,t){this.inherited.apply(this,arguments);this.rewardRatioDivisor=t.rewardRatioDivisor*1;this.$amountEarned=n.find(".ccAmountEarned")},startup:function(){var t=this.$el.find("#CreditCardSpendSlider"),n=nbs.registry.get(t);n.on("move",nbs.util.hitch(this,"spendSliderMove"));this.spendSliderMove({value:n.getValue()})},spendSliderMove:function(n){var t=n.value/this.rewardRatioDivisor;this.$amountEarned.html("&pound;"+nbs.number.formatWithCommas(t,2))}});nbs.modules.FxRatesTool=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$ddl=n.find("#currencyFilter select");this.$ddl.change(nbs.util.hitch(this,"_filterTable"))},_filterTable:function(){var n=this.$ddl.val();n!="*"?($("#fxTable tbody tr").hide(),$("#"+n).show()):$("#fxTable tbody tr").show()}});nbs.modules.HousePriceIndexCalc=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.analyticsHasRan=!1;this.$quarter=n.find("#valuQtr");this.$year=n.find("#valuYear");this.$quarter2=n.find("#valuQtr2");this.$year2=n.find("#valuYear2");this.$propValue=n.find("#propValue");this.$calculate=n.find("#calculatehpi");this.$regionLink=n.find(".valDetails .regionLink a");this.$calculateResult=n.find("#calculateResult");this.$percentageChange=n.find("#percentageChange");this.$regionPicker=n.find(".hpiRegionPicker");this.$regionPostCode=this.$regionPicker.find(".postcodebox");this.$regionMessageArea=this.$regionPicker.find(".messageArea");this.$regionMessage=this.$regionMessageArea.find(".message");this.opts=t=$.extend(!0,{prefix:"",formatter:null},t)},startup:function(){this.propValueSlider=nbs.registry.get("hpiPropValueSlider");this.selectYear=nbs.registry.get("hpiSelectYear");this.selectQtr=nbs.registry.get("hpiSelectQtr");this.selectYear2=nbs.registry.get("hpiSelectYear2");this.selectQtr2=nbs.registry.get("hpiSelectQtr2");this.selectRegion=nbs.registry.get("hpiRegions");this.regionPickerOverlay=nbs.registry.get("regionPicker");this.propValueSlider.on("move",nbs.util.hitch(this,"_updateValues"));this.selectYear.on("change",nbs.util.hitch(this,"_updateValues"));this.selectQtr.on("change",nbs.util.hitch(this,"_updateValues"));if(this.selectYear2!=null&&this.selectQtr2!=null){this.selectYear2.on("change",nbs.util.hitch(this,"_updateValues"));this.selectQtr2.on("change",nbs.util.hitch(this,"_updateValues"))}this.$calculate.click(nbs.util.hitch(this,"_calculateHpi"));this.$regionLink.click(nbs.util.hitch(this,"_showRegionPicker"));var n=this.$regionPicker.find("#findRegionButton");n.click(nbs.util.hitch(this,"_getHpiRegion"));this._updateValues()},_showRegionPicker:function(n){n.preventDefault();this.regionPickerOverlay.show()},_updateValues:function(){this.$propValue.text(this.propValueSlider.getFormattedValue());this.$year.text(this.selectYear.getValue());this.$quarter.text(this.selectQtr.getValue());this.selectYear2!=null&&this.selectQtr2!=null&&(this.$year2.text(this.selectYear2.getValue()),this.$quarter2.text(this.selectQtr2.getValue()))},_calculateHpi:function(n){var i;n.preventDefault();var r=this.propValueSlider.getValue(),u=this.selectYear.getValue(),f=this.selectQtr.getValue(),e=this.selectYear2?this.selectYear2.getValue():"",o=this.selectQtr2?this.selectQtr2.getValue():"",t=this.selectRegion.getValue();t=encodeURIComponent(t);i="/services/toolservice.svc/CalculateHPI?propval="+r+"&year1="+u+"&quarter1="+f+"&year2="+e+"&quarter2="+o+"&region="+t;$.ajax({dataType:"json",url:i,success:nbs.util.hitch(this,"_calculateSuccess")});this.analytics()},_calculateSuccess:function(n){var t=this.opts.formatter,i;typeof t=="function"?(i=t(Number(n.PropertyValue).toFixed(0)),this.$calculateResult.text(this.opts.prefix+i)):this.$calculateResult.text(this.opts.prefix+n.PropertyValue);this.$percentageChange.text(Number(n.PercentChange).toFixed(2)+"%")},_getHpiRegion:function(n){n.preventDefault();var t=this.$regionPostCode.val(),i="/services/toolservice.svc/GetHpiRegion?postcode="+t;this.$regionMessageArea.hide();$.ajax({dataType:"json",url:i,success:nbs.util.hitch(this,"_getRegionSuccess"),error:nbs.util.hitch(this,"_getRegionError")})},_getRegionSuccess:function(n){n.length>0?(this.selectRegion.setValue(n),this.regionPickerOverlay.hide()):(this.$regionMessageArea.show(),this.$regionMessage.text("We could not locate that postcode, please try again."))},_getRegionError:function(){this.$regionMessageArea.show();this.$regionMessage.text("An error has occurred, please try again later.")},analytics:function(){this.analyticsHasRan||(nbs.analytics.toolUsage({eVar4:"House Price Index Calculator|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage"),this.analyticsHasRan=!0)}});nbs.modules.InformationRequest=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$el=n},startup:function(){var n=$("#radNoDetailUsage");n.next().trigger("click")}});nbs.modules.LifeCoverCalculator=nbs.declare(nbs.modules.SteppedForm,{steppedFormName:"Life Cover Calculator",term:20,totalOutgoings:0,coverReqdTotal:0,coverInPlaceTotal:0,initialise:function(n){this.inherited.apply(this,arguments);this.$monthly_spend=n.find("#monthly_spend");this.$outgoings=n.find("#loans_cards, #council_tax, #car_petrol_insurance, #home_insurance, #gas_water_electricity, #food, #satellite_telephone, #child_care, #other");this.$coverWantedFields=n.find("#lump_sum, #outstanding_mortgage");this.$coverTotal=n.find("#cover_total");this.$coverInPlaceFields=n.find("#life_cover, #existing_savings, #death_in_service");this.$coverInPlaceTotal=n.find("#cover_in_place_total");this.$termOutput=n.find("#result_term");this.$resultsMortgage=n.find("#results_mortgage");this.$resultsMonthly=n.find("#results_monthly");this.$resultsExpenses=n.find("#results_expenses");this.$errorMessage=n.find("#errorOverlay .errorMessage");this._updateTermLabel();this._calcCoverWanted();this._calcCoverInPlace();this._bindFormEvents()},_bindFormEvents:function(){this.$monthly_spend.on("keyup",nbs.util.hitch(this,"_handleMonthlySpendKeyUp"));this.$outgoings.on("keyup",nbs.util.hitch(this,"_handleOutgoingsKeyUp"));this.$coverWantedFields.on("keyup blur",nbs.util.hitch(this,"_calcCoverWanted"));this.$coverInPlaceFields.on("keyup blur",nbs.util.hitch(this,"_calcCoverInPlace"));$(".termButton.increase").click(nbs.util.hitch(this,"_termButtonIncrease"));$(".termButton.decrease").click(nbs.util.hitch(this,"_termButtonDecrease"))},startup:function(){this.inherited.apply(this,arguments);this.errorOverlay=nbs.registry.get("errorOverlay");this.forms[0].customFormValidationFunction=nbs.util.hitch(this,"_handleStep1CustomValidation");this.forms[0].on("reset",nbs.util.hitch(this,"_resetStep1"))},_resetStep1:function(){this.$outgoings.prop("disabled",!1);this.$monthly_spend.prop("disabled",!1);this._calcCoverWanted();this._calcCoverInPlace()},_showErrorOverlay:function(n){this.$errorMessage.text(n);this.errorOverlay.show()},toggle:function(n){n==this.stepCount-1&&this._calcCoverReqd();this.inherited.apply(this,arguments)},_handleStep1CustomValidation:function(){var n=this._getMonthlyOutgoings(),t=!isNaN(n)&&n>0;return t?this.totalOutgoings=n:this._showErrorOverlay("Please enter a valid amount for your outgoings."),t},_getMonthlyOutgoings:function(){var t=0,n;return this.$monthly_spend.val().length>0&&(t=parseFloat(this.$monthly_spend.val())),n=0,this.$outgoings.each(function(){$(this).val().length>0&&(n+=parseFloat($(this).val()))}),t+n},_handleMonthlySpendKeyUp:function(){var n=this.$monthly_spend.val().length>0;this.$outgoings.prop("disabled",n)},_handleOutgoingsKeyUp:function(){var n=!1;this.$outgoings.each(function(){return n=$(this).val().length>0,n?!1:void 0});this.$monthly_spend.prop("disabled",n)},_calcCoverWanted:function(){var n=this;this.coverReqdTotal=0;this.$coverWantedFields.each(function(){if($(this).val().length>0){var t=parseFloat($(this).val());isNaN(t)||(n.coverReqdTotal+=t)}});this.$coverTotal.html("<strong>&pound;"+nbs.number.formatWithCommas(this.coverReqdTotal)+"<\/strong>")},_calcCoverInPlace:function(){var n=this;this.coverInPlaceTotal=0;this.$coverInPlaceFields.each(function(){if($(this).val().length>0){var t=parseFloat($(this).val());isNaN(t)||(n.coverInPlaceTotal+=t)}});this.$coverInPlaceTotal.html("<strong>&pound;"+nbs.number.formatWithCommas(this.coverInPlaceTotal)+"<\/strong>")},_termButtonIncrease:function(){this.term<25&&(this.term++,this._updateTermLabel(),this._calcCoverReqd())},_termButtonDecrease:function(){this.term>5&&(this.term--,this._updateTermLabel(),this._calcCoverReqd())},_updateTermLabel:function(){this.$termOutput.html("<strong>"+this.term+" years<\/strong>")},_calcCoverReqd:function(){var t=parseInt(this.totalOutgoings*12),n=parseInt(t*this.term),i=this._floorNumber(0,this.coverReqdTotal-this.coverInPlaceTotal),r=this._floorNumber(0,n-this.coverInPlaceTotal),u=this._floorNumber(0,n+parseInt(this.coverReqdTotal-this.coverInPlaceTotal));this.$resultsMortgage.html("<strong>&pound;"+nbs.number.formatWithCommas(i)+"<\/strong>");this.$resultsMonthly.html("<strong>&pound;"+nbs.number.formatWithCommas(r)+"<\/strong>");this.$resultsExpenses.html("<strong>&pound;"+nbs.number.formatWithCommas(u)+"<\/strong>")},_floorNumber:function(n,t){return t<n?n:t}});nbs.modules.LoansQuickQuote=nbs.declare(nbs.modules._Base,{productGuid:null,rates:null,initialise:function(n){this.inherited.apply(this,arguments);this.productGuid=n.attr("data-nbs-guid");this.$apr=n.find("span.qqApr");this.$monthlyRepay=n.find("span.qqRepaymentMonthly");this.$totalRepay=n.find("span.qqRepaymentTotal");this.$amount=n.find("span.qqAmount");this.$term=n.find("span.qqTerm");this.$quoteDate=n.find("span.qqRequestDate");this.$discount=n.find("span.qqDiscount");this.$aprRep=n.find("span.qqAprRep");this.$amountRep=n.find("span.qqAmountRep");this.$termRep=n.find("span.qqTermRep");this.$monthlyRepayRep=n.find("span.qqRepayMonthlyRep");this.$totalRepayRep=n.find("span.qqTotalRepayRep");this.analyticsHasRan=!1},startup:function(){this.productGuid&&(nbs.configData.get(this.productGuid,this.getRateDataCallback,this),this.$amountSlider=nbs.registry.get(this.$el.find("#LoanAmountSlider")),this.$termSlider=nbs.registry.get(this.$el.find("#LoanTermSlider")))},enableCalc:function(){this.$amountSlider.on("move",nbs.util.hitch(this,"amountSliderMove"));this.$termSlider.on("move",nbs.util.hitch(this,"termSliderMove"));this.changeQuote(!0)},getRateDataCallback:function(n,t){if(n){for(var i in t)break;this.rates=t[i];this.enableCalc()}else this.$el.find(".loanCalcLegal").hide(),this.$el.find(".loanCalcExample").hide()},amountSliderMove:function(n){this.prevAmount!=n.value&&(this.prevAmount=n.value,this.changeQuote())},termSliderMove:function(n){this.prevTerm!=n.value&&(this.prevTerm=n.value,this.changeQuote())},changeQuote:function(n){if(this.rates){var t=this.$amountSlider.getValue(),u=this.$termSlider.getValue(),e=this.getDate(),i=this.getRate(t),r=this.formatPerc(i.APR,1,1),f=this.getPayment(t,u,r);this.$apr.html(r);this.$monthlyRepay.html(nbs.tidying.formatCurrency(f.monthlyRepayment,2));this.$totalRepay.html(nbs.tidying.formatCurrency(f.totalRepayment,2));this.$amount.html(nbs.tidying.formatCurrency(t,0));this.$term.html(u);this.$quoteDate.html(e);this.$discount.html(i.Discount);this.updateRepresentativeExample(i,r);n||this._usageAnalytics()}},updateRepresentativeExample:function(n,t){var i=parseInt(n.RepExAmount,10),r=parseInt(n.RepExTerm,10),u=this.getPayment(i,r,t);this.$aprRep.html(t);this.$amountRep.html(nbs.tidying.formatCurrency(i,0));this.$termRep.html(r);this.$monthlyRepayRep.html(nbs.tidying.formatCurrency(u.monthlyRepayment,2));this.$totalRepayRep.html(nbs.tidying.formatCurrency(u.totalRepayment,2))},getRate:function(n){var i=null,r,t;for(r in this.rates)if(t=this.rates[r],n>=t.Floor&&n<=t.Ceiling){i=t;break}return i},getPayment:function(n,t,i){var s=t.toFixed(2),h=this.formatDec((Math.exp(Math.log(1+i/100,Math.exp)/12)-1)*100,6),u=this.repaymentFactor(t,i),f=this.formatDec(n/u,5),e=this.formatDec((f*t-n)/t/n*1200,4),r=this.formatDec(this.formatDec(n+n*t/12*(e/100),2)/t,2),o=this.formatDec(r*t,2);return{monthlyRepayment:r,totalRepayment:o}},repaymentFactor:function(n,t){var r=this.formatDec((Math.exp(Math.log(1+t/100,Math.exp)/12)-1)*100,6),i=this.formatDec(r/100,6),u=Math.log(i+1)/Math.log(Math.E),f=Math.exp(u*parseFloat(n)),e=1/(i*f),o=this.formatDec(1/i-e,4);return parseFloat(o)},formatDec:function(n,t,i){var u,r,e,o,f;if(t<=0)return Math.round(n);for(u=Math.pow(10,t),r=String(Math.round(n*u)/u),r.indexOf(".")==-1&&(r+=".00"),e=r.split("."),o=t-e[1].length+1,f=1;f<o;f++)r+="0";return i!=1&&(r=parseFloat(r)),r},formatPerc:function(n,t,i){var u,r,e,o,f;if(t<=0)return Math.round(n);for(u=Math.pow(10,t),r=String(Math.round(n*u)/u),r.indexOf(".")==-1&&(r+=".0"),e=r.split("."),o=t-e[1].length+1,f=1;f<o;f++)r+="0";return i!=1&&(r=parseFloat(r)),r},getDate:function(){var i=new Date,t=i.getDate(),n;return t.toString().length!=2&&(t="0"+t),n=i.getMonth()+1,n.toString().length!=2&&(n="0"+n),t+"/"+n+"/"+i.getFullYear()},qs:function(){var n=document.location.search,t;n=n!=""?n.substring(1):"";t=n.split("&");this.getKey=function(n){for(i=0;i<t.length;i++){var r=t[i].split("=");if(r.length==2&&r[0].toLowerCase()==n.toLowerCase())return r[1]}return""}},_usageAnalytics:function(){this.analyticsHasRan||(nbs.analytics.toolUsage({eVar4:"Loans Quick Quote|Interacted",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage"),this.analyticsHasRan=!0)}});nbs.modules.LoansQuickQuotePrimeChoice=nbs.declare(nbs.modules.LoansQuickQuote,{initialise:function(n){this.inherited.apply(this,arguments);this.$benefitsCalulator=n.find(".benefitsCalulator");this.$totalSaving=n.find("span.qqSaving")},startup:function(){if(this.inherited.apply(this,arguments),this.productGuid){this.$primeRadio=nbs.registry.get(this.$el.find(".primeRadio"));this.$primeRadio.on("change",nbs.util.hitch(this,"primeRadioChange"));this.primeRadioChange()}},primeRadioChange:function(){this.changeQuote(!1);this.$primeRadio.getValue()==="Yes"?this.$benefitsCalulator.addClass("prime"):this.$benefitsCalulator.removeClass("prime")},changeQuote:function(n){if(this.rates){var e=this.$primeRadio.getValue()==="Yes"?!0:!1,i=this.$amountSlider.getValue(),r=this.$termSlider.getValue(),o=this.getDate(),t=this.getRate(i),u=this.formatPerc(e?t.APRPrime:t.APR,1,1),f=this.getPayment(i,r,u),s=parseFloat(t.APRPrime)+1,h=this.getPayment(i,r,this.formatPerc(t.APRPrime,1,1)),a=this.getPayment(i,r,this.formatPerc(t.APR,1,1)),c=this.getPayment(i,r,this.formatPerc(s,1,1)),l=c.totalRepayment-h.totalRepayment;this.$totalSaving.html(nbs.tidying.formatCurrency(l,2));this.$apr.html(u);this.$monthlyRepay.html(nbs.tidying.formatCurrency(f.monthlyRepayment,2));this.$totalRepay.html(nbs.tidying.formatCurrency(f.totalRepayment,2));this.$amount.html(nbs.tidying.formatCurrency(i,0));this.$term.html(r);this.$quoteDate.html(o);this.$discount.html(t.Discount);this.updateRepresentativeExample(t,u);n||this._usageAnalytics()}}});nbs.modules.LoansQuickQuoteEnhanced=nbs.declare(nbs.modules.LoansQuickQuote,{initialise:function(n){this.inherited.apply(this,arguments);this.$loansCalculatorEnhanced=n.find("div.loansCalculatorEnhanced");this.$totalSaving=n.find("span.qqSaving");this.$amountToBorrowMore=n.find("span.amountToBorrowMore");this.slideDownDuration=n.attr("data-borrowMessage-setting");$(".panel.alert").hide()},startup:function(){if(this.inherited.apply(this,arguments),this.productGuid){this.$primeRadio=nbs.registry.get(this.$el.find(".primeRadio"));this.$primeRadio.on("change",nbs.util.hitch(this,"primeRadioChange"));this.primeRadioChange();this.$noObligationQuote=this.$el.find("div.noObligationQuoteUrl");this.$noObligationQuote.on("click",nbs.util.hitch(this,"noObligationQuote"));this.$noObligationQuote.attr("data-nbs-analytics-options","navigation:'personal loan calculator|Get a no obligation quote'");$(window).width()<=599&&($(".sliderCol").css({"margin-bottom":"35px"}),$(".radioGroupStyle01").css({"margin-top":"0px"}));$(window).width()<=1023&&($(".sliderCol").css({"margin-bottom":"35px"}),$(".radioGroupStyle01").css({"margin-top":"0px"}));$(window).width()>1023&&($(".sliderCol").css({"margin-bottom":"17px"}),$(".col").css({"margin-top":"0px"}),$(".radioGroupStyle01").css({"margin-top":"18px"}))}},primeRadioChange:function(){this.changeQuote(!1);var n=this.$primeRadio.getValue();n==="Yes"?this.$loansCalculatorEnhanced.addClass("prime"):this.$loansCalculatorEnhanced.removeClass("prime");event.type=="click"&&this.getAnalyticsForIsCurrentAccountHolder(n)},enableCalc:function(){this.$amountSlider.on("move",nbs.util.hitch(this,"amountSliderMove"));this.$termSlider.on("move",nbs.util.hitch(this,"termSliderMove"));this.changeQuote(!0);this.$amountSlider.on("dragend",nbs.util.hitch(this,"borrowMessage"));this.$amountSlider.$el.keyup(nbs.util.hitch(this,"borrowMessage"));this.$amountSlider.on("keydown",nbs.util.hitch(this,"borrowMessage"))},borrowMessage:function(){var n=this.getQuoteData(),t=$.map(this.rates,function(n){return[n]}),r,u,i,o,s;for(r in t)if(u=t[r],n.borrowAmt>=u.Floor&&n.borrowAmt<=u.Ceiling&&(i=parseInt(r.match(/\d+/g))),i>=0&&i!=t.length-1){var f=t[i+1],h=this.formatPerc(n.bPrime?f.APRPrime:f.APR,1,1),e=Math.round(f.Floor/25)*25;break}o=this.getPayment(e,n.term,h);n.payment.totalRepayment>o.totalRepayment?(s=e-n.borrowAmt,this.$amountToBorrowMore.html(nbs.tidying.formatCurrency(s,2)),$(".panel.alert").slideDown(this.slideDownDuration),$(".borrowMessageText").html(),$(window).width()<=599&&($(".panel").css({"margin-bottom":"35px"}),$(".sliderCol").css({"margin-bottom":"15px"}),$(".radioGroupStyle01").css({"margin-top":"20px"}),$(".col").css({"margin-top":"0px"})),$(window).width()>599&&$(window).width()<1023&&($(".panel").css({"margin-bottom":"35px"}),$(".sliderCol").css({"margin-bottom":"15px"}),$(".radioGroupStyle01").css({"margin-top":"20px"})),$(window).width()>1023&&($(".panel").css({"margin-bottom":"17px"}),$(".panel").css({"margin-top":"15px"}),$(".sliderCol").css({"margin-bottom":"15px"}),$(".radioGroupStyle01").css({"margin-top":"20px"}),$(".col").css({"margin-top":"0px"})),this.getAnalyticsForBorrowMessage(n.borrowAmt)):($(".panel.alert").slideUp(),$(window).width()<=599&&($(".sliderCol").css({"margin-bottom":"35px"}),$(".radioGroupStyle01").css({"margin-top":"0px"})),$(window).width()>599&&$(window).width()<1023&&($(".sliderCol").css({"margin-bottom":"35px"}),$(".radioGroupStyle01").css({"margin-top":"0px"})),$(window).width()>1023&&($(".sliderCol").css({"margin-bottom":"17px"}),$(".radioGroupStyle01").css({"margin-top":"18px"}),$(".col").css({"margin-top":"0px"})))},changeQuote:function(n){if(this.rates){var t=this.getQuoteData(),i=this.getDate();this.$totalSaving.html(nbs.tidying.formatCurrency(t.saving,2));this.$apr.html(t.rate);this.$monthlyRepay.html(nbs.tidying.formatCurrency(t.payment.monthlyRepayment,2));this.$totalRepay.html(nbs.tidying.formatCurrency(t.payment.totalRepayment,2));this.$amount.html(nbs.tidying.formatCurrency(t.borrowAmt,0));this.$term.html(t.term);this.$quoteDate.html(i);this.$discount.html(t.rateTier.Discount);this.updateRepresentativeExample(t.rateTier,t.rate);n||this._additionalAnalytics()}},getQuoteData:function(){var r=this.$primeRadio.getValue()==="Yes"?!0:!1,f=this.$primeRadio.getValue(),n=this.$amountSlider.getValue(),i=this.$termSlider.getValue(),t=this.getRate(n),u=this.formatPerc(r?t.APRPrime:t.APR,1,1),e=this.getPayment(n,i,u),o=parseFloat(t.APRPrime)+1,s=this.getPayment(n,i,this.formatPerc(t.APRPrime,1,1)),l=this.getPayment(n,i,this.formatPerc(t.APR,1,1)),h=this.getPayment(n,i,this.formatPerc(o,1,1)),c=h.totalRepayment-s.totalRepayment;return{borrowAmt:n,term:i,payment:e,saving:c,isCurrentAccountHolder:f,bPrime:r,rate:u,rateTier:t}},_additionalAnalytics:function(){this.analyticsHasRan||(nbs.analytics.toolUsage({eVar4:"Loans Quick Quote Enhanced|Interacted",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage"),this.analyticsHasRan=!0)},noObligationQuote:function(){var t=this.getQuoteData(),n={eVar4:"Loans Quick Quote Enhanced|Get a no obligation quote",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events,contextData.personal_loan_calc.loan_amount,contextData.personal_loan_calc.loan_term,contextData.personal_loan_calc.nbs_main_current_account,contextData.personal_loan_calc.monthly_repayment_amount,contextData.personal_loan_calc.total_repayment_amount,contextData.personal_loan_calc.typical_savings_nbs_member",contextData:{}};n.contextData["personal_loan_calc.loan_amount"]=t.borrowAmt;n.contextData["personal_loan_calc.loan_term"]=t.term;n.contextData["personal_loan_calc.nbs_main_current_account"]=t.isCurrentAccountHolder;n.contextData["personal_loan_calc.monthly_repayment_amount"]=t.payment.monthlyRepayment;n.contextData["personal_loan_calc.total_repayment_amount"]=t.payment.totalRepayment;n.contextData["personal_loan_calc.typical_savings_nbs_member"]=parseFloat(Math.round(t.saving*100)/100).toFixed(2);nbs.analytics.toolUsage(n,"personal loan calculator|Get a no obligation quote",!1)},getAnalyticsForBorrowMessage:function(n){nbs.analytics.toolUsage({linkTrackVars:"eVar4,events",linkTrackEvents:"event98",events:"event98"},"personal loan calculator|borrow more message|£"+n)},getAnalyticsForIsCurrentAccountHolder:function(n){nbs.analytics.toolUsage({linkTrackVars:"eVar4,events",linkTrackEvents:"event98",events:"event98"},"personal loan calculator|Is your main current account with Nationwide|"+n)}});~function(){var t="/services/toolservice.svc/GetMortgageRatesRange",i={unavailable:"Sorry, the mortgage rates search is currently unavailable. Please try again later."},n={existCustBorrowingMore:"ec-bm",existCustSwitchAndFix:"ec-sf"};nbs.modules.MortgageRatesAllRates=nbs.declare(nbs.modules._Base,{isInitialSearch:!0,scrollToResultsOnLoad:!1,searchStartTime:null,comparisonCheckboxes:[],initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t=$.extend(!0,{orderBy:"InitialRate",sortBy:"asc",index:0,take:0,maxPages:5,resultsPerPage:1e3,limitedResultsPerPage:50,mobileResultsPerPage:20,findRatesUrl:"",findRatesText:"",searchingContent:{},validations:{},firstSearchMinDuration:1e3,searchMinDuration:1e3,updateMinDuration:1e3,searchPage:"",scrollPadding:10,analytics:{tableType:"All Rates table",productCategory:"Mortgages",actionName:"Filter",filterOption:"no-filter-option-set"}},t);this.$el=n;this.pagination=!1;this.$results=n.find(".results");this.$results.hide();this.$filters=this.$results.find(".filters");this.$mortgageTypeFilter=this.$results.find(".filters .mortgageTypes");this.$mortgageRatesRows=n.find(".mortgageRatesRows");this.$tableDivDesktop=n.find(".tableDivDesktop");this.$tableDivMobile=n.find(".tableDivMobile");this.$mortgageResultCount=n.find(".allRatesMortgageResultCount");this.$mortgageResultsAnchor=n.find("#mortgageResultsAnchor");this.$paginationTemplate=n.find("#allRatesPaginationTemplate");this.$pagination=n.find(".allRatesPaginationTemplate");this.$paginationTop=n.find(".allRatesPaginationTemplateTop");this.$mortgageRateHeaders=n.find("thead");this.$loadingOverlay=n.find("#allRatesLoadingOverlay");this.$loadingOverlayLightbox=this.$loadingOverlay.find(".lightboxContent");this.$loadingContent=this.$loadingOverlay.find(".searchOverlayContent");this.$loadingImgContainer=this.$loadingOverlay.find(".searchImageContainer");this.$loadingImg=this.$loadingImgContainer.children("img");this.$errorMessage=n.find("#allRatesErrorOverlay div.errorMessage");this.$errorsTemplate=n.find("#allRatesErrorsTemplate");this.$infoMessage=n.find("#allRatesInfoOverlay div.infoMessage");this.noResultsMessage=n.find(".noResultsMessage").html();this.$findRates=n.find(".findRates");this.inTabs=nbs.registry.getAncestors(n,["Tabs"]).length>0?!0:!1;this.firstSearchOnTabChange=!1;this._getSearchingContent();this._printTooltips()},startup:function(){var i=this,t,n;for(this.fixedOption=nbs.registry.get("all-"+this.opts.buyerType+"-fixed"),this.trackerOption=nbs.registry.get("all-"+this.opts.buyerType+"-tracker"),this.dealTwoOption=nbs.registry.get("all-"+this.opts.buyerType+"-deal-two"),this.dealThreeOption=nbs.registry.get("all-"+this.opts.buyerType+"-deal-three"),this.dealFourOption=nbs.registry.get("all-"+this.opts.buyerType+"-deal-four"),this.dealFiveOption=nbs.registry.get("all-"+this.opts.buyerType+"-deal-five"),this.dealTenOption=nbs.registry.get("all-"+this.opts.buyerType+"-deal-ten"),this.productFeeOption=nbs.registry.get("all-"+this.opts.buyerType+"-fee"),this.productNoFeeOption=nbs.registry.get("all-"+this.opts.buyerType+"-nofee"),this.loadingOverlay=nbs.registry.get("allRatesLoadingOverlay"),this.updatingOverlay=nbs.registry.get("allRatesUpdatingOverlay"),this.errorOverlay=nbs.registry.get("allRatesErrorOverlay"),this.infoOverlay=nbs.registry.get("allRatesInfoOverlay"),this.$el.find(".filterTable button").click(function(n){n.preventDefault();i._searchMortgages()}),t=nbs.registry.getDescendents(this.$el.find(".filters"),["Checkbox"]),n=0;n<t.length;n++)t[n].on("change",nbs.util.hitch(this,"_filterCheckClick"));this.$tableDivMobile.on("click","div.backToSearch a",nbs.util.hitch(this,"_handleBackToSearchClick"));this.$results.on("click",".findRates",nbs.util.hitch(this,"_findRatesClick"));if(this.inTabs)this.on("ancestor-opened",nbs.util.hitch(this,"_tabSwitched"));else nbs.dispatcher.on("nbs/initialise",nbs.util.hitch(this,"_searchMortgages",!0))},_filterCheckClick:function(){this.opts.index=0;this._searchMortgages(!0)},_initialisePagination:function(n,t,i){var u=nbs.registry.get(this.$tableDivDesktop);if(u.off("sort"),i===n){this.pagination=!1;return}u.on("sort",nbs.util.hitch(this,"_sortClick"));this.pagination=!0;var f=n||0,r=i||20,e=t||0;this.pagedResults={};this.pagedResults.TotalCount=f;this.pagedResults.MaxPages=this.opts.maxPages;this.pagedResults.ResultIndex=e;this.pagedResults.ResultTake=r;this.pagedResults.ResultPages=[];this.pagedResults.ResultPages.length=Math.ceil(f/r);this.pagedResults.ResultPage=Math.floor(e/r)+1},_findRatesClick:function(){nbs.dom.animateScrollToElement(this.$el.find(".filterTable"),1e3,this.opts.scrollPadding)},_tabSwitched:function(){this.firstSearchOnTabChange||(this._searchMortgages(!0),this.firstSearchOnTabChange=!0)},_handleBackToSearchClick:function(n){n.preventDefault();nbs.dom.animateScrollToElement(this.$el,500,this.opts.scrollPadding)},_getSearchingContent:function(){var n=this;this.$el.find(".searchingContent").each(function(){var t=nbs.parser.getOptions($(this),"nbs"),i=$(this).html();t.borrowerType&&t.borrowerType.length>0&&(n.opts.searchingContent[t.borrowerType]={content:i,imageUrl:t.imageUrl});$(this).remove()})},_getCurrentFilters:function(){var n=[];return this.dealTwoOption&&(this.dealTwoOption.getChecked()?n.push(this.dealTwoOption.getLabel()+":Y"):n.push(this.dealTwoOption.getLabel()+":N")),this.dealThreeOption&&(this.dealThreeOption.getChecked()?n.push(this.dealThreeOption.getLabel()+":Y"):n.push(this.dealThreeOption.getLabel()+":N")),this.dealFourOption&&(this.dealFourOption.getChecked()?n.push(this.dealFourOption.getLabel()+":Y"):n.push(this.dealFourOption.getLabel()+":N")),this.dealFiveOption&&(this.dealFiveOption.getChecked()?n.push(this.dealFiveOption.getLabel()+":Y"):n.push(this.dealFiveOption.getLabel()+":N")),this.dealTenOption&&(this.dealTenOption.getChecked()?n.push(this.dealTenOption.getLabel()+":Y"):n.push(this.dealTenOption.getLabel()+":N")),this.fixedOption&&(this.fixedOption.getChecked()?n.push(this.fixedOption.getLabel()+":Y"):n.push(this.fixedOption.getLabel()+":N")),this.trackerOption&&(this.trackerOption.getChecked()?n.push(this.trackerOption.getLabel()+":Y"):n.push(this.trackerOption.getLabel()+":N")),this.productFeeOption&&(this.productFeeOption.getChecked()?n.push(this.productFeeOption.getLabel()+":Y"):n.push(this.productFeeOption.getLabel()+":N")),this.productNoFeeOption&&(this.productNoFeeOption.getChecked()?n.push(this.productNoFeeOption.getLabel()+":Y"):n.push(this.productNoFeeOption.getLabel()+":N")),n.join("/")},_bindPaginationEvents:function(){this.$pagination.off("click");this.$pagination.on("click","a",{self:this},this._paginationClick);this.$paginationTop.off("click");this.$paginationTop.on("click","a",{self:this},this._paginationClick)},_sortClick:function(n,t){this.opts.index=0;var i=this.$mortgageRateHeaders.find("th").eq(n).attr("data-nbs-mortgages-orderBy");this.opts.orderBy=i;this.opts.sortBy=t.replace("ending","");this._searchMortgages(!0);nbs.dom.animateScrollToElement(this.$mortgageResultsAnchor,1e3,this.opts.scrollPadding)},_paginationClick:function(n){var t=n.data.self,i=$(this).attr("data-nbs-mortgages-index");t.opts.index=i;t._searchMortgages(!0);nbs.dom.animateScrollToElement(t.$mortgageResultsAnchor,1e3,t.opts.scrollPadding)},_setTakeAmount:function(){return nbs.isLessThanTablet()?this.opts.mobileResultsPerPage:nbs.detect.isIe()||nbs.isTablet()?this.opts.limitedResultsPerPage:this.opts.resultsPerPage},_runAnalytics:function(){var n=[],t;if(n.push(this.opts.analytics.tableType),n.push(this.opts.analytics.productCategory),n.push(this.opts.analytics.actionName),n.push(this._getCurrentFilters()),n=n.join("|"),this.analyticsHasRan)nbs.analytics.customLink(n);else try{t={eVar4:"Mortgage Table Search|Interacted",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events,contextData.tool.mortgage.borrower_type"};t.contextData={"tool.mortgage.borrower_type":this.opts.buyerType};nbs.analytics.toolUsage(t,n);this.analyticsHasRan=!0}catch(i){}},_showErrorOverlay:function(n,t){this.$errorMessage.html(this.$errorsTemplate.tmpl({messageTitle:n,errors:t}));this.errorOverlay.show()},_searchMortgages:function(i){var r=this.opts.buyerType,f,e,o;if($activeElement=$(document.activeElement),r!="null"&&r!=""){this._runAnalytics();r==n.existCustSwitchAndFix?this.$mortgageTypeFilter.hide():this.$mortgageTypeFilter.show();i||(this._resetFilters(r),this.$results.hide());var s=this.fixedOption.getChecked(),h=this.trackerOption.getChecked(),l=s&&h?"all":s?"fixed":h?"tracker":"all",u=[],c;return this.dealTwoOption&&this.dealTwoOption.getChecked()&&u.push(2),this.dealThreeOption&&this.dealThreeOption.getChecked()&&u.push(3),this.dealFourOption&&this.dealFourOption.getChecked()&&u.push(4),this.dealFiveOption&&this.dealFiveOption.getChecked()&&u.push(5),this.dealTenOption&&this.dealTenOption.getChecked()&&u.push(10),c=u.join(","),f="all",this.productFeeOption&&this.productNoFeeOption&&(e=this.productFeeOption.getChecked(),o=this.productNoFeeOption.getChecked(),f=e&&o?"all":e?"fee":o?"nofee":"all"),i?this.updatingOverlay.show():this._showLoadingOverlay(r),this.opts.take=this._setTakeAmount(),this.searchStartTime=new Date,$.ajax({dataType:"json",url:t,global:!1,cache:!1,type:"GET",context:this,data:{buyerType:r,productType:l,dealPeriod:c,productFee:f,searchPage:this.opts.searchPage,orderBy:this.opts.orderBy,sortBy:this.opts.sortBy,index:this.opts.index,take:this.opts.take},success:function(n,t,u){this._getMortgageRatesSuccess(n,t,u,i,r);$activeElement.focus()},error:nbs.util.hitch(this,"_getMortgageRatesError")}),!1}},_getMortgageRatesSuccess:function(n,t,i,r,u){var o=new Date,e=new Date(o-this.searchStartTime),f=0;this.isInitialSearch?(f=new Date(this.opts.firstSearchMinDuration-e),this.isInitialSearch=!1):f=r?new Date(this.opts.updateMinDuration-e):new Date(this.opts.searchMinDuration-e);f>0?nbs.util.defer(function(){this._extractMortgageRatesData(n,u,r)},this,f):this._extractMortgageRatesData(n,u,r)},_extractMortgageRatesData:function(n,t,i){var r=this._extendRatesData(n.Rates,t),u,f,e;this._hideLoadingOverlays();this._initialisePagination(n.TotalCount,n.ResultIndex,n.ResultTake);this.$mortgageResultCount.text(n.TotalCount);n.ResultCount>0?(this.$pagination.empty(),this.$paginationTop.empty(),nbs.isLessThanTablet()?(this.$tableDivDesktop.hide(),this.$mortgageRatesRows.empty(),this.$tableDivMobile.html($("#allRatesMobileTable").tmpl(r,{findRatesUrl:this.opts.findRatesUrl,findRatesText:this.opts.findRatesText})).show(),this.pagination&&(this.$pagination.html(this.$paginationTemplate.tmpl(this.pagedResults)),this.$tableDivMobile.append(this.$pagination)),nbs.parser.parse(this.$tableDivMobile)):(this.$tableDivMobile.empty().hide(),this.$mortgageRatesRows.html($("#allRatesTableRow").tmpl(r,{findRatesUrl:this.opts.findRatesUrl,findRatesText:this.opts.findRatesText})),this.pagination&&(u=this.$paginationTemplate.tmpl(this.pagedResults),f=this.$paginationTemplate.tmpl(this.pagedResults,{alignRight:!0}),this.$pagination.html(u),this.$paginationTop.html(f)),this.$tableDivDesktop.show(),nbs.parser.parse(this.$tableDivDesktop)),i||this._updateFilters(n.Rates),nbs.analytics.bindEvents(),this._removeDiscountedProducts(),this.$results.show(),this._bindPaginationEvents(),e=this.$el.find(".addedSection.open"),e.length>0?this.$el.find(".annualSavingInfo").show():this.$el.find(".annualSavingInfo").hide(),!i&&(this.scrollToResultsOnLoad||nbs.isLessThanTablet())&&(nbs.dom.animateScrollToElement(this.$results,1e3,this.opts.scrollPadding),this.scrollToResultsOnLoad=!1),nbs.registry.purge()):i?(this.$tableDivMobile.hide(),this.$tableDivDesktop.hide()):(this.$results.hide(),this.$infoMessage.html(this.noResultsMessage),this.infoOverlay.show())},_removeDiscountedProducts:function(){$(".featuresList .tooltipText p:contains(Reduced product fee)",this.$results).closest("li").remove()},_extendRatesData:function(n,t){var i,r;if(n)for(i=0;i<n.length;i++)r=n[i],r.BuyerType=t,r.Index=i;return n},_resetFilters:function(t){this.dealTwoOption&&this.dealTwoOption.setChecked(!1);this.dealThreeOption&&this.dealThreeOption.setChecked(!1);this.dealFourOption&&this.dealFourOption.setChecked(!1);this.dealFiveOption&&this.dealFiveOption.setChecked(!1);this.dealTenOption&&this.dealTenOption.setChecked(!1);this.fixedOption&&this.fixedOption.setChecked(!1);this.trackerOption&&this.trackerOption.setChecked(!1);this.productFeeOption.setChecked(!1);this.productNoFeeOption.setChecked(!1);t==n.existCustSwitchAndFix?this.$mortgageTypeFilter.hide():this.$mortgageTypeFilter.show()},_updateFilters:function(n){var r=0,u=0,f=0,e=0,o=0,s=0,t,i,h;if(period10=0,n){for(t=0;t<n.length;t++){i=n[t];h=i.Term/12;i.MortgageType==0?r++:i.MortgageType==1&&u++;switch(h){case 2:f++;break;case 3:e++;break;case 4:o++;break;case 5:s++;break;case 10:period10++}}this._setFilterAvailability(this.fixedOption,r);this._setFilterAvailability(this.trackerOption,u);this._setFilterAvailability(this.dealTwoOption,f);this._setFilterAvailability(this.dealThreeOption,e);this._setFilterAvailability(this.dealFourOption,o);this._setFilterAvailability(this.dealFiveOption,s);this.dealTenOption&&this._setFilterAvailability(this.dealTenOption,period10)}},_setFilterAvailability:function(n,t){n&&(t>0?n.enable():(n.disable(),n.setChecked(!1)))},_getMortgageRatesError:function(){this._hideLoadingOverlays();this._showErrorOverlay(i.unavailable)},_showLoadingOverlay:function(n){if(this.$loadingContent.hide(),this.$loadingImgContainer.hide(),this.$loadingOverlayLightbox.removeClass("col8").addClass("col4"),this.isInitialSearch){var t=this.opts.searchingContent[n];t&&t.content&&(this.$loadingOverlayLightbox.removeClass("col4").addClass("col8"),this.$loadingContent.html(t.content).show(),t.imageUrl&&t.imageUrl.length>0&&(this.$loadingImgContainer.show(),this.$loadingImg.attr("src",t.imageUrl)))}this.loadingOverlay.show()},_hideLoadingOverlays:function(){this.loadingOverlay.hide();this.updatingOverlay.hide()},_printTooltips:function(){var n=this.$tableDivDesktop.find("th div.tooltip");if(n.size()>0){var r=$('<div id="tooltipKey"><h2>Notes about this page<\/h2><\/div>'),t=$("<ol><\/ol>"),i=1;n.each(function(){$(this).after('<span class="toolTipIndex">See note '+i+"<\/span>");t.append("<li>"+$(this).find(".tooltipText").html()+"<\/li>");i++});$(".contentBody").append(r.append(t))}}})}();~function(){var i="/services/toolservice.svc/GetFullMortgageRatesForSearch",n={borrowerTypeError:"Select a borrower type",propertyValueError:"Enter a property value",mortgageAmountError:"Enter a mortgage amount",existingMtgAmtError:"Enter existing mortgage amount",additionalBorrowingError:"Enter additional borrowing amount",termError:"Enter a mortgage term",messagesTitle:"Please correct the following errors:",maxComparison:"A maximum of three mortgages can be selected to compare.",minComparison:"Please select at least two mortgages to compare.",unavailable:"Sorry, the mortgage rates search is currently unavailable. Please try again later."},t={existCustBorrowingMore:"ec-bm",existCustSwitchAndFix:"ec-sf"};nbs.modules.MortgageRates=nbs.declare(nbs.modules._Base,{isInitialSearch:!0,scrollToResultsOnLoad:!1,searchStartTime:null,searchResults:[],comparisonCheckboxes:[],initialise:function(n,t){this.inherited.apply(this,arguments);this.$el=n;t=this.opts=$.extend(!0,{searchingContent:{},validations:{},firstSearchMinDuration:1e3,searchMinDuration:1e3,updateMinDuration:1e3,searchPage:"",scrollPadding:10,analytics:{tableType:"Rates table",productCategory:"Mortgages",actionName:"Filter",filterOption:"no-filter-option-set"}},t);this.$buyerType=n.find("#BorrowerType");this.$propVal=n.find("#propValue");this.$mortgageAmount=n.find("#mortgageAmount");this.$additionalBorrowing=n.find("#additionalBorrowing");this.$term=n.find("#term");this.$results=n.find(".results").hide();this.$filters=this.$results.find(".filters");this.$mortgageTypeFilter=this.$results.find(".filters .mortgageTypes");this.$loadingOverlay=n.find("#loadingOverlay");this.$loadingOverlayLightbox=this.$loadingOverlay.find(".lightboxContent");this.$loadingContent=this.$loadingOverlay.find(".searchOverlayContent");this.$loadingImgContainer=this.$loadingOverlay.find(".searchImageContainer");this.$loadingImg=this.$loadingImgContainer.children("img");this.$comparisonTable=n.find("#comparisonTableBody");this.$comparisonTemplate=n.find("#comparisonTemplate");this.$errorMessage=n.find("#errorOverlay div.errorMessage");this.$errorsTemplate=n.find("#errorsTemplate");this.$infoMessage=n.find("#infoOverlay div.infoMessage");this.noResultsMessage=n.find(".noResultsMessage").html();n.find(".additionalContent").hide();this._getSearchingContent();this._setUpSeeIfYouCanSaveSections();this._printTooltips();this.inTabs=nbs.registry.getAncestors(n,["Tabs"]).length>0?!0:!1;this.firstSearchOnTabChange=!1},_tabSwitched:function(){!this.firstSearchOnTabChange&&this.opts.autoSearch&&(this.scrollToResultsOnLoad=!1,this._searchMortgages(),this.firstSearchOnTabChange=!0)},startup:function(){var t=this,r,i,n;if(this.fixedOption=nbs.registry.get("fixed"),this.trackerOption=nbs.registry.get("tracker"),this.dealTwoOption=nbs.registry.get("deal-two"),this.dealThreeOption=nbs.registry.get("deal-three"),this.dealFourOption=nbs.registry.get("deal-four"),this.dealFiveOption=nbs.registry.get("deal-five"),this.dealTenOption=nbs.registry.get("deal-ten"),this.productFeeOption=nbs.registry.get("product-fee-fee"),this.productNoFeeOption=nbs.registry.get("product-fee-nofee"),this.loadingOverlay=nbs.registry.get("loadingOverlay"),this.updatingOverlay=nbs.registry.get("updatingOverlay"),this.errorOverlay=nbs.registry.get("errorOverlay"),this.infoOverlay=nbs.registry.get("infoOverlay"),this.comparisonOverlay=nbs.registry.get("comparisonOverlay"),this.inTabs){this.on("ancestor-opened",nbs.util.hitch(this,"_tabSwitched"));$(".inPageToggles .tabSection:first").has("#MortgageRatesModule").length>0&&(r=nbs.hash.get().length==0||nbs.hash.get().length>0&&nbs.hash.get().indexOf("xtab")<0||nbs.hash.get().indexOf($(".inPageToggles .tabSection:first").attr("id"))>=0?!0:!1,r&&this.opts.autoSearch&&(this.scrollToResultsOnLoad=!0,this._searchMortgages(),this.firstSearchOnTabChange=!0))}else this.opts.autoSearch&&(this.scrollToResultsOnLoad=!0,this._searchMortgages());for(this.$el.find(".filterTable button").click(function(n){n.preventDefault();t._searchMortgages()}),i=nbs.registry.getDescendents(this.$el.find(".filters"),["Checkbox"]),n=0;n<i.length;n++)i[n].on("change",function(){t._searchMortgages(!0)});this.$el.find("#tableDivDesktop .compareButton").click(function(n){n.preventDefault();t._compareMortgages()});$("#tableDivMobile").on("click","div.backToSearch a",nbs.util.hitch(this,"_handleBackToSearchClick"))},_handleBackToSearchClick:function(n){n.preventDefault();nbs.dom.animateScrollToElement(this.$el,500,this.opts.scrollPadding)},_getSearchingContent:function(){var n=this;this.$el.find(".searchingContent").each(function(){var t=nbs.parser.getOptions($(this),"nbs"),i=$(this).html();t.borrowerType&&t.borrowerType.length>0&&(n.opts.searchingContent[t.borrowerType]={content:i,imageUrl:t.imageUrl});$(this).remove()})},_setUpSeeIfYouCanSaveSections:function(){this.$el.find(".searchBar .addedSection").each(function(){var n=$(this).find("input.currentRate"),t=$(this).find("input.currentPayment");n.on("keyup",function(){t.prop("disabled",$(this).val().length>0)});t.on("keyup",function(){n.prop("disabled",$(this).val().length>0)})});this.$results.on("click","a.annualSavingLink",nbs.util.hitch(this,"_handleAnnualSavingLinkClick"))},_handleAnnualSavingLinkClick:function(n){n.preventDefault();var t=$(".addedSection.open"),i;t.size()>0&&(i=nbs.registry.get(t),i&&(i.open(0),nbs.dom.animateScrollToElement(t)))},_getCurrentFilters:function(){var n=[];this.dealTwoOption&&n.push(this.dealTwoOption);this.dealThreeOption&&n.push(this.dealThreeOption);this.dealFourOption&&n.push(this.dealFourOption);this.dealFiveOption&&n.push(this.dealFiveOption);this.dealTenOption&&n.push(this.dealTenOption);this.fixedOption&&n.push(this.fixedOption);this.trackerOption&&n.push(this.trackerOption);this.productFeeOption&&n.push(this.productFeeOption);this.productNoFeeOption&&n.push(this.productNoFeeOption);var t=[],i=n.length,r=0,u=0;return $.each(n,function(n,f){f.getChecked()?(r++,t.push(f.getLabel()+":Y")):u++;r==i&&(t=[],t.push("ALL:Y"));u==i&&(t=[],t.push("ALL:N"))}),t.join("/")},_runAnalytics:function(){var n=[],t;if(n.push(this.opts.analytics.tableType),n.push(this.opts.analytics.productCategory),n.push(this.opts.analytics.actionName),n.push(this._getCurrentFilters()),n=n.join("|"),this.analyticsHasRan)nbs.analytics.customLink(n);else try{t={eVar4:"Mortgage Table Search|Interacted",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events,contextData.tool.mortgage.borrower_type"};t.contextData={"tool.mortgage.borrower_type":this.$buyerType.val()};nbs.analytics.toolUsage(t,n);this.analyticsHasRan=!0}catch(i){}},_validateSearchCriteria:function(i,r,u,f,e,o,s){var h=[],p=this.$buyerType.children("option:selected").index(),v=!0,l,a,c,y;if(this.$el.find(".form .formField").removeClass("error"),p==0&&(h.push(n.borrowerTypeError),this.$buyerType.closest(".formField").addClass("error")),r==0&&(h.push(n.propertyValueError),this.$propVal.closest(".formField").addClass("error")),u==0&&(i==t.existCustBorrowingMore?h.push(n.existingMtgAmtError):h.push(n.mortgageAmountError),this.$mortgageAmount.closest(".formField").addClass("error")),i==t.existCustBorrowingMore&&f==0&&(h.push(n.additionalBorrowingError),this.$additionalBorrowing.closest(".formField").addClass("error")),o==0&&(h.push(n.termError),this.$term.closest(".formField").addClass("error")),h.length==0)for(a=0;a<this.opts.validations.length;a++)if(c=this.opts.validations[a],y=!0,c.types&&nbs.util.indexOfItem(c.types,i)!=-1&&(y=this._checkRule(c,e,s,o,r),y))if(c.isInfo){l=c.message;break}else h.push(c.message);return l&&l.length>0?(this.$infoMessage.html("<p>"+l+"<\/p>"),this.infoOverlay.show(),v=!1):h.length>0&&(this._showErrorOverlay(n.messagesTitle,h),v=!1),v},_showErrorOverlay:function(n,t){this.$errorMessage.html(this.$errorsTemplate.tmpl({messageTitle:n,errors:t}));this.errorOverlay.show()},_searchMortgages:function(n){var r=this.$buyerType.val(),f=nbs.tidying.cleanNumerical(this.$propVal.val()),e=nbs.tidying.cleanNumerical(this.$mortgageAmount.val()),o=nbs.tidying.cleanNumerical(this.$additionalBorrowing.val()),s=this._getRelevantMortgageAmount(r,e,o),h=nbs.tidying.cleanNumerical(this.$term.val()),c=this._getLtv(r,f,e,o),b=$(document.activeElement);if(this.productFeeOption&&this.productNoFeeOption)var l=this.productFeeOption.getChecked(),a=this.productNoFeeOption.getChecked(),v=l&&a?"all":l?"fee":a?"nofee":"all";if(this._runAnalytics(),n||(this._resetFilters(r),this.$results.hide()),this._validateSearchCriteria(r,f,e,o,s,h,c)){var y=this.fixedOption.getChecked(),p=this.trackerOption.getChecked(),k=y&&p?"all":y?"fixed":p?"tracker":"all",u=[],w;this.dealTwoOption&&this.dealTwoOption.getChecked()&&u.push(2);this.dealThreeOption&&this.dealThreeOption.getChecked()&&u.push(3);this.dealFourOption&&this.dealFourOption.getChecked()&&u.push(4);this.dealFiveOption&&this.dealFiveOption.getChecked()&&u.push(5);this.dealTenOption&&this.dealTenOption.getChecked()&&u.push(10);w=u.join(",");this._showMortgageSpecificContent(r,f,s,h,c);n?this.updatingOverlay.show():this._showLoadingOverlay(r);this.searchStartTime=new Date;$.ajax({dataType:"json",url:i,global:!1,cache:!1,type:"GET",context:this,data:{buyerType:r,loanToValueTier:c,productType:k,mortgageTerm:h,mortgageAmount:s,dealPeriod:w,productFee:v?v:"all",propertyValue:f,existingBorrowing:r==t.existCustBorrowingMore?e:0,searchPage:this.opts.searchPage},success:function(t,i,u){this._getMortgageRatesSuccess(t,i,u,n,r);b.focus()},error:nbs.util.hitch(this,"_getMortgageRatesError")})}return!1},_getMortgageRatesSuccess:function(n,t,i,r,u){var o=new Date,e=new Date(o-this.searchStartTime),f=0;this.isInitialSearch?(f=new Date(this.opts.firstSearchMinDuration-e),this.isInitialSearch=!1):f=r?new Date(this.opts.updateMinDuration-e):new Date(this.opts.searchMinDuration-e);f>0?nbs.util.defer(function(){this._extractMortgageRatesData(n,u,r)},this,f):this._extractMortgageRatesData(n,u,r)},_extractMortgageRatesData:function(n,t,i){var r=this._extendRatesData(n.Rates,t),u;this._hideLoadingOverlays();$(".mortgageResultCount").text(n.ResultCount);n.ResultCount>0?(this.searchResults=r,nbs.isLessThanTablet()?($("#tableDivDesktop").hide(),$("#mortgageRatesRows").empty(),$("#tableDivMobile").html($("#mobileTable").tmpl(r)).show(),nbs.parser.parse($("#tableDivMobile"))):($("#tableDivMobile").empty().hide(),$("#mortgageRatesRows").html($("#tableRow").tmpl(r)),$("#tableDivDesktop").show(),nbs.parser.parse($("#mortgageRatesRows")),this._updateComparisonCheckboxes()),i||this._updateFilters(n.Rates),nbs.analytics.bindEvents(),this._removeDiscountedProducts(),this.$results.show(),u=$(".addedSection.open"),u.length>0?$(".annualSavingInfo").show():$(".annualSavingInfo").hide(),!i&&(this.scrollToResultsOnLoad||nbs.isLessThanTablet())&&(nbs.dom.animateScrollToElement($(".results"),1e3,this.opts.scrollPadding),this.scrollToResultsOnLoad=!1),nbs.registry.purge()):i?$("#tableDivDesktop, #tableDivMobile").hide():(this.$results.hide(),this.$infoMessage.html(this.noResultsMessage),this.infoOverlay.show())},_removeDiscountedProducts:function(){$(".featuresList .tooltipText p:contains(Reduced product fee)",this.$results).closest("li").remove()},_updateComparisonCheckboxes:function(){this.comparisonCheckboxes=nbs.registry.getDescendents($("#mortgageRatesRows"),["Checkbox"]);for(var n=0;n<this.comparisonCheckboxes.length;n++)this.comparisonCheckboxes[n].on("change",nbs.util.hitch(this,"_countComparisonCheckboxes"))},_countComparisonCheckboxes:function(t){for(var r=0,i=0;i<this.comparisonCheckboxes.length;i++)this.comparisonCheckboxes[i].getChecked()&&r++;r>3&&(this._showErrorOverlay(n.maxComparison),t.setChecked(!1))},_extendRatesData:function(n,t){var r,i,u;if(n)for(r=0;r<n.length;r++)i=n[r],u=this._calculateMonthlySaving(i.Apr,this.$mortgageAmount.val(),this.$term.val(),i.MonthlyRepayment),i.ShowAnnualSaving=u.showSaving,i.AnnualSavingValue=u.saving,i.AnnualSaving=u.savingText,i.BuyerType=t,i.Index=r;return n},_compareMortgages:function(){for(var u,t,e,i=[],f=[],r=0;r<this.comparisonCheckboxes.length;r++)u=this.comparisonCheckboxes[r],u.getChecked()&&(t=u.$el.closest(".compare").data("rate-index"),nbs.util.isDefined(t)&&t<this.searchResults.length&&(i.push(this.searchResults[t]),f.push(";mg_"+$.trim(this.searchResults[t].ProductDescription)+"_"+$.trim(this.searchResults[t].AssetUrl))));if(i.length>1){this.$comparisonTable.html(this.$comparisonTemplate.tmpl({rates:i}));nbs.parser.parse(this.$comparisonTable);this.comparisonOverlay.show();try{e={events:"event97",products:f.join(",").toLowerCase(),linkTrackEvents:"event97",linkTrackVars:"products,events"};nbs.analytics.toolUsage(e);this.analyticsHasRan=!0}catch(o){}}else this._showErrorOverlay(n.minComparison)},_resetFilters:function(n){this.dealTwoOption&&this.dealTwoOption.setChecked(!1);this.dealThreeOption&&this.dealThreeOption.setChecked(!1);this.dealFourOption&&this.dealFourOption.setChecked(!1);this.dealFiveOption&&this.dealFiveOption.setChecked(!1);this.dealTenOption&&this.dealTenOption.setChecked(!1);this.fixedOption&&this.fixedOption.setChecked(!1);this.trackerOption&&this.trackerOption.setChecked(!1);n==t.existCustSwitchAndFix?this.$mortgageTypeFilter.hide():this.$mortgageTypeFilter.show()},_updateFilters:function(n){var r=0,u=0,f=0,e=0,o=0,s=0,t,i,h;if(period10=0,n){for(t=0;t<n.length;t++){i=n[t];h=i.Term/12;i.MortgageType==0?r++:i.MortgageType==1&&u++;switch(h){case 2:f++;break;case 3:e++;break;case 4:o++;break;case 5:s++;break;case 10:period10++}}this._setFilterAvailability(this.fixedOption,r);this._setFilterAvailability(this.trackerOption,u);this._setFilterAvailability(this.dealTwoOption,f);this._setFilterAvailability(this.dealThreeOption,e);this._setFilterAvailability(this.dealFourOption,o);this._setFilterAvailability(this.dealFiveOption,s);this.dealTenOption&&this._setFilterAvailability(this.dealTenOption,period10)}},_setFilterAvailability:function(n,t){n&&(t>0?n.enable():(n.disable(),n.setChecked(!1)))},_getMortgageRatesError:function(){this._hideLoadingOverlays();this._showErrorOverlay(n.unavailable)},_showLoadingOverlay:function(n){if(this.$loadingContent.hide(),this.$loadingImgContainer.hide(),this.$loadingOverlayLightbox.removeClass("col8").addClass("col4"),this.isInitialSearch){var t=this.opts.searchingContent[n];t&&t.content&&(this.$loadingOverlayLightbox.removeClass("col4").addClass("col8"),this.$loadingContent.html(t.content).show(),t.imageUrl&&t.imageUrl.length>0&&(this.$loadingImgContainer.show(),this.$loadingImg.attr("src",t.imageUrl)))}this.loadingOverlay.show()},_hideLoadingOverlays:function(){this.loadingOverlay.hide();this.updatingOverlay.hide()},_showMortgageSpecificContent:function(n,t,i,r,u){var f=this;$(".additionalContent").hide().each(function(){var e=nbs.parser.getOptions($(this),"nbs"),o;e.types&&nbs.util.indexOfItem(e.types,n)!=-1&&(o=f._checkRule(e,i,u,r,t),o&&$(this).show())})},_checkRule:function(n,t,i,r,u){return this._checkRangeLimits(n.lowerLoan,n.upperLoan,t)?this._checkRangeLimits(n.lowerLtv,n.upperLtv,i)?this._checkRangeLimits(n.lowerTerm,n.upperTerm,r)?this._checkRangeLimits(n.lowerValue,n.upperValue,u)?!0:!1:!1:!1:!1},_checkRangeLimits:function(n,t,i){return nbs.util.isDefined(t)&&i>=t?!1:nbs.util.isDefined(n)&&i<=n?!1:!0},_getRelevantMortgageAmount:function(n,i,r){var u=i;return n==t.existCustBorrowingMore&&r>0&&(u=r),u},_getLtv:function(n,i,r,u){var f=0;return f=n==t.existCustBorrowingMore?(r+u)/i*100:r/i*100,f.toFixed(2)},_calculateMonthlyPayment:function(n,t,i){var r=n/1200,u=i*12;return Math.floor(t*r/(1-Math.pow(1+r,-1*u))*100)/100},_calculateMonthlySaving:function(n,t,i,r){var o=$(".addedSection.open"),f=0,e="",s=!1,u=0,h;return o.length>0&&(e='<a href="#" class="linkStyle02 annualSavingLink"><span class="srText">Potential annual saving with this mortgage - <\/span>Find out more<\/a>',u=$(".currentPayment",o).val(),(u==null||u==""||u==0)&&(h=$(".currentRate",o).val(),(u==null||u==""||u==0)&&(u=this._calculateMonthlyPayment(h,nbs.tidying.cleanNumerical(t),i)))),isNaN(u)||u!=null&&u!=""&&u!=0&&r!=null&&r!=""&&(f=(u-r)*12,s=!0,f>0?e=nbs.tidying.formatCurrency(f,2):(f=0,e="No Saving")),{showSaving:s,saving:f,savingText:e}},_printTooltips:function(){var n=$("#tableDivDesktop").find("th div.tooltip");if(n.size()>0){var r=$('<div id="tooltipKey"><h2>Notes about this page<\/h2><\/div>'),t=$("<ol><\/ol>"),i=1;n.each(function(){$(this).after('<span class="toolTipIndex">See note '+i+"<\/span>");t.append("<li>"+$(this).find(".tooltipText").html()+"<\/li>");i++});$(".contentBody").append(r.append(t))}}})}();nbs.modules.MortgageRatesFilter=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.borrowingMore=!1;this.invalidLTVvalue=!1;this.$borrowerType=n.find("#BorrowerType");this.$mortgageAmountInput=this.$el.find("#mortgageAmountInput");this.$additionalBorrowingInput=this.$el.find("#additionalBorrowingAmountInput");this.$mortgageAmountTitle=this.$el.find("#mortgageAmountTitle");this.$existingMortgageAmountTitle=this.$el.find("#existingMortgageAmountTitle");this.$depositAmountInput=this.$el.find("#depositAmountInput");this.$propValue=n.find("#propValue");this.$term=n.find("#term");this.$mortgageAmount=n.find("#mortgageAmount");this.$additionalBorrowing=n.find("#additionalBorrowing");this.$ltvValue=n.find("#ltvValue");this.$depositAmount=n.find("depositAmount");n.on("change","input",nbs.util.hitch(this,"_inputChangeHandler"))},startup:function(){var n=nbs.registry.get("mortgageRatesBorrowerType");this.pie=nbs.registry.get("ltvPie");n.on("change",nbs.util.hitch(this,"_selectChangeHandler"));this._selectChangeHandler(n.getValue());this.updateLTV(!0)},_readValue:function(n){var t=this["$"+n],i=nbs.number.parse(t.val());return t.val()===""&&(this._clearLTV(),this.invalidLTVvalue=!0),i},updateLTV:function(n){var u,i,f,t,r;if(this.invalidLTVvalue=!1,u=this._readValue("propValue"),this.borrowingMore?(t=this._readValue("mortgageAmount"),f=this._readValue("additionalBorrowing")):t=this._readValue("mortgageAmount"),!this.invalidLTVvalue){if(i=this.borrowingMore?t+f:t,i<0){this._clearLTV();return}r=i/u*100;this.$ltvValue.text(r.toFixed(2)+"%");this.pie&&this.pie.update(r,n)}},_clearLTV:function(){this.pie&&this.pie.reset();this.$ltvValue.text("")},_inputChangeHandler:function(){this.updateLTV()},_selectChangeHandler:function(){this.$borrowerType.val()==="ftb"?(this.$depositAmountInput.show(),this.$additionalBorrowingInput.hide(),this.$existingMortgageAmountTitle.hide(),this.$mortgageAmountInput.hide(),this.borrowingMore=!1):this.$borrowerType.val()==="ec-bm"?(this.$additionalBorrowingInput.show(),this.$mortgageAmountTitle.hide(),this.$existingMortgageAmountTitle.show(),this.$depositAmountInput.hide(),this.$mortgageAmountInput.show(),this.borrowingMore=!0):(this.$additionalBorrowingInput.hide(),this.$mortgageAmountTitle.show(),this.$existingMortgageAmountTitle.hide(),this.$depositAmountInput.hide(),this.$mortgageAmountInput.show(),this.borrowingMore=!1);this.updateLTV()}});nbs.modules.MortgageRepaymentCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$messageTemplate=n.find("#messageTemplate");this.$opt1MortAmt=n.find("#opt1MortAmt");this.$opt1Term=n.find("#opt1Term");this.$opt1Rate=n.find("#opt1Rate");this.$opt1Result=n.find("#paymentMonthlyOption1");this.$opt2MortAmt=n.find("#opt2MortAmt");this.$opt2Term=n.find("#opt2Term");this.$opt2Rate=n.find("#opt2Rate");this.$opt2Result=n.find("#paymentMonthlyOption2");n.find("#opt1MortAmt, #opt1Term, #opt2MortAmt, #opt2Term").keydown(nbs.util.hitch(this,"_inputKeydownHandler")).blur(nbs.util.hitch(this,"updateResults"));n.find("#opt1Rate, #opt2Rate").keydown(nbs.util.hitch(this,"_inputKeydownHandler")).keyup(nbs.util.hitch(this,"updateResults"))},_inputKeydownHandler:function(n){var t=n.keyCode;t===13&&(this.updateResults(),n.preventDefault())},_readValue:function(n){var t=this["$"+n],i=nbs.number.parse(t.val());return(t.val()===""||isNaN(i))&&(t.val(""),i=null),i},updateResults:function(){var n=this.calculateOption("opt1MortAmt","opt1Term","opt1Rate",1),t=this.calculateOption("opt2MortAmt","opt2Term","opt2Rate",2);n>0?(this.$opt1Result.html("&pound;"+nbs.number.formatWithCommas(n,0)),this.analytics()):this.$opt1Result.html("");t>0?(this.$opt2Result.html("&pound;"+nbs.number.formatWithCommas(t,0)),this.analytics()):this.$opt2Result.html("")},calculateOption:function(n,t,i,r){var f=this._readValue(n),e=this._readValue(t),u=this._readValue(i),c=".errorRow"+r,s=this.$el.find(c),o={errors:[]},h=0;return this._setFieldErrors([n,t,i],!1),s.hide(),f!=null&&(f<1e4||f>1e6)&&(this._setFieldErrors(n,!0),o.errors.push({message:"The mortgage amount under option "+r+" should be between £10,000 and £1,000,000 (inclusive)."})),e!=null&&(e<1||e>40)&&(this._setFieldErrors(t,!0),o.errors.push({message:"The term under option "+r+" should be between 1 and 40 (inclusive)."})),u!=null&&(u<1||u>20)&&(this._setFieldErrors(i,!0),o.errors.push({message:"The interest rate under option "+r+" should be between 1% and 20% (inclusive)."})),o.errors.length>0?(this.$messageTemplate.tmpl(o).appendTo(s.empty()),s.show()):f&&e&&u&&(u=u/100,h=this.calculateMonthlyPayment(f,e,u)),h},_setFieldErrors:function(n,t){var i,u,r;for(typeof n=="string"&&(n=[n]),i=0;i<n.length;i++)u=n[i],r=this["$"+u].closest(".col"),t?r.addClass("error"):r.removeClass("error")},calculateMonthlyPayment:function(n,t,i){return n*(i/12)*Math.pow(1+i/12,t*12)/(Math.pow(1+i/12,t*12)-1)},analytics:function(){this.analyticsHasRan||(nbs.analytics.toolUsage({eVar4:"Mortgage Repayment Calculator|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage"),this.analyticsHasRan=!0)}});nbs.modules.PlanningCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$el=n;this.$Sliders=n.find(".question");this.analyticsHasRan=!1;this.executed=!1;this.firstload=!0},startup:function(){var u,n,f,t,e;this.inherited.apply(this,arguments);this.selectorTabs=nbs.registry.get(this.$el.find(".selectorTabs"));var i=this.$el.find(".tabSection"),o=this.$el.find(".restart"),s=this.$el.find(".restore"),r=this.$el.find("li .tabSectionValue");i.each(function(){var u=this.id,i,n,t;r=$("a[href='#"+u+"']").find(".tabSectionValue");i=$(this).find(".question");n=0;i.each(function(){var t=$(this).find("input").val(),i=parseInt(t.replace("£","").replace(",",""));n=n+i});t="&pound;"+nbs.number.formatWithCommas(n,0);$(this).find(".value").html(t);$(this).find("h3").find(".tabSectionValue").html(t);r.html(t)});this.updateTotal(!0);u=i.find(".question");n=this;u.each(function(){var t=nbs.registry.get($(this));t.on("move",nbs.util.hitch(n,"_sliderMove"))});o.on("click",nbs.util.hitch(n,"restartCalc"));s.on("click",nbs.util.hitch(n,"restoreCalc"));this.$el.find(".tabTitle").on("blur",function(){$(this).find(".descIcon").addClass("tick")});f=$(".tab").find("a.tabTitle");$(".controls .nxt,.controls .prv").click(function(){$(".tabSection.active .question .sliderInput:first").focus()});f.click(function(){$(".tabSection.active .question .sliderInput:first").focus()});t=[];$("li.tab").each(function(){t.push($(this).find(".tabInner").text())});$(".tabSection").each(function(n){$(this).find(".section").text(t[n])});e=$(".controls").length-1;this.$el.find(".controls").each(function(t){var i=$(this);if(t===0){i.find(".prv").addClass("inactiveBtn").on("click",nbs.util.hitch(n,"inactiveBtn"));i.find(".nxt").on("click",nbs.util.hitch(n,"nextTab"))}else if(t===e){i.find(".prv").on("click",nbs.util.hitch(n,"prevTab"));i.find(".nxt").addClass("inactiveBtn").on("click",nbs.util.hitch(n,"inactiveBtn"))}else{i.find(".prv").on("click",nbs.util.hitch(n,"prevTab"));i.find(".nxt").on("click",nbs.util.hitch(n,"nextTab"))}});nbs.dispatcher.on("tabs/changeTab",nbs.util.hitch(this,"_changeTabHandler"))},_changeTabHandler:function(){this._resetSliders()},_resetSliders:function(){var n=nbs.registry.getDescendents(this.$el,["Slider"],"nbs");$.each(n,function(n,t){typeof t._ancestorOpenedHandler=="function"&&t._ancestorOpenedHandler()})},inactiveBtn:function(n){n.preventDefault()},prevTab:function(n){this.$el.find(".selectorTabs.calculator input[type=text]").blur();this.updateSectionTotal(!1);n.preventDefault();var t=nbs.registry.get(this.$el.find(".selectorTabs")),i=t.currentIndex-1;this.$el.find(".selectorTabs nav.tabs li:eq("+i+") a").click()},nextTab:function(n){this.$el.find(".selectorTabs.calculator input[type=text]").blur();this.updateSectionTotal(!1);n.preventDefault();var t=nbs.registry.get(this.$el.find(".selectorTabs")),i=t.currentIndex+1;this.$el.find(".selectorTabs nav.tabs li:eq("+i+") a").click()},restartCalc:function(n){var i,t,u;if(n.preventDefault(),i=nbs.registry.get(this.$el.find(".selectorTabs.calculator.homeContentsCalculator")),t=this.$el.find(".selectorTabs.calculator.homeContentsCalculator"),!this.executed){this.executed=!0;$("#calcTotalPrev").val($("#calcTotal").text());var r=[],f=t.find("li .tabSectionValue").map(function(){return this.innerHTML}).get(),e=t.find(".tabSection .tabSectionValue").map(function(){return this.innerHTML}).get(),o=t.find(".tabSection .sliderInput").map(function(){return this.value}).get(),s=t.find(".tabSection .sectionValue .value").map(function(){return this.innerHTML}).get();t.find("li .tabSectionValuePrev").each(function(n){$(this).text(f[n])});t.find(".tabSection .tabSectionValuePrevMob").each(function(n){$(this).text(e[n])});t.find(".tabSection .sliderInputPrev").each(function(n){$(this).text(o[n])});t.find(".tabSection .sectionValue .valuePrev").each(function(n){$(this).text(s[n])});t.find(".tabSection .sliderScrubber").each(function(){r.push($(this).attr("style"))});t.find(".tabSection .sliderPositionPrev").each(function(n){$(this).text(r[n])})}this.$Sliders.each(function(){var n=nbs.registry.get($(this));n.moveByIndex(0,!1)});this.$el.find(".tab, .tabSection").find(".descIcon").removeClass("tick");i._changeTab(0);u=this.$el.find(".tab.active a").attr("href").replace("#","");nbs.hash.set("xtab:"+u);this.updateSectionTotal(!0)},restoreCalc:function(n){if(n.preventDefault(),this.executed){var t=this.$el.find(".selectorTabs.calculator.homeContentsCalculator"),i=[],r=[],u=[],f=[],e=[];t.find("#calcTotal").text($("#calcTotalPrev").val());t.find("#calcTotal").val($("#calcTotalPrev").val());t.find("li .tabSectionValuePrev").each(function(){i.push($(this).text())});t.find("li .tabSectionValue").each(function(n){$(this).text(i[n])});t.find(".tabSectionValue").each(function(n){$(this).text(i[n])});t.find(".tabSection .sliderInputPrev").each(function(){r.push($(this).text())});t.find(".tabSection .sliderInput").each(function(n){$(this).val(r[n])});t.find(".tabSection .sectionValue .valuePrev").each(function(){f.push($(this).text())});t.find(".tabSection .sectionValue .value").each(function(n){$(this).text(f[n])});t.find(".tabSection .sliderPositionPrev").each(function(){u.push($(this).text())});t.find(".tabSection .sliderScrubber").each(function(n){$(this).attr("style",u[n])});$(".tabSection .sliderScrubber").each(function(n){$(this).attr("aria-valuenow",r[n])});t.find(".tabSection .tabSectionValuePrevMob").each(function(){e.push($(this).text())});t.find(".tabSection .tabSectionValue").each(function(n){$(this).text(e[n])});this.executed=!1;this.$el.find(".selectorTabs.calculator input[type=text]").blur();this.updateSectionTotal(!1)}},_sliderMove:function(){this.updateSectionTotal(!1)},updateSectionTotal:function(n){var t,u,f,i,r;n?(t=this.$el.find(".tabSection"),u=this.$el.find(".tab")):(t=this.$el.find(".tabSection.active"),u=this.$el.find(".tab.active"));f=t.find(".question");i=0;f.each(function(){var n=$(this).find("input").val(),t=parseInt(n.replace("£","").replace(/,/g,""));i=i+t});r="&pound;"+nbs.number.formatWithCommas(i,0);t.find(".value").html(r);t.find("h3").find(".tabSectionValue").html(r);u.find(".tabSectionValue").html(r);this.updateTotal(!1)},updateTotal:function(n){var i=this.$el.find(".tab"),t=0;i.each(function(){var n=$(this).find(".tabSectionValue").text(),i=parseInt(n.replace("£","").replace(/,/g,""));t=t+i});this.$el.find("#calcTotal").html("&pound;"+nbs.number.formatWithCommas(t,0));this.$el.find(".tab.active, .tabSection.active").find(".descIcon").addClass("tick");n||this.analytics()},analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({eVar4:"Home content calculator|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage",!0),this.analyticsHasRan=!0}});nbs.modules.MsoAffordabilityCalculator=nbs.declare(nbs.modules.SteppedForm,{maxTerm:4e3,ltvMG:.95,ltvFA:.85,ltvRM:.9,maxNoOfOtherMortgages:6,steppedFormName:"Mso Mortgage Affordability Calculator",newBuyStandard:"What is the(expected) purchase price?",newBuySharedOrEquity:"What is the(expected) purchase price of your share?",newBuyRightToBuy:"What is the(expected) discounted purchase price?",expectedWord:" expected",expectedPlaceholder:"(expected)",remortgageSharedOrEquity:"What will be the estimated value of your share at completion?",remortgageStandardOrRight:"What is the current estimated value?",furtherShared:"What will be the estimated value of your share at completion?",furtherEquity:"What is the estimated value of the share you currently own?",furtherStandardOrRight:"What is the current estimated value?",currentMarketValue:"What's the full market value of the place you've found?",expectedMarketValue:"What's the expected full market value?",timeTrading:"How long have you been in business?",timeWithEmployer:" How long have you had your job?",timeContracting:"How long have you been a contractor?",timeRegular:"How long have you been in regular work?",sections:{stepOne:{Existing_mortgage_details:"#d0e373cfc9674146975a69170ca0338d",Property_details:"#afa9c37a60514f9aa666315cc753c91e"},stepTwo:{MainDependents:"#cee73de8fa1841518b864114b8925ab1",JointDependents:"#5f85ea88e6fb47eebbd196ab21b624d3"},stepThree:{main_first_Income:"#ce6f56befaa5412b83f59f1dd9493c67",main_first_Major:"#b6a999738a424b8ab1a1b98125fa7192",main_first_Profit:"#a05e52bf11b143d18c793f76e463d3a2",main_first_Share:"#cf4e2dd0fdcf4f10a9cf320c5f5ec95d",main_second_Income:"#b65c33cd87ba47d9980c5e97f6d9bfb9",main_second_Major:"#708c6c5120db42c5a4c232a3f021f047",main_second_Profit:"#55bf07248eae4a94889fd515a0500ff4",main_second_Share:"#2f2a341ebd06436e85dcef5efe7dacc9",joint_applicant:"#c1685def13264fe7b7c9db3699cb55b9",joint_applicant_first_job:"#e5f4f1ddb35446208418fe94ce3ac9b3",joint_first_Income:"#cc2d563752d94dc194de66ae24e72779",joint_first_Major:"#0f9c12b1778d48928622decee0159449",joint_first_Profit:"#c32bd1430f0642a88fb22d89599220b9",joint_first_Share:"#e5e3803ecb0d459a92832372e0b1e698",joint_second_Income:"#a37df29fc0e24083a91a5699d0a7e3c5",joint_second_Major:"#c7ab48fb74d7412790fb158e6931e21b",joint_second_Profit:"#9703d17e08f44d989a9a0d0c5e6bf6d2",joint_second_Share:"#44abe3f4857d4170884654cfcff2d141"},stepFour:{main_retirement_income:"#6da793274fc2447492c9417ed46d826c",joint_applicant:"#2535d807b38d4d27982a498d53614ba4",joint_retirement_income:"#02f47acf0098478f9f6326ebcbd57cd9"},stepFive:{main_dependents:"#53b342d55275421ea1b0744223f0e519",joint_applicant:"#34528f6cc0334be18498364ecd5bfff3",joint_dependents:"#5ba73a32f54d41ddabaaa5a4fc7ad690"},stepSix:{main_joint_other_mortgages:"#ff9ff7d162a54642927984dde7a29fb0",main_other_mortgages:"#f2c28c6aec1941ceb537570c43bafeac",joint_other_mortgages:"#ca350d88589c40d3b4318907ff8d42eb"}},initialise:function(n){this.inherited.apply(this,arguments);this._intializeStep1();this._intializeStep2();this._intializeStep3();this._intializeStep4();this._intializeStep5();this._intializeStep6();this.$errorList=n.find("#errorOverlay ol");this.$errorsTemplate=n.find("#errorsTemplate");this.$resultReqTerm=n.find(".resultArea span.requestedTerm");this.$resultAmount=n.find("#result_mortgage_amount");this.$resultReqLoanAmt=n.find(".termResult span.requestedLoanAmt");this.$resultTerm=n.find(".termResult span.minTermResult");this.$resultArea=n.find(".resultArea");this.$resultError=n.find(".resultError");this.$resultLoading=n.find(".resultLoading")},_intializeStep1:function(){this.$foundProperty=this.$el.find("#have_found_property");this.$foundPropertyRow=this.$foundProperty.closest(".formRow");this.$propertyDetails=this.$el.find("#afa9c37a60514f9aa666315cc753c91e");this.$marketValue=this.$el.find("#market_value");this.$marketValueRow=this.$marketValue.closest(".formRow");this.$purchasePrice=this.$el.find("#purchase_price");this.$purchasePriceRow=this.$purchasePrice.closest(".formRow");this.$propertyTenure=this.$el.find("#property_tenure");this.$propertyTenureRow=this.$propertyTenure.closest(".formRow");this.$propertyType=this.$el.find("#property_type");this.$propertyTypeRow=this.$propertyType.closest(".formRow");this.$requiredLoan=this.$el.find("#required_loan");this.$requestedTermYY=this.$el.find("#requested_term_yy");this.$requestedTermMM=this.$el.find("#requested_term_mm");this.$requestedTermRow=this.$requestedTermYY.closest(".formRow");this._disableField("market_value")},_intializeStep2:function(){this.$mainPlannedRetireAge=this.$el.find("#main_planned_retirement_age");this.$mainPlannedRetireAgeRow=this.$mainPlannedRetireAge.closest(".formRow");this.$jointPlannedRetireAge=this.$el.find("#joint_planned_retirement_age");this.$jointPlannedRetireAgeRow=this.$jointPlannedRetireAge.closest(".formRow")},_intializeStep3:function(){this.$mainTreatedForTax=this.$el.find("#main_first_treated_as_employee_for_tax");this.$mainTreatedForTaxRow=this.$mainTreatedForTax.closest(".formRow");this.$mainTreatedForTaxRow.hide();this.$jointTreatedForTax=this.$el.find("#joint_first_treated_as_employee_for_tax");this.$jointTreatedForTaxRow=this.$jointTreatedForTax.closest(".formRow");this.$jointTreatedForTaxRow.hide();this._disableField("main_first_remaining_contract_yy");this._disableField("main_second_remaining_contract_yy");this._disableField("joint_first_remaining_contract_yy");this._disableField("joint_second_remaining_contract_yy");this.$secondTreatedForTax=this.$el.find("#main_second_treated_as_employee_for_tax");this.$secondTreatedForTaxRow=this.$secondTreatedForTax.closest(".formRow");this.$secondTreatedForTaxRow.hide();this.$jointSecondTreatedForTax=this.$el.find("#joint_second_treated_as_employee_for_tax");this.$jointSecondTreatedForTaxRow=this.$jointSecondTreatedForTax.closest(".formRow");this.$jointSecondTreatedForTaxRow.hide();this.$mainSecondRemainContract=this.$el.find("#main_second_remaining_contract_yy");this.$mainSecondRemainContractRow=this.$mainSecondRemainContract.closest(".formRow");this.$jointSecondRemainContract=this.$el.find("#joint_second_remaining_contract_yy");this.$jointSecondRemainContractRow=this.$jointSecondRemainContract.closest(".formRow");this._disableAllSections(this.sections.stepThree)},_intializeStep4:function(){this._disableAllSections(this.sections.stepFour)},_intializeStep5:function(){this._disableAllSections(this.sections.stepFive)},_intializeStep6:function(){this.$buildingInsurance=this.$el.find("#property_building_insurance");this.$buildingInsuranceRow=this.$buildingInsurance.closest(".formRow");this._disableAllSections(this.sections.stepSix);this._disableField("joint_do_you_have_other_mortgages");this._disableField("property_ground_rent");this._disableField("property_service_charge")},startup:function(){this.inherited.apply(this,arguments);this.forms[0].customFormValidationFunction=nbs.util.hitch(this,"_handleStep1CustomValidation");this.forms[1].customFormValidationFunction=nbs.util.hitch(this,"_handleStep2CustomValidation");this.forms[2].customFormValidationFunction=nbs.util.hitch(this,"_handleStep3CustomValidation");this.forms[2].on("reset",nbs.util.hitch(this,"_handleStep3ClearForm"));this.errorOverlay=nbs.registry.get("errorOverlay");this._startUpStep1();this._startUpStep2();this._startUpStep3();this._startUpStep6();this.soleOrJoint=nbs.registry.get("sole_or_joint");this.app1RetirementIncomeRequired=!1;this.app2RetirementIncomeRequired=!1},_startUpStep1:function(){this._disablePropertyDetails();this.borrowerType=nbs.registry.get("borrower_type_select");this.borrowerType.on("change",nbs.util.hitch(this,"_handleBorrowerTypeChange"));this.propertyOwnership=nbs.registry.get("property_ownership_select");this.propertyOwnership.on("change",nbs.util.hitch(this,"_handlePropertyOwnershipChange"));this.propertyTenure=nbs.registry.get("property_tenure_select");this.propertyTenure.on("change",nbs.util.hitch(this,"_handlePropertyTenureChange"));this.numberApplicants=nbs.registry.get("sole_or_joint");this.numberApplicants.on("change",nbs.util.hitch(this,"_handleNumberApplicantsChange"));this.foundProperty=nbs.registry.get("have_found_property");this.foundProperty.on("change",nbs.util.hitch(this,"_handleFoundPropertyChange"))},_startUpStep2:function(){this.mainNoDependents=nbs.registry.get("main_no_of_dependants_select");this.mainNoDependents.on("change",nbs.util.hitch(this,"_handleNoOfDependentsChange"));this.jointNoDependents=nbs.registry.get("joint_no_of_dependants_select");this.jointNoDependents.on("change",nbs.util.hitch(this,"_handleNoOfDependentsChange"));this.mainAreRetired=nbs.registry.get("main_are_retired");this.mainAreRetired.on("change",nbs.util.hitch(this,"_handleAreRetiredChange"));this.jointAreRetired=nbs.registry.get("joint_are_retired");this.jointAreRetired.on("change",nbs.util.hitch(this,"_handleAreRetiredChange"))},_startUpStep3:function(){this.mainEmploymentStatus=nbs.registry.get("main_first_job_employment_status_select");this.mainEmploymentStatus.on("change",nbs.util.hitch(this,"_handleEmploymentStatusChange"));this.mainEmploymentSecondStatus=nbs.registry.get("main_second_job_employment_status_select");this.mainEmploymentSecondStatus.on("change",nbs.util.hitch(this,"_handleEmploymentStatusChange"));this.jointEmploymentStatus=nbs.registry.get("joint_first_job_employment_status_select");this.jointEmploymentStatus.on("change",nbs.util.hitch(this,"_handleEmploymentStatusChange"));this.jointEmploymentSecondStatus=nbs.registry.get("joint_second_job_employment_status_select");this.jointEmploymentSecondStatus.on("change",nbs.util.hitch(this,"_handleEmploymentStatusChange"));this.mainEmploymentContract=nbs.registry.get("main_first_employed_contract_select");this.mainEmploymentContract.on("change",nbs.util.hitch(this,"_handleEmploymentContractChange"));this.mainEmploymentSecondContract=nbs.registry.get("main_second_employed_contract_select");this.mainEmploymentSecondContract.on("change",nbs.util.hitch(this,"_handleEmploymentContractChange"));this.jointEmploymentContract=nbs.registry.get("joint_first_employed_contract_select");this.jointEmploymentContract.on("change",nbs.util.hitch(this,"_handleEmploymentContractChange"));this.jointEmploymentSecondContract=nbs.registry.get("joint_second_employed_contract_select");this.jointEmploymentSecondContract.on("change",nbs.util.hitch(this,"_handleEmploymentContractChange"));this.mainEmploymentTax=nbs.registry.get("main_first_treated_as_employee_for_tax");this.mainEmploymentTax.on("change",nbs.util.hitch(this,"_handleTreatedAsEmployeeForTax"));this.mainEmploymentSecondTax=nbs.registry.get("main_second_treated_as_employee_for_tax");this.mainEmploymentSecondTax.on("change",nbs.util.hitch(this,"_handleTreatedAsEmployeeForTax"));this.jointEmploymentTax=nbs.registry.get("joint_first_treated_as_employee_for_tax");this.jointEmploymentTax.on("change",nbs.util.hitch(this,"_handleTreatedAsEmployeeForTax"));this.jointEmploymentSecondTax=nbs.registry.get("joint_second_treated_as_employee_for_tax");this.jointEmploymentSecondTax.on("change",nbs.util.hitch(this,"_handleTreatedAsEmployeeForTax"))},_startUpStep6:function(){this.mainHaveMortgages=nbs.registry.get("main_do_you_have_other_mortgages");this.mainHaveMortgages.on("change",nbs.util.hitch(this,"_handleHaveMortgages"));this.jointHaveMortgages=nbs.registry.get("joint_do_you_have_other_mortgages");this.jointHaveMortgages.on("change",nbs.util.hitch(this,"_handleHaveMortgages"));this.howManyJointMortgages=nbs.registry.get("main_how_many_joint_mortgages_select");this.howManyJointMortgages.on("change",nbs.util.hitch(this,"_handleHowManyJointMortgages"));this.howManyMainOtherMortgages=nbs.registry.get("main_how_many_other_mortgages_select");this.howManyMainOtherMortgages.on("change",nbs.util.hitch(this,"_handleHowManyOtherMortgages"));this.howManyJointOtherMortgages=nbs.registry.get("joint_how_many_other_mortgages_select");this.howManyJointOtherMortgages.on("change",nbs.util.hitch(this,"_handleHowManyOtherMortgages"))},_setRadioButton:function(n,t){var i=nbs.registry.get(n);i.toggle(t)},_enableField:function(n){var i=this.$el.find("#"+n),t=i.closest(".formRow");t.data("required",!0);t.show()},_setFieldAsRequired:function(n){var i=this.$el.find("#"+n),t=i.closest(".formRow");t.data("required",!0);t.find(".required").show()},_disableField:function(n){var i=this.$el.find("#"+n),t=i.closest(".formRow");t.data("required",!1);t.hide()},_setFieldAsUnrequired:function(n){var i=this.$el.find("#"+n),t=i.closest(".formRow");t.data("required",!1);t.find(".required").hide()},_enablePropertyDetails:function(n){this.$propertyTypeRow.data("required",!0);this.$propertyTenureRow.data("required",!0);this.$propertyDetails.slideDown();this.$propertyDetails.find(".sectionTitle").text("Please tell us more about "+n+" property");this.propertyOwnership.getValue()==="SD"||this.propertyOwnership.getValue()===""?this._disableField("market_value"):this._enableField("market_value")},_setPurchasePriceLabel:function(){var r=this.borrowerType.getValue(),n=this.propertyOwnership.getValue(),u=this.foundProperty.getValue(),t=this.newBuyStandard,i=this.expectedWord;switch(r){case"":case"MG":t=n==="SD"||n===""?this.newBuyStandard:n==="SO"||n==="ES"?this.newBuySharedOrEquity:this.newBuyRightToBuy;u==="Yes"&&(i="");break;case"RM":t=n==="SO"||n==="ES"?this.remortgageSharedOrEquity:this.remortgageStandardOrRight;break;case"FA":t=n==="SO"?this.furtherShared:n==="ES"?this.furtherEquity:this.furtherStandardOrRight}return t.replace(this.expectedPlaceholder,i)},_setEmploymentTimeLabel:function(n,t){var i="";switch(n){case"P":case"T":case"Y":i=this.timeTrading;break;case"D":i=this.timeWithEmployer;break;case"E":switch(t){case"SF":case"SE":case"FC":i=this.timeContracting;break;case"TP":i=this.timeRegular;break;default:i=this.timeWithEmployer}}return i},_disablePropertyDetails:function(){this.$propertyTypeRow.data("required",!1);this.$propertyTenureRow.data("required",!1);this.$propertyDetails.slideUp()},_isSectionEnabled:function(n){var t=this.$el.find(n);return t.hasClass("open")},_enableSectionByGuid:function(n){var t=this.$el.find(n);t.removeClass("closed").addClass("open");t.slideDown()},_disableSection:function(n){var t=this.$el.find(n);t.removeClass("open").addClass("closed");t.slideUp()},_disableAllSections:function(n){for(var t in n)this._disableSection(n[t])},_disableSectionsStartingWith:function(n,t){for(var i in n)i.indexOf(t)>=0&&this._disableSection(n[i])},_getYearsAndMonths:function(n){var t=nbs.registry.get(n+"_yy").getValue(),i=nbs.registry.get(n+"_mm").getValue();return parseInt(t)*100+parseInt(i)},_setApplicantToUnemployed:function(n,t,i){this._disableSectionsStartingWith(this.sections.stepThree,i);this._disableField(i+"_time_in_employment_yy");this._disableField(i+"_time_in_employment_mm");this._disableField(n+"_have_second_employment");var r=nbs.registry.get(n+"_have_second_employment");r.reset()},_removeOption6FromMortgageSelects:function(){$("#main_how_many_joint_mortgages option[value=6]").hide();$("#main_how_many_other_mortgages option[value=6]").hide();$("#joint_how_many_other_mortgages option[value=6]").hide();this.maxNoOfOtherMortgages=5},_addOption6FromMortgageSelects:function(){$("#main_how_many_joint_mortgages option[value=6]").show();$("#main_how_many_other_mortgages option[value=6]").show();$("#joint_how_many_other_mortgages option[value=6]").show();this.maxNoOfOtherMortgages=6},_handleEmploymentStatusChange:function(n,t){var f="stepThree",u="",r=t.getId(),i=r.split("_")[0]+"_"+r.split("_")[1];this._enableField(i+"_time_in_employment_yy");this._enableField(i+"_time_in_employment_mm");r.split("_")[1]==="first"&&this._enableField(r.split("_")[0]+"_have_second_employment");this._disableSectionsStartingWith(this.sections[f],i);this._disableField(i+"_remaining_contract_yy");this._setFieldAsUnrequired(r.split("_")[0]+"_add_pension_income");this._setRadioButton(r.split("_")[0]+"_have_additional_income",1);switch(n){case"Y":u=i+"_Major";break;case"D":u=i+"_Income";break;case"P":u=i+"_Share";break;case"T":u=i+"_Profit";break;case"E":this._disableSectionsStartingWith(this.sections[f],i);nbs.registry.get(i+"_employed_contract_select").reset();break;case"R":r.split("_")[1]==="first"&&(this._setFieldAsRequired(r.split("_")[0]+"_add_pension_income"),this._setRadioButton(r.split("_")[0]+"_have_additional_income",0));default:r.split("_")[1]==="first"&&this._setApplicantToUnemployed(r.split("_")[0],f,i)}u.length>0&&!this._isSectionEnabled(this.sections[f][u])&&(this._disableSectionsStartingWith(this.sections[f],i),this._enableSectionByGuid(this.sections[f][u]));var e=nbs.registry.get(i+"_employed_contract_select"),o=this.$el.find("#"+i+"_time_in_employment_yy"),s=o.closest(".formRow");s.find('label[for="'+i+'_time_in_employment"]').html(this._setEmploymentTimeLabel(n,e.getValue())+'<span class="required" aria-label="This is a required field">*<\/span>')},_handleEmploymentContractChange:function(n,t){var r="stepThree",f=t.getId(),i=f.split("_")[0]+"_"+f.split("_")[1],u=nbs.registry.get(i+"_treated_as_employee_for_tax");switch(n){case"":this._disableSectionsStartingWith(this.sections[r],i);this._disableField(i+"_treated_as_employee_for_tax");this._disableField(i+"_remaining_contract_yy");u.reset();break;case"SF":case"SE":this._enableField(i+"_treated_as_employee_for_tax");this._disableField(i+"_remaining_contract_yy");n==="SF"&&this._enableField(i+"_remaining_contract_yy");u.getValue()==="Yes"?(this._disableSection(this.sections[r][i+"_Profit"]),this._enableSectionByGuid(this.sections[r][i+"_Income"])):u.getValue()==="No"?(this._disableSection(this.sections[r][i+"_Income"]),this._enableSectionByGuid(this.sections[r][i+"_Profit"])):this._disableSectionsStartingWith(this.sections[r],i);break;default:this._disableField(i+"_treated_as_employee_for_tax");this._disableField(i+"_remaining_contract_yy");n==="FC"&&this._enableField(i+"_remaining_contract_yy");u.reset();this._isSectionEnabled(this.sections[r][i+"_Income"])||(this._disableSectionsStartingWith(this.sections[r],i),this._enableSectionByGuid(this.sections[r][i+"_Income"]))}var e=nbs.registry.get(i+"_job_employment_status_select"),o=this.$el.find("#"+i+"_time_in_employment_yy"),s=o.closest(".formRow");s.find('label[for="'+i+'_time_in_employment"]').html(this._setEmploymentTimeLabel(e.getValue(),n)+'<span class="required" aria-label="This is a required field">*<\/span>')},_handleTreatedAsEmployeeForTax:function(n,t){var i="stepThree",u=t.getId(),r=u.split("_")[0]+"_"+u.split("_")[1];n.value==="Yes"?(this._disableSection(this.sections[i][r+"_Profit"]),this._enableSectionByGuid(this.sections[i][r+"_Income"])):(this._disableSection(this.sections[i][r+"_Income"]),this._enableSectionByGuid(this.sections[i][r+"_Profit"]))},_handleAreRetiredChange:function(n,t){var f=t.getId(),i=f.split("_")[0],r=nbs.registry.get(i+"_first_job_employment_status_select"),u=this.$el.find("#"+i+"_first_job_employment_status");n.value==="Yes"?(r.setValue("R"),u.prop("disabled",!0)):(r.setValue(""),u.prop("disabled",!1))},_handlePropertyOwnershipChange:function(n){this._disableField("property_shared_ownership_rental");n==="SD"||n===""?this._disableField("market_value"):(this._enableField("market_value"),n==="SO"&&(this._enableField("property_shared_ownership_rental"),this.foundProperty.getValue()==="Yes"?this._setFieldAsRequired("property_shared_ownership_rental"):this._setFieldAsUnrequired("property_shared_ownership_rental")));this.$purchasePriceRow.find("label").html(this._setPurchasePriceLabel()+'<span class="required" aria-label="This is a required field">*<\/span>');this.$marketValueRow.find("label").html(this.currentMarketValue+'<span class="required" aria-label="This is a required field">*<\/span>')},_handlePropertyTenureChange:function(n){n==="1"?(this.$buildingInsuranceRow.data("validation","numberOptional"),this._enableField("property_ground_rent"),this._enableField("property_service_charge")):(this.$buildingInsuranceRow.data("validation","required"),this._disableField("property_ground_rent"),this._disableField("property_service_charge"))},_handleNumberApplicantsChange:function(n){n.value==="joint"?(this._enableSectionByGuid(this.sections.stepThree.joint_applicant),this._enableSectionByGuid(this.sections.stepThree.joint_applicant_first_job),this._enableSectionByGuid(this.sections.stepFour.joint_applicant),this._enableSectionByGuid(this.sections.stepFive.joint_applicant),this._enableField("joint_do_you_have_other_mortgages")):(this._disableSection(this.sections.stepThree.joint_applicant),this._disableSection(this.sections.stepThree.joint_applicant_first_job),this._disableSection(this.sections.stepFour.joint_applicant),this._disableSection(this.sections.stepFive.joint_applicant),this._disableField("joint_do_you_have_other_mortgages"))},_handleNoOfDependentsChange:function(n,t){var i=["stepFour","stepFive"],u=t.getId(),r=u.split("_")[0],f=parseInt(n);f>0?(this._enableSectionByGuid(this.sections[i[0]][r+"_additional_dependents"]),this._enableSectionByGuid(this.sections[i[0]][r+"_retirement_dependents"]),this._enableSectionByGuid(this.sections[i[1]][r+"_dependents"])):(this._disableSection(this.sections[i[0]][r+"_additional_dependents"]),this._disableSection(this.sections[i[0]][r+"_retirement_dependents"]),this._disableSection(this.sections[i[1]][r+"_dependents"]))},_handleBorrowerTypeChange:function(n){n==="RM"||n==="FA"?(this.$foundPropertyRow.data("required",!1),this.$foundPropertyRow.hide(),this._enablePropertyDetails("your"),n==="FA"?this._removeOption6FromMortgageSelects():this._addOption6FromMortgageSelects()):(this.foundProperty.reset(),this.$foundPropertyRow.show(),this.$foundPropertyRow.data("required",!0),this._disablePropertyDetails(),this._addOption6FromMortgageSelects());this.$purchasePriceRow.find("label").html(this._setPurchasePriceLabel()+'<span class="required" aria-label="This is a required field">*<\/span>')},_handleFoundPropertyChange:function(n){this._disableField("property_shared_ownership_rental");this.borrowerType.getValue()==="MG"&&n.value==="Yes"?this._enablePropertyDetails("this"):this.borrowerType.getValue()==="MG"&&n.value==="No"?this._disablePropertyDetails():this._disablePropertyDetails();this.propertyOwnership.getValue()!="SD"&&(n.value==="Yes"?(this.$marketValueRow.find("label").html(this.currentMarketValue+'<span class="required" aria-label="This is a required field">*<\/span>'),this.propertyOwnership.getValue()==="SO"&&(this._enableField("property_shared_ownership_rental"),this._setFieldAsRequired("property_shared_ownership_rental"))):(this.$marketValueRow.find("label").html(this.expectedMarketValue+'<span class="required" aria-label="This is a required field">*<\/span>'),this.propertyOwnership.getValue()==="SO"&&(this._enableField("property_shared_ownership_rental"),this._setFieldAsUnrequired("property_shared_ownership_rental"))));n.value==="Yes"&&this.propertyTenure.getValue()==="1"?(this._enableField("property_ground_rent"),this._enableField("property_service_charge")):(this._disableField("property_ground_rent"),this._disableField("property_service_charge"));this.$purchasePriceRow.find("label").html(this._setPurchasePriceLabel()+'<span class="required" aria-label="This is a required field">*<\/span>')},_handleHaveMortgages:function(n,t){var r=t.getId(),i=r.split("_")[0];n.value==="Yes"?(this._enableSectionByGuid(this.sections.stepSix[i+"_other_mortgages"]),i==="main"&&this.soleOrJoint.getValue()==="joint"&&this._enableSectionByGuid(this.sections.stepSix.main_joint_other_mortgages)):(this._disableSection(this.sections.stepSix[i+"_other_mortgages"]),i==="main"&&this._disableSection(this.sections.stepSix.main_joint_other_mortgages))},_handleHowManyJointMortgages:function(n){var t,r,i;if(n!="")if(n==this.maxNoOfOtherMortgages)this._disableSection(this.sections.stepSix.main_other_mortgages),this._disableField("main_how_many_other_mortgages"),this._disableField("joint_do_you_have_other_mortgages");else{for(this._enableSectionByGuid(this.sections.stepSix.main_other_mortgages),this._enableField("main_how_many_other_mortgages"),this._enableField("joint_do_you_have_other_mortgages"),t=1;t<this.maxNoOfOtherMortgages+1;t++)$("#main_how_many_other_mortgages option[value="+t+"]").show(),$("#joint_how_many_other_mortgages option[value="+t+"]").show();for(r=this.maxNoOfOtherMortgages-n,i=this.maxNoOfOtherMortgages;i>r;i--)$("#main_how_many_other_mortgages option[value="+i+"]").hide(),$("#joint_how_many_other_mortgages option[value="+i+"]").hide()}},_handleHowManyOtherMortgages:function(n){var t,i;if(this.soleOrJoint.getValue()==="joint"&&n!="")if(n==this.maxNoOfOtherMortgages)this._disableSection(this.sections.stepSix.main_joint_other_mortgages);else{for(this._enableSectionByGuid(this.sections.stepSix.main_joint_other_mortgages),t=1;t<this.maxNoOfOtherMortgages+1;t++)$("#main_how_many_joint_mortgages option[value="+t+"]").show();var r=this.howManyMainOtherMortgages.getValue()===""?0:this.howManyMainOtherMortgages.getValue(),u=this.howManyJointOtherMortgages.getValue()===""?0:this.howManyJointOtherMortgages.getValue(),f=Math.max(r,u),e=this.maxNoOfOtherMortgages-f;for(i=this.maxNoOfOtherMortgages;i>e;i--)$("#main_how_many_joint_mortgages option[value="+i+"]").hide()}},_handleStep3ClearForm:function(){this.mainAreRetired.getValue()==="Yes"&&(this.mainEmploymentStatus.setValue("R"),this.$el.find("#main_first_job_employment_status").prop("disabled",!0));this.soleOrJoint.getValue()==="joint"&&this.jointAreRetired.getValue()==="Yes"&&(this.jointEmploymentStatus.setValue("R"),this.$el.find("#joint_first_job_employment_status").prop("disabled",!0))},_handleStep1CustomValidation:function(){var t=[],f=!0,e=this.borrowerType.getValue(),o=this.$el.find("#required_loan"),i=nbs.number.parse(o.val()),l=nbs.number.parse(this.$el.find("#market_value").val()),a=nbs.number.parse(this.$el.find("#current_outstanding_balance").val()),v=nbs.number.parse(this.$el.find("#purchase_price").val()),s=this.propertyOwnership.getValue(),r=1,h,u,c,n;return this._getYearsAndMonths("requested_term")>this.maxTerm&&(this.$requestedTermRow.removeClass("valid").addClass("error"),this.$requestedTermRow.children(".field").children(".errorMessage").children("p").hide(),this.$requestedTermRow.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),n="Sorry, Nationwide cannot offer any product with a term greater than 40 years.",t.push(n)),e==="FA"?(i=i+a,r=this.ltvFA,this._getYearsAndMonths("requested_term")>this._getYearsAndMonths("remaining_term_of_loan")&&(this.$requestedTermRow.removeClass("valid").addClass("error"),this.$requestedTermRow.children(".field").children(".errorMessage").children("p").hide(),this.$requestedTermRow.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),n="Sorry, Nationwide cannot offer a Borrow More with a term greater than your existing agreement",t.push(n))):r=e==="RM"?this.ltvRM:this.ltvMG,h=s==="ES"||s==="RB"?i/l:i/v,h>r&&(u=o.closest(".formRow"),u.removeClass("valid").addClass("error"),u.children(".field").children(".errorMessage").children("p").hide(),u.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),c=this.$el.find("#borrower_type option:selected").text()+".",n="Sorry, Nationwide does not offer greater than "+r*100+"% LTV for "+c,t.push(n),f=!1),t.length>0&&(this.$errorList.html(this.$errorsTemplate.tmpl({errors:t})),this.errorOverlay.show()),this.borrowerType.getValue()==="FA"?($("#main_other_mortgages option[value=6]").hide(),$("#joint_other_mortgages option[value=12]").hide()):($("#main_other_mortgages option[value=6]").show(),$("#joint_other_mortgages option[value=12]").show()),f},_handleStep2CustomValidation:function(){var t=[],i=!0,h=nbs.registry.get("requested_term_yy").getValue(),c=this.soleOrJoint.getValue()==="joint"?!0:!1,y=this._getDob("#main_date_of_birth"),l=this._getAge(y),f=this.mainAreRetired.getValue()=="Yes",a=nbs.registry.get("main_retire_at_state_age").getValue()=="Yes",r=nbs.registry.get("main_planned_retirement_age_select").getValue(),e=this._isAgeError("#main_date_of_birth",l),v,o,u,s,n;return r=f||a||r.length==0?0:r,!f&&!a&&r<=l&&(this.$mainPlannedRetireAgeRow.removeClass("valid").addClass("error"),this.$mainPlannedRetireAgeRow.children(".field").children(".errorMessage").children("p").hide(),this.$mainPlannedRetireAgeRow.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),t.push("Your planned retirement age must be greater than your age."),i=!1),c&&(v=this._getDob("#joint_date_of_birth"),o=this._getAge(v),u=this.jointAreRetired.getValue()=="Yes",s=nbs.registry.get("joint_retire_at_state_age").getValue()=="Yes",e=this._isAgeError("#joint_date_of_birth",o)?!0:e,n=nbs.registry.get("joint_planned_retirement_age_select").getValue(),n=u||s||n.length==0?0:n,!u&&!s&&n<=o&&(this.$jointPlannedRetireAgeRow.removeClass("valid").addClass("error"),this.$jointPlannedRetireAgeRow.children(".field").children(".errorMessage").children("p").hide(),this.$jointPlannedRetireAgeRow.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),t.push("The planned retirement age for the joint applicant must be greater than their age."),i=!1)),e&&(t.push("Sorry, Nationwide does not offer mortgages to people under the age of 18 or over the age of 75. If one or more applicants are over 75 we are only able to lend if:<br/>a. They are an existing Nationwide borrower.<br/>b. They do not increase the loan amount.<br/>c. The term of the new loan is not greater than the current loan."),i=!1),t.length>0&&(this.$errorList.html(this.$errorsTemplate.tmpl({errors:t})),this.errorOverlay.show()),i&&(f?this.app1RetirementIncomeRequired=!1:this._getRetirementIncomeRequired("main",this._getDobString("#main_date_of_birth"),this._getGender("main"),r,h),c&&(u?this.app2RetirementIncomeRequired=!1:this._getRetirementIncomeRequired("joint",this._getDobString("#joint_date_of_birth"),this._getGender("joint"),n,h))),i},_handleStep3CustomValidation:function(){var r=this.soleOrJoint.getValue()==="joint"?!0:!1,t;this.mainEmploymentStatus.getValue()!="R"&&this.app1RetirementIncomeRequired?this._enableSectionByGuid(this.sections.stepFour.main_retirement_income):this._disableSection(this.sections.stepFour.main_retirement_income);r&&(this.jointEmploymentStatus.getValue()!="R"&&this.app2RetirementIncomeRequired?this._enableSectionByGuid(this.sections.stepFour.joint_retirement_income):this._disableSection(this.sections.stepFour.joint_retirement_income));var n=[],i=!0,f=this._getYearsAndMonths("main_second_remaining_contract"),u;return f>4e3&&(this.$mainSecondRemainContractRow.removeClass("valid").addClass("error"),this.$mainSecondRemainContractRow.children(".field").children(".errorMessage").children("p").hide(),this.$mainSecondRemainContractRow.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),t="The maximum remaining contract is 40 years.",n.push(t),i=!1),r&&(u=this._getYearsAndMonths("joint_second_remaining_contract"),u>4e3&&(this.$jointSecondRemainContractRow.removeClass("valid").addClass("error"),this.$jointSecondRemainContractRow.children(".field").children(".errorMessage").children("p").hide(),this.$jointSecondRemainContractRow.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),t="The maximum remaining contract is 40 years.",n.push(t),i=!1)),n.length>0&&(this.$errorList.html(this.$errorsTemplate.tmpl({errors:n})),this.errorOverlay.show()),i},_isAgeError:function(n,t){var r=!1,i=this.$el.find(n+"_d").closest(".formRow");return nbs.util.isDefined(t)&&(t<18||t>75)&&(r=!0,i.removeClass("valid").addClass("error"),i.children(".field").children(".errorMessage").children("p").hide(),i.children(".field").children(".errorMessage").children("p[data-error-type=date]").show()),r},_getDob:function(n){var t=this.$el.find(n+"_d"),i=this.$el.find(n+"_m"),r=this.$el.find(n+"_y"),u;return t.size()>0&&i.size()>0&&r.size()>0&&(u=new Date(r.val(),i.val()-1,t.val())),u},_getDobString:function(n){var t=this._getDob(n);return t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear()},_getGender:function(n){var t=nbs.registry.get(n+"_gender");return t.getValue()},_getAge:function(n){var t=new Date,i,r;return n&&(i=t.getFullYear()-n.getFullYear(),r=t.getMonth()-n.getMonth(),(r<0||r===0&&t.getDate()<n.getDate())&&i--),i},_getRetirementIncomeRequired:function(n,t,i,r,u){return $.ajax({type:"GET",global:!1,cache:!1,url:"/services/toolservice.svc/GetMortgageAffordabilityRetirementIncomeRequired",data:{dateOfBirth:t,gender:i,plannedRetirementAge:r,mortgageTerm:u},success:nbs.util.hitch(this,"_getRetirementIncomeRequiredSuccess",n),error:nbs.util.hitch(this,"_getRetirementIncomeRequiredError")}),!1},_getRetirementIncomeRequiredSuccess:function(n,t,i,r){r=="main"?this.app1RetirementIncomeRequired=n.GetMortgageAffordabilityRetirementIncomeRequiredResult:r=="joint"&&(this.app2RetirementIncomeRequired=n.GetMortgageAffordabilityRetirementIncomeRequiredResult)},_getRetirementIncomeRequiredError:function(){},toggle:function(n){var t=arguments,i=this;n==this.stepCount-1&&this._calculate();this.inherited.apply(this,arguments)},_calculate:function(){for(var r,i=this.forms,n={},t=0,u=i.length;t<u;t++)r=i[t],n=$.extend(!0,r.serialise(!0),n);n.main_applicant_retirement_income_required=this.app1RetirementIncomeRequired;n.joint_applicant_retirement_income_required=this.app2RetirementIncomeRequired;this.$resultArea.hide();this.$resultError.hide();this.$resultLoading.show();$.ajax({type:"POST",url:"/services/toolservice.svc/GetMsoMortgageAffordability",data:n,success:nbs.util.hitch(this,"_calculateSuccess"),error:nbs.util.hitch(this,"_calculateError")})},_calculateSuccess:function(n){var t;if(this.$resultError.hide(),t=n.GetMsoMortgageAffordabilityResult,nbs.util.isDefined(t)&&t!=null&&t.MortgageMaxAmount!=null&&t.MortgageMinTerm!=null){var u=parseInt(t.MortgageMinTerm.substr(0,2)),f=parseInt(t.MortgageMinTerm.substr(2,2)),e=nbs.number.parse(this.$requiredLoan.val()),i=this.$requestedTermYY.val(),r=this.$requestedTermMM.val(),o=i.length>0?parseInt(i):0,s=r.length>0?parseInt(r):0;this.$resultReqTerm.html(o+" years and "+s+" months");this.$resultAmount.html("&pound;"+nbs.number.formatWithCommas(t.MortgageMaxAmount));this.$resultReqLoanAmt.html("&pound;"+nbs.number.formatWithCommas(e));this.$resultTerm.html(u+" years and "+f+" months");this.$resultArea.fadeIn()}else this.$resultError.fadeIn();this.$resultLoading.hide()},_calculateError:function(){this.$resultLoading.hide();this.$resultError.fadeIn()}});nbs.modules.ProductComparison=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t=$.extend(!0,{productComparisonContainer:".productComparison",compareStickyHeader:".compareStickyHeader"},t);n.parents(".grid").addClass("productComparison");this.pcc=n.parents(this.opts.productComparisonContainer);this.compareStickyHeader=this.pcc.find(this.opts.compareStickyHeader);this.numberOfCols=this.compareStickyHeader.find("table tr:first th").length;this.tableWidth=parseInt(this.numberOfCols)*150;this.compareTable=this.pcc.find(".ProductCompareTable");this.compareStickyRow=this.pcc.find(".compareStickyRow");this.compareSticky=this.pcc.find(".compareSticky");this.compareStickyRow=this.pcc.find(".compareStickyRow");this.stickyRow=this.compareTable.find(".stickyRow");this.repEx=this.compareTable.find(".repEx");this.repEx.find(".titleStyle05").addClass("repEx");this.pcc.find("table").css({width:this.tableWidth+"px"});this.$applyScroll=this.pcc.find(".applyScroll");this.applyScrollHeadingClicked="";this.applyScrollLinkText="";this.$applyScroll.on("click",function(){var n=$(this).closest("tr").children().index($(this).closest("th"));applyScrollHeadingClicked=$(this).closest("tr").prev().find("th:eq("+n+")").find("h3").text();applyScrollLinkText=this.innerHTML});this.$applyScroll.on("click",nbs.util.hitch(this,"applyScroll"));nbs.dom.$window.scroll(nbs.util.hitch(this,"_scrollHandler"));this.compareStickyHeader.scroll(nbs.util.hitch(this,"_stickyheaderScrollHandler"));this.compareTable.scroll(nbs.util.hitch(this,"_compareTableScrollHandler"));this.$otherProdComparisonLinks=this.pcc.find("a").not(".applyScroll, [data-nbs-analytics-options]");this.$otherProdComparisonLinks.each(function(){var n=$(this).closest("tr").children().index($(this).closest("td")),t=$(this).closest(".ProductComparison").find(".compareStickyHeader table tr:eq(1) th:eq("+n+")").find("h3").text();$(this).attr("data-nbs-analytics-options","navigation:'"+s.pageName+"|ProdCompV|"+t+"|"+$(this).text()+"'")});this.$applyLinks=this.pcc.find(".productComparisonApply a");this.$applyLinks.each(function(){var n=$(this).closest("tr").children().index($(this).closest("td")),t=$(this).closest(".ProductComparison").find(".compareStickyHeader table tr:eq(1) th:eq("+n+")").find("h3").text();$(this).append('&nbsp;<span class="srText">for '+t+"<\/span>")});this.$findOutMoreLinks=this.pcc.find("a.arrowLink");this.$findOutMoreLinks.each(function(){var n=$(this).closest("tr").children().index($(this).closest("td")),t=$(this).closest(".ProductComparison").find(".compareStickyHeader table tr:eq(1) th:eq("+n+")").find("h3").text();$(this).append('&nbsp;<span class="srText">about '+t+"<\/span>")})},startup:function(){this.pccHeight=$(".productComparison").outerHeight();$compareStickyHeight=this.compareSticky.outerHeight()},applyScroll:function(n){n.preventDefault();$("html, body").animate({scrollTop:this.pcc.offset().top+this.pcc.outerHeight(!0)-$(window).height()},300);this._analyticsApplyScroll(applyScrollHeadingClicked,applyScrollLinkText)},_scrollHandler:function(){var n=$(window).scrollTop(),i=$(this.opts.productComparisonContainer).offset(),t=parseInt(i.top),r=parseInt(this.pccHeight-$compareStickyHeight+t-150),u=this.compareStickyRow;n>=t&&n<=r?(this.compareSticky.addClass("fixed"),this.compareStickyRow.show(),this.compareTable.css({marginTop:$compareStickyHeight+"px"})):(this.compareSticky.removeClass("fixed"),this.compareStickyRow.hide(),this.compareTable.css({marginTop:"0px"}));this.stickyRow.each(function(){var t=$(this),i=t.html();thisOffset=t.offset();thisOffsetTop=parseInt(thisOffset.top-$compareStickyHeight);n>=thisOffsetTop&&u.html(i)})},_stickyheaderScrollHandler:function(){if(!this.compareTable.hasClass("scrolling")){this.compareStickyHeader.addClass("scrolling");var n=this.compareStickyHeader.scrollLeft();this.compareTable.scrollLeft(n);clearTimeout($.data(this,"scrollTimer"));$.data(this,"scrollTimer",setTimeout(function(){$(".compareStickyHeader").removeClass("scrolling")},250))}},_compareTableScrollHandler:function(){if(!this.compareStickyHeader.hasClass("scrolling")){this.compareTable.addClass("scrolling");var n=this.compareTable.scrollLeft();this.compareStickyHeader.scrollLeft(n);clearTimeout($.data(this,"scrollTimer"));$.data(this,"scrollTimer",setTimeout(function(){$(".ProductCompareTable").removeClass("scrolling")},250))}},_analyticsApplyScroll:function(n,t){s.tl("true","o","ProdCompV|"+n+"|"+t)},_analyticsOtherLinksInPanel:function(){}});nbs.modules.RiskAssessment=nbs.declare(nbs.modules._Base,{pieChart:null,stageIndex:0,stageData:null,initialised:!1,colours:["#1775d9","#73ae57","#dc291e","#eb7125"],pieChartOptions:{tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value %>%",animationEasing:"easeOutQuart",animationSteps:50,tooltipFillColor:"rgba(255,255,255,0.9)",tooltipFontColor:"#5b6063"},initialise:function(n,t){this.inherited.apply(this,arguments);this.stageData=t.riskData;this.$legendLabels=n.find(".riskChart .legend .dataLabel");this.$legendValues=n.find(".riskChart .legend .dataValue");this.$riskContent=n.find(".riskContent .riskStageContent");this.$riskContent.hide();this.$chartHolder=n.find(".riskChart .chart");this.$riskSlider=this.$el.find("#RiskSlider");nbs.dom.$window.scroll(nbs.util.hitch(this,"_scrollHandler"));this._bindGenerateButton()},startup:function(){var n=nbs.registry.get(this.$riskSlider);this.stageIndex=n.getValue();n.on("move",nbs.util.hitch(this,"_riskSliderMove"))},_scrollHandler:function(){var n=nbs.dom.$window.scrollTop(),t=nbs.dom.$window.height(),i=this.$riskSlider.offset().top;!this.initialised&&n>i-t&&(nbs.util.defer(function(){this._createChart()},this,1e3),this.initialised=!0)},_createChart:function(){var i=this.stageData[this.stageIndex].data,r,t,n,u;if(document.createElement("canvas").getContext){for(r=$("#riskPieChart").get(0).getContext("2d"),t=[],n=0;n<4;n++)u=this.$legendLabels.eq(n).text(),t.push({label:u,color:this.colours[n],value:i[n]});this.pieChart=new Chart(r).Pie(t,this.pieChartOptions);this._checkForSingleSegment()}else this._createChartFallback();this._updateLegendValues(i);this.$riskContent.eq(this.stageIndex).fadeIn()},_createChartFallback:function(){var n=this.stageData[this.stageIndex].fallbackImg;$("#riskPieChart").remove();this.$chartImg=$("<img><\/img>").hide();this.$chartHolder.prepend(this.$chartImg);n&&(this.$chartImg.prop("src",n),this.$chartImg.fadeIn())},_riskSliderMove:function(n){var t=this,i=n.value,r=this.stageData[i],u=r.data;i!=this.stageIndex&&(this.pieChart?(this.pieChart.stop(),this._updatePieData(u),this.pieChart.update()):this.$chartImg.fadeOut(function(){r.fallbackImg&&(t.$chartImg.prop("src",r.fallbackImg),t.$chartImg.fadeIn())}),this.$legendValues.fadeOut(nbs.util.hitch(this,"_updateLegendValues",u)),this.$riskContent.eq(this.stageIndex).fadeOut(function(){t.$riskContent.hide();t.$riskContent.eq(i).fadeIn()}),this.stageIndex=i,this._analytics())},_updateLegendValues:function(n){for(var t=0;t<n.length;t++)this.$legendValues.eq(t).html('<span class="srText">'+this.$legendLabels.eq(t).text()+": <\/span>"+n[t]+"%");this.$legendValues.fadeIn()},_updatePieData:function(n){for(var t=0;t<n.length;t++)this.pieChart.segments[t].value=n[t];this._checkForSingleSegment()},_checkForSingleSegment:function(){for(var t,n=0;n<this.pieChart.segments.length;n++)t=this.pieChart.segments[n],t.showStroke=t.value==this.pieChart.total?!1:!0},_bindGenerateButton:function(){var n=this;$("#lnkGenChartImg").click(function(t){t.preventDefault();window.open(n.pieChart.toBase64Image())})},_analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({pageName:"bw:tool:Risk Assessment",eVar4:"Risk Assessment|Interacted",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"}),this.analyticsHasRan=!0}}),function(){"use strict";var n={poilcyTypes:{LifeInsurance:"LifeInsurance",MortgageProtection:"MortgageProtection"},MortgageCoverTypes:{Level:"LevelTerm",Decreasing:"DecreasingTerm"},radioValues:{withoutCic:"withoutCic",withCic:"withCic"},content:{poilcyShortNames:{LifeInsurance:"Life",MortgageProtection:"Mortgage"},MortgageCoverTypes:{LevelTerm:"Level",DecreasingTerm:"Decreasing"},resultsWithCiC:", including Critical Illness Cover",radios:{unselectedText:"Select this policy",selectedText:"Selected"},smoker:{Yes:"Smoker",No:"Non smoker"}},quoteTypes:{Benefit:"Benefit",Contribution:"Contribution"},holders:{Sole:"Sole",Joint:"Joint"},styles:{buttons:{positive:"buttonStyle01",negative:"buttonStyle03"}},validation:{ageAtStart:{minimum:18,maximum:90},ageAtEnd:{maximum:90},term:{minimum:1,maximum:50}}};nbs.modules.ProtectionInsuranceQuickQuoteCalculator=nbs.declare(nbs.modules.SteppedForm,{steppedFormName:"Protection Insurance Quick Quote Calculator",capture:{},quote:{},sendData:{},temp:{},results:{},errors:{},products:0,response:{},xml:"",initialise:function(n,t){this.inherited.apply(this,arguments);this.today=new Date(Date.parse(t.today));this.opts=t=$.extend(!0,{sections:{monthly:"#57fcb8f90cb84447aeb6d4b6a65dd499",total:"#b68c3951d1d8474fb44ea9440524775a"}},t);this.$sectionMonthly=n.find(t.sections.monthly);this.$sectionTotal=n.find(t.sections.total);this.errors.$errorList=n.find("#errorOverlay ol");this.errors.$errorsTemplate=n.find("#errorsTemplate");this.results.$resultArea=n.find(".resultArea");this.results.$resultError=n.find(".resultError");this.results.$resultLoading=n.find(".resultLoading");this.results.years=this.results.$resultArea.find(".years");this.results.smoker=this.results.$resultArea.find(".smoker");this.results.dob=this.results.$resultArea.find(".dob");this.results.smoker2=this.results.$resultArea.find(".smoker2");this.results.dob2=this.results.$resultArea.find(".dob2");this.results.joint=this.results.$resultArea.find(".joint");this.results.policyType=this.results.$resultArea.find(".policyType");this.results.coverType=this.results.$resultArea.find(".coverType");this.results.product2=this.results.$resultArea.find(".product2");this.results.product1Radio=this.results.$resultArea.find(".product1Radio");this.results.timeout=this.$el.find(".timeout");this._intializeStep1();this._intializeStep2()},_intializeStep1:function(){this.$sectionMonthly.hide();this.$sectionTotal.hide();this.results.timeout.hide();this.quote.SoleJoint=n.holders.Sole;this.$sectionTotal.addClass("optionalSection");this.$sectionMonthly.addClass("optionalSection")},_intializeStep2:function(){},startup:function(){this.inherited.apply(this,arguments);this.capture.PolicyType=nbs.registry.get(this.$el.find("#PolicyType"));this.capture.MortgageCoverType=nbs.registry.get(this.$el.find("#MortgageCoverType"));this.capture.CoverDuration_yy=nbs.registry.get(this.$el.find("#CoverDuration_yy"));this.capture.CoverDuration_yy.$el.on("keyup",nbs.util.hitch(this,"_changeCoverDuration_yy"));this.capture.QuoteType=nbs.registry.get(this.$el.find("#QuoteType"));this.capture.QuoteType.on("change",nbs.util.hitch(this,"_changeQuoteType"));this.capture.CoverTotal=nbs.registry.get(this.$el.find("#CoverTotal"));this.capture.CoverMonthly=nbs.registry.get(this.$el.find("#CoverMonthly"));this.capture.SoleJoint=nbs.registry.get(this.$el.find("#SoleJoint"));this.capture.SoleJoint.on("change",nbs.util.hitch(this,"_changeHolders"));this.capture.MainDOB_d=nbs.registry.get(this.$el.find("#MainDOB_d"));this.capture.MainDOB_m=nbs.registry.get(this.$el.find("#MainDOB_m"));this.capture.MainDOB_y=nbs.registry.get(this.$el.find("#MainDOB_y"));this.capture.MainSmoker=nbs.registry.get(this.$el.find("#MainSmoker"));this.capture.JointDOB_d=nbs.registry.get(this.$el.find("#JointDOB_d"));this.capture.JointDOB_m=nbs.registry.get(this.$el.find("#JointDOB_m"));this.capture.JointDOB_y=nbs.registry.get(this.$el.find("#JointDOB_y"));this.capture.JointSmoker=nbs.registry.get(this.$el.find("#JointSmoker"));this.capture.productRadios=nbs.registry.get(this.$el.find(".productRadios"));this.capture.productRadios.$el.find(".radio").find(".smallPrint").hide();this.capture.productRadios.on("change",nbs.util.hitch(this,"_changeProductRadios"));this.capture.agreeTerms=nbs.registry.get(this.$el.find(".agreeTerms"));this.capture.agreeTerms.on("change",nbs.util.hitch(this,"_changeAgreeTerms"));this.capture.Back=this.$el.find(".back");this.capture.Back.on("click",nbs.util.hitch(this,"_clickBack"));this.capture.Apply=this.$el.find(".apply");this.capture.Apply.on("click",nbs.util.hitch(this,"_clickApply"));this.capture.Retry=this.$el.find(".retry");this.capture.Retry.on("click",nbs.util.hitch(this,"_clickRetry"));this.errors.errorOverlay=nbs.registry.get("errorOverlay");this.forms[0].customFormValidationFunction=nbs.util.hitch(this,"_handleStep1CustomValidation")},_changeQuoteType:function(){var t=this.capture.QuoteType.getValue();switch(t){case n.quoteTypes.Benefit:this.$sectionMonthly.hide();this.$sectionMonthly.removeClass("open");this.$sectionMonthly.addClass("closed");this.$sectionTotal.show();this.$sectionTotal.removeClass("closed");this.$sectionTotal.addClass("open");this.quote.QuoteType=n.quoteTypes.Benefit;break;case n.quoteTypes.Contribution:this.$sectionTotal.hide();this.$sectionTotal.removeClass("open");this.$sectionTotal.addClass("closed");this.$sectionMonthly.show();this.$sectionMonthly.addClass("open");this.$sectionMonthly.removeClass("closed");this.quote.QuoteType=n.quoteTypes.Contribution}},_changeProductRadios:function(){this.capture.productRadios.setLabel(n.content.radios.unselectedText,0);this.capture.productRadios.setLabel(n.content.radios.unselectedText,1);this.capture.productRadios.setLabel(n.content.radios.selectedText);this.capture.productRadios.$el.find(".radio").find(".smallPrint").hide();this.capture.productRadios.$radios.eq(this.capture.productRadios.index).closest(".radio").find(".smallPrint").show()},_changeHolders:function(){var t=this.capture.SoleJoint.getValue();switch(t){case n.holders.Sole:this.quote.SoleJoint=n.holders.Sole;break;case n.holders.Joint:this.quote.SoleJoint=n.holders.Joint}},_changeAgreeTerms:function(){this.capture.Apply.toggleClass(n.styles.buttons.positive+" "+n.styles.buttons.negative);this.capture.Apply.attr("disabled",function(n,t){return t==="disabled"?!1:"disabled"})},_clickApply:function(n){n.preventDefault();this._handleStep2CustomValidation()&&this._createPrepop()},_clickRetry:function(n){n.preventDefault();this._calculate()},_clickBack:function(n){n.preventDefault();this.toggle(0)},_changeCoverDuration_yy:function(){var n=this.capture.CoverDuration_yy.getValue();n.length>2&&(n=n.substring(0,2));this.capture.CoverDuration_yy.$el.val(n)},toggle:function(n){n==this.stepCount-1&&(this._populateQuoteData(),this._calculate());this.inherited.apply(this,arguments)},_populateQuoteData:function(){this.quote.PolicyType=this.capture.PolicyType.getValue();this.quote.MortgageCoverType=n.MortgageCoverTypes.Level;this.quote.PolicyType===n.poilcyTypes.MortgageProtection&&(this.quote.MortgageCoverType=this.capture.MortgageCoverType.getValue());this.quote.CoverDuration_yy=this.capture.CoverDuration_yy.getValue();this.quote.QuoteType===n.quoteTypes.Contribution?(this.quote.CoverMonthly=this.capture.CoverMonthly.getValue(),this.quote.CoverTotal=null):(this.quote.CoverTotal=this.capture.CoverTotal.getValue(),this.quote.CoverMonthly=null);this.temp.MainDOB_d=this.capture.MainDOB_d.getValue();this.temp.MainDOB_m=this.capture.MainDOB_m.getValue();this.temp.MainDOB_d.length>0&&(this.temp.MainDOB_d=this.temp.MainDOB_d.length<2?"0"+this.temp.MainDOB_d:this.temp.MainDOB_d,this.capture.MainDOB_d.setValue(this.temp.MainDOB_d));this.temp.MainDOB_m.length>0&&(this.temp.MainDOB_m=this.temp.MainDOB_m.length<2?"0"+this.temp.MainDOB_m:this.temp.MainDOB_m,this.capture.MainDOB_m.setValue(this.temp.MainDOB_m));this.temp.MainDOB_y=this.capture.MainDOB_y.getValue();this.quote.MainSmoker=this.capture.MainSmoker.getValue();this.quote.MainHolderDob="{0}-{1}-{2}".format(this.temp.MainDOB_y,this.temp.MainDOB_m,this.temp.MainDOB_d);this.quote.SoleJoint===n.holders.Joint&&(this.temp.JointDOB_d=this.capture.JointDOB_d.getValue(),this.temp.JointDOB_m=this.capture.JointDOB_m.getValue(),this.temp.JointDOB_y=this.capture.JointDOB_y.getValue(),this.quote.JointSmoker=this.capture.JointSmoker.getValue(),this.quote.JointHolderDob="{0}-{1}-{2}".format(this.temp.JointDOB_y,this.temp.JointDOB_m,this.temp.JointDOB_d));this.temp={}},_handleStep1CustomValidation:function(){function f(n){var t=new Date,i=t.getFullYear(),r=i-n.getFullYear(),u=new Date(i,n.getMonth(),n.getDate()),f=t>=u;return f?r:r-1}var t=[],u=!0,i,r;return this._populateQuoteData(),i=f(new Date(this.quote.MainHolderDob)),(i>=n.validation.ageAtStart.maximum||i<n.validation.ageAtStart.minimum)&&t.push("Applicants must be between {0} and {1} years old".format(n.validation.ageAtStart.minimum,n.validation.ageAtStart.maximum)),i+nbs.number.parse(this.quote.CoverDuration_yy)>=n.validation.ageAtEnd.maximum&&t.push("Term cannot extend beyond your {0}th birthday".format(n.validation.ageAtEnd.maximum)),this.quote.SoleJoint===n.holders.Joint&&(r=f(new Date(this.quote.JointHolderDob)),(r>=n.validation.ageAtStart.maximum||r<n.validation.ageAtStart.minimum)&&t.push("Applicants must be between {0} and {1} years old".format(n.validation.ageAtStart.minimum,n.validation.ageAtStart.maximum)),r+nbs.number.parse(this.quote.CoverDuration_yy)>=n.validation.ageAtEnd.maximum&&t.push("Term cannot extend beyond your {0}th birthday".format(n.validation.ageAtEnd.maximum))),t.length>0&&(this.errors.$errorList.html(this.errors.$errorsTemplate.tmpl({errors:t})),this.errors.errorOverlay.show(),u=!1),u},_handleStep2CustomValidation:function(){var n=[],t=!0;return this.capture.agreeTerms.getChecked()||(t=!1),this.capture.productRadios.getValue()==null&&this.products===2&&n.push("Please select a policy to continue"),n.length>0&&(this.errors.$errorList.html(this.errors.$errorsTemplate.tmpl({errors:n})),this.errors.errorOverlay.show(),t=!1),t},_calculate:function(){var t=this.forms;this.sendData={};this.results.$resultArea.hide();this.results.$resultError.hide();this.results.$resultLoading.fadeIn();this.results.timeout.fadeOut();this.sendData.PolicyType=this.quote.PolicyType;this.quote.PolicyType===n.poilcyTypes.MortgageProtection&&(this.sendData.MortgageCoverType=this.quote.MortgageCoverType);this.sendData.CoverDuration_yy=this.quote.CoverDuration_yy;this.sendData.QuoteType=this.quote.QuoteType;this.quote.QuoteType===n.quoteTypes.Contribution?this.sendData.CoverMonthly=this.capture.CoverMonthly.getValue():this.sendData.CoverTotal=this.capture.CoverTotal.getValue();this.sendData.SoleJoint=this.quote.SoleJoint;this.sendData.MainSmoker=this.quote.MainSmoker;this.sendData.MainHolderDob=this.quote.MainHolderDob;this.quote.SoleJoint===n.holders.Joint&&(this.sendData.JointSmoker=this.quote.JointSmoker,this.sendData.JointHolderDob=this.quote.JointHolderDob);$.ajax({type:"POST",url:"/services/toolservice.svc/GetProtectionInsuranceQuote",data:this.sendData,context:this,timeout:5e3,async:!0}).done(function(n){this._calculateSuccess(n)}).fail(function(n,t,i){this._calculateError(n,t,i)})},_calculateSuccess:function(t){var i,r,u,f;this.response={};t.Products=t.Products||[];this.products=t.Products.length;t.Products.length===0&&this._calculateError();t.Products.length>0&&(this.capture.productRadios.reset(),this.capture.productRadios.setLabel(n.content.radios.unselectedText,0),this.capture.productRadios.setLabel(n.content.radios.unselectedText,1),this.capture.agreeTerms.getChecked()&&(this.capture.agreeTerms.reset(),this.capture.agreeTerms.trigger("change")),i=nbs.tidying.formatCurrency(nbs.number.parse(t.Products[0].MonthlyPremium),2),r=nbs.tidying.formatCurrency(nbs.number.parse(t.Products[0].TotalCover),2),$(".product1Contribution").html(i),$(".product1Benefit").html(r),this.capture.productRadios.$el.find(".radio").find(".smallPrint").hide(),t.Products.length===1&&(this.results.product2.hide(),this.results.product1Radio.hide(),this.capture.productRadios.$el.find(".smallPrint").show()),t.Products.length===2&&(this.results.product2.show(),this.results.product1Radio.show(),u=nbs.tidying.formatCurrency(nbs.number.parse(t.Products[1].MonthlyPremium),2),f=nbs.tidying.formatCurrency(nbs.number.parse(t.Products[1].TotalCover),2),$(".product2Contribution").html(u),$(".product2Benefit").html(f)),this.results.$resultError.fadeOut(),this.results.$resultArea.fadeIn(),this.results.$resultLoading.fadeOut(),this.results.years.text("{0} years".format(this.quote.CoverDuration_yy)),this.results.smoker.text(n.content.smoker[this.quote.MainSmoker]),this.results.dob.text(this.quote.MainHolderDob),this.results.policyType.text(n.content.poilcyShortNames[this.quote.PolicyType]),this.results.coverType.text(n.content.MortgageCoverTypes[this.quote.MortgageCoverType]),this.results.joint.hide(),this.quote.SoleJoint===n.holders.Joint&&(this.results.smoker2.text(n.content.smoker[this.quote.JointSmoker]),this.results.dob2.text(this.quote.JointHolderDob),this.results.joint.show()),this.capture.Apply.show(),this.response=t,window.setTimeout(nbs.util.hitch(this,"_timeoutQuote"),12e5))},_timeoutQuote:function(){this.capture.Apply.fadeOut();this.results.$resultError.fadeOut();this.results.$resultArea.fadeOut();this.results.$resultLoading.fadeOut();this.results.timeout.fadeIn()},_createPrepop:function(){var n=$("<form />"),i=$("<input />"),r=$("<input />"),t="";this.response.Products.length===1&&(t=this.response.Products[0].XmlData);this.response.Products.length===2&&(t=this.response.Products[this.capture.productRadios.index].XmlData);i.attr({type:"hidden",value:t,name:"xmlData"});r.attr({type:"submit",value:"submitPrepop",name:"submitButton"});n.attr({action:"https://www10.landg.com/COLAWeb/getQuote.htm?campaignCode=NW01&campaignSource=NWEB&isMyLife=true",method:"post",target:"_blank"});n.append(i);n.append(r);nbs.dom.$body.append(n);n.trigger("submit");n.remove()},_calculateError:function(){var n=[];n.length>0&&(this.errors.$errorList.html(this.errors.$errorsTemplate.tmpl({errors:n})),this.errors.errorOverlay.show());this.capture.Apply.hide();this.results.$resultLoading.hide();this.results.$resultError.fadeIn()}})}();nbs.modules.QuickQuoteAffordabilityCalculator=nbs.declare(nbs.modules.SteppedForm,{maxTerm:4e3,steppedFormName:"Quick Quote Mortgage Affordability Calculator",initialise:function(n){this.inherited.apply(this,arguments);this._intializeStep1();this.$errorList=n.find("#errorOverlay ol");this.$errorsTemplate=n.find("#errorsTemplate");this.$resultAmount=n.find("#result_mortgage_amount");this.$resultReqLoanAmt=n.find(".termResult span.requestedLoanAmt");this.$resultArea=n.find(".resultArea");this.$resultError=n.find(".resultError");this.$resultLoading=n.find(".resultLoading");this.$zeroResult=n.find(".zeroResult");this.$printCalcResults=n.find(".printCalcResults")},_generatePrintSummaryOfDataEntered:function(){var r,n,t,i;$(".printedSummary").remove();$(".resultsContainer").prepend("<table class='printedSummary'><caption>Based on the following details that you entered:<\/caption><\/table>");$("button.printCalcResults").closest(".toolSection").find(".formRow").each(function(){$(this).find("input[type=text],input[type=number],select :selected, div.radio.checked, input[type=checkbox] :checked").each(function(){t=i="";$(this).is("option")?(n=$(this).text(),(n=="Please choose"||n=="Please select")&&(n="")):n=$(this).is("div.radio.checked")?$(this).find("label").text():$(this).val();r=$(this).closest(".formRow").find(".label label").clone().children().remove().end().text();t=$(this).closest(".formRow").find(".prefix").text();$(this).parent().hasClass("yearsInput")&&(i=" years");n!=""&&$(".printedSummary").append("<tr><th>"+r+"<\/th><td>"+t+n+i+"<\/td><\/tr>")})});this.$printCalcResults.on("click",function(){return window.print(),!1})},_intializeStep1:function(){this.$requiredLoan=this.$el.find("#required_loan");this.$requestedTermYY=this.$el.find("#requested_term_yy");this.$requestedTermRow=this.$requestedTermYY.closest(".formRow")},startup:function(){this.inherited.apply(this,arguments);this.forms[0].customFormValidationFunction=nbs.util.hitch(this,"_handleStep1CustomValidation");this.errorOverlay=nbs.registry.get("errorOverlay");this._startUpStep1();this.soleOrJoint=nbs.registry.get("sole_or_joint")},_startUpStep1:function(){},_setRadioButton:function(n,t){var i=nbs.registry.get(n);i.toggle(t)},_enableField:function(n){var i=this.$el.find("#"+n),t=i.closest(".formRow");t.data("required",!0);t.show()},_setFieldAsRequired:function(n){var i=this.$el.find("#"+n),t=i.closest(".formRow");t.data("required",!0);t.find(".required").show()},_disableField:function(n){var i=this.$el.find("#"+n),t=i.closest(".formRow");t.data("required",!1);t.hide()},_setFieldAsUnrequired:function(n){var i=this.$el.find("#"+n),t=i.closest(".formRow");t.data("required",!1);t.find(".required").hide()},_isSectionEnabled:function(n){var t=this.$el.find(n);return t.hasClass("open")},_enableSectionByGuid:function(n){var t=this.$el.find(n);t.removeClass("closed").addClass("open");t.slideDown()},_disableSection:function(n){var t=this.$el.find(n);t.removeClass("open").addClass("closed");t.slideUp()},_disableAllSections:function(n){for(var t in n)this._disableSection(n[t])},_disableSectionsStartingWith:function(n,t){for(var i in n)i.indexOf(t)>=0&&this._disableSection(n[i])},_getYears:function(n){var t=nbs.registry.get(n+"_yy").getValue();return parseInt(t)*100},_handleStep1CustomValidation:function(){var n=[],t=!0,i;return this._getYears("requested_term")>this.maxTerm&&(this.$requestedTermRow.removeClass("valid").addClass("error"),this.$requestedTermRow.children(".field").children(".errorMessage").children("p").hide(),this.$requestedTermRow.children(".field").children(".errorMessage").children("p[data-error-type=required]").show(),i="Sorry, Nationwide cannot offer any product with a term greater than 40 years.",n.push(i),t=!1),n.length>0&&(this.$errorList.html(this.$errorsTemplate.tmpl({errors:n})),this.errorOverlay.show()),t},toggle:function(n){var t=arguments,i=this;n==this.stepCount-1&&this._calculate();this.inherited.apply(this,arguments)},_calculate:function(){for(var r,i=this.forms,n={},t=0,u=i.length;t<u;t++)r=i[t],n=$.extend(!0,r.serialise(!0),n);this.$zeroResult.hide();this.$resultArea.hide();this.$resultError.hide();this.$resultLoading.show();$.ajax({type:"POST",url:"/services/toolservice.svc/GetQuickQuoteMortgageAffordability",data:n,success:nbs.util.hitch(this,"_calculateSuccess"),error:nbs.util.hitch(this,"_calculateError")})},_calculateSuccess:function(n){this.$resultError.hide();var t=n.GetQuickQuoteMortgageAffordabilityResult;nbs.util.isDefined(t)&&t!=null&&t.MortgageMaxAmount!=null?(this.$resultAmount.html("&pound;"+nbs.number.formatWithCommas(t.MortgageMaxAmount)),t.MortgageMaxAmount!=0?this.$resultArea.fadeIn():this.$zeroResult.fadeIn()):this.$resultError.fadeIn();this.$resultLoading.hide();$("button.printCalcResults").attr("aria-hidden",!1).attr("hidden",!1);this._generatePrintSummaryOfDataEntered()},_calculateError:function(){$("button.printCalcResults").attr("aria-hidden",!0).attr("hidden",!0);$(".printedSummary").remove();this.$resultLoading.hide();this.$resultError.fadeIn()}});nbs.modules.SavingsGoalHitTheGoalCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.$el=n;this.opts=t;this.factory=nbs.factories.SavingsGoalFactory},startup:function(){this.capture={atLeastOneError:this.$el.find(".atLeastOneErrorOnThisForm"),targetbalance:nbs.registry.get(this.$el.find(".goalBalance")),startbalance:nbs.registry.get(this.$el.find(".goalStartingBalance")),saving:nbs.registry.get(this.$el.find(".goalSaveAmount")),frequency:nbs.registry.get(this.$el.find(".goalFrequency")),rate:nbs.registry.get(this.$el.find(".goalRate"))};this.validate={targetbalance:this.$el.find(".goalBalance"),startbalance:this.$el.find(".goalStartingBalance"),saving:this.$el.find(".goalSaveAmount"),frequency:this.$el.find(".goalFrequency"),rate:this.$el.find(".goalRate")};this.results={targetbalance:this.$el.find(".resultGoal"),targetbalanceactual:this.$el.find(".resultGoalActual"),saving:this.$el.find(".resultSaving"),interest:this.$el.find(".resultInterest"),frequency:this.$el.find(".resultFrequency"),rate:this.$el.find(".resultRate"),date:this.$el.find(".resultDate")};this.action={calculate:this.$el.find(".calculate"),reset:this.$el.find(".reset")};this.form={capture:this.$el.find(".capture"),results:this.$el.find(".results")};this._bindEvents()},_bindEvents:function(){this.action.calculate.on("click",nbs.util.hitch(this,"_calculate"));this.action.reset.on("click",nbs.util.hitch(this,"_reset"));this.validate.targetbalance.on("change",nbs.util.hitch(this,"_validatetargetbalance"));this.validate.startbalance.on("change",nbs.util.hitch(this,"_validatestartbalance"));this.validate.saving.on("change",nbs.util.hitch(this,"_validatesaving"));this.validate.rate.on("change",nbs.util.hitch(this,"_validaterate"))},_validatetargetbalance:function(){var n=parseFloat(this.capture.targetbalance.getValue()),t;return n==""||n<1||isNaN(n)?(this.validate.targetbalance.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.targetbalance.required),this.validate.targetbalance.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.targetbalance.required)),this.validate.targetbalance.parents(".field").addClass("error").removeClass("valid"),this.validate.targetbalance.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):(t=parseFloat(this.capture.startbalance.getValue()),t!=""&&n<=t)?(this.validate.targetbalance.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.targetbalance.lessThanSaved),this.validate.targetbalance.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.targetbalance.lessThanSaved)),this.validate.targetbalance.parents(".field").addClass("error").removeClass("valid"),this.validate.targetbalance.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):(this.validate.targetbalance.parents(".field").removeClass("error").addClass("valid"),this.validate.targetbalance.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0),!0)},_validatestartbalance:function(){var t=parseFloat(this.capture.startbalance.getValue()),n=parseFloat(this.capture.targetbalance.getValue());return n!=""&&t>=n?(this.validate.startbalance.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.startbalance.greaterThanGoal),this.validate.startbalance.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.startbalance.greaterThanGoal)),this.validate.startbalance.parents(".field").addClass("error").removeClass("valid"),this.validate.startbalance.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):(this.validate.startbalance.parents(".field").removeClass("error").addClass("valid"),this.validate.startbalance.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0),!0)},_validatesaving:function(){var n=!0,t=this.capture.saving.getValue()||0,i=this.capture.rate.getValue()||0,r=this.capture.startbalance.getValue()||0,u=parseFloat(i)>0&&parseFloat(r)>0?!0:!1;return!u&&t<=0?(n=!1,this.validate.saving.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.saving.required),this.validate.saving.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.saving.required)),this.validate.saving.parents(".field").addClass("error").removeClass("valid"),this.validate.saving.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden")):(this.validate.saving.parents(".field").removeClass("error").addClass("valid"),this.validate.saving.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0)),n},_validaterate:function(){var n=!0,t=this.capture.rate.getValue()||0,i=this.capture.saving.getValue()||0,r=parseFloat(t)<=0&&parseFloat(i)>0;return!r&&t<=0?(n=!1,this.validate.rate.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.rate.required),this.validate.rate.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.rate.required)),this.validate.rate.parents(".field").addClass("error").removeClass("valid"),this.validate.rate.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden")):(this.validate.rate.parents(".field").removeClass("error").addClass("valid"),this.validate.rate.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0)),n},_validateFields:function(){var n=!0;return this._validatetargetbalance()||(n=!1),this._validatestartbalance()||(n=!1),this._validatesaving()||(n=!1),this._validaterate()||(n=!1),n?this.capture.atLeastOneError.attr("aria-hidden","true").attr("hidden",!0):(this.capture.atLeastOneError.attr("aria-hidden","false").removeAttr("hidden"),$("#errNotication1").focus()),n},_calculate:function(n){var i,r;if(n.preventDefault(),this._validateFields()){var u=parseFloat(this.capture.targetbalance.getValue())||0,f=parseFloat(this.capture.startbalance.getValue())||0,e=parseFloat(this.capture.saving.getValue())||0,o=parseFloat(this.capture.frequency.getValue())||0,s=parseFloat(this.capture.rate.getValue())||0,t=this.factory.hitTheGoal(u,f,e,o,s);this.results.targetbalance.text(nbs.number.formatWithCommas(u,2));this.results.targetbalanceactual.text(nbs.number.formatWithCommas(parseFloat(t.saved),2));this.results.saving.text(nbs.number.formatWithCommas(t.periodicDeposit,2));this.results.interest.text("including £"+nbs.number.formatWithCommas(parseFloat(t.interest),2)+" in  interest");switch(t.monthsInPeriod){case 1:this.results.frequency.text("per month");break;case 3:this.results.frequency.text("per quarter");break;case 12:this.results.frequency.text("per year")}this.results.rate.text(t.rate.toFixed(2));i=Math.floor(t.term/12);r=t.term%12;i===0&&r===0?this.results.date.text("0 years 0 months"):this.results.date.text((i>0?i+(i===1?" year ":" years "):"")+(r>0?r+(r===1?" month":" months"):""));this.form.capture.hide();this.form.results.show();this._analytics()}else $(".jumpToFirstError").click(function(){return $(this).closest(".form").find(".field.error").first().find(":input").first().focus(),!1})},_reset:function(n){n.preventDefault();this.form.capture.show();this.form.results.hide()},_analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({pageName:"bw:tool:Savings Goal Hit the Goal",eVar4:"bw:tool:Savings Goal Hit the Goal|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage",!1),this.analyticsHasRan=!0}});nbs.modules.SavingsGoalHowMuchSavedCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.$el=n;this.opts=t;this.factory=nbs.factories.SavingsGoalFactory},startup:function(){this.capture={atLeastOneError:this.$el.find(".atLeastOneErrorOnThisForm"),startbalance:nbs.registry.get(this.$el.find(".goalStartingBalance")),saving:nbs.registry.get(this.$el.find(".goalSaveAmount")),frequency:nbs.registry.get(this.$el.find(".goalFrequency")),durationyears:nbs.registry.get(this.$el.find(".durationYears")),durationmonths:nbs.registry.get(this.$el.find(".durationMonths")),rate:nbs.registry.get(this.$el.find(".goalRate"))};this.validate={startbalance:this.$el.find(".goalStartingBalance"),saving:this.$el.find(".goalSaveAmount"),frequency:this.$el.find(".goalFrequency"),durationyears:this.$el.find(".durationYears"),durationmonths:this.$el.find(".durationMonths"),rate:this.$el.find(".goalRate")};this.results={saving:this.$el.find(".resultSaving"),frequency:this.$el.find(".resultFrequency"),rate:this.$el.find(".resultRate"),interest:this.$el.find(".resultInterest"),duration:this.$el.find(".resultDuration"),couldsave:this.$el.find(".resultCouldSave")};this.action={calculate:this.$el.find(".calculate"),reset:this.$el.find(".reset")};this.form={capture:this.$el.find(".capture"),results:this.$el.find(".results")};this._bindEvents()},_bindEvents:function(){this.action.calculate.on("click",nbs.util.hitch(this,"_calculate"));this.action.reset.on("click",nbs.util.hitch(this,"_reset"));this.validate.startbalance.on("change",nbs.util.hitch(this,"_validatestartbalance"));this.validate.saving.on("change",nbs.util.hitch(this,"_validatesaving"));this.validate.durationyears.on("change",nbs.util.hitch(this,"_validateterm"));this.validate.durationmonths.on("change",nbs.util.hitch(this,"_validateterm"));this.validate.rate.on("change",nbs.util.hitch(this,"_validaterate"))},_calculate:function(n){var i,r;if(n.preventDefault(),this._validateFields()){var u=parseFloat(this.capture.startbalance.getValue())||0,f=parseFloat(this.capture.saving.getValue())||0,e=parseFloat(this.capture.frequency.getValue())||0,o=this._toMonths(this.capture.durationyears.getValue(),this.capture.durationmonths.getValue()),s=parseFloat(this.capture.rate.getValue())||0,t=this.factory.howMuchSavedRegularAmount(u,f,e,o,s);this.results.saving.text(nbs.number.formatWithCommas(t.periodicDeposit,2));switch(t.monthsInPeriod){case 1:this.results.frequency.text("per month");break;case 3:this.results.frequency.text("per quarter");break;case 12:this.results.frequency.text("per year")}this.results.rate.text(t.rate.toFixed(2));i=Math.floor(t.term/12);r=t.term%12;this.results.duration.text((i>0?i+(i===1?" year ":" years "):"")+(r>0?r+(r===1?" month":" months"):""));this.results.couldsave.text(nbs.number.formatWithCommas(parseFloat(t.saved),2));this.results.interest.text("including £"+nbs.number.formatWithCommas(parseFloat(t.interest),2)+" in interest");this.form.capture.hide();this.form.results.show();this._analytics()}else $(".jumpToFirstError").click(function(){return $(this).closest(".form").find(".field.error").first().find(":input").first().focus(),!1})},_validatestartbalance:function(){return this.validate.startbalance.parents(".field").removeClass("error").addClass("valid"),this.validate.startbalance.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0),!0},_validatesaving:function(){var n=!0,t=this.capture.saving.getValue()||0,i=this.capture.rate.getValue()||0,r=this.capture.startbalance.getValue()||0,u=parseFloat(i)>0&&parseFloat(r)>0?!0:!1;return!u&&t<=0?(n=!1,this.validate.saving.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.saving.required),this.validate.saving.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.saving.required)),this.validate.saving.parents(".field").addClass("error").removeClass("valid"),this.validate.saving.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden")):(this.validate.saving.parents(".field").removeClass("error").addClass("valid"),this.validate.saving.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0)),n},_validateterm:function(){parseInt(this.capture.durationmonths.getValue())>11&&this.capture.durationmonths.$el.val("11");var n=this._toMonths(this.capture.durationyears.getValue(),this.capture.durationmonths.getValue());return this.capture.durationyears.getValue()==""&&this.capture.durationmonths.getValue()==""?(this.validate.durationyears.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.duration.required),this.validate.durationyears.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.duration.required)),this.validate.durationyears.parents(".field").addClass("error").removeClass("valid"),this.validate.durationyears.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):n<=0?(this.validate.durationyears.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.duration.onemonth),this.validate.durationyears.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.duration.onemonth)),this.validate.durationyears.parents(".field").addClass("error").removeClass("valid"),this.validate.durationyears.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):(this.validate.durationyears.parents(".field").removeClass("error").addClass("valid"),this.validate.durationyears.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0),!0)},_validaterate:function(){var n=!0,t=this.capture.rate.getValue()||0,i=this.capture.saving.getValue()||0,r=parseFloat(t)<=0&&parseFloat(i)>0;return!r&&t<=0?(n=!1,this.validate.rate.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.rate.required),this.validate.rate.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.rate.required)),this.validate.rate.parents(".field").addClass("error").removeClass("valid"),this.validate.rate.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden")):(this.validate.rate.parents(".field").removeClass("error").addClass("valid"),this.validate.rate.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0)),n},_validateFields:function(){var n=!0;return this._validatestartbalance()||(n=!1),this._validatesaving()||(n=!1),this._validateterm()||(n=!1),this._validaterate()||(n=!1),n?this.capture.atLeastOneError.attr("aria-hidden","true").attr("hidden",!0):(this.capture.atLeastOneError.attr("aria-hidden","false").removeAttr("hidden"),$("#errNotication3").focus()),n},_toMonths:function(n,t){return(parseInt(n)||0)*12+(parseInt(t)||0)},_reset:function(n){n.preventDefault();this.form.capture.show();this.form.results.hide()},_analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({pageName:"bw:tool:Savings Goal How Much Saved",eVar4:"bw:tool:Savings Goal How Much Saved|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage",!1),this.analyticsHasRan=!0}});nbs.modules.SavingsGoalHowMuchToSaveEachMonthCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t;this.factory=nbs.factories.SavingsGoalFactory},startup:function(){this.capture={atLeastOneError:this.$el.find(".atLeastOneErrorOnThisForm"),goal:nbs.registry.get(this.$el.find(".goalBalance")),startbalance:nbs.registry.get(this.$el.find(".goalStartingBalance")),durationyears:nbs.registry.get(this.$el.find(".durationYears")),durationmonths:nbs.registry.get(this.$el.find(".durationMonths")),rate:nbs.registry.get(this.$el.find(".goalRate"))};this.validate={goal:this.$el.find(".goalBalance"),startbalance:this.$el.find(".goalStartingBalance"),durationyears:this.$el.find(".durationYears"),durationmonths:this.$el.find(".durationMonths"),rate:this.$el.find(".goalRate")};this.results={goal:this.$el.find(".resultGoal"),rate:this.$el.find(".resultRate"),interest:this.$el.find(".resultInterest"),duration:this.$el.find(".resultDuration"),amount:this.$el.find(".resultAmount")};this.action={calculate:this.$el.find(".calculate"),reset:this.$el.find(".reset")};this.form={capture:this.$el.find(".capture"),results:this.$el.find(".results")};this._bindEvents()},_bindEvents:function(){this.action.calculate.on("click",nbs.util.hitch(this,"_calculate"));this.action.reset.on("click",nbs.util.hitch(this,"_reset"));this.validate.goal.on("change",nbs.util.hitch(this,"_validategoal"));this.validate.startbalance.on("change",nbs.util.hitch(this,"_validatestartbalance"));this.validate.durationyears.on("change",nbs.util.hitch(this,"_validateterm"));this.validate.durationmonths.on("change",nbs.util.hitch(this,"_validateterm"));this.validate.rate.on("change",nbs.util.hitch(this,"_validaterate"))},_calculate:function(n){var i,r;if(n.preventDefault(),this._validateFields()){var u=parseFloat(this.capture.goal.getValue())||0,f=parseFloat(this.capture.startbalance.getValue())||0,e=this._toMonths(this.capture.durationyears.getValue(),this.capture.durationmonths.getValue()),o=parseFloat(this.capture.rate.getValue())||0,t=this.factory.howMuchToSaveEachMonth(u,f,e,o);this.results.goal.text(nbs.number.formatWithCommas(t.goal,2));this.results.rate.text(t.rate.toFixed(2));this.results.interest.text("including £"+nbs.number.formatWithCommas(parseFloat(t.interest),2)+" in  interest");i=Math.floor(t.term/12);r=t.term%12;i===0&&r===0?this.results.duration.text("0 years 0 months"):this.results.duration.text((i>0?i+(i===1?" year ":" years "):"")+(r>0?r+(r===1?" month":" months"):""));this.results.amount.text(nbs.number.formatWithCommas(parseFloat(t.periodicDeposit),2));this.form.capture.hide();this.form.results.show();this._analytics()}else $(".jumpToFirstError").click(function(){return $(this).closest(".form").find(".field.error").first().find(":input").first().focus(),!1})},_validategoal:function(){var n=parseFloat(this.capture.goal.getValue()),t;return n==""||n<1||isNaN(n)?(this.validate.goal.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.goal.required),this.validate.goal.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.goal.required)),this.validate.goal.parents(".field").addClass("error").removeClass("valid"),this.validate.goal.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):(t=parseFloat(this.capture.startbalance.getValue()),t!=""&&n<=t)?(this.validate.goal.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.goal.lessThanSaved),this.validate.goal.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.goal.lessThanSaved)),this.validate.goal.parents(".field").addClass("error").removeClass("valid"),this.validate.goal.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):(this.validate.goal.parents(".field").removeClass("error").addClass("valid"),this.validate.goal.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0),!0)},_validatestartbalance:function(){var t=parseFloat(this.capture.startbalance.getValue()),n=parseFloat(this.capture.goal.getValue());return n!=""&&t>=n?(this.validate.startbalance.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.startbalance.greaterThanGoal),this.validate.startbalance.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.startbalance.greaterThanGoal)),this.validate.startbalance.parents(".field").addClass("error").removeClass("valid"),this.validate.startbalance.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):(this.validate.startbalance.parents(".field").removeClass("error").addClass("valid"),this.validate.startbalance.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0),!0)},_validateterm:function(){parseInt(this.capture.durationmonths.getValue())>11&&this.capture.durationmonths.$el.val("11");var n=this._toMonths(this.capture.durationyears.getValue(),this.capture.durationmonths.getValue());return this.capture.durationyears.getValue()==""&&this.capture.durationmonths.getValue()==""?(this.validate.durationyears.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.duration.required),this.validate.durationyears.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.duration.required)),this.validate.durationyears.parents(".field").addClass("error").removeClass("valid"),this.validate.durationyears.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):n<=0?(this.validate.durationyears.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.duration.onemonth),this.validate.durationyears.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.duration.onemonth)),this.validate.durationyears.parents(".field").addClass("error").removeClass("valid"),this.validate.durationyears.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden"),!1):(this.validate.durationyears.parents(".field").removeClass("error").addClass("valid"),this.validate.durationyears.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0),!0)},_validaterate:function(){var n=!0,t=this.capture.rate.getValue();return t==""?(n=!1,this.validate.rate.parents(".field").find(".errorMessage p").text(this.opts.errorMessages.rate.required),this.validate.rate.parents(".field").find("label .srText").text(" - {0}".format(this.opts.errorMessages.rate.required)),this.validate.rate.parents(".field").addClass("error").removeClass("valid"),this.validate.rate.parents(".field").find("label .srText").attr("aria-hidden","false").removeAttr("hidden")):(this.validate.rate.parents(".field").removeClass("error").addClass("valid"),this.validate.rate.parents(".field").find("label .srText").attr("aria-hidden","true").attr("hidden",!0)),n},_validateFields:function(){var n=!0;return this._validategoal()||(n=!1),this._validatestartbalance()||(n=!1),this._validateterm()||(n=!1),this._validaterate()||(n=!1),n?this.capture.atLeastOneError.attr("aria-hidden","true").attr("hidden",!0):(this.capture.atLeastOneError.attr("aria-hidden","false").removeAttr("hidden"),$("#errNotication2").focus()),n},_toMonths:function(n,t){return(parseInt(n)||0)*12+(parseInt(t)||0)},_reset:function(n){n.preventDefault();this.form.capture.show();this.form.results.hide()},_analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({pageName:"bw:tool:Savings Goal How Much To Save",eVar4:"bw:tool:Savings Goal How Much To Save|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage",!1),this.analyticsHasRan=!0}});nbs.modules.SavingsRatesTable=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);t=this.opts=$.extend(!0,{analytics:{tableType:"Rates table",productCategory:"Savings",actionName:"Filter",filterOption:"no-filter-option-set"},selectors:{filterToggler:".tableFilterRow header button"},animation:{slideDuration:300},jStorage:{timeout:36e5},onCheckboxChanged:!1,doesInitializeAccountTypeFilterRan:!1},t);this.$filterToggler=this.$(t.selectors.filterToggler);nbs.respond.on("change",nbs.util.hitch(this,"_responsiveHandler"));this.firstrun=!0;this.$chkAccountList=n.find('.resultsFilter input[name="accounttype"]');this.$chkAccessList=n.find('.resultsFilter input[name="accesstype"]');$.jStorage.set("isColumnSortCached",!0)},startup:function(){for(this.inherited.apply(this,arguments),this.$tbl=this.$el.find("tbody"),this.$tblRows=this.$tbl.find("tr"),this.chkFilterOptions=nbs.registry.getDescendents(this.$el,["Checkbox"]),this.table=nbs.registry.get("savingsRatesTable"),i=0;i<this.chkFilterOptions.length;i++)this.chkFilterOptions[i].on("change",nbs.util.hitch(this,"_filterSelected"));this._initializeAccountTypeFilter();this._toggleTableFilterControls();this.$el.find(".resultsFilter").length&&this.opts.doesInitializeAccountTypeFilterRan==!0&&this._filterSelected();this.$noResults=this.$el.find(".noResults");this.$noResults.hide();this.$el.find('[data-nbs-hide="mobile"]').show();this.$el.find('[data-nbs-show="mobile"]').hide();this.opts.onCheckboxChanged=!0},_toggleTableFilterControls:function(){var i=this,n,t=$(".tableFilterRow .filterControls");t.hide().show();i.$filterToggler.on("click",function(){return t=$(".tableFilterRow .filterControls"),n=$(this).hasClass("active"),n?($(this).removeClass("active"),$(this).find("span").text("Show filters"),t.slideUp(300)):($(this).addClass("active"),$(this).find("span").text("Hide filters"),t.slideDown(300)),n=!n,$(this).attr("aria-expanded",n),t.attr("aria-hidden",!n).attr("hidden",!n),!1})},_initializeAccountTypeFilter:function(){this.$chkAccountList.each(function(){var n=$(this).attr("id"),t=$.jStorage.get(n);t=="1"&&($(this).is(":checked")||$(this).closest(".checkbox").click())});this.opts.doesInitializeAccountTypeFilterRan=!0},_removeUnwantedFilters:function(){var t=this.opts.onCheckboxChanged,n;t&&(n=this.opts.jStorage.timeout,this.$chkAccountList.each(function(){var t=$(this).attr("id");$(this).prop("checked")?($.jStorage.set(t,"1"),$.jStorage.setTTL(t,n)):($.jStorage.set(t,"0"),$.jStorage.setTTL(t,n))}))},_filterSelected:function(){var i=this,n=$("<tbody><\/tbody>"),t;this.$tblRows.detach();t=this.opts.jStorage.timeout;this.$chkAccountList.filter(":checked").length!=0?this.$chkAccountList.filter(":checked").each(function(){var u=$(this).next("label").text(),r;n.append(i.$tblRows.filter("tr[data-nbs-accounttype*='"+u+"']"));r=$(this).attr("id");$.jStorage.set(r,"1");$.jStorage.setTTL(r,t)}):this.$chkAccountList.each(function(){var u=$(this).next("label").text(),r;n.append(i.$tblRows);r=$(this).attr("id");$.jStorage.set(r,"0");$.jStorage.setTTL(r,t)});n.children().length?(this.$el.find(".noResults").fadeOut(),this.$tbl.append(n.children()),this.table.refreshSortOrder(),this.$el.find(".results").fadeIn(),this.firstrun||this._analytics()):(this.$el.find(".results").fadeOut(),this.$noResults.fadeIn());this.firstrun=!1;this._responsiveHandler();nbs.analytics.bindEvents();this._removeUnwantedFilters()},_analytics:function(){var t=[],i=0,r=0,u=$(this.chkFilterOptions).size(),n;$.each(this.chkFilterOptions,function(n,f){f.getChecked()?(i++,t.push(f.getLabel()+":Y")):r++;i==u&&(t=[],t.push("ALL:Y"));r==u&&(t=[],t.push("ALL:N"))});n=[];n.push(this.opts.analytics.tableType);n.push(this.opts.analytics.productCategory);n.push(this.opts.analytics.actionName);n.push(t.join("/"));n=n.join("|");nbs.analytics.customLink(n)},_responsiveHandler:function(n){nbs.isLessThanTablet(n)?(this.$el.find('[data-nbs-hide="mobile"]').hide(),this.$el.find('[data-nbs-show="mobile"]').show()):(this.$el.find('[data-nbs-hide="mobile"]').show(),this.$el.find('[data-nbs-show="mobile"]').hide())}});nbs.modules.SavingsRatesTableLite=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);t=this.opts=$.extend(!0,{analytics:{tableType:"Rates table",productCategory:"Savings",actionName:"Filter",filterOption:"no-filter-option-set"},selectors:{},animation:{slideDuration:300},jStorage:{name:"savingsAccountTypeFilter_"+window.location.pathname,timeout:36e5},doesInitializeAccountTypeFilterRan:!1},t);nbs.respond.on("change",nbs.util.hitch(this,"_responsiveHandler"));this.disableAnalytics=!1;this.firstrun=!0},startup:function(){var r,t,n,i;for(this.inherited.apply(this,arguments),this.chkFilterOptions=nbs.registry.getDescendents(this.$el,["Checkbox"]),n=0;n<this.chkFilterOptions.length;n++){this.chkFilterOptions[n].startup();this.chkFilterOptions[n].on("change",nbs.util.hitch(this,"_filterSelected"))}if(this.$tbl=this.$el.find("tbody"),this.$tblRows=this.$tbl.find("tr"),this.table=nbs.registry.get("savingsRatesTable"),this.$noResults=this.$el.find(".noResults"),this.$noResults.hide(),r=this._didStartupFromQuerystring(),!r&&this.chkFilterOptions.length>0&&(t=$.jStorage.get(this.opts.jStorage.name),t)){for(n=0;n<t.length;n++)i=this.chkFilterOptions.filter(function(i){return i.$el.attr("data-account-type")==t[n]}),i&&i.length>=1&&(i[0].opts.checked=!0);this.filterBy(t)}this._setFilterAvailability();this.$el.find('[data-nbs-hide="mobile"]').show();this.$el.find('[data-nbs-show="mobile"]').hide()},_initializeAccountTypeFilter:function(){this.opts.doesInitializeAccountTypeFilterRan=!0},filterBy:function(n){var t,i,r;if(this.$tblRows.detach(),t=$("<tbody><\/tbody>"),$.isArray(n))if(n.length===0)t.append(this.$tblRows.filter("tr"));else{i="";for(r in n)i+='[data-nbs-accounttype*="'+n[r]+'"]';t.append(this.$tblRows.filter("tr"+i))}else(n.toLowerCase()===""||n.toLowerCase()==="all")&&t.append(this.$tblRows.filter("tr"));t.children().length?(this.$el.find(".noResults").fadeOut(),this.$tbl.append(t.children()),this.table.refreshSortOrder(),this.$el.find(".results").fadeIn(),this.firstrun||this._analytics()):(this.$el.find(".results").fadeOut(),this.$noResults.fadeIn());this.firstrun=!1;this._responsiveHandler();nbs.analytics.bindEvents()},_setFilterAvailability:function(){for(var r=this.$el.find("tbody"),u=r.find("tr"),t=this.chkFilterOptions.filter(function(n){return!n.getChecked()}),n=0;n<this.chkFilterOptions.length;n++)this.chkFilterOptions[n].enable();for(n=0;n<t.length;n++){var i=t[n],f=i.$el.attr("data-account-type"),e=u.filter('tr[data-nbs-accounttype*="'+f+'"]').length>0;e||i.disable()}},_filterSelected:function(){var i=this,n=this.chkFilterOptions.filter(function(n){return n.getChecked()}).map(function(n){return n.$el.attr("data-account-type")}),t;this.filterBy(n);this._setFilterAvailability();this.autoFilter||(t=this.opts.jStorage.timeout,$.jStorage.set(this.opts.jStorage.name,n),$.jStorage.setTTL(this.opts.jStorage.name,t))},_analytics:function(){var n;if(!this.disableAnalytics){var t=[],i=0,r=0,u=$(this.chkFilterOptions).size();$.each(this.chkFilterOptions,function(n,f){f.getChecked()?(i++,t.push(f.getLabel()+":Y")):r++;i==u&&(t=[],t.push("ALL:Y"));r==u&&(t=[],t.push("ALL:N"))});n=[];n.push(this.opts.analytics.tableType);n.push(this.opts.analytics.productCategory);n.push(this.opts.analytics.actionName);n.push(t.join("/"));n=n.join("|");nbs.analytics.customLink(n)}},_responsiveHandler:function(n){nbs.isLessThanTablet(n)?(this.$el.find('[data-nbs-hide="mobile"]').hide(),this.$el.find('[data-nbs-show="mobile"]').show()):(this.$el.find('[data-nbs-hide="mobile"]').show(),this.$el.find('[data-nbs-show="mobile"]').hide())},_didStartupFromQuerystring:function(){var t,i,n,f,r,u;for(this._setFilterAvailability(),this.autoFilter=!0,t=!1,i=nbs.querystring.get("rates").split("|"),n=0;n<i.length;n++)f=i[n],r=this.chkFilterOptions.filter(function(n){var t=n.$el.attr("data-account-type")||"";return t=t.replace(/[^a-zA-Z0-9]/gi,"").toLowerCase(),t==this},f),r.length>=1&&(u=r[0],u.toggle(),u.opts.checked=!0,t=!0);return this.autoFilter=!1,t}}),function(){nbs.modules.SavingsSelector=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.$productTableWrapper=$("#savingsRatesTable");this.$table=this.$productTableWrapper.find("table");this.$tableBody=this.$productTableWrapper.find("tbody");this.$productRows=this.$tableBody.find("tr");this.$resultContent=this.$productTableWrapper.find(".resultContent");this.$productTableWrapper.hide();this.opts=t=$.extend(!0,{selectors:{tabs:"nav.tabs",route:".questionSection",routeContent:".questionContent"},classes:{active:"active"}},t);nbs.respond.on("change",nbs.util.hitch(this,"_responsiveHandler"));this.busy=!1;this._createRoutes();this.$productTableWrapper.find('[data-nbs-hide="mobile"]').show();this.$productTableWrapper.find('[data-nbs-show="mobile"]').hide()},_createRoutes:function(){var t=this,r=this.opts,i=this.$el.find(r.selectors.tabs);i.find("li a").on("click",nbs.util.hitch(t,"_analyticsInteraction"));i.each(function(){var i=$(this).find("li");new n(i,t)})},filterProducts:function(n,t){var i=this,r=n.split(","),u=this.$productTableWrapper.is(":visible");this.$productTableWrapper.fadeOut(function(){var e=$("<tbody><\/tbody>"),f;for(i.$resultContent.hide(),i.$resultContent.filter("[data-result='"+t+"']").show(),i.$productRows.detach(),n?i.$table.show():i.$table.hide(),f=0;f<r.length;f++)e.append(i.$productRows.filter("[data-product-id='"+r[f]+"']"));i.$tableBody.append(e.children());u?i.$productTableWrapper.fadeIn(nbs.util.hitch(i,"_scrollToTable")):i.$productTableWrapper.slideDown(nbs.util.hitch(i,"_scrollToTable"));i._responsiveHandler()});this._analytics()},hideProductTable:function(){this.$productTableWrapper.slideUp()},_scrollToTable:function(){nbs.isLessThanTablet()&&nbs.dom.animateScrollToElement(this.$productTableWrapper,500)},_responsiveHandler:function(n){nbs.isLessThanTablet(n)?(this.$productTableWrapper.find('[data-nbs-hide="mobile"]').hide(),this.$productTableWrapper.find('[data-nbs-show="mobile"]').show()):(this.$productTableWrapper.find('[data-nbs-hide="mobile"]').show(),this.$productTableWrapper.find('[data-nbs-show="mobile"]').hide())},_analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({eVar4:"Savings Selector|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage"),this.analyticsHasRan=!0},_analyticsInteraction:function(){if(!this.analyticsFirstInteraction)nbs.analytics.toolUsage({eVar4:"Savings Selector|Interacted",events:"event4",linkTrackEvents:"event4",linkTrackVars:"eVar4,events"},"tool usage"),this.analyticsFirstInteraction=!0}});var n=nbs.declare({initialise:function(n,t){var i=this;this.$triggers=n;this.parent=t;this.$nodes=$();this.index=null;n.each(function(n){var t=$(this),r=i.getOptionContent(t);r&&(i.$nodes=i.$nodes.add(r));t.children("a").click(function(t){t.preventDefault();i.toggle(n)})});this.$nodeContent=this.$nodes.children(t.opts.selectors.routeContent).attr("aria-hidden",!0)},getOptionContent:function(n){var t=n.children("a").attr("href");return t&&t!=="#"?$(t):null},toggle:function(n){var t=this,i=this.parent.opts;this.parent.busy||this.$triggers.eq(n).hasClass(i.classes.active)||(this.parent.busy=!0,this.close().pipe(function(){return t._closeDescendents(),t.open(n)}).pipe(function(){t.parent.busy=!1}))},_closeDescendents:function(){var n=this.parent.opts;this.$nodeContent.find(n.selectors.tabs).find("li.tab").removeClass(n.classes.active);this.$nodeContent.find(n.selectors.route).removeClass(n.classes.active)},close:function(){var i=this,n=new $.Deferred,r=this.parent.opts,u,t,f;return this.index===null?n.resolve():(u=this.$triggers.eq(this.index),u.removeClass(r.classes.active),t=i.getOptionContent(u),t?(f=t.children(r.selectors.routeContent),f.slideUp(function(){t.removeClass(r.classes.active);f.attr("aria-hidden",!0);i.index=null;n.resolve()})):(i.index=null,n.resolve())),n.promise()},open:function(n){var s=this,u=new $.Deferred,i=this.$triggers.eq(n),f=this.getOptionContent(i),e=this.parent.opts,t,r,o;return i.addClass(e.classes.active),f?(t=f.children(e.selectors.routeContent),this.parent.hideProductTable(),t.slideDown(function(){f.addClass(e.classes.active);t.css("display","");t.attr("aria-hidden",!1);s.index=n;nbs.isLessThanTablet()&&nbs.dom.animateScrollToElement(t,500,10);u.resolve()})):(r=i.data("products"),o=i.data("result"),(r||o&&!r)&&this.parent.filterProducts(r,o),s.index=n,u.resolve()),u.promise()}})}();nbs.modules.TimeDepositEnquiry=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$el=n},startup:function(){var n=$("#chkPhoneToDiscussAnswer").closest(".checkbox"),t=nbs.registry.get(n);t.on("change",nbs.util.hitch(this,"_handlePhoneChange"));$("#txtTelephone").bind("keyup blur",nbs.util.hitch(this,"_handlePhoneChange"));this.$el.find("button[type=submit],input[type=submit]").on("click",nbs.util.hitch(this,"_setSubject"))},_handlePhoneChange:function(){function o(n){return strErrorIcon='<div class="errFeedback"><span class="icon iconInvalid" data-icon="&#xe009;" aria-label="Error"><span class="screenReaderText">Invalid<\/span><\/span><div class="errorMessage"><p>'+n+"<\/p><\/div><\/div>"}function r(n,t){var i=t.attr("data-validation-msg");t.removeClass("valid").removeClass("error").addClass(n).find(".errFeedback").remove();n=="error"?t.find(".field").append(o(i)):t.find(".field").append(e)}var t=$("#txtMandatoryTelephoneTDI"),f=$("#chkPhoneToDiscussAnswer"),i=$("#txtTelephoneTDI"),n=t.closest(".formRow"),e='<span class="errFeedback icon iconValid" data-icon="&#xe00f;"><span class="screenReaderText">Valid<\/span><\/span>',u=!0;f.is(":checked")&&(t.removeClass("required").addClass("required").show(),i.val()==""&&(n.attr("data-validation-msg","Please enter your telephone number"),i.closest(".formRow").removeClass("requiredRow").addClass("requiredRow"),u=!1,r("error",n)));u&&(t.removeClass("required").hide(),n.removeClass("error").attr("data-validation-msg",""),i.closest(".formRow").removeClass("requiredRow"),r("valid",n))},_setSubject:function(){var n=$("#chkDistributionListAnswer"),t=$("#chkPhoneToDiscussAnswer"),i="";i=n.is(":checked")&&!t.is(":checked")?"Website: TD Mailing Registration":t.is(":checked")&&!n.is(":checked")?"Website: TD Phone Call Request":"Website: TD Registration and Phone Call Request";$("#hidSubject").val(i)}});$(".trusteerDownLoadContent").hide();$("div#pcContinue").hide();$("div#macContinue").hide();$(".pcDownload").bind("click",function(){$(".trusteerDownLoadContent").show();$("div#pcContinue").show();$("div#macContinue").hide()});$(".macDownload").bind("click",function(){$(".trusteerDownLoadContent").show();$("div#macContinue").show();$("div#pcContinue").hide()});$(".pcLink,.macLink").click(function(n){$("#trustSystemRequire").is(":checked")&&$("#securitySoftwareCompat").is(":checked")&&$("#trustTechSupport").is(":checked")?$("#pcDownload").is(":checked")||$("#macDownload").is(":checked")||(alert("Please select if you use a PC or Mac."),n.preventDefault()):(alert("Please select the boxes to confirm you have made the relevant checks before you download."),n.preventDefault())});nbs.modules.UsingYourCardAbroad=nbs.declare(nbs.modules._Base,{areCalculationsUsed:!1,tabSelected:"purchase",currencyRate:.807689,currencyRateSymbol:"�",secondaryCurrencyRate:.661627,secondaryRateSymbol:"$",gbRate:1.238083,gbSecondaryRate:1.511487,gbRateSymbol:"�",checkboxes:[],initialise:function(n){this.inherited.apply(this,arguments);this.$cardChooser=n.find(".cardChooser");this.$checkboxes=this.$cardChooser.find("input[type=checkbox]");this.$cardChooser.find("div.card").on("mouseover",function(){$(this).css("cursor","pointer");$(this).css("cursor","hand")}).on("click",function(){var n=$(this).find(".checkbox"),t=nbs.registry.get(n);return t.toggle(),!1});n.on("click","#printThis",nbs.util.hitch(this,"_handlePrintThis"));n.on("click","#clearSelection",nbs.util.hitch(this,"_handleClearSelection"));this.$checkboxes.each(function(){n.find("#compareCards table tbody td."+$(this).attr("id")+",#compareCards table thead th."+$(this).attr("id")).hide()})},_handlePrintThis:function(n){n.preventDefault();window.print()},_handleClearSelection:function(n){n.preventDefault();this._clearSelection()},_getQuerystring:function(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+n+"=([^&#]*)"),t=i.exec(window.location.href);return t==null?"no":t[1]},startup:function(){var f,n,e;this.inherited.apply(this,arguments);this.checkboxes=nbs.registry.getDescendents(this.$cardChooser,["Checkbox"]);f=this;this.tabs=nbs.registry.get("cardChooserPageToggles");this.tabs.on("change-tab",function(){f._updateTableStyles()});for(this._clearSelection(),n=0;n<this.checkboxes.length;n++){e=this.checkboxes[n];e.on("change",nbs.util.hitch(this,"_cardSelectionChanged"))}if(this._getQuerystring("cards")!="no"){var t=this._getQuerystring("cards").split(","),i=t[0],r=t[1],u=t[2];i!=undefined&&i!=null&&this._checkCheckboxWithId(i);r!=undefined&&r!=null&&this._checkCheckboxWithId(r);u!=undefined&&u!=null&&this._checkCheckboxWithId(u)}else this._checkCheckboxWithId("ncc"),this._checkCheckboxWithId("fadc"),this._checkCheckboxWithId("ccPlus")},_checkCheckboxWithId:function(n){var t=this._getCheckboxWithId(n);t&&(t.setChecked(!0),this._cardSelectionChanged(t,!0))},_getCheckboxWithId:function(n){for(var i=null,t=0;t<this.checkboxes.length;t++)if(this.checkboxes[t].getId()===n){i=this.checkboxes[t];break}return i},_cardSelectionChanged:function(n,t){var i=n.getId(),r,u,f,e,o;t?(n.$el.closest("li").addClass("cardSelected"),$("#compareCards table tbody td."+i+",#compareCards table thead th."+i+",div.note div."+i).show()):(n.$el.closest("li").removeClass("cardSelected"),$("#compareCards table tbody td."+i+",#compareCards table thead th."+i+",div.note div."+i).hide());$("div.note").each(function(){var n=0,t=0;$(this).find("div.tabContent div").each(function(){t++;$(this).css("display")=="block"&&n++});n==0&&t!=0?$(this).hide():$(this).show()});r=!1;$("#compareCards tr#PEF td").each(function(){if($(this).text()!="Not applicable"&&$("#"+$(this).attr("class")).is(":checked")){r=!0;return}});r?$("#compareCards tr#PEF").show():$("#compareCards tr#PEF").hide();u=!1;$("#compareCards tr#CEFA td").each(function(){if($(this).text()!="Not applicable"&&$("#"+$(this).attr("class")).is(":checked")){u=!0;return}});u?$("#compareCards tr#CEFA").show():$("#compareCards tr#CEFA").hide();f=!1;$("#compareCards tr#CEFUK td").each(function(){if($(this).text()!="Not applicable"&&$("#"+$(this).attr("class")).is(":checked")){f=!0;return}});f?$("#compareCards tr#CEFUK").show():$("#compareCards tr#CEFUK").hide();e=!1;$("#compareCards tr#_commissionRow td").each(function(){if($(this).text()!="Not applicable"&&($("#"+$(this).attr("class").split(" ")[0]).is(":checked")||$("#"+$(this).attr("class").split(" ")[1]).is(":checked"))){e=!0;return}});e?$("#compareCards tr#commissionRow").show():$("#compareCards tr#commissionRow").hide();o=!1;$("#compareCards tr#CROW td").each(function(){if($(this).text()!="Not applicable"&&($("#"+$(this).attr("class").split(" ")[0]).is(":checked")||$("#"+$(this).attr("class").split(" ")[1]).is(":checked"))){o=!0;return}});o?$("#compareCards tr#CROW").show():$("#compareCards tr#CROW").hide();this._updateCardsEnabled();this._updateTableStyles()},_updateCardsEnabled:function(){for(var n,e,t,i,r,f=this.$cardChooser.find("input[type=checkbox]:checked").size(),u=0;u<this.checkboxes.length;u++)n=this.checkboxes[u],e=n.getId(),f>2?n.checked||(n.disable(),n.$el.closest("li").addClass("cardDisabled")):(n.enable(),n.$el.closest("li").removeClass("cardDisabled"));f>0?($("table.tData").show(),$(".tWarn").hide(),$(".warn").hide()):($("table.tData").hide(),$("div.note").hide(),$(".tWarn").show(),$(".warn").show());$("div.purchaseOptional,div.cashOptional").hide();$("#c_2").hide();$("#c_3").hide();$("#p_2").hide();$(".p_cardcharges").hide();t=[];this.$checkboxes.filter(":checked").each(function(){$(this).hasClass("childActivep_2")&&($("div.purchaseOptional").show(),$("#p_2").show(),t.push($(this).closest("div.card").find(".cardName").text()));$(this).hasClass("childActivec_2")&&($("div.cashOptional").show(),$("#c_2").show());$(this).hasClass("childActivec_3")&&($("div.cashOptional").show(),$("#c_3").show())});t.length!=0?(i=t.join(", "),i=i.replace(/,([^,]*)$/," and$1"),r="has",t.length>1&&(r="have"),$(".p_cardcharges,.f_cardcharges").show(),$(".p_cardcharges").html("* "+i+" "+r+' different charges when used outside the Visa Europe region. We\'ve shown you an example in US dollars below, so that you can see what the charges might be. <a href="/support/support-articles/services/a-z-list-of-countries" target="_blank">See which countries are inside and which are outside the Visa Europe region<\/a>.'),$(".f_cardcharges").html(""+i+" "+r+' different charges when used outside the Visa Europe region. <a href="/support/support-articles/services/a-z-list-of-countries" target="_blank">See which countries are inside and which are outside the Visa Europe region<\/a>.')):($(".p_cardcharges,.f_cardcharges").hide(),$(".p_cardcharges,.f_cardcharges").html(""))},_clearSelection:function(){for(var i,t,n=0;n<this.checkboxes.length;n++)i=this.checkboxes[n],t=i.getId(),i.reset(),$("div.cardChooser li").removeClass("cardSelected"),$("#compareCards table tbody td."+t+",#compareCards table thead th."+t+",div.note div."+t).hide();this._updateCardsEnabled();this._updateTableStyles();$("table.tData, div.note, .p_cardcharges,div.purchaseOptional,div.cashOptional,#c_2,#c_3,#p_2").hide();$(".tWarn, .warn").show()},_updateTableStyles:function(){$("table:visible").each(function(){var n=!1;$(this).removeClass("hasHiddenCells");$(this).find("th,td").each(function(){if($(this).is(":hidden"))return n=!0,!1});$(this).parent().find(".hiddenCells").remove();n&&$(this).addClass("hasHiddenCells")});$("table.hasHiddenCells").each(function(){$(this).find("td,th").removeClass("dynamicTableTopLeftCorner").removeClass("dynamicTableTopRightCorner").removeClass("dynamicTableBottomRightCorner").removeClass("dynamicTableBottomLeftCorner").removeClass("dynamicTableRightMost");$(this).find("thead tr:visible:first-child th:visible:first,thead tr:visible:first-child td:visible:first").addClass("dynamicTableTopLeftCorner");$(this).find("thead tr:visible:first-child th:visible:last,thead tr:visible:first-child td:visible:last").addClass("dynamicTableTopRightCorner");$(this).find("tbody tr:visible:last-child th:visible:last,tbody tr:visible:last-child td:visible:last").addClass("dynamicTableBottomRightCorner");$(this).find("tbody tr:visible:last-child th:visible:first,tbody tr:visible:last-child td:visible:first").addClass("dynamicTableBottomLeftCorner");$(this).find("thead tr:visible").find("th:visible:last").addClass("dynamicTableRightMost");$(this).find("tbody tr:visible").find("td:visible:last").addClass("dynamicTableRightMost")})}});nbs.modules.BondsPanel=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t=$.extend(!0,{showLightBox:".showLightBox"},t);this.$showLightBoxBtn=n.find(this.opts.showLightBox)},startup:function(){var n=this;this.$showLightBoxBtn.click(function(t){t.preventDefault();var i=$(this).attr("data-lightboxID"),r=nbs.registry.get(i),u=$(this).parents(".BondsPanel").find("h3:first").text().replace(/[^a-zA-Z0-9-\ ]/g,"").replace(/\s{2,}/g," ");n.analytics($.trim(u));r.show()})},analytics:function(n){var u=window.location.pathname,t="bw:lightbox"+u.replace(/[\/]/g,":"),i,r;t.indexOf("?")!=-1&&(t=t.split("?")[0]);i=n;t=i!=""?t+":"+i:t;r={pageName:t};nbs.temp.lightbox_pageName=t;nbs.analytics.send(r)}});nbs.modules.MortgageBaseRateCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t=$.extend(!0,{duration:500,selectors:{calculate:".calculate .button",results:".results",result:".result",current:".current",newV:".new",comparisonSection:".MortgageBaseRateCalculatorComparison",brfield:".brfield",minValue:".minValue",maxValue:".maxValue",edit:".edit a"},text:{heading:""}},t);this.MortgageBaseRateCalculator=n;this.$OutstandingBalanceField=n.find("#outstandingBalance");this.$currentRate=n.find("#currentRate");this.$remainingTermYears=n.find("#remainingTermYears");this.$remainingTermMonths=n.find("#remainingTermMonths");this.$repaymentType=n.find("#repaymentType");this.$minRange=n.find(this.opts.selectors.minValue);this.$maxRange=n.find(this.opts.selectors.maxValue);this.$result=n.find(this.opts.selectors.result);this.$OutstandingBalanceField.parent(".brfield").find("p").append(" <span><\/span>");this.$currentRate.parent(".brfield").find("p").append(" <span><\/span>");this.$remainingTermYears.parent(".brfield").find("p").append(" <span><\/span>");this.$calculate=n.find(this.opts.selectors.calculate);this.$results=n.find(this.opts.selectors.results);this.$current=n.find(this.opts.selectors.current);this.$new=n.find(this.opts.selectors.newV);this.$currentValue=this.$current.find(".value");this.$newValue=this.$new.find(".value");this.$comparisonSection=n.find(this.opts.selectors.comparisonSection);this.delay=!0},startup:function(){this.$results.hide();this.OutstandingBalance=nbs.registry.get(this.$OutstandingBalanceField.find("input"));this.currentRate=nbs.registry.get(this.$currentRate.find("input"));this.$MortgageBaseRateSlider=nbs.registry.get("MortgageBaseRateSlider");this.$MortgageBaseRateSlider.on("move",nbs.util.hitch(this,"_MortgageBaseRateSliderMove"));this.$calculate.on("click",nbs.util.hitch(this,"_calculate"));this.$OutstandingBalanceField.on("change",nbs.util.hitch(this,"_validateBalance"));this.$currentRate.on("change",nbs.util.hitch(this,"_validateRate"));this.$remainingTermYears.on("change",nbs.util.hitch(this,"_validateTerm"));this.$remainingTermMonths.on("change",nbs.util.hitch(this,"_validateTerm"));this.$repaymentType.on("change",nbs.util.hitch(this,"_toggleDisableRemainingTerm"));this.years=nbs.registry.get("remainingTermYears");this.months=nbs.registry.get("remainingTermMonths");this.repaymentType=nbs.registry.get("repaymentType");this.repaymentType.on("change",nbs.util.hitch(this,"_RepaymentType"));$(".resultHeadingLess").after('<div class="edit"><a href="#" data-icon="&#xe011;"> Edit<\/a><\/div>');$(".edit").on("click",nbs.util.hitch(this,"_edit"))},_hideResults:function(){this.$results.hide()},_edit:function(n){n.preventDefault();$("html,body").animate({scrollTop:this.MortgageBaseRateCalculator.offset().top-30},800)},_toggleDisableRemainingTerm:function(){this.repaymentType.getValue()=="repayment"?(this.years.setDisabled(!1),this.months.setDisabled(!1)):(this.years.setDisabled(!0),this.months.setDisabled(!0),this.$remainingTermYears.parent(this.opts.selectors.brfield).removeClass("error"))},_calculate:function(n){n.preventDefault();this._validateFields()&&(this._showComparison(),this._RepaymentType(),this.$MortgageBaseRateSlider._resizeHandler())},_RepaymentType:function(){var n=0,t=0,r=0,i=parseFloat(this.currentRate.$el.val()),u=i+parseFloat(this.$MortgageBaseRateSlider.getValue());this.repaymentType.getValue()=="repayment"?(n=this._mortgageRepaymentMonthlyRepayment(i),t=this._mortgageRepaymentMonthlyRepayment(u)):(n=this._mortgageInterestOnlyMonthlyRepayments(i),t=this._mortgageInterestOnlyMonthlyRepayments(u));r=t-n;this._adjustGraph(parseFloat(n),parseFloat(t),parseFloat(r))},_adjustGraph:function(n,t,i){var e,f,r,u;this.delay?(delayTime=2e3,animateTime=1e3):(delayTime=0,animateTime=50);this.$result.text("£"+nbs.number.formatWithCommas(Math.abs(i),2));this.$currentValue.text("£"+nbs.number.formatWithCommas(n.toFixed(2)));this.$newValue.text("£"+nbs.number.formatWithCommas(t.toFixed(2)));e=Math.max(n,t);f=e/200;n>=t?($(".resultHeadingLess").show(),$(".resultHeadingMore").hide(),r=t/f,r<=75&&(r=75),this.$current.delay(delayTime).animate({height:"200px"},animateTime),this.$new.delay(delayTime).animate({height:r+"px"},animateTime)):($(".resultHeadingLess").hide(),$(".resultHeadingMore").show(),u=n/f,u<=75&&(u=75),this.$current.delay(delayTime).animate({height:u+"px"},animateTime),this.$new.delay(delayTime).animate({height:"200px"},animateTime));this.delay=!1},_mortgageRepaymentMonthlyRepayment:function(n){var r=this.OutstandingBalance.$el.val(),i=this._toMonths(this.years.getValue(),this.months.getValue()),t=1+n/1200,u=r*Math.pow(t,i)*(t-1),f=Math.pow(t,i)-1,e=u/f;return parseFloat(e.toFixed(2)).toFixed(2)},_mortgageInterestOnlyMonthlyRepayments:function(n){var t=this.OutstandingBalance.$el.val(),i=t*(n/100)/12;return parseFloat(i.toFixed(2)).toFixed(2)},_validateBalance:function(){var n=!0,t=this.$OutstandingBalanceField.parent(this.opts.selectors.brfield);return this.OutstandingBalance.$el.val()==""||this.OutstandingBalance.$el.val()<1||this.OutstandingBalance.$el.val()>9999999?(n=!1,t.addClass("error")):t.removeClass("error"),n},_validateRate:function(){var n=!0,t=this.$currentRate.parent(this.opts.selectors.brfield);return this.currentRate.$el.val()==""||this.currentRate.$el.val()<.1?(n=!1,t.addClass("error")):this.currentRate.$el.val().match(/^[0-9]{1,2}(\.[0-9]{1,9})?$/)?(t.removeClass("error"),this._updateBaseRateRange()):(n=!1,t.addClass("error")),n},_updateBaseRateRange:function(){var r=parseFloat(this.currentRate.$el.val()),t=(Math.floor(r*4)/4).toFixed(2),n=Math.max(-2.5,-t+.25==0?diff=.25:-t+.25),i=n+5;this.$minRange.find("span").text(n);this.$maxRange.find("span").text(i);this.$MortgageBaseRateSlider.changeRange(n,i,this.$MortgageBaseRateSlider.opts.increment,.25)},_validateTerm:function(){var t=!0,n,i;return this.repaymentType.getValue()=="repayment"&&(n=this.$remainingTermYears.parent(this.opts.selectors.brfield),i=this._toMonths(this.years.getValue(),this.months.getValue()),i<1?(t=!1,n.addClass("error")):n.removeClass("error")),t},_validateFields:function(){var n=!0;return this._validateBalance()||(n=!1),this._validateRate()||(n=!1),this._validateTerm()||(n=!1),n},getValue:function(){return this.value},_toMonths:function(n,t){return parseInt(n)*12+parseInt(t)},_showComparison:function(){var n=this;this._analytics();this.$results.slideDown();this.$comparisonSection.slideDown(function(){$("html").hasClass("ie8")&&n.$MortgageBaseRateSlider._setDimensions();$("html, body").animate({scrollTop:n.MortgageBaseRateCalculator.offset().top-($(window).height()-n.MortgageBaseRateCalculator.outerHeight()-40)},500)})},_MortgageBaseRateSliderMove:function(){this._RepaymentType()},_analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({pageName:"bw:tool:Mortgage Base Rate calculator",eVar4:"Mortgage Base Rate calculator|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage",!1),this.analyticsHasRan=!0}});nbs.modules.OverdraftCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t=$.extend(!0,{fadeinspeed:800,delayspeed:400,selectors:{overdraftInputArea:".overdraftInputArea",overdraftResultsArea:".overdraftResultsArea",overdraftCostSummary:".overdraftCostSummary",highestCostLabel:".highestCostLabel",lowestCostLabel:".lowestCostLabel",resultsButton:".formActions .continue",calculatedCost:".calculatedCost",overdraftAmountSlider:".OverdraftAmountSlider",overdraftLengthSlider:".OverdraftLengthSlider",resultsColumn:".ResultsColumn",formActions:".formActions"}},t,{});this.firstRun=!0;this.analyticsHasRan=!1;this.accounts={flexaccount:"flexaccount",flexdirect:"flexdirect",flexplus:"flexplus"};this.jObjects={overdraftInputArea:n.find(t.selectors.overdraftInputArea),overdraftResultsArea:n.find(t.selectors.overdraftResultsArea),overdraftCostSummary:n.find(t.selectors.overdraftCostSummary),resultsButton:n.find(t.selectors.resultsButton),highestCostLabel:n.find(t.selectors.highestCostLabel),lowestCostLabel:n.find(t.selectors.lowestCostLabel),calculatedCost:n.find(t.selectors.calculatedCost),resultsColumn:n.find(t.selectors.resultsColumn),formActions:n.find(t.selectors.formActions),overdraftAmountSlider:n.find(t.selectors.overdraftAmountSlider),overdraftLengthSlider:n.find(t.selectors.overdraftLengthSlider)};nbs.dispatcher.on("window/resize",nbs.util.hitch(this,"_resizeHandler"));nbs.respond.on("change",nbs.util.hitch(this,"_responsiveHandler"));this._bindEvents();this.buttonClicked=!1;this.analyticsString=""},startup:function(){this.inherited.apply(this,arguments);this.OverdraftAmountSlider=nbs.registry.get(this.jObjects.overdraftAmountSlider);this.OverdraftLengthSlider=nbs.registry.get(this.jObjects.overdraftLengthSlider);this._bindEventsToRegistryObjects();this._styleFixes();nbs.mode.isLive()&&(this.jObjects.overdraftResultsArea.fadeOut(500),this.jObjects.overdraftResultsArea.attr("hidden"),this.jObjects.overdraftResultsArea.attr("aria-hidden","true"))},_responsiveHandler:function(){this._styleFixes()},_resizeHandler:function(){this._styleFixes()},_bindEvents:function(){this.jObjects.resultsButton.on("click",nbs.util.hitch(this,"_resultsButtonClick"))},_bindEventsToRegistryObjects:function(){this.OverdraftAmountSlider.on("move",nbs.util.hitch(this,"_OverdraftAmountSliderMove"));this.OverdraftLengthSlider.on("move",nbs.util.hitch(this,"_OverdraftLengthSliderMove"));this.OverdraftAmountSlider.$input.on("keyup",nbs.util.hitch(this,"_OverdraftAmountInputBlur"))},_OverdraftAmountSliderMove:function(){this.buttonClicked&&this._getResults()},_OverdraftLengthSliderMove:function(){this.buttonClicked&&this._getResults()},_OverdraftAmountInputBlur:function(){var n=nbs.number.parse(this.OverdraftAmountSlider.$input.val());n>this.OverdraftAmountSlider.opts.max&&this.OverdraftAmountSlider.$input.val(this.OverdraftAmountSlider.opts.max)},_styleFixes:function(){},_resultsButtonClick:function(n){n.preventDefault();this.buttonClicked=!0;this._getResults();this.jObjects.overdraftResultsArea.removeAttr("hidden").attr("aria-hidden","false");nbs.dom.animateScrollToElement(this.jObjects.overdraftResultsArea,500,150)},_getResults:function(){this._getOverDraftCosts();this.firstRun&&(this._displayResults(),this.firstRun=!1);this._styleFixes()},_getOverDraftCosts:function(){var r=nbs.number.parse(this.OverdraftAmountSlider.$input.val()),u=this.OverdraftLengthSlider.getValue(),n=this,i=0,t=Number.MAX_VALUE;$.each(this.jObjects.resultsColumn,function(f,e){var s=$(e),l=s.attr("data-account-name").toLowerCase(),a=nbs.number.parse(s.attr("data-arranged-rate")),h=nbs.number.parse(s.attr("data-daily-fee")),c=nbs.number.parse(s.attr("data-fee-free-buffer")),v=s.find(".calculatedCost"),o;switch(l){case n.accounts.flexaccount:o=r*(a/100)/365*u;break;case n.accounts.flexdirect:o=r<=c?0:u*h/100;break;case n.accounts.flexplus:o=r<=c?0:u*h/100;break;default:o=0}s.data("result",o);o>=i&&(i=o);o<=t&&(t=o);o=nbs.number.formatWithCommas(o.toFixed(2));v.text(o)});n.jObjects.highestCostLabel.hide();n.jObjects.lowestCostLabel.fadeTo(0,0);$.each(this.jObjects.resultsColumn,function(r,u){var f=$(u),e=f.data("result"),o;f.removeClass("lowestcost highestcost");(e>=i||e>t)&&(f.addClass("highestcost"),f.removeClass("lowestcost"));e<=t&&(f.addClass("lowestcost"),f.removeClass("highestcost"));o=f.attr("data-account-name").toLowerCase();e===t?(n.jObjects.highestCostLabel.eq(r).hide(),n.jObjects.lowestCostLabel.eq(r).fadeTo(0,.7),n.analyticsString+=n.accounts[o]+":lowest|"):e===i?(n.jObjects.lowestCostLabel.eq(r).hide(),n.jObjects.highestCostLabel.eq(r).show().fadeTo(0,.7),n.analyticsString+=n.accounts[o]+":highest|"):n.analyticsString+=n.accounts[o]+":middle|"})},_displayResults:function(){nbs.mode.isLive()&&this.jObjects.formActions.slideUp(500,function(){$(this).remove()});var t=this.jObjects.overdraftResultsArea.find(".sequencial"),n=this.opts.fadeinspeed,i=this.opts.delayspeed;this.jObjects.overdraftResultsArea.fadeIn(n,function(){$.each(t,function(t,r){$(r).delay(i*t).fadeIn(n,function(){$(this).find(".productImage").animate({top:0},n)})})});this.usageAnalytics()},usageAnalytics:function(){var n={eVar4:"Overdraft Calculator|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events,contextData.tool.overdraft.result"};n.contextData={"tool.overdraft.result":this.analyticsString.slice(0,-1)};this.analyticsHasRan||(nbs.analytics.toolUsage(n),this.analyticsHasRan=!0)}});nbs.modules.OverdraftCalculatorDailyFees=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t=$.extend(!0,{fadeinspeed:800,delayspeed:400,selectors:{overdraftInputArea:".overdraftInputArea",overdraftResultsArea:".overdraftResultsArea",overdraftCostSummary:".overdraftCostSummary",highestCostLabel:".highestCostLabel",lowestCostLabel:".lowestCostLabel",resultsButton:".formActions .continue",calculatedCost:".calculatedCost",dailyCharge:".dailyCharge",overdraftAmountSlider:".OverdraftAmountSlider",overdraftLengthSlider:".OverdraftLengthSlider",resultsColumn:".ResultsColumn",formActions:".formActions"}},t,{});this.firstRun=!0;this.analyticsHasRan=!1;this.accounts={flexaccount:"flexaccount",flexdirect:"flexdirect",flexplus:"flexplus"};this.jObjects={overdraftInputArea:n.find(t.selectors.overdraftInputArea),overdraftResultsArea:n.find(t.selectors.overdraftResultsArea),overdraftCostSummary:n.find(t.selectors.overdraftCostSummary),resultsButton:n.find(t.selectors.resultsButton),highestCostLabel:n.find(t.selectors.highestCostLabel),lowestCostLabel:n.find(t.selectors.lowestCostLabel),calculatedCost:n.find(t.selectors.calculatedCost),dailyCharge:n.find(t.selectors.dailyCharge),resultsColumn:n.find(t.selectors.resultsColumn),formActions:n.find(t.selectors.formActions),overdraftAmountSlider:n.find(t.selectors.overdraftAmountSlider),overdraftLengthSlider:n.find(t.selectors.overdraftLengthSlider)};nbs.dispatcher.on("window/resize",nbs.util.hitch(this,"_resizeHandler"));nbs.respond.on("change",nbs.util.hitch(this,"_responsiveHandler"));this._bindEvents();this.buttonClicked=!1;this.analyticsString=""},startup:function(){this.inherited.apply(this,arguments);this.OverdraftAmountSlider=nbs.registry.get(this.jObjects.overdraftAmountSlider);this.OverdraftLengthSlider=nbs.registry.get(this.jObjects.overdraftLengthSlider);this._bindEventsToRegistryObjects();this._styleFixes();nbs.mode.isLive()&&(this.jObjects.overdraftResultsArea.fadeOut(500),this.jObjects.overdraftResultsArea.attr("hidden"),this.jObjects.overdraftResultsArea.attr("aria-hidden","true"))},_responsiveHandler:function(){this._styleFixes()},_resizeHandler:function(){this._styleFixes()},_bindEvents:function(){this.jObjects.resultsButton.on("click",nbs.util.hitch(this,"_resultsButtonClick"))},_bindEventsToRegistryObjects:function(){this.OverdraftAmountSlider.on("move",nbs.util.hitch(this,"_OverdraftAmountSliderMove"));this.OverdraftLengthSlider.on("move",nbs.util.hitch(this,"_OverdraftLengthSliderMove"));this.OverdraftAmountSlider.$input.on("keyup",nbs.util.hitch(this,"_OverdraftAmountInputBlur"))},_OverdraftAmountSliderMove:function(){this.buttonClicked&&this._getResults()},_OverdraftLengthSliderMove:function(){this.buttonClicked&&this._getResults()},_OverdraftAmountInputBlur:function(){var n=nbs.number.parse(this.OverdraftAmountSlider.$input.val());n>this.OverdraftAmountSlider.opts.max&&this.OverdraftAmountSlider.$input.val(this.OverdraftAmountSlider.opts.max)},_styleFixes:function(){},_resultsButtonClick:function(n){n.preventDefault();this.buttonClicked=!0;this._getResults();this.jObjects.overdraftResultsArea.removeAttr("hidden").attr("aria-hidden","false");nbs.dom.animateScrollToElement(this.jObjects.overdraftResultsArea,500,150)},_getResults:function(){this._getOverDraftCosts();this.firstRun&&(this._displayResults(),this.firstRun=!1);this._styleFixes()},_getOverDraftCosts:function(){var t=nbs.number.parse(this.OverdraftAmountSlider.$input.val()),i=this.OverdraftLengthSlider.getValue(),n=this,u=0,r=Number.MAX_VALUE;$.each(this.jObjects.resultsColumn,function(f,e){var c=$(e),l=c.attr("data-account-name").toLowerCase(),a=nbs.number.parse(c.attr("data-fee-free-buffer")),o=JSON.parse("{"+c.attr("data-overdraft-tiers")+"}"),v=c.find(".calculatedCost"),y=c.find(".dailyCharge"),h,s;switch(l){case n.accounts.flexaccount:case n.accounts.flexdirect:case n.accounts.flexplus:t<=a?(s=0,h=0):t>=o.overdraftTiers[0].Tier0.OverdrawnLowerBalance&&t<=o.overdraftTiers[0].Tier0.OverdrawnUpperBalance?(s=i*o.overdraftTiers[0].Tier0.DailyCharge,h=o.overdraftTiers[0].Tier0.DailyCharge):t>=o.overdraftTiers[1].Tier1.OverdrawnLowerBalance&&t<=o.overdraftTiers[1].Tier1.OverdrawnUpperBalance?(s=i*o.overdraftTiers[1].Tier1.DailyCharge,h=o.overdraftTiers[1].Tier1.DailyCharge):t>=o.overdraftTiers[2].Tier2.OverdrawnLowerBalance&&t<=o.overdraftTiers[2].Tier2.OverdrawnUpperBalance?(s=i*o.overdraftTiers[2].Tier2.DailyCharge,h=o.overdraftTiers[2].Tier2.DailyCharge):t>=o.overdraftTiers[3].Tier3.OverdrawnLowerBalance&&t<=o.overdraftTiers[3].Tier3.OverdrawnUpperBalance?(s=i*o.overdraftTiers[3].Tier3.DailyCharge,h=o.overdraftTiers[3].Tier3.DailyCharge):t>=o.overdraftTiers[4].Tier4.OverdrawnLowerBalance&&(s=i*o.overdraftTiers[4].Tier4.DailyCharge,h=o.overdraftTiers[4].Tier4.DailyCharge);break;default:s=0;h=0}c.data("result",s);c.data("dc",h);s>=u&&(u=s);s<=r&&(r=s);s=nbs.number.formatWithCommas(s.toFixed(2));h=nbs.number.formatWithCommas(h.toFixed(2));v.text(s);y.text(h)});n.jObjects.highestCostLabel.hide();n.jObjects.lowestCostLabel.fadeTo(0,0);$.each(this.jObjects.resultsColumn,function(t,i){var f=$(i),e=f.data("result"),o;f.removeClass("lowestcost highestcost");(e>=u||e>r)&&(f.addClass("highestcost"),f.removeClass("lowestcost"));e<=r&&(f.addClass("lowestcost"),f.removeClass("highestcost"));o=f.attr("data-account-name").toLowerCase();e===r?(n.jObjects.highestCostLabel.eq(t).hide(),n.jObjects.lowestCostLabel.eq(t).fadeTo(0,.7),n.analyticsString+=n.accounts[o]+":lowest|"):e===u?(n.jObjects.lowestCostLabel.eq(t).hide(),n.jObjects.highestCostLabel.eq(t).show().fadeTo(0,.7),n.analyticsString+=n.accounts[o]+":highest|"):n.analyticsString+=n.accounts[o]+":middle|"})},_displayResults:function(){nbs.mode.isLive()&&this.jObjects.formActions.slideUp(500,function(){$(this).remove()});var t=this.jObjects.overdraftResultsArea.find(".sequencial"),n=this.opts.fadeinspeed,i=this.opts.delayspeed;this.jObjects.overdraftResultsArea.fadeIn(n,function(){$.each(t,function(t,r){$(r).delay(i*t).fadeIn(n,function(){$(this).find(".productImage").animate({top:0},n)})})});this.usageAnalytics()},usageAnalytics:function(){var n={eVar4:"Overdraft Calculator|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events,contextData.tool.overdraft.result"};n.contextData={"tool.overdraft.result":this.analyticsString.slice(0,-1)};this.analyticsHasRan||(nbs.analytics.toolUsage(n),this.analyticsHasRan=!0)}});nbs.modules.MortgageERCCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n,t){var f,o,i,r,u,e;this.inherited.apply(this,arguments);this.$el=n;this.json=t.json;this.today=t.today;this.factory=nbs.factories.MortgageEarlyRepaymentChargeFactory;f=this.$el.find(".mortgageProductOptions");o=this.$el.find(".mortgageAdditionalProductOptions");f.append('<option value="pre">A product pre-2006<\/option>');i=[];for(r in this.json)for(u in this.json[r]){var s=this.json[r][u].option,h=this.json[r][u].availabilityMonth||0,c=this.json[r][u].availabilityYear||0;i.push({text:s,value:r+"|"+u+"|"+h+"|"+c,term:u})}i.sort(function(n,t){return parseInt(n.term)===parseInt(t.term)?0:parseInt(n.term)<parseInt(t.term)?-1:parseInt(n.term)>parseInt(t.term)?1:void 0});for(e in i)f.append('<option value="'+i[e].value+'">'+i[e].text+"<\/option>");f.append('<option value="other">Another Product<\/option>');o.append(f.html());this.mortgageMonthOptions=this.$el.find(".mortgageMonth").find("select option").clone(!0);this.mortgageYearOptions=this.$el.find(".mortgageYear").find("select option").clone(!0);this.mortgageAdditionalMonthOptions=this.$el.find(".mortgageAdditionalMonth").find("select option").clone(!0);this.mortgageAdditionalYearOptions=this.$el.find(".mortgageAdditionalYear").find("select option").clone(!0)},startup:function(){this.capture={additionalMortgage:nbs.registry.get("additionalMortgage"),mortgageProduct:nbs.registry.get(this.$el.find(".mortgageProduct")),mortgageMonth:nbs.registry.get(this.$el.find(".mortgageMonth")),mortgageYear:nbs.registry.get(this.$el.find(".mortgageYear")),mortgageOutstanding:nbs.registry.get(this.$el.find(".mortgageOutstanding")),mortgageAdditionalProduct:nbs.registry.get(this.$el.find(".mortgageAdditionalProduct")),mortgageAdditionalMonth:nbs.registry.get(this.$el.find(".mortgageAdditionalMonth")),mortgageAdditionalYear:nbs.registry.get(this.$el.find(".mortgageAdditionalYear")),mortgageAdditionalOutstanding:nbs.registry.get(this.$el.find(".mortgageAdditionalOutstanding"))};this.validate={mortgageProduct:this.$el.find(".mortgageProduct"),mortgageMonth:this.$el.find(".mortgageMonth"),mortgageYear:this.$el.find(".mortgageYear"),mortgageOutstanding:this.$el.find(".mortgageOutstanding"),mortgageAdditionalProduct:this.$el.find(".mortgageAdditionalProduct"),mortgageAdditionalMonth:this.$el.find(".mortgageAdditionalMonth"),mortgageAdditionalYear:this.$el.find(".mortgageAdditionalYear"),mortgageAdditionalOutstanding:this.$el.find(".mortgageAdditionalOutstanding")};this.results={results:this.$el.find(".results"),resultsMortgageBalance:this.$el.find(".resultsMortgageBalance"),resultsMortgageERC:this.$el.find(".resultsMortgageERC"),resultsAdditionalMortgageBalance:this.$el.find(".resultsAdditionalMortgageBalance"),resultsAdditionalMortgageERC:this.$el.find(".resultsAdditionalMortgageERC"),resultsTotal:this.$el.find(".resultsTotal"),ercPercent:this.$el.find(".ercPercent"),ercPercentAdditional:this.$el.find(".resultsAdditional .ercPercent")};this.action={btnCalculate:this.$el.find(".btnCalculate"),closeMsg:this.$el.find(".closeMsg")};this.form={preMsg:this.$el.find(".mortgages-pre"),notListedMsg:this.$el.find(".mortgages-notlisted"),capture:this.$el.find(".capture"),additionalBorrowing:this.$el.find(".additional-borrowing"),resultsAdditional:this.$el.find(".resultsAdditional")};this._bindEvents()},_bindEvents:function(){this.action.btnCalculate.on("click",nbs.util.hitch(this,"_calculateClick"));this.capture.additionalMortgage.on("change",nbs.util.hitch(this,"_additionalBorrowing"));this.action.closeMsg.on("click",nbs.util.hitch(this,"_closeMsg"));this.capture.mortgageProduct.on("change",nbs.util.hitch(this,"_changeMortgageProduct"));this.capture.mortgageProduct.on("blur",nbs.util.hitch(this,"_blurMortgageProduct"));this.capture.mortgageYear.on("change",nbs.util.hitch(this,"_changeMortgageYear"));this.capture.mortgageAdditionalProduct.on("change",nbs.util.hitch(this,"_changeMortgageAdditionalProduct"));this.capture.mortgageAdditionalProduct.on("blur",nbs.util.hitch(this,"_blurMortgageAdditionalProduct"));this.capture.mortgageAdditionalYear.on("change",nbs.util.hitch(this,"_changeMortgageAdditionalYear"))},_changeMortgageYear:function(){var t=this.capture.mortgageProduct.getValue().split("|"),r=parseInt(t[2]),u=parseInt(t[3]),f=this,e=new Date(this.today).getMonth()+1,o=new Date(this.today).getFullYear(),i=this.capture.mortgageMonth.$el.find("option"),n=this.capture.mortgageYear.getValue(),s=this.capture.mortgageMonth.getValue(),i=this.capture.mortgageMonth.$el.find("option");if(n=="0"){i.show();return}this.capture.mortgageMonth.resetOptions();i.each(function(){var t=parseInt($(this).val());(e<t&&n==o||t<r&&n<=u&&t>0)&&($(this).remove(),s>=t&&f.capture.mortgageMonth.reset())});this.capture.mortgageMonth.update()},_changeMortgageProduct:function(){var n=this.capture.mortgageProduct.getValue();n=="pre"?this._showPreMsg():n=="other"&&this._showNotListedMsg()},_blurMortgageProduct:function(){var n=this.capture.mortgageProduct.getValue().split("|"),f=parseInt(n[2]),i=parseInt(n[3]),r=this,u=$(".mortgageYear").find(".valueRegion span").text(),t=this.capture.mortgageYear.$el.find("option");this.capture.mortgageYear.resetOptions();t=this.capture.mortgageYear.$el.find("option");t.each(function(){var n=$(this).val();n<i&&n>0&&($(this).remove(),n==u&&r.capture.mortgageYear.reset())});this.capture.mortgageYear.update();this._changeMortgageYear()},_changeMortgageAdditionalYear:function(){var i=this.capture.mortgageAdditionalProduct.getValue().split("|"),r=parseInt(i[2]),u=parseInt(i[3]),f=this,e=new Date(this.today).getMonth()+1,o=new Date(this.today).getFullYear(),n=this.capture.mortgageAdditionalMonth.$el.find("option"),t=this.capture.mortgageAdditionalYear.getValue(),s=this.capture.mortgageAdditionalMonth.getValue();if(this.capture.mortgageAdditionalMonth.resetOptions(),n=this.capture.mortgageAdditionalMonth.$el.find("option"),t=="0"){n.show();return}n.each(function(){var n=parseInt($(this).val());(e<n&&t==o||n<r&&t<=u&&n>0)&&($(this).remove(),s>=n&&f.capture.mortgageAdditionalMonth.reset())});this.capture.mortgageAdditionalMonth.update()},_changeMortgageAdditionalProduct:function(){var n=this.capture.mortgageAdditionalProduct.getValue();n=="pre"?this._showPreMsg():n=="other"&&this._showNotListedMsg()},_blurMortgageAdditionalProduct:function(){var n=this.capture.mortgageAdditionalProduct.getValue().split("|"),f=parseInt(n[2]),i=parseInt(n[3]),r=this,u=$(".mortgageAdditionalYear").find(".valueRegion span").text(),t=this.capture.mortgageAdditionalYear.$el.find("option");this.capture.mortgageAdditionalYear.resetOptions();t=this.capture.mortgageAdditionalYear.$el.find("option");t.each(function(){var n=$(this).val();n<i&&n>0&&($(this).remove(),n==u&&r.capture.mortgageAdditionalYear.reset())});this.capture.mortgageAdditionalYear.update();this._changeMortgageAdditionalYear()},_showPreMsg:function(){var n=this,t,i;nbs.dom.animateScrollToElement(n.form.capture,400);this.results.results.slideUp();this.form.capture.fadeOut(function(){n.form.preMsg.fadeIn();n.form.preMsg.attr("aria-live","polite")});t=this.capture.mortgageProduct.getValue();i=this.capture.mortgageAdditionalProduct.getValue();t=="pre"&&this.capture.mortgageProduct.reset();i=="pre"&&this.capture.mortgageAdditionalProduct.reset()},_showNotListedMsg:function(){var n=this,t,i;nbs.dom.animateScrollToElement(n.form.capture,400);this.results.results.slideUp();this.form.capture.fadeOut(function(){n.form.notListedMsg.fadeIn();n.form.notListedMsg.attr("aria-live","polite")});t=this.capture.mortgageProduct.getValue();i=this.capture.mortgageAdditionalProduct.getValue();t=="other"&&this.capture.mortgageProduct.reset();i=="other"&&this.capture.mortgageAdditionalProduct.reset()},_closeMsg:function(n){n.preventDefault();var t=this;t.form.preMsg.removeAttr("aria-live");t.form.notListedMsg.removeAttr("aria-live");this.form.preMsg.fadeOut(400);this.form.notListedMsg.fadeOut(400);setTimeout(function(){t.form.capture.fadeIn(400)},400)},_additionalBorrowing:function(){var n=this;this.results.results.slideUp();this.capture.additionalMortgage.getValue()=="No"?this.form.additionalBorrowing.removeClass("active").slideUp(function(){n._calculate()}):n.form.additionalBorrowing.hasClass("active")||(nbs.dom.animateScrollToElement(n.form.capture,400,-n.form.capture.outerHeight()+100),setTimeout(function(){n.form.additionalBorrowing.slideDown().addClass("active")},400))},_calculateClick:function(n){n.preventDefault();this._calculate()},_calculate:function(){var n=this;this._validateFields()&&(nbs.dom.animateScrollToElement(n.form.capture,400,-n.form.capture.outerHeight()),setTimeout(function(){var u=n.capture.mortgageProduct.getValue().split("|"),c=u[0],l=u[1],i=n.capture.mortgageOutstanding.getValue(),f=n.factory.getErc(n.json,c,l,"1 "+$(".mortgageMonth").find(".valueRegion .arrow").text()+" "+n.capture.mortgageYear.getValue(),n.today),e=n.factory.getCharge(i,f),t;if(n.results.resultsMortgageBalance.text(nbs.number.formatWithCommas(parseInt(i),2)),n.results.resultsMortgageERC.text(nbs.number.formatWithCommas(parseFloat(e),2)),n.results.ercPercent.text(f),t=parseInt(i)+parseFloat(e),n.capture.additionalMortgage.getValue()=="Yes"){n.form.resultsAdditional.show();var o=n.capture.mortgageAdditionalProduct.getValue().split("|"),a=o[0],v=o[1],r=n.capture.mortgageAdditionalOutstanding.getValue(),s=n.factory.getErc(n.json,a,v,"1 "+$(".mortgageAdditionalMonth").find(".valueRegion > span").text()+" "+n.capture.mortgageAdditionalYear.getValue(),n.today),h=n.factory.getCharge(r,s);n.results.resultsAdditionalMortgageBalance.text(nbs.number.formatWithCommas(parseInt(r),2));n.results.resultsAdditionalMortgageERC.text(nbs.number.formatWithCommas(parseInt(h),2));n.results.ercPercentAdditional.text(s);t=parseInt(t)+parseInt(r)+parseInt(h)}else n.form.resultsAdditional.hide();n.results.resultsTotal.text(nbs.number.formatWithCommas(t,2));n._showResults();n._analytics()},400))},_showResults:function(){this.results.results.slideDown()},_validateMortgageProduct:function(){var n=!0,t=this.capture.mortgageProduct.getValue();return t=="0"?(n=!1,this.validate.mortgageProduct.parents(".field").addClass("error").removeClass("valid")):this.validate.mortgageProduct.parents(".field").removeClass("error").addClass("valid"),n},_validateMortgageDate:function(){var n=!0,t=this.capture.mortgageMonth.getValue(),i=this.capture.mortgageYear.getValue();return t=="0"||i=="0"?(n=!1,this.validate.mortgageMonth.parents(".field").addClass("error").removeClass("valid")):this.validate.mortgageMonth.parents(".field").removeClass("error").addClass("valid"),n},_validateMortgageOutstanding:function(){var n=!0,t=this.capture.mortgageOutstanding.getValue();return t==""||t=="0"?(n=!1,this.validate.mortgageOutstanding.parents(".field").addClass("error").removeClass("valid")):this.validate.mortgageOutstanding.parents(".field").removeClass("error").addClass("valid"),n},_validateMortgageAdditionalProduct:function(){var t=!0,n=this.capture.mortgageAdditionalProduct.getValue();return n=="0"||n=="pre"||n=="other"?(t=!1,this.validate.mortgageAdditionalProduct.parents(".field").addClass("error").removeClass("valid"),n=="pre"?this._showPreMsg():n=="other"&&this._showNotListedMsg()):this.validate.mortgageAdditionalProduct.parents(".field").removeClass("error").addClass("valid"),t},_validateMortgageAdditionalDate:function(){var n=!0,t=this.capture.mortgageAdditionalMonth.getValue(),i=this.capture.mortgageAdditionalYear.getValue();return t=="0"||i=="0"?(n=!1,this.validate.mortgageAdditionalMonth.parents(".field").addClass("error").removeClass("valid")):this.validate.mortgageAdditionalMonth.parents(".field").removeClass("error").addClass("valid"),n},_validateMortgageAdditionalOutstanding:function(){var n=!0,t=this.capture.mortgageAdditionalOutstanding.getValue();return t==""||t=="0"?(n=!1,this.validate.mortgageAdditionalOutstanding.parents(".field").addClass("error").removeClass("valid")):this.validate.mortgageAdditionalOutstanding.parents(".field").removeClass("error").addClass("valid"),n},_validateFields:function(){var n=!0;return this._validateMortgageProduct()||(n=!1),this._validateMortgageDate()||(n=!1),this._validateMortgageOutstanding()||(n=!1),this.capture.additionalMortgage.getValue()=="Yes"&&(this._validateMortgageAdditionalProduct()||(n=!1),this._validateMortgageAdditionalDate()||(n=!1),this._validateMortgageAdditionalOutstanding()||(n=!1)),n},_analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({pageName:"bw:tool:Early Repayment Charge Calculator",eVar4:"bw:tool:Early Repayment Charge Calculator|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage",!1),this.analyticsHasRan=!0}});nbs.modules.FilterFeatureCards=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);t=this.opts=$.extend(!0,{analyticsToolName:"Filterable Feature Cards",selectors:{filterToggler:".filterOptions header button"},filterResetText:"Reset filters",filterHeading:"Filter options",showFiltersText:"Show filters",hideFiltersText:"Hide filters",classes:{isExpanded:"isExpanded"}},t);this.storageKey=t.analyticsToolName.replace(/ /g,"_");this.$filterToggler=this.$(t.selectors.filterToggler);nbs.dispatcher.on("window/resize",nbs.util.hitch(this,"_resizeHandler"));this.capture={radioGroups:n.find(".radioGroup")};this.hasRunAnalytics=!1;this.runLegacyMode=nbs.detect.is("ie")&&nbs.detect.getVersion()<9;this.inhibitTagging=!1},startup:function(){this.action={filterFeatureCards:this.$el.find(".filterFeatureCards"),featureCardGrid:this.$(".featureCardGrid"),expandCell:this.$el.find(".expandCell"),expandIcon:this.$el.find(".expandIcon"),expandIconH3:this.$el.find(".expandIcon h3"),expandIconLink:this.$el.find(".expandIcon a"),collapseCell:this.$el.find(".expandClose"),arrowUp:this.$el.find(".arrowUp"),noResults:this.$(".noResults"),reset:this.$el.find(".reset")};this.$allFilterControls=this.$(".filterOptions .filterControls");this.$filterControlsHeader=this.$(".filterOptions header");this.action.expandIcon.on("click",nbs.util.hitch(this,"_expandCell"));this.action.collapseCell.on("click",nbs.util.hitch(this,"_collapseCell"));nbs.mode.isLive()?(this._bindEvents(),this._styleFixes()):(this.$el.find(".links").css({position:"relative"}),this.$allFilterControls.attr({hidden:!1,"aria-hidden":!1}));this._checkPreviousUsage()},_bindEvents:function(){var n=this;nbs.dispatcher.on("nbs/initialise",nbs.util.hitch(n,"_resize"));nbs.dispatcher.on("nbs/windowload",nbs.util.hitch(n,"_resize"));n.action.reset.on("click",nbs.util.hitch(n,"_resetAll"));n.capture.radioGroups.each(function(){var t=$(this),i=nbs.registry.get(t);i.on("change",nbs.util.hitch(n,"_radioButtonChange"))});n.$filterToggler.on("click",nbs.util.hitch(n,"_toggleFilterClick"));nbs.dispatcher.on("nbs/initialise",nbs.util.hitch(n,"_wipeContextData"))},_styleFixes:function(){this.action.expandIconH3.each(function(){var n=$(this),t=n.clone();n.parents(".expandCell").find(".featureCardExpand").prepend(t)});this.$allFilterControls.hide();this.action.noResults.hide()},_getPreviousUsage:function(){return nbs.cookie.read(this.storageKey)},_checkPreviousUsage:function(){var n,t;this.inhibitTagging=!0;n=this._getPreviousUsage();n!=null&&(n=n.split(","),t=[],this.capture.radioGroups.each(function(i){var e=$(this),r=nbs.registry.get(e),u,f;r!=null&&(n[i].toString()!=="-1"&&r.toggle(n[i]),typeof s!="undefined"&&(u=r.getValue(),f=e.attr("data-nbs-analytics-filter-category"),u==null&&t.push("{0}:none".format(f)),u!=null&&t.push("{0}:{1}".format(f,nbs.tidying.sanitizeString(r.getValue()))),s.contextData.nbs_filter_options=t.join("/")))}),this.$filterToggler.trigger("click"));this.inhibitTagging=!1},_wipeContextData:function(){typeof s!="undefined"&&delete s.contextData.nbs_filter_options},_setUsageIntoStorage:function(n){nbs.cookie.create(this.storageKey,n)},_toggleFilterClick:function(n){var u,f;n.preventDefault();var r=this,t=$(n.currentTarget),i=t.hasClass("active");i?(t.removeClass("active"),t.find("span").text(this.opts.showFiltersText),this.runLegacyMode?(this.$allFilterControls.hide(),r.$filterControlsHeader.removeClass("active")):this.$allFilterControls.slideUp(300,function(){r.$filterControlsHeader.removeClass("active")})):(this.$filterControlsHeader.addClass("active"),t.addClass("active"),t.find("span").text(this.opts.hideFiltersText),this.runLegacyMode?this.$allFilterControls.show():this.$allFilterControls.slideDown(300),u={},f="Filter|{0}|Reveal".format(this.opts.filterHeading),this._runAnalytics(u,f));i=!i;t.attr("aria-expanded",i);this.$allFilterControls.attr("aria-hidden",!i).attr("hidden",!i)},_expandCell:function(n){var r,t,i,u,f;n.preventDefault();nbs.isMobile()&&(r=$(n.currentTarget),t=r.closest(this.action.expandCell),t.hasClass(this.opts.classes.isExpanded)?this._collapseCell(n):(this.action.expandCell.removeClass(this.opts.classes.isExpanded).addClass("isCollapsed"),t.removeClass("isCollapsed").addClass(this.opts.classes.isExpanded),i=nbs.parser.getOptions(t,"nbs"),i.featureHeading&&(u={},f="FeatCard|Reveal|{0}".format(i.featureHeading),this._runAnalytics(u,f))))},_collapseCell:function(n){n.preventDefault();var t=$(n.currentTarget),i=t.closest(".expandCell");i.removeClass(this.opts.classes.isExpanded)},_resizeHandler:function(){this._fireFeatureCardSelection(!1);this._resize()},_resize:function(){nbs.isMobile()?(this.showAllCards(),this._equaliseHeights(2)):nbs.isSmallTablet()?(this.action.expandCell.removeClass(this.opts.classes.isExpanded).addClass("isCollapsed"),this._equaliseHeights(2)):(this.action.expandCell.removeClass(this.opts.classes.isExpanded).addClass("isCollapsed"),this._equaliseHeights(3))},_equaliseHeights:function(n){var i=this.action.featureCardGrid.find(".expandCell"),r=this.action.expandIconLink,c=i.width()/2-14,t,s;if(i.css("height","auto"),r.css("height","auto"),this.action.arrowUp.css("margin-left",c),n!=null&&!(n<2))for(t=0,s=i.length;t<s;t+=n){var u=0,f=0,h=0,e=0,o=i.slice(t,t+n);o.each(function(){var n=$(this),t=parseInt(n.outerHeight()),i=parseInt(n.find(".links").outerHeight()),o=parseInt(n.find(r).outerHeight());u=Math.max(t,u);f=Math.max(i,f);e=Math.max(o,e);h=u+f});nbs.isMobile()?o.find(r).css("height",e):o.css("height",h)}},_radioButtonChange:function(){nbs.dom.animateScrollToElement(this.$el);this._fireFeatureCardSelection(!0);this._resize()},_fireFeatureCardSelection:function(n){var e=this,t=[],u=[],r=[],o,f,i,s;if(this.capture.radioGroups.each(function(){var i=$(this),n=nbs.registry.get(i),f=n.getValue(),e=i.attr("data-nbs-analytics-filter-category");f==null&&(u.push(-1),r.push("{0}:none".format(e)));f!=null&&(t.push(n.getValue()),u.push(n.index),r.push("{0}:{1}".format(e,nbs.tidying.sanitizeString(n.getValue()))))}),n&&this._setUsageIntoStorage(u.join(",")),this.showAllCards(),!(t.length<=0)){o=t.join("|");for(f in t)t.hasOwnProperty(f)&&this.action.expandCell.filter(":visible").each(function(){var r=$(this),n=nbs.parser.getOptions(r,"nbs"),i,u;if(n.featureMatches&&(n.featureMatches.contains(t[f])||e.hideCard(r)),n.featureExceptionsMatches){i=n.featureExceptionsMatches.split(",");for(u in i)i.hasOwnProperty(u)&&o===i[u]&&e.hideCard(r)}});this.action.featureCardGrid.find(".expandCell").size()===0&&this.action.noResults.show();n&&(i={},s="Filter|{0}|Selection".format(this.opts.filterHeading),i.linkTrackVars="contextData.nbs_filter_options",r.length>0&&(i.contextData={nbs_filter_options:r.join("/")}),this._runAnalytics(i,s),delete i.contextData.nbs_filter_options)}},hideCard:function(n){n.detach()},showAllCards:function(){this.action.expandCell.detach();this.action.expandCell.appendTo(this.action.featureCardGrid);this.action.noResults.hide()},hideAllCards:function(){this.action.expandCell.hide();this.action.noResults.show()},_resetAll:function(n){n.preventDefault();nbs.cookie.destroy(this.storageKey);this.capture.radioGroups.each(function(){var n=$(this),t=nbs.registry.get(n);t.reset()});this.showAllCards();this._resize();nbs.dom.animateScrollToElement(this.$el);var t={},i="Filter|{0}|Selection".format(this.opts.filterHeading);t.linkTrackVars="contextData.nbs_filter_options";t.contextData={nbs_filter_options:this.opts.filterResetText};this._runAnalytics(t,i);delete t.contextData.nbs_filter_options},_runAnalytics:function(n,t){this.inhibitTagging||(this.hasRunAnalytics=!0,nbs.analytics.toolUsage(n,t,!1))}});nbs.modules.FeatureLandingPagePanels=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$el=n;this.panel=this.$el.find(".featureLandingPagePanel")},startup:function(){this._bindEvents()},_bindEvents:function(){nbs.dispatcher.on("nbs/initialise",nbs.util.hitch(this,"_resizeHandler"));nbs.dispatcher.on("window/resize",nbs.util.hitch(this,"_resizeHandler"))},_resizeHandler:function(n){var n=nbs.respond.widthInPixels;n>1199?this._equaliseHeightsAndSides(3):n>599?this._equaliseHeightsAndSides(2):this._equaliseHeightsAndSides(1)},_equaliseHeightsAndSides:function(n){var f=this.panel,i=20,e=45,s,r,h;if(f.css("height",""),f.find(".flipperFront, .flipperBack").css("height",""),n==null||n<2){s=this.$el.find(".flipper");s.each(function(){var r=$(this),u=r.find(".flipperFront"),f=u.outerHeight()-i+e,n=r.find(".flipperBack"),o=n.outerHeight()-i+e;t=Math.max(f,o);u.css("height",t);n.hasClass("table")?n.css("height",t+i):n.css("height",t);r.css("height",t+i)});return}for(r=0,h=f.length;r<h;r+=n){var o=0,t=0,u=f.slice(r,r+n);u.each(function(){var n=$(this),r=parseInt(n.outerHeight()),u=parseInt(n.find(".flipperFront").outerHeight()-i+e)|0,f=parseInt(n.find(".flipperBack").outerHeight()-i+e)|0;o=Math.max(r,u,f,o);t=o});nbs.respond.widthInPixels>599&&(u.css("height",t),u.find(".flipperFront").css("height",parseInt(t)),u.find(".flipperBack").css("height",parseInt(t)),u.find(".table").css("height",parseInt(t+i)))}}});nbs.modules.MortgageOverpaymentCalculator=nbs.declare(nbs.modules._Base,{initialise:function(n){this.inherited.apply(this,arguments);this.$el=n;this.factory=nbs.factories.MortgageOverpaymentsFactory;this.ctx=document.getElementById("myChart").getContext("2d")},startup:function(){this.showFinalMonthOnHighVarianceCases=!0;this.debug=!1;this.isRepayment=!1;this.isInterestOnly=!1;this.chartOptions={scaleBeginAtZero:!0,animation:!1,responsive:!0,maintainAspectRatio:!0,showTooltips:!1,lineTension:0,lineWidth:10,pointRadius:0,radius:0,pointHitRadius:0,borderWidth:0};this.capture={debug:this.$el.find(".debug"),lumpSumAmount:nbs.registry.get(this.$el.find(".lumpSumAmount")),mortgageInterestRate:nbs.registry.get(this.$el.find(".mortgageInterestRate")),mortgageInterestRate:nbs.registry.get(this.$el.find(".mortgageInterestRate")),mortgageOutstandingBalance:nbs.registry.get(this.$el.find(".mortgageOutstandingBalance")),mortgageOverpaymentType:nbs.registry.get(this.$el.find(".mortgageOverpaymentType")),mortgagePaymentType:nbs.registry.get(this.$el.find(".mortgagePaymentType")),mortgageTermMonths:nbs.registry.get(this.$el.find(".mortgageTermMonths")),mortgageTermYears:nbs.registry.get(this.$el.find(".mortgageTermYears")),mortgageType:nbs.registry.get(this.$el.find(".mortgageType")),regularOverpaymentAmount:nbs.registry.get(this.$el.find(".regularOverpaymentAmount")),regularOverpaymentMonths:nbs.registry.get(this.$el.find(".regularOverpaymentMonths")),regularOverpaymentUntilFurtherNotice:nbs.registry.get(this.$el.find(".regularOverpaymentUntilFurtherNotice")),regularOverpaymentYears:nbs.registry.get(this.$el.find(".regularOverpaymentYears")),formRows:this.$el.find(".formRow")};this.validate={lumpSumAmount:this.$el.find(".lumpSumAmount"),mortgageInterestRate:this.$el.find(".mortgageInterestRate"),mortgageOutstandingBalance:this.$el.find(".mortgageOutstandingBalance"),mortgageOverpaymentType:this.$el.find(".mortgageOverpaymentType"),mortgagePaymentType:this.$el.find(".mortgagePaymentType"),mortgageTermMonths:this.$el.find(".mortgageTermMonths"),mortgageTermYears:this.$el.find(".mortgageTermYears"),mortgageType:this.$el.find(".mortgageType"),regularOverpaymentAmount:this.$el.find(".regularOverpaymentAmount"),regularOverpaymentMonths:this.$el.find(".regularOverpaymentMonths"),regularOverpaymentUntilFurtherNotice:this.$el.find(".regularOverpaymentUntilFurtherNotice"),regularOverpaymentYears:this.$el.find(".regularOverpaymentYears")};this.action={btnCalculate:this.$el.find(".btnCalculate"),btnUpdate:this.$el.find(".btnUpdate"),run:this.$el.find(".run")};this.form={interestRate:this.$el.find(".innerField.interestRate"),lumpSumOverpayment:this.$el.find(".formRow.lumpSumOverpayment"),mortgageOverpaymentType:this.$el.find(".mortgageOverpaymentType"),mortgageOverpaymentTypeLabel:this.$el.find(".mortgageOverpaymentTypeLabel"),mortgageOverpaymentTypeRad_oneOfflumpSum:this.$el.find(".mortgageOverpaymentTypeRad_oneOfflumpSum"),mortgageOverpaymentTypeRad_regAmount:this.$el.find(".mortgageOverpaymentTypeRad_regAmount"),mortgageOverpaymentTypeRad_regAmountAndOneOfflumpSum:this.$el.find(".mortgageOverpaymentTypeRad_regAmountAndOneOfflumpSum"),regOverpaymentYearsMonthsFields:this.$el.find(".regOverpaymentYearsMonthsFields"),regularOverpaymentAmount:this.$el.find(".formRow.regularOverpaymentAmountRow"),regularOverpaymentTerm:this.$el.find(".formRow.regularOverpaymentTerm")};this.results={interestRate:this.$el.find(".details .interestRate"),chart:this.$el.find("#chartContainer"),lumpSumOverpaymentValue:this.$el.find(".changes .lumpSumOverpaymentValue"),monthlyOverpaymentValue:this.$el.find(".changes .monthlyOverpaymentValue"),monthlyPayment:this.$el.find(".details .monthlyPayment"),mortgageBalance:this.$el.find(".mortgageBalance"),oneOffOverPaymentDetails:this.$el.find(".changes .oneOffOverPaymentDetails"),overpaymentDurationValue:this.$el.find(".changes .overpaymentDurationValue"),reducedTerm:this.$el.find(".changes .reducedTerm"),reduceYourBalance:this.$el.find(".changes .reduceYourBalance"),regOverpaymentsDetails:this.$el.find(".changes .regOverpaymentsDetails"),regOverpaymentsDetails_overpaymentsOnly:this.$el.find(".changes .regOverpaymentsDetails_overpaymentsOnly"),regOverpaymentsDetails_plusOverpayments:this.$el.find(".changes .regOverpaymentsDetails_plusOverpayments"),regOverpaymentsDetails_setDuration:this.$el.find(".changes .regOverpaymentsDetails_setDuration"),regOverpaymentsDetails_untilFurtherNotice:this.$el.find(".changes .regOverpaymentsDetails_untilFurtherNotice"),overpaymentsReduceTerm:this.$el.find(".changes .overpaymentsReduceTerm"),remainingTerm:this.$el.find(".details .remainingTerm"),results:this.$el.find(".results"),saveYou:this.$el.find(".changes .saveYou")};this.table={resultsTable:this.$el.find(".resultsTable"),lengthOfMortgageNoOverpayments:this.$el.find(".lengthOfMortgageNoOverpayments span.val"),lengthOfMortgageWithOverpayments:this.$el.find(".lengthOfMortgageWithOverpayments span.val"),monthlyRepaymentNoOverpayments:this.$el.find(".monthlyRepaymentNoOverpayments span.val"),monthlyRepaymentWithOverpayments:this.$el.find(".monthlyRepaymentWithOverpayments span.val"),totalToPayNoOverpayments:this.$el.find(".totalToPayNoOverpayments span.val"),totalToPayWithOverpayments:this.$el.find(".totalToPayWithOverpayments span.val")};this._bindEvents();this._checkMaxLengths();this.action.btnUpdate.hide();this.capture.regularOverpaymentAmount.getValue();this.form.interestRate.hide();this.form.lumpSumOverpayment.hide();this.form.regularOverpaymentTerm.hide();this.form.regularOverpaymentAmount.hide();this.results.results.hide();this.debug&&this.capture.debug.show()},_bindEvents:function(){this.action.btnCalculate.on("click",nbs.util.hitch(this,"_calculateClick"));this.action.btnUpdate.on("click",nbs.util.hitch(this,"_updateClick"));this.capture.mortgageOverpaymentType.on("change",nbs.util.hitch(this,"_mortgageOverpaymentTypeChange"));this.capture.mortgageType.on("change",nbs.util.hitch(this,"_mortgageTypeChange"));this.capture.regularOverpaymentUntilFurtherNotice.on("change",nbs.util.hitch(this,"_regularOverpaymentUntilFurtherNotice"))},_checkMaxLengths:function(){$("input[maxlength]").each(function(){var n=$(this).attr("maxlength");$(this).bind("keyup",function(){$(this).val().length>n&&$(this).val($(this).val().slice(0,n))})})},_calculate:function(){var nt=this,ft=[],et=[],h=[],a,i,v,t,f,ot,e=0,r=0,ht=0,ct=0,c=0,u="",l,o,lt=0,y=0,ti=(new Date).getTime(),tt,p,at=0,w=0,s=0,vt=0,ni=0,b=0,k="Month ",it=0,yt=!1,pt=!1,wt=!1,bt=!1,kt=!1,n,rt,ut,gt;if(this.capture.mortgageTermMonths.getValue()||this.capture.mortgageTermMonths.setValue(0),this.capture.mortgageTermYears.getValue()||this.capture.mortgageTermYears.setValue(0),this.capture.regularOverpaymentYears.getValue()||this.capture.regularOverpaymentYears.setValue(0),i=parseFloat(this.capture.mortgageOutstandingBalance.getValue())||0,v=parseFloat(this.capture.mortgageInterestRate.getValue())||0,t=parseInt(this.capture.mortgageTermYears.getValue()*12)+parseInt(this.capture.mortgageTermMonths.getValue())||0,f=parseFloat(this.capture.lumpSumAmount.getValue())||0,ot=parseFloat(this.capture.regularOverpaymentAmount.getValue())||0,e=parseInt(this.capture.regularOverpaymentYears.getValue()*12||0)+parseInt(this.capture.regularOverpaymentMonths.getValue()||0)||0,this.capture.regularOverpaymentUntilFurtherNotice.checked?(this.results.regOverpaymentsDetails_setDuration.hide(),this.results.regOverpaymentsDetails_untilFurtherNotice.show(),e=t):(this.results.regOverpaymentsDetails_setDuration.show(),this.results.regOverpaymentsDetails_untilFurtherNotice.hide()),this.isRepayment?(l=this.factory.simulateRepaymentMortgage(i,v,t,0,0,e),o=this.factory.simulateRepaymentMortgage(i,v,t,f,ot,e)):(l=this.factory.simulateInterestOnlyMortgage(i,v,t,0),o=this.factory.simulateInterestOnlyMortgage(i,v,t,f)),u+='<h3>Debug Data - OVERPAYMENTS MADE<\/h3><p>Please note: this table will NOT appear in the final calculator, nor will the interest figures that are output at the top (only there to show the workings for the interest saved figure).<\/p><table class="tableStyle01 stickyHeader"><tr><th>Month<\/th><th>Repayment Amount<\/th><th>Balance<\/th><th>Interest<\/th><th>Capital<\/th><th>Accrued Interest<\/th><\/tr>',this.debug){for(m in o)n=o[m],u+="<tr>",u+="<td>"+n.month+"<\/td><td>£"+nbs.number.formatWithCommas(n.repayment,2)+"<\/td><td>£"+nbs.number.formatWithCommas(n.balance,2)+"<\/td><td>£"+nbs.number.formatWithCommas(n.interest,2)+"<\/td><td>£"+nbs.number.formatWithCommas(n.capitalPaid,2)+"<\/td><td>£"+nbs.number.formatWithCommas(n.accInterest,2)+"<\/td>",u+="<\/tr>";u+="<\/table>";u+='<h3>Debug Data - NO OVERPAYMENTS MADE<\/h3><p>Please note: this table will NOT appear in the final calculator, nor will the interest figures that are output at the top (only there to show the workings for the interest saved figure).<\/p><table class="tableStyle01 stickyHeader"><tr><th>Month<\/th><th>Repayment Amount<\/th><th>Balance<\/th><th>Interest<\/th><th>Capital<\/th><th>Accrued Interest<\/th><\/tr>';for(m in l)n=l[m],u+="<tr>",u+="<td>"+n.month+"<\/td><td>£"+nbs.number.formatWithCommas(n.repayment,2)+"<\/td><td>£"+nbs.number.formatWithCommas(n.balance,2)+"<\/td><td>£"+nbs.number.formatWithCommas(n.interest,2)+"<\/td><td>£"+nbs.number.formatWithCommas(n.capitalPaid,2)+"<\/td><td>£"+nbs.number.formatWithCommas(n.accInterest,2)+"<\/td>",u+="<\/tr>";u+="<\/table>";this.capture.debug.empty().html(u);$(".interestData").css("position","relative").css("top","auto")}t<13&&(yt=!0);t>12&&t<241&&(wt=!0);t>12&&t<25&&(pt=!0);t>240&&t<361&&(bt=!0);t>360&&(kt=!0);wt&&(b=12,k="Year ");bt&&(b=24,k="Year ");kt&&(b=48,k="Year ");nt=this;for(m in l)n=l[m],m<t&&(n.balance>0?ft.push(n.balance):(rt=0-n.balance,ut=parseInt(rt/a*100),(ut<95||nt.showFinalMonthOnHighVarianceCases)&&ft.push(0)),yt?n.month!=0?h.push(k+n.month):h.push(""):pt?n.month%b!=0?n.month%3==0?h.push("Month "+n.month):h.push(""):(it=n.month/12,h.push("YEAR "+it)):n.month%b==0?(it=n.month/12,h.push(k+it)):h.push(""),r=n.repayment,m==0&&(a=r),m==l.length-2&&(ht=n.balance+n.interest),m==l.length-1&&(r=ht),w+=parseFloat(r));tt=n.accInterest;for(m in o)n=o[m],n.balance>0?et.push(n.balance):(rt=0-n.balance,ut=parseInt(rt/r*100),(ut<95||nt.showFinalMonthOnHighVarianceCases)&&et.push(0)),m==0?(r=f!=0?n.repayment-f:n.repayment,c=r):(r=n.repayment,(c<r||m==1)&&(c=r)),m==o.length-2&&(ct=n.balance+n.interest),m==o.length-1&&(r=ct),s+=parseFloat(r);if(y=o.length,w=a*t,e<y?(vt=e*c+(y-e)*a,s=vt):s=c*y,this.isInterestOnly&&(w+=i,s+=i),f!=0&&(s+=f),p=n.accInterest,ni=w-s,this._validateFields()){this.action.btnCalculate.hide();this.action.btnUpdate.show();this.results.results.show();nbs.dom.animateScrollToElement(this.results.results,400);f!=0?this.results.oneOffOverPaymentDetails.show():this.results.oneOffOverPaymentDetails.hide();e==0?this.results.regOverpaymentsDetails.hide():(this.isInterestOnly?this.results.regOverpaymentsDetails.hide():this.results.regOverpaymentsDetails.show(),f>0?(this.results.regOverpaymentsDetails_plusOverpayments.show(),this.results.regOverpaymentsDetails_overpaymentsOnly.hide()):(this.results.regOverpaymentsDetails_plusOverpayments.hide(),this.results.regOverpaymentsDetails_overpaymentsOnly.show()),this.results.overpaymentDurationValue.text(this._toYearsAndMonths(e)));at=tt-p;lt=this._toYearsAndMonths(t-y);this.results.reducedTerm.text(lt);this.results.mortgageBalance.text("£"+nbs.number.formatWithCommas(parseFloat(i),2));this.results.interestRate.text(v+"%");this.results.monthlyPayment.text("£"+nbs.number.formatWithCommas(parseFloat(a),2)+" (calculated)");this.results.remainingTerm.text(this._toYearsAndMonths(t));this.results.lumpSumOverpaymentValue.text("£"+nbs.number.formatWithCommas(parseFloat(f),2));this.results.monthlyOverpaymentValue.text("£"+nbs.number.formatWithCommas(parseFloat(ot),2));this.results.saveYou.text("£"+nbs.number.formatWithCommas(parseFloat(at),2)+" in interest");var dt=Math.ceil(i/10),d=Math.ceil(Math.pow(10,dt.toString().length-1)),st=dt/d,g;g=st<=1?1*d:st<=2?2*d:st<=5?5*d:10*d;gt=Math.ceil(i/g);this.chartOptions.scaleOverride=!0;this.chartOptions.scaleSteps=gt;this.chartOptions.scaleStartValue=0;this.chartOptions.scaleStepWidth=g;this.chartOptions.scaleLabel=g>1e5?"£<%=value/1000000%>m":g>1e3?"£<%=value/1000%>k":"£<%=value%>";this.isRepayment&&this.results.reducedTerm.text()!=""?this.results.overpaymentsReduceTerm.show():this.results.overpaymentsReduceTerm.hide();this.isRepayment?this._toYearsAndMonths(t)=="1 month"?this.results.chart.hide():(this.results.chart.show(),this._createChart(h,ft,et)):this.results.chart.hide();this.isInterestOnly&&(s=c*t+i);c<p+i?this.table.monthlyRepaymentWithOverpayments.text("£"+nbs.number.formatWithCommas(parseFloat(c),2)):this.table.monthlyRepaymentWithOverpayments.text("£"+nbs.number.formatWithCommas(parseFloat(p+i),2));this.table.totalToPayWithOverpayments.text("£"+nbs.number.formatWithCommas(parseFloat(p+i),2));this.table.lengthOfMortgageWithOverpayments.text(this._toYearsAndMonths(y));this.table.monthlyRepaymentNoOverpayments.text("£"+nbs.number.formatWithCommas(parseFloat(a),2));this.table.totalToPayNoOverpayments.text("£"+nbs.number.formatWithCommas(parseFloat(tt+i),2));this.table.lengthOfMortgageNoOverpayments.text(this._toYearsAndMonths(t));nt._analytics();$(".InterestNoOverpayments span").text("£"+nbs.number.formatWithCommas(tt,2));$(".InterestWithOverpayments span").text("£"+nbs.number.formatWithCommas(p,2))}else this.results.results.hide()},_unsetOverpaymentType:function(){$("#mortgageOverpaymentType div.radio").each(function(){$(this).removeClass("checked");$(this).find(".customRadio").attr("aria-checked","false")})},_regularOverpaymentUntilFurtherNotice:function(){var n=this;this.capture.regularOverpaymentUntilFurtherNotice.checked?(this.capture.regularOverpaymentMonths.setValue(),this.capture.regularOverpaymentYears.setValue(),this.form.regOverpaymentYearsMonthsFields.hide(),this.validate.regularOverpaymentUntilFurtherNotice.parents(".formRow").removeClass("error").addClass("valid")):this.form.regOverpaymentYearsMonthsFields.show()},_mortgageTypeChange:function(){this.capture.mortgageType.getValue()=="Repayment"?(this.isRepayment=!0,this.isInterestOnly=!1):(this.isRepayment=!1,this.isInterestOnly=!0);var n=this;this.capture.lumpSumAmount.setValue();this.capture.regularOverpaymentAmount.setValue();this.capture.regularOverpaymentYears.setValue();this.capture.regularOverpaymentMonths.setValue();this.validate.lumpSumAmount.parents(".formRow").removeClass("error").removeClass("valid");this.validate.regularOverpaymentAmount.parents(".formRow").removeClass("error").removeClass("valid");this.validate.regularOverpaymentYears.parents(".formRow").removeClass("error").removeClass("valid");this.isRepayment?(this._unsetOverpaymentType(),this.form.mortgageOverpaymentTypeLabel.show(),this.form.mortgageOverpaymentType.show(),this.form.mortgageOverpaymentTypeRad_regAmount.show(),this.form.mortgageOverpaymentTypeRad_oneOfflumpSum.show(),this.form.mortgageOverpaymentTypeRad_regAmountAndOneOfflumpSum.show(),this.form.lumpSumOverpayment.hide()):(this.form.regularOverpaymentAmount.hide(),this.form.regularOverpaymentTerm.hide(),this.form.mortgageOverpaymentTypeLabel.hide(),this.form.mortgageOverpaymentType.hide(),this.form.mortgageOverpaymentTypeRad_regAmount.hide(),this.form.mortgageOverpaymentTypeRad_oneOfflumpSum.show(),this.form.mortgageOverpaymentTypeRad_regAmountAndOneOfflumpSum.hide(),this.form.lumpSumOverpayment.show())},_mortgageOverpaymentTypeChange:function(){var t=this,n=this.capture.mortgageOverpaymentType.getValue();this.form.lumpSumOverpayment.hide();this.form.regularOverpaymentAmount.hide();this.form.regularOverpaymentTerm.hide();this.form.regOverpaymentYearsMonthsFields.hide();this.capture.lumpSumAmount.setValue();this.capture.regularOverpaymentAmount.setValue();this.capture.regularOverpaymentYears.setValue();this.capture.regularOverpaymentMonths.setValue();this.capture.regularOverpaymentUntilFurtherNotice.setChecked();n=="regularAmountOnly"?(this.form.lumpSumOverpayment.hide(),this.form.regularOverpaymentAmount.show(),this.form.regOverpaymentYearsMonthsFields.show(),this.form.regularOverpaymentTerm.show()):n=="oneoffLumpSumOnly"?(this.form.lumpSumOverpayment.show(),this.form.regularOverpaymentAmount.hide(),this.form.regOverpaymentYearsMonthsFields.hide(),this.form.regularOverpaymentTerm.hide()):(this.form.lumpSumOverpayment.show(),this.form.regularOverpaymentAmount.show(),this.form.regOverpaymentYearsMonthsFields.show(),this.form.regularOverpaymentTerm.show())},_createChart:function(n,t,i){for(var r=0;r<n.length;r++)r==0||r==n.length-1||n[r]!=""||r==t.length-1||t.length>r&&(t[r]=null),r==0||r==n.length-1||n[r]!=""||r==i.length-1||i.length>r&&(i[r]=null);this.chartData={labels:n,datasets:[{fillColor:"#e7f1fb",strokeColor:"#1676d9",pointColor:"#1676d9",data:t},{fillColor:"#dbeaea",strokeColor:"#73ae57",pointColor:"#73ae57",data:i}]};this.ctx.clearRect(0,0,this.ctx.width,this.ctx.height);this.myNewChart=new Chart(this.ctx).Line(this.chartData,this.chartOptions)},_updateClick:function(n){n.preventDefault();this._calculate()},_calculateClick:function(n){n.preventDefault();this._calculate()},_toYearsAndMonths:function(n){var e=n/12,t=Math.floor(e),i=Math.ceil(n%12),r=t+" years",u=i+" months",f="";return t==0?r="":t==1&&(r=t+" year"),i==0?u="":i===1&&(u=i+" month"),!t==0&&!i==0&&(f=" and "),r+f+u},_validateMortgageType:function(){var n=!0;return this.capture.mortgageType.getValue()?this.validate.mortgageType.parents(".formRow").removeClass("error").addClass("valid"):(n=!1,this.validate.mortgageType.parents(".formRow").addClass("error").removeClass("valid")),n},_validateMortgageOutstandingBalance:function(){var n=!0;return!this.capture.mortgageOutstandingBalance.getValue()||this.capture.mortgageOutstandingBalance.getValue()<1||this.capture.mortgageOutstandingBalance.getValue()>2e6?(n=!1,this.validate.mortgageOutstandingBalance.parents(".formRow").addClass("error").removeClass("valid")):this.validate.mortgageOutstandingBalance.parents(".formRow").removeClass("error").addClass("valid"),n},_validateMortgageInterestRate:function(){var n=!0;return!this.capture.mortgageInterestRate.getValue()||this.capture.mortgageInterestRate.getValue()<=0||this.capture.mortgageInterestRate.getValue()>10?(n=!1,this.validate.mortgageInterestRate.parents(".formRow").addClass("error").removeClass("valid")):this.validate.mortgageInterestRate.parents(".formRow").removeClass("error").addClass("valid"),n},_validateMortgagePaymentType:function(){var n=!0;return this.capture.mortgageInterestRate.getValue()?this.validate.mortgagePaymentType.parents(".formRow").removeClass("error").addClass("valid"):(n=!1,this.validate.mortgagePaymentType.parents(".formRow").addClass("error").removeClass("valid")),n},_validateMortgageTerm:function(){var n=!0,t=parseInt(this.capture.mortgageTermYears.getValue()*12)+parseInt(this.capture.mortgageTermMonths.getValue());return this.capture.mortgageTermMonths.getValue()>11?(n=!1,this.validate.mortgageTermMonths.parents(".formRow").addClass("error").addClass("monthError").removeClass("valid")):(this.validate.mortgageTermMonths.parents(".formRow").removeClass("monthError"),this.validate.mortgageTermMonths.parents(".formRow").addClass("valid").removeClass("error")),this.capture.mortgageTermYears.getValue()&&!this.capture.mortgageTermMonths.getValue()&&this.capture.mortgageTermMonths.setValue(0),(!this.capture.mortgageTermYears.getValue()&&!this.capture.mortgageTermMonths.getValue()||t>480)&&(n=!1,this.validate.mortgageTermYears.parents(".formRow").addClass("error").removeClass("valid")),this.capture.mortgageTermYears.getValue()==0&&this.capture.mortgageTermMonths.getValue()==0?(n=!1,this.validate.mortgageTermYears.parents(".formRow").addClass("error").removeClass("valid")):!this.capture.mortgageTermYears.getValue()&&this.capture.mortgageTermMonths.getValue()&&this.capture.mortgageTermMonths.getValue()<=12&&(n=!0,this.capture.mortgageTermYears.setValue(0),this.validate.mortgageTermYears.parents(".formRow").removeClass("error").addClass("valid")),n},_validateMortgageOverpaymentType:function(){var n=!0;return this.isInterestOnly||(this.capture.mortgageOverpaymentType.getValue()?this.validate.mortgageOverpaymentType.parents(".formRow").removeClass("error").addClass("valid"):(n=!1,this.validate.mortgageOverpaymentType.parents(".formRow").addClass("error").removeClass("valid"))),n},_validateMortgageOverpaymentTerm:function(){var n=!0,t,i;return this.form.regOverpaymentYearsMonthsFields.is(":visible")&&(this.capture.regularOverpaymentYears.getValue()&&this.capture.regularOverpaymentYears.getValue()!=0||this.capture.regularOverpaymentMonths.getValue()&&this.capture.regularOverpaymentMonths.getValue()!=0?this.capture.regularOverpaymentMonths.getValue()>=12&&(n=!1):n=!1,n&&(this.capture.regularOverpaymentMonths.getValue()||this.capture.regularOverpaymentMonths.setValue(0),this.capture.regularOverpaymentYears.getValue()||this.capture.regularOverpaymentYears.setValue(0),t=parseInt(this.capture.mortgageTermYears.getValue()*12)+parseInt(this.capture.mortgageTermMonths.getValue()),i=parseInt(this.capture.regularOverpaymentYears.getValue()*12)+parseInt(this.capture.regularOverpaymentMonths.getValue()),i>t&&(n=!1))),n?this.validate.regularOverpaymentYears.parents(".formRow").removeClass("error").addClass("valid"):this.validate.regularOverpaymentYears.parents(".formRow").addClass("error").removeClass("valid"),n},_validatelumpSumAmount:function(){var n=!0,t=this.capture.mortgageOverpaymentType.getValue();return this.isInterestOnly||t!="oneoffLumpSumOnly"&&t!="BothRegularAmountAndLumpSum"?this.isInterestOnly&&(!this.capture.lumpSumAmount.getValue()||this.capture.lumpSumAmount.getValue()<1||this.capture.lumpSumAmount.getValue()>2e6?(n=!1,this.validate.lumpSumAmount.parents(".formRow").addClass("error").removeClass("valid"),this.validate.lumpSumAmount.parents(".formRow").addClass("requiredError").removeClass("totalError")):parseInt(this.capture.lumpSumAmount.getValue(),10)>=parseInt(this.capture.mortgageOutstandingBalance.getValue(),10)?(n=!1,this.validate.lumpSumAmount.parents(".formRow").addClass("error").removeClass("valid"),this.validate.lumpSumAmount.parents(".formRow").removeClass("requiredError").addClass("totalError")):this.validate.lumpSumAmount.parents(".formRow").removeClass("error").addClass("valid")):!this.capture.lumpSumAmount.getValue()||this.capture.lumpSumAmount.getValue()<1||this.capture.lumpSumAmount.getValue()>2e6?(n=!1,this.validate.lumpSumAmount.parents(".formRow").addClass("error").removeClass("valid"),this.validate.lumpSumAmount.parents(".formRow").addClass("requiredError").removeClass("totalError")):parseInt(this.capture.lumpSumAmount.getValue(),10)>=parseInt(this.capture.mortgageOutstandingBalance.getValue(),10)?(n=!1,this.validate.lumpSumAmount.parents(".formRow").addClass("error").removeClass("valid"),this.validate.lumpSumAmount.parents(".formRow").removeClass("requiredError").addClass("totalError")):this.validate.lumpSumAmount.parents(".formRow").removeClass("error").addClass("valid"),n},_validateregularOverpaymentAmount:function(){var n=!0,i,t;return this.validate.regularOverpaymentYears.parents(".formRow").removeClass("requiredError").removeClass("monthError"),i=this.capture.mortgageType.getValue(),t=this.capture.mortgageOverpaymentType.getValue(),i=="Repayment"&&(t=="regularAmountOnly"||t=="BothRegularAmountAndLumpSum")&&(!this.capture.regularOverpaymentAmount.getValue()||this.capture.regularOverpaymentAmount.getValue()<1||this.capture.regularOverpaymentAmount.getValue()>1e4?(n=!1,this.validate.regularOverpaymentAmount.parents(".formRow").addClass("error").removeClass("valid"),this.validate.regularOverpaymentAmount.parents(".formRow").addClass("requiredError").removeClass("totalError")):parseInt(this.capture.regularOverpaymentAmount.getValue(),10)>=parseInt(this.capture.mortgageOutstandingBalance.getValue(),10)?(n=!1,this.validate.regularOverpaymentAmount.parents(".formRow").addClass("error").removeClass("valid"),this.validate.regularOverpaymentAmount.parents(".formRow").removeClass("requiredError").addClass("totalError")):parseInt(this.capture.regularOverpaymentAmount.getValue(),10)+parseInt(this.capture.lumpSumAmount.getValue(),10)>=parseInt(this.capture.mortgageOutstandingBalance.getValue(),10)?(n=!1,this.validate.regularOverpaymentAmount.parents(".formRow").addClass("error").removeClass("valid"),this.validate.lumpSumAmount.parents(".formRow").addClass("error").removeClass("valid"),this.validate.regularOverpaymentAmount.parents(".formRow").removeClass("requiredError").addClass("totalError"),this.validate.lumpSumAmount.parents(".formRow").removeClass("requiredError").addClass("totalError")):this.capture.regularOverpaymentMonths.getValue()>11&&(n=!1,this.validate.regularOverpaymentYears.parents(".formRow").removeClass("requiredError").addClass("monthError"),this.validate.regularOverpaymentYears.parents(".formRow").addClass("error").removeClass("valid"))),n},_validateFields:function(){var n,t;return this.capture.formRows.removeClass("error"),n=!0,this._validateMortgageType()||(n=!1),this._validateMortgageOutstandingBalance()||(n=!1),this._validateMortgageInterestRate()||(n=!1),this._validateMortgagePaymentType()||(n=!1),this._validateMortgageTerm()||(n=!1),this._validateMortgageOverpaymentType()||(n=!1),this._validateMortgageOverpaymentTerm()||(n=!1),this._validatelumpSumAmount()||(n=!1),this._validateregularOverpaymentAmount()||(n=!1),n||(t=$(".formRow.error").first(),nbs.dom.animateScrollToElement(t,500,10)),n},_analytics:function(){if(!this.analyticsHasRan)nbs.analytics.toolUsage({pageName:"bw:tool:Mortgage Overpayment Calculator",eVar4:"bw:tool:Mortgage Overpayment Calculator|Result Shown",events:"event98",linkTrackEvents:"event98",linkTrackVars:"eVar4,events"},"tool usage",!1),this.analyticsHasRan=!0},scale:function(n){return tenth=n/10,factor=pow(10,tenth.length-1),ratioVal=tenth/factor,ratioVal==1?1*factor:ratioVal<=2?2*factor:ratioVal<=5?5*factor:10*factor}});nbs.modules.ComparableProducts=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.$el=n;this.opts=$.extend(!0,{},t);this.resizeTimer=null;this.scrollWidth=0;this.comparableProductsWidth=0;this.comparableProductsHeight=0;this.productDetailItems=0;this.positionTop=0;this.positionBottom=0;this.selectedItems=0;this.isIEorMstr=!1;(nbs.detect.isMstr()||nbs.detect.isIe())&&(this.isIEorMstr=!0)},startup:function(){var n=this;this.components={filter:nbs.registry.get(this.$el.find(".choiceSelector"))};this.components.filter.$el.find("li.tab a").on("click",function(t){var i=t.currentTarget.getAttribute("data-filter"),r=[];i&&(i="{"+i+"}",r=new Function("return "+i)(),n._applyFilter(r.products))});this.selectedProducts=[];this.uiClass={active:"active",hide:"hide",fixed:"fixed"};this.uiElement={controls:this.$el.find(".controls"),compareBar:this.$el.find(".compareBar"),stickyHeader:this.$el.find(".stickyHeader:visible"),behind:this.$el.find(".behind"),stickyHeaderCompareBtns:this.$el.find(".stickyHeader .compare"),comparableComparison:this.$el.find(".comparableComparison"),comparableProducts:this.$el.find(".comparableProducts"),comparableProduct:this.$el.find(".comparableProduct"),leftShadow:this.$el.find(".shadow .leftShadow"),rightShadow:this.$el.find(".shadow .rightShadow"),comparisonProduct:this.$el.find(".comparisonProduct"),productDetails:".productDetails",productDetailsContainer:this.$el.find(".productDetailsContainer"),comparisonSticky1:this.$el.find(".comparisonSticky1"),comparisonSticky2:this.$el.find(".comparisonSticky2"),comparisonHeaderBG:this.$el.find(".comparisonHeaderBG"),cardImage:this.$el.find(".cardImage"),compareDataOverlay:this.$el.find(".comparableComparisonProductData")};this.uiInfo={stickyHeaderouterHeight:0,windowScrollPos:0,comparisonSticky1Height:this.uiElement.comparisonSticky1.outerHeight(),comparisonSticky2Height:this.uiElement.comparisonSticky2.outerHeight(),cardImageHeight:this.uiElement.cardImage.outerHeight()};this.uiElement.cardImage.css("margin-top",this.uiElement.comparisonSticky1.outerHeight()+20);this.action={compareButton:this.$el.find(".compare"),compareBarButton:this.$el.find(".compareBarButton"),leftScrollBtn:this.$el.find(".leftScrollBtn"),rightScrollBtn:this.$el.find(".rightScrollBtn")};this.action.compareBarButton.find(".close").hide();nbs.mode.isEditor()&&this.uiElement.productDetailsContainer.css("position","inherit");this._productDetails();this._bindEvents();this._onLoadReveal();this.components.filter.$el.find("li.tab a").first().click()},_bindEvents:function(){nbs.dispatcher.on("window/resize",nbs.util.hitch(this,"_resizeHandler"));nbs.respond.on("change",nbs.util.hitch(this,"_responsiveHandler"));if(!this.isIEorMstr&&!nbs.mode.isEditor()){nbs.dispatcher.on("window/scroll",nbs.util.hitch(this,"_onScroll"));this.uiElement.comparableComparison.scroll(nbs.util.hitch(this,"_overlayScroll"))}this.uiElement.comparableProducts.on("scroll",nbs.util.hitch(this,"_xScroll"));this.action.leftScrollBtn.on("click",nbs.util.hitch(this,"_scrollLeft"));this.action.rightScrollBtn.on("click",nbs.util.hitch(this,"_scrollRight"));this.action.compareButton.on("click",nbs.util.hitch(this,"_addToCompareClick"));this.action.compareBarButton.on("click",nbs.util.hitch(this,"_compareClick"))},_onLoadReveal:function(){var n=this.uiElement.comparableProducts[0].scrollWidth-this.uiElement.comparableProducts.width(),t=this;this.uiElement.comparableProducts.animate({scrollLeft:"+="+n+""},0,function(){t.uiElement.comparableProducts.delay(1e3).animate({scrollLeft:"-="+n+""},1e3)})},_xScroll:function(){var n,t;this.comparableProductsWidth=this.uiElement.comparableProducts.width();n=this.uiElement.comparableProducts.scrollLeft();this.scrollWidth=this.uiElement.comparableProducts[0].scrollWidth;t=this.comparableProductsWidth+n;console.log("comparableProductsWidth: "+this.comparableProductsWidth);console.log("scrollWidth: "+this.scrollWidth);this.scrollWidth<=this.comparableProductsWidth?this.uiElement.controls.fadeOut():this.uiElement.controls.fadeIn();n>0?(this.uiElement.leftShadow.addClass("active"),this.action.leftScrollBtn.removeClass("disabled")):(this.uiElement.leftShadow.removeClass("active"),this.action.leftScrollBtn.addClass("disabled"));t===this.scrollWidth?(this.uiElement.rightShadow.removeClass("active"),this.action.rightScrollBtn.addClass("disabled")):(this.uiElement.rightShadow.addClass("active"),this.action.rightScrollBtn.removeClass("disabled"))},_applyFilter:function(n){this.uiElement.comparableProduct.removeClass("first");this.uiElement.comparableProduct.removeClass("last");this.uiElement.comparableProduct.removeClass("selected");this.uiElement.comparableProduct.removeClass("notCompared");this.selectedItems=0;this.uiElement.stickyHeaderCompareBtns.removeClass("checked");this.uiElement.comparableProduct.each(function(){$.inArray($(this).attr("data-product"),n)<0?$(this).addClass("removed").hide():$(this).removeClass("removed").show()});nbs.dispatcher.trigger("showHide/open");this._productDetails();this._xScroll()},_applyCompare:function(n){var t=this.uiElement.comparisonProduct.filter(function(){return $.inArray($(this).attr("data-product"),n)>=0}),i=this.uiElement.comparisonProduct.filter(function(){return $.inArray($(this).attr("data-product"),n)<0});t.removeClass("removed").show();i.addClass("removed").hide()},_productDetails:function(){this.productDetailItems=this.uiElement.comparableProduct.first().find(this.uiElement.productDetails).length;var n=this;this.uiElement.comparableProduct.not(".removed").first().addClass("first");this.uiElement.comparableProduct.not(".removed").last().addClass("last");this.uiElement.comparableProduct.not(".removed").each(function(){var t=0;$(this).find(n.uiElement.productDetails).each(function(){$(this).addClass("productDetails"+t);t++})});this._productDetailsHeight()},_productDetailsHeight:function(){var u=this,r,n,t,i;for($(this.uiElement.productDetails).height(""),this.uiElement.comparableProduct.not(".removed").find(".stickyHeader").height(""),r=$(window).height(),this.uiElement.comparableComparison.height(r),this.uiElement.comparableComparison.css("top",r),this.uiInfo.stickyHeaderouterHeight=this.uiElement.stickyHeader.outerHeight(),n=0,this.uiElement.comparableProduct.not(".removed").find(".stickyHeader").each(function(){var t=$(this).outerHeight();t>=n&&(n=t)}),this.uiElement.comparableProduct.not(".removed").find(".stickyHeader").height(n-40),this.uiElement.productDetailsContainer.css("margin-top",n),this.positionTop=this.uiElement.comparableProducts.offset().top,t=0;t<this.productDetailItems;t++)i=0,$(u.uiElement.productDetails+t).each(function(){var n=$(this).outerHeight();n>i&&(i=n)}),$(u.uiElement.productDetails+t).height(i)},_scrollLeft:function(){this.uiElement.comparableProducts.animate({scrollLeft:"-=240"},300)},_scrollRight:function(){this.uiElement.comparableProducts.animate({scrollLeft:"+=240"},300)},_addToCompareClick:function(n){n.preventDefault();var i=this,t=$(n.target);t.hasClass("checked")?(t.removeClass("checked"),t.parents(".comparableProduct").removeClass("selected"),this.action.compareButton.parents(".comparableProduct").removeClass("notCompared"),this.selectedItems=this.selectedItems-1,i.action.compareBarButton.attr({"aria-disabled":!0,disabled:!0})):(this.selectedItems<2&&(this.selectedItems=this.selectedItems+1,t.addClass("checked"),t.parents(".comparableProduct").addClass("selected")),this.selectedItems===2&&(i.action.compareBarButton.attr({"aria-disabled":!1,disabled:!1}),i.action.compareButton.not(".checked").parents(".comparableProduct").addClass("notCompared")))},_compareClick:function(n){if(n.preventDefault(),this.selectedItems===2)if(this.uiElement.comparableComparison.hasClass("show"))$(".masthead .primary").css("z-index",""),this.uiElement.comparableComparison.removeClass("show"),this.action.compareBarButton.find(".open").show(),this.action.compareBarButton.find(".close").hide(),$(window).scrollTop(this.uiInfo.windowScrollPos);else{var t=this;this.selectedProducts=[];$(".masthead .primary").css("z-index",-1);this.uiElement.comparableComparison.addClass("show");$(".comparableProduct.selected").each(function(){t.selectedProducts.push($(this).attr("data-product"))});this.action.compareBarButton.find(".open").hide();this.action.compareBarButton.find(".close").show();this.uiInfo.windowScrollPos=$(window).scrollTop();this._applyCompare(this.selectedProducts)}},_onScroll:function(){var n,t;this.comparableProductsHeight=this.uiElement.comparableProducts.outerHeight();n=$(window).scrollTop();this.positionBottom=this.positionTop+this.comparableProductsHeight;this.uiElement.comparableComparison.hasClass("show")||(n>=this.positionTop?(t=n-this.positionTop,this.uiElement.stickyHeader.css("margin-top",t),this.uiElement.behind.css("margin-top",t),this.uiElement.controls.css("top",t),this.uiElement.stickyHeader.hasClass("fixed")||(this.uiElement.stickyHeader.addClass("fixed"),this.uiElement.behind.show()),n>=this.positionBottom-this.uiInfo.stickyHeaderouterHeight?(this.uiElement.compareBar.addClass(this.uiClass.hide),this.uiElement.controls.fadeOut()):(this.uiElement.compareBar.removeClass(this.uiClass.hide),this.scrollWidth<=this.comparableProductsWidth?this.uiElement.controls.fadeOut():this.uiElement.controls.fadeIn())):(this.uiElement.stickyHeader.removeClass("fixed"),this.uiElement.stickyHeader.css("margin-top",""),this.uiElement.controls.css("top",""),this.uiElement.behind.hide()))},_overlayScroll:function(){var t=this.uiElement.comparisonSticky1.height()+this.uiElement.comparisonSticky1.height()+this.uiElement.cardImage.height(),n=this.uiElement.comparableComparison.scrollTop();this.uiElement.comparisonHeaderBG.css("margin-top",n);this.uiElement.comparisonSticky1.css("margin-top",n);this.uiElement.comparisonHeaderBG.height(this.uiInfo.comparisonSticky1Height+this.uiInfo.comparisonSticky2Height);n>=this.uiInfo.cardImageHeight+25?(this.uiElement.comparisonSticky2.addClass("fixed"),this.uiElement.comparisonHeaderBG.addClass("fixed"),this.uiElement.comparisonSticky2.css("top",n+this.uiInfo.comparisonSticky1Height),this.uiElement.compareDataOverlay.css("margin-top",this.uiInfo.comparisonSticky2Height+20)):(this.uiElement.comparisonSticky2.removeClass("fixed"),this.uiElement.comparisonSticky2.css("top",""),this.uiElement.compareDataOverlay.css("margin-top",""),this.uiElement.comparisonHeaderBG.removeClass("fixed"))},_responsiveHandler:function(){this._onScroll();this._xScroll();this._productDetailsHeight()},_resizeHandler:function(){this._onScroll();this._xScroll();this._productDetailsHeight()}});nbs.modules.CostOfMovingToolBuying=nbs.declare(nbs.modules.CostOfMovingToolCommonFunctions,{NumberInput:null,BuyingAmount:null,BuyingDepositAmount:null,BuyingMortgageValuationFee:null,BuyingMortgageFees:null,BuyingHomeBuyerReportFee:null,BuyingPropertyType:null,BuyingPropertyLocation:null,FirstTimeBuyer:null,ContinueButton1:null,HomeBuyerReport:null,MortgageValuationFee:null,MortgageFee:null,StampDuty:null,BuyingConveyancingFee:null,StartAgainButton:null,DepositText:null,lblResult:null,HiddenCalculatedAgentFeeInPounds:null,HiddenPlusDepositText:null,TextHomeBuyerReport:null,LinkHomeBuyerReport:null,TextMortgageValuationFee:null,LinkMortgageValuationFee:null,TextMortgageFee:null,LinkMortgageFee:null,TextBuyingConveyancingFee:null,LinkBuyingConveyancingFee:null,divBuyingPanel:null,divResultPanel:null,initialise:function(n){this.inherited.apply(this,arguments);this.NumberInput=n.find(".numberinput");this.BuyingAmount=n.find("#txtBuyingAmountBuying");this.BuyingDepositAmount=n.find("#txtBuyingDepositAmountBuying");this.BuyingMortgageValuationFee=n.find("#txtBuyingMortgageValuationFeeBuying");this.BuyingMortgageFees=n.find("#txtBuyingMortgageFeesBuying");this.BuyingHomeBuyerReportFee=n.find("#txtBuyingHomeBuyerReportFeeBuying");this.BuyingPropertyType=n.find("#rdoBuyingPropertyTypeBuying");this.BuyingPropertyLocation=n.find("#rdoBuyingPropertyLocationBuying");this.FirstTimeBuyer=n.find("#rdoFirstTimeBuyerBuying");this.ContinueButton1=n.find("#lbtnContinue1Buying");this.HomeBuyerReport=n.find("#txtHomeBuyerReportBuying");this.MortgageValuationFee=n.find("#txtMortgageValuationFeeBuying");this.MortgageFee=n.find("#txtMortgageFeeBuying");this.StampDuty=n.find("#txtStampDutyBuying");this.BuyingConveyancingFee=n.find("#txtBuyingConveyancingFeeBuying");this.StartAgainButton=n.find("#lbtnStartAgainBuying");this.DepositText=n.find("#lblDepositTextBuying");this.lblResult=n.find("#lblResultBuying");this.HiddenCalculatedAgentFeeInPounds=n.find("#hfCalculatedAgentFeeInPoundsBuying");this.HiddenPlusDepositText=n.find("#hfPlusDepositTextBuying");this.TextHomeBuyerReport=n.find("#txtHomeBuyerReportBuying");this.LinkHomeBuyerReport=n.find(".hrfHomeBuyerReportBuying");this.TextMortgageValuationFee=n.find("#txtMortgageValuationFeeBuying");this.LinkMortgageValuationFee=n.find(".hrfMortgageValuationFeeBuying");this.TextMortgageFee=n.find("#txtMortgageFeeBuying");this.LinkMortgageFee=n.find(".hrfMortgageFeeBuying");this.TextBuyingConveyancingFee=n.find("#txtBuyingConveyancingFeeBuying");this.LinkBuyingConveyancingFee=n.find(".hrfBuyingConveyancingFeeBuying");this.divBuyingPanel=n.find(".divBuyingPanelBuying");this.divResultPanel=n.find(".divResultPanelBuying")},startup:function(){this.NumberInput.forceNumeric();this.divResultPanel.hide();this.CostOfMoovingToolEvents()},CostOfMoovingToolEvents:function(){var n=this;this.ContinueButton1.click(function(){n.divResultPanel.show();n.divBuyingPanel.hide();n.GetResultBuying(n)});this.StartAgainButton.click(function(){n.divBuyingPanel.show();n.divResultPanel.hide()});this.LinkHomeBuyerReport.bind("click",function(){n.TextHomeBuyerReport.attr("ReadOnly",!1).focus()});this.TextHomeBuyerReport.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkMortgageValuationFee.bind("click",function(){n.TextMortgageValuationFee.attr("ReadOnly",!1).focus()});this.TextMortgageValuationFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkMortgageFee.bind("click",function(){n.TextMortgageFee.attr("ReadOnly",!1).focus()});this.TextMortgageFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkBuyingConveyancingFee.bind("click",function(){n.TextBuyingConveyancingFee.attr("ReadOnly",!1).focus()});this.TextBuyingConveyancingFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())})}});nbs.modules.CostOfMovingToolSelling=nbs.declare(nbs.modules.CostOfMovingToolCommonFunctions,{NumberInput:null,SellingAmount:null,StateAgentFeeIn:null,SellingEstateAgentFees:null,SellingEnergyPerformanceCertificate:null,SellingRemovalCosts:null,SellingPropertyType:null,SellingPropertyLocation:null,GoBackButton1:null,ContinueButton1:null,estateAgentFeesPurpleBox:null,PurpleBoxPanel:null,EnergyPerformanceCertificate:null,RemovalCosts:null,EstateAgentFee:null,SellingConveyancingFee:null,StartAgainButton:null,DepositText:null,lblResult:null,HiddenPurpleBoxText:null,HiddenCalculatedAgentFeeInPounds:null,TextEnergyPerformanceCertificate:null,LinkEnergyPerformanceCertificate:null,TextMortgageValuationFee:null,LinkMortgageValuationFee:null,TextRemovalCosts:null,LinkRemovalCosts:null,TextEstateAgentFee:null,LinkEstateAgentFee:null,TextSellingConveyancingFee:null,LinkSellingConveyancingFee:null,divSellingPanel:null,divResultPanel:null,initialise:function(n){this.inherited.apply(this,arguments);this.NumberInput=n.find(".numberinput");this.SellingAmount=n.find("#txtSellingAmountSelling");this.SellingEstateAgentFees=n.find("#txtSellingEstateAgentFeesSelling");this.StateAgentFeeIn=n.find("#rdoFeeInSelling");this.SellingEnergyPerformanceCertificate=n.find("#txtSellingEnergyPerformanceCertificateSelling");this.SellingRemovalCosts=n.find("#txtSellingRemovalCostsSelling");this.SellingPropertyType=n.find("#rdoSellingPropertyTypeSelling");this.SellingPropertyLocation=n.find("#rdoSellingPropertyLocationSelling");this.GoBackButton1=n.find("#lbtnGoBack1Selling");this.ContinueButton1=n.find("#lbtnContinue1Selling");this.estateAgentFeesPurpleBox=n.find(".PurpleBoxEstateAgentFeesSelling");this.PurpleBoxPanel=n.find(".purpleBoxPanel");this.EnergyPerformanceCertificate=n.find("#txtEnergyPerformanceCertificateSelling");this.RemovalCosts=n.find("#txtRemovalCostsSelling");this.EstateAgentFee=n.find("#txtEstateAgentFeeSelling");this.SellingConveyancingFee=n.find("#txtSellingConveyancingFeeSelling");this.StartAgainButton=n.find("#lbtnStartAgainSelling");this.DepositText=n.find("#lblDepositTextv");this.lblResult=n.find("#lblResultSelling");this.HiddenPurpleBoxText=n.find("#hfPurpleBoxTextSelling");this.HiddenCalculatedAgentFeeInPounds=n.find("#hfCalculatedAgentFeeInPoundsSelling");this.TextEnergyPerformanceCertificate=n.find("#txtEnergyPerformanceCertificateSelling");this.LinkEnergyPerformanceCertificate=n.find(".hrfEnergyPerformanceCertificateSelling");this.TextHomeBuyerReport=n.find("#txtHomeBuyerReportSelling");this.LinkHomeBuyerReport=n.find(".hrfHomeBuyerReportSelling");this.TextRemovalCosts=n.find("#txtRemovalCostsSelling");this.LinkRemovalCosts=n.find(".hrfRemovalCostsSelling");this.TextEstateAgentFee=n.find("#txtEstateAgentFeeSelling");this.LinkEstateAgentFee=n.find(".hrfEstateAgentFeeSelling");this.TextSellingConveyancingFee=n.find("#txtSellingConveyancingFeeSelling");this.LinkSellingConveyancingFee=n.find(".hrfSellingConveyancingFeeSelling");this.divSellingPanel=n.find(".divSellingPanelSelling");this.divResultPanel=n.find(".divResultPanelSelling")},startup:function(){this.NumberInput.forceNumeric();this.divResultPanel.hide();this.CostOfMoovingToolEvents();var n=this.StateAgentFeeIn.find("input:checked").val();this.CalculateAgentFee();this.PurpleBoxPanel.hide()},CostOfMoovingToolEvents:function(){var n=this;this.ContinueButton1.click(function(){n.divResultPanel.show();n.divSellingPanel.hide();n.GetResultSelling(n)});this.StartAgainButton.click(function(){n.divSellingPanel.show();n.divResultPanel.hide();n.NumberInput.val("")});this.SellingAmount.on("input paste keyup blur",function(){n.CalculateAgentFee()});this.StateAgentFeeIn.change(function(){n.CalculateAgentFee()});this.SellingEstateAgentFees.on("input paste keyup blur",function(){n.CalculateAgentFee()});this.LinkEnergyPerformanceCertificate.bind("click",function(){n.TextEnergyPerformanceCertificate.attr("ReadOnly",!1).focus()});this.TextEnergyPerformanceCertificate.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkRemovalCosts.bind("click",function(){n.TextRemovalCosts.attr("ReadOnly",!1).focus()});this.TextRemovalCosts.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkEstateAgentFee.bind("click",function(){n.TextEstateAgentFee.attr("ReadOnly",!1).focus()});this.TextEstateAgentFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())});this.LinkSellingConveyancingFee.bind("click",function(){n.TextSellingConveyancingFee.attr("ReadOnly",!1).focus()});this.TextSellingConveyancingFee.on("input paste keyup blur",function(){n.lblResult.html(n.CalculateOnResultPage())})}}),function(){nbs.modules.RoutedApply=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t=$.extend(!0,{selectors:{tabs:"ul.routeTabs, ul.innerRouteTabs",route:"div.route",routeContent:"div.routeContent",analyticsTriggers:"ul.routeTabs li.lastOption, ul.innerRouteTabs li.lastOption",activeTabs:"ul.routeTabs li.active, ul.innerRouteTabs li.active"},classes:{active:"active"},fadeSpeed:500,slideSpeed:500},t);this.$analyticsTriggers=this.$el.find(this.opts.selectors.analyticsTriggers);this.busy=!1;this._createRoutes()},_analyticsHandler:function(){var t=this.$el.find(this.opts.selectors.activeTabs),n="";t.each(function(){n+="|"+$(".triggerInner",this).text()});s.tl("true","o","RApply"+n)},_createRoutes:function(){var t=this,i=this.opts,r=this.$el.find(i.selectors.tabs);r.each(function(){var i=$(),r=$(this).find("li").not(".directButton").each(function(){var n=$(this),r=n.children("a").attr("href"),u=t.$el.find(r);i=i.add(u)});new n(r,i,t)})}});var n=nbs.declare({initialise:function(n,t,i){var r=this;this.$triggers=n;this.$nodes=t;this.$nodeContent=t.children(i.opts.selectors.routeContent).attr("aria-hidden",!0);this.parent=i;this.index=null;n.each(function(n){$(this).children("a").click(function(t){t.preventDefault();r.toggle(n)})});t.each(function(n){$(this).children("a:first").click(function(t){t.preventDefault();r.toggle(n)})})},toggle:function(n){var t=this,i=this.parent.opts;this.parent.busy||this.$triggers.eq(n).hasClass(i.classes.active)||(this.parent.busy=!0,this.close().pipe(function(){return t._closeDescendents(),t.open(n)}).pipe(function(){t.parent.busy=!1}))},_closeDescendents:function(){var n=this.parent.opts;this.$nodeContent.find(n.selectors.tabs).children("li").removeClass(n.classes.active);this.$nodeContent.find(n.selectors.route).removeClass(n.classes.active).attr("aria-hidden","true")},close:function(){var u=this,i=new $.Deferred,n=this.parent.opts,r,t;return this.index===null?i.resolve():(this.$triggers.eq(this.index).removeClass(n.classes.active),this.$triggers.eq(this.index).children("a").focus(),r=this.$nodes.eq(this.index),t=this.$nodeContent.eq(this.index),t.fadeTo(n.fadeSpeed,0,function(){t.animate({height:0},n.slideSpeed,function(){r.removeClass(n.classes.active).attr("aria-hidden","true");t.css("display","").attr("aria-hidden",!0).height("auto");u.index=null;i.resolve()})})),i.promise()},open:function(n){var e=this,u=new $.Deferred,o=this.$nodes.eq(n),t=this.$nodeContent.eq(n),i=this.parent.opts,f,r;return this.$triggers.eq(n).addClass(i.classes.active),this.$triggers.eq(n).children("a").focus(),o.addClass(i.classes.active).attr("aria-hidden","false"),this.$triggers.eq(n).hasClass("lastOption")&&this.parent._analyticsHandler(),t.fadeTo(0,0),f=t.height(),r=t.find('[data-nbs-module="EqualHeights"]'),r.length&&r.each(function(){var n=nbs.registry.get($(this));n&&n.equaliseHeights()}),t.height(0),t.animate({height:f},i.slideSpeed,function(){t.fadeTo(i.fadeSpeed,1).attr("aria-hidden",!1).height("auto");e.index=n;u.resolve()}),u.promise()}})}();nbs.modules.myNationwideApp=nbs.declare(nbs.modules._Base,{initialise:function(n,t){this.inherited.apply(this,arguments);this.opts=t=$.extend(!0,{path:""},t)},startup:function(){this.prepareValidation();this.data={};$(".contentSection").find(".success,.failure").hide()},setParentRowErrorState:function(n,t,i){var r=t.attr("data-validation-msg");t.removeClass("valid").removeClass("error").addClass(n).find(".errFeedback").remove();n=="error"?t.find(".field").append(i.genErrorIcon(r)):t.find(".field").append('<span class="errFeedback icon iconValid" data-icon="&#xe00f;"><span class="screenReaderText">Valid<\/span><\/span>')},genErrorIcon:function(n){return'<div class="errFeedback"><span class="icon iconInvalid" data-icon="&#xe009;" aria-label="Error"><span class="screenReaderText">Invalid<\/span><\/span><div class="errorMessage"><p>'+n+"<\/p><\/div><\/div>"},prepareValidation:function(){function f(n){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(n)}var n=this,r,t,u,i;this.$el.find(".formActions .validationMessage").hide();this.$el.find("label span.required, div.label span.required").each(function(){$(this).closest(".formRow").addClass("requiredRow")});this.$el.find(".requiredRow select").bind("change blur",function(){var t=$(this).val().toLowerCase();t.indexOf("please select")!=-1?n.setParentRowErrorState("error",$(this).closest(".formRow"),n):n.setParentRowErrorState("valid",$(this).closest(".formRow"),n)});this.$el.find(".requiredRow input:not([type=radio]), .requiredRow input:not([type=checkbox]), .requiredRow textarea").on("blur",function(){var t=$(this),i=t.closest(".formRow"),r,u;if(t.val()=="")n.setParentRowErrorState("error",i,n);else if(t.hasClass("emailValidation")?(r=t.val(),f(r)?(n.setParentRowErrorState("valid",i,n),n.data.email=r):(n.setParentRowErrorState("error",i,n),n.data.email="")):n.setParentRowErrorState("valid",i,n),t.attr("id")=="txtPhoneNumber"){u=t.val().trim().replace(" ","").replace("(","").replace(")","").replace("-","");function e(n){return n.replace(/^(?:0044|0|\\+?44)/gi,"+44")}function o(n){var t=e(n),i=new RegExp("^(\\+?44)7(?:\\d\\s?){9}$");return i.test(t)}o(u)?(n.setParentRowErrorState("valid",i,n),n.data.phoneNumber=e(u)):(n.setParentRowErrorState("error",i,n),n.data.phoneNumber="")}});for(r=nbs.registry.getDescendents(this.$el,["Checkbox"]),t=0;t<r.length;t++)r[t].on("change",function(t){var i=t.$el,r=i.parent(".multiCheck, .multiCheckInline"),u=1;i.closest(".formRow").hasClass("requiredRow")&&(r.length>0&&(r.hasClass("multiRequire2")?u=2:r.hasClass("multiRequire3")?u=3:r.hasClass("multiRequireAll")&&(u=r.find(".checkbox").length)),i.closest(".formRow").find("input[type=checkbox]:checked").length>=u?(i.closest(".formRow").addClass("validateCheckboxes"),n.setParentRowErrorState("valid",i.closest(".formRow"),n)):i.closest(".formRow").hasClass("validateCheckboxes")&&n.setParentRowErrorState("error",i.closest(".formRow"),n))});for(u=nbs.registry.getDescendents(this.$el,["RadioGroup"]),i=0;i<u.length;i++)u[i].on("change",function(t){var i=t.$el.closest(".formRow");i.hasClass("requiredRow")&&(i.find(".booleanYes").find("input[type=radio]:checked").length>=1?n.setParentRowErrorState("valid",i,n):n.setParentRowErrorState("error",i,n))});this.$el.find("button[type=submit],input[type=submit]").on("click",nbs.util.hitch(this,"validateBeforeSubmit"))},validateBeforeSubmit:function(){var r,t,u,i,f,n;for(this.$el.find(".requiredRow .checkbox").each(function(){$(this).closest(".formRow").addClass("validateCheckboxes")}),this.$el.find(".requiredRow select").change(),this.$el.find(".requiredRow input:not([type=checkbox]), .requiredRow input:not([type=radio]), .requiredRow textarea").blur(),r=nbs.registry.getDescendents(this.$el,["Checkbox"]),t=0;t<r.length;t++)r[t].trigger("change",r[t]);for(u=nbs.registry.getDescendents(this.$el,["RadioGroup"]),i=0;i<u.length;i++)u[i].trigger("change",u[i]);return(f=this.$el.find("div.formRow.error").size(),f>0)?(this.$el.find(".formActions .validationMessage").html("Please scroll up and correct the errors ("+f+" in total)").show(),!1):(this.$el.find(".formActions .validationMessage").hide(),n=this,$.ajax({dataType:"json",method:"POST",url:n.opts.path,context:n,data:{phone:n.data.phoneNumber,email:n.data.email}}).done(function(t){n.success(t)}).fail(function(t){n.fail(t)}).always(function(){}),!1)},success:function(){$(".formSectionInner").hide();$(".contentSection").find(".success").show();$(".formActions").remove()},fail:function(){$(".formSectionInner").hide();$(".contentSection").find(".failure").show();$(".formActions").remove()}});